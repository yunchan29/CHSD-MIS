<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link rel="icon" href="/resources/pictures/chsd.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }
        @media (max-width: 768px) {
    .wide-modal {
        max-width: 100% !important;
    }
}
       /* Highlight effect */
       .highlight {
    background-color: #d3f9d8; /* light green */
    transition: background-color 1s ease-out; /* fades out smoothly */
}
.btn-upload {
        padding: 8px 16px;
        background-color: #4CAF50 !important;
        color: white !important;
        border: none;
        cursor: pointer !important;
    }
    .btn-upload:hover {
        background-color: #45a049;
    }
    .file-item {
        display: flex;
        align-items: center;
    }
    .file-name {
        margin-right: 10px;
    }
    .btn-delete {
        color: red;
        cursor: pointer;
    }
   
    </style>
</head>
<body>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
               
               
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html" class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building Permit</a></li>
              <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html" class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy Permit</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html" class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html" class="text-decoration-none"><i class="fa-solid fa-gear"></i> Settings</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html" class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>
             
              <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
           <!--Navigation Bar-->
<nav class="navigationBar navbar navbar-expand-lg bg-light">
  <div class="container-fluid">
      <!-- Mobile View -->
      <div class="d-flex justify-content-between d-md-none d-block">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
              <h5 class="mb-0 fs-5">CHSD</h5>
          </a>
          <button class="btn px-1 py-0 open-btn">
              <i class="fa-solid fa-bars-staggered"></i>
          </button>
      </div>

      <!-- Desktop View -->
      <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
              <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
          </a>
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <!-- Additional nav items go here -->
          </ul>
      </div>
  </div>
</nav>
           
            <div class="contentContainer">
               
                <!-- Bootstrap Table -->
            <div class="container">
                
                <h5>Profile</h5>
                <div class="row mt-4">
                    <div class="col">
                        <a class="btn btn-dark text-white" data-bs-toggle="modal" data-bs-target="#occupancyUploadModal"><i class="fa-solid fa-plus"></i> Add Profile</a>
                       
                    </div>
                <div class="d-flex justify-content-end mb-3">
                  <input type="text" class="form-control search-bar" placeholder="Search">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                  </div>
                </div>

                <h4 class="text-center">Certificate of Occupancy</h4>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Owner</th>
                      <th>Representative</th>
                      <th>Submitted at</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="profileTableBody">
                    <!-- Rows will be populated by Firebase data -->
                </tbody>
                
                      
                </table>
                  <!-- Pagination Controls -->
                  <div class="pagination-controls text-center">
                    <button id="prevPageBtn" class="btn btn-primary" disabled>Previous</button>
                    <span id="pageInfo"></span>
                    <button id="nextPageBtn" class="btn btn-primary">Next</button>
                </div>


             </div>
             <!-- End of Bootstrap Table -->
            </div>
        </div>
    </div>

    <!-- Certificate of Occupancy Upload Modal -->
    <div class="modal fade" id="occupancyUploadModal" tabindex="-1" aria-labelledby="occupancyUploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="occupancyUploadModalLabel">Certificate of Occupancy Application</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Step Progress Bar -->
                    <div class="step-progress mb-4">
                        <div class="step completed">
                            <div class="circle"></div>
                            <div class="label">Upload Requirements</div>
                        </div>
                        <div class="step">
                            <div class="circle"></div>
                            <div class="label">Appointment</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <label for="buildingPermitOption">Building Permit Option</label>
                            
                            <!-- Toggle Buttons for Selection -->
                            <div class="btn-group d-flex" role="group">
                                <input type="radio" class="btn-check" name="permitOption" id="typeOption" autocomplete="off" checked>
                                <label class="btn btn-outline-secondary flex-fill" for="typeOption">Type Permit No.</label>
                    
                                <input type="radio" class="btn-check" name="permitOption" id="selectOption" autocomplete="off">
                                <label class="btn btn-outline-secondary flex-fill" for="selectOption">Select Permit</label>
                            </div>
                    
                            <!-- Dynamic Instructional Text -->
                            <small id="instructionText" class="form-text text-muted mt-2">
                                Please type the Building Permit Number.
                            </small>
                    
                            <!-- Input for Typing Permit Number -->
                            <div id="permitInputContainer" class="mt-2">
                                <input type="text" id="buildingPermitNo" class="form-control" placeholder="ex. 2024-XXXX">
                            </div>
                    
                            <!-- Button for Selecting Permit from Modal -->
                            <div id="permitSelectContainer" class="mt-2 d-none">
                                <button type="button" id="openPermitModalBtn" class="btn btn-outline-secondary w-100">Select Permit from List</button>
                            </div>
                    
                            <!-- Readonly Display of Selected Permit Number -->
                            <div id="selectedPermitDisplay" class="mt-2 d-none">
                                <input type="text" id="selectedPermitNumber" class="form-control" readonly>
                                <small class="form-text text-muted">Selected Permit Number</small>
                            </div>
                        </div>
                    </div>
                    
                    
                    <div class="row">
                        <label for="ownerName">Owner/Applicant Name:</label>
                        <input type="text" class="form-control" id="ownerName" placeholder="Enter Name">
                    </div>
    
                    <div class="row">
                        <div class="col-md-8">
                            <label for="ownerAddress">Address of Owner</label>
                            <input type="text" class="form-control" id="ownerAddress">
                        </div>
                            
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <label for="projectLocation">Location of the Project</label>
                        <input type="text" class="form-control" id="projectLocation">
                        </div>
                        
                     </div>
                     <div class="row">
                        <div class="col-md-4">
                            <label for="totalFloorArea">Total Floor Area</label>
                            <input type="number" class="form-control" id="totalFloorArea">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="NOunits">Number of Units</label>
                            <input type="text" class="form-control" id="NOUnits">
                        </div>
                        <div class="col-md-4">
                            <label for="NOStorey">Number of Storeys</label>
                            <input type="text" class="form-control" id="NOStorey">
                        </div>
                     </div>
                    <!-- Content -->
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Requirements</th>
                                <th>File</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Duly Accomplished Certificate of Building Permit Completion Form</td>
                                <td class="file-column">
                                    <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                        <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                             ondrop="handleDrop(event, 'buildingPermitCompletionFile')" ondragover="handleDragOver(event)">
                                            <p>Drag & drop file</p>
                                        </div>
                                        <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('buildingPermitCompletionFile').click()">Upload</button>
                                        <input type="file" class="file-input" id="buildingPermitCompletionFile" style="display: none;" onchange="uploadFile(this)">
                                        <div id="buildingPermitCompletionFileName" class="file-column"></div> <!-- Display file details here -->
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Photocopy of Approved Building Permit Form</td>
                                <td class="file-column">
                                    <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                        <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                             ondrop="handleDrop(event, 'approvedBuildingPermitFile')" ondragover="handleDragOver(event)">
                                            <p>Drag & drop file</p>
                                        </div>
                                        <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('approvedBuildingPermitFile').click()">Upload</button>
                                        <input type="file" class="file-input" id="approvedBuildingPermitFile" style="display: none;" onchange="uploadFile(this)">
                                        <div id="approvedBuildingPermitFileName" class="file-column"></div> <!-- Display file details here -->
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Photocopy of Approved Plan</td>
                                <td class="file-column">
                                    <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                        <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                             ondrop="handleDrop(event, 'approvedPlanFile')" ondragover="handleDragOver(event)">
                                            <p>Drag & drop file</p>
                                        </div>
                                        <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('approvedPlanFile').click()">Upload</button>
                                        <input type="file" class="file-input" id="approvedPlanFile" style="display: none;" onchange="uploadFile(this)">
                                        <div id="approvedPlanFileName" class="file-column"></div> <!-- Display file details here -->
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Photos of Structure (Front, Back, Left, Right, Lavatory, and CR)</td>
                                <td class="file-column">
                                    <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                        <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                             ondrop="handleDrop(event, 'structurePhotosFile')" ondragover="handleDragOver(event)">
                                            <p>Drag & drop file</p>
                                        </div>
                                        <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('structurePhotosFile').click()">Upload</button>
                                        <input type="file" class="file-input" id="structurePhotosFile" style="display: none;" onchange="uploadFile(this)">
                                        <div id="structurePhotosFileName" class="file-column"></div> <!-- Display file details here -->
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Sketch of Location and Contact Number</td>
                                <td class="file-column">
                                    <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                        <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                             ondrop="handleDrop(event, 'sketchFile')" ondragover="handleDragOver(event)">
                                            <p>Drag & drop file</p>
                                        </div>
                                        <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('sketchFile').click()">Upload</button>
                                        <input type="file" class="file-input" id="sketchFile" style="display: none;" onchange="uploadFile(this)">
                                        <div id="sketchFileName" class="file-column"></div> <!-- Display file details here -->
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        
                        
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitAppointment">Submit</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="permitSelectionModal" tabindex="-1" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Building Permit</h5>
                    <button type="button" id="closePermitModalBtn" class="btn-close"></button>
                </div>
                <div class="modal-body">
                    <ul id="permitList" class="list-group">
                        <!-- Building permits will be loaded here dynamically -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" id="closeModalFooterBtn" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>



    <!--Generate Occupancy Permit-->
  
  <div class="modal fade" id="occupancyPermitModal" tabindex="-1" aria-labelledby="occupancyPermitModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Occupancy Permit</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="d-flex justify-content-center align-items-center mb-2 mt-2">
                <!-- Left Logo -->
                <img src="/resources/pictures/calambaLogo.png" alt="Calamba Logo" style="height: 50px; width: 50px; margin-left: auto;">
                <!-- Center Title -->
                <div class="text-center" style="margin: 0 10px;">
                    <h5 class="mb-0">CITY HOUSING AND SETTLEMENTS DEPARTMENT</h5>
                    <p class="mb-0">City Government of Calamba</p>
                </div>
                <!-- Right Logo -->
                <img src="/resources/pictures/chsd.png" alt="CHSD Logo" style="height: 50px; width: 50px; margin-right: auto;">
            </div> 
            <br>
            
            <h6 class="text-center">CERTIFICATE OF BUILDING COMPLETION</h6>
            <p class="">This is to certify that the construction of of the residential building covered by <strong>Building Permit No.<span id="aaaBuildingPermitNo"></span></strong> under BP220 issued on <strong><span id="aaaIssuedOn"></span> </strong> has been constructed and completed under out inspection and supervision pursuant to Section 306 and the National Building Code (PD 1096). Its IRR and conforms the architectural well being, structural stability, electrical, plumbing, interior design, and the fire-protective properties in accordance with the plans and specifications submitted and on file with the City Housing and Settlements Department.</p>
            <div class="container">
                
                <div class="row">
                       <div class="col-md-8">
                        
                        <p><strong>Name of Owner: </strong><span id="certOwnerName"></span></p>
                       </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <p><strong>Address of Owner: </strong><span id="certOwnerAddress"></span></p>
                    </div>
                        
                </div>
                <div class="row">
                    <div class="col-md-8">
                    
                    <p><strong>Location Of The Project: </strong><span id="certProjectLocation"></span></p>
                    </div>
                    
                 </div>
                 <div class="row">
                    <div class="col-md-4">
                        <p><strong>Total Floor Area: </strong><span id="certTotalFloorArea"></span></p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Number of Storeys: </strong><span id="certNOStorey"></span></p>
                    </div>
                    <div class="col-md-4">
                        <p><strong>Number of Units: </strong><span id="certNOUnits"></span></p>
                    </div>
                 </div>
                 
        
                 <hr>
        
                            <p class="text-center">Full Time Inspector And Supervisor of Construction Works(Representing the Owner)</p>
                            
                            <hr>
                            <div class="row">
                                <div class="col-md-6" style="border: 0.5px solid black; padding: 2px;">
                                    <br>
                                    <br>
                                    <p class="text-center">Architect or Civil Engineer</p>
                                    <p class="text-center"><i>(Signed and Sealed Over Printed Name)</i></p>
                                </div>
                            
                                <div class="col-md-6" style="border: 0.5px solid black; padding: 2px;">
                                    <br>
                                    <br>
                                    <p class="text-center">Architect or Civil Engineer</p>
                                    <p class="text-center"><i>(Signed and Sealed Over Printed Name)</i></p>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>PRC No.:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>Validity:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>PRC No.:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>Validity:</p>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>PTR No.:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>Date Issued:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>PTR No.:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>Date Issued:</p>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6" style="border: 0.5px solid black; padding: 2px;">
                                    <br>
                                    <br>
                                    <p class="text-center">Architect or Civil Engineer</p>
                                    <p class="text-center"><i>(Signed and Sealed Over Printed Name)</i></p>
                                </div>
                            
                                <div class="col-md-6" style="border: 0.5px solid black; padding: 2px;">
                                    <br>
                                    <br>
                                    <p class="text-center">Architect or Civil Engineer</p>
                                    <p class="text-center"><i>(Signed and Sealed Over Printed Name)</i></p>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>PRC No.:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>Validity:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>PRC No.:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>Validity:</p>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>PTR No.:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>Date Issued:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>PTR No.:</p>
                                </div>
                                <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                                    <p>Date Issued:</p>
                                </div>
                                <br>
                                <p>HSD Form No.3</p>
                                <h6 class="text-center">CERTIFICATE OF OCCUPANCY under BP220</h6>
                                <div class="row">
                                    <div class="col-md-4">
                            
                                         <p><strong>CO BP220 No.: </strong><span id="certBuildingPermitNo"></span></p>
                                    </div>
                                    <div class="col-md-8">
                                        <label for="issuedOn">Issued On:
                                        </label>
                                        <input type="date" class="form-control" id="issuedOn">
                                    </div>
                                </div>
                                <div class="row">
                                     <div class="col-md-12">
                                        <label for="lotNumber">Lot and Block Number:</label>
                                        <input type="text" class="form-control" id="lotNumber">
                                     </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <label for="NOUnits">No. of Units</label>
                                        <input type="number" class="form-control" id="NOUnits">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="totalFloorArea">
                                            Total Floor Area
                                        </label>
                                        <input type="number" class="form-control" id="totalFloorArea">
                                    </div>
                                </div>
        
                                <p><i>This certificate of occupancy is issued purusant to Section 1(b) of Executive Order No. 71, Series of 1993.</i></p>
        </div></div></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>

     <!-- View Uploads Modal -->
<div class="modal fade" id="viewUploadsModal" tabindex="-1" aria-labelledby="viewUploadsModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewUploadsModalLabel">Uploaded Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Uploaded Files List -->
                    <div class="col-lg-12">
                        <ul id="uploadedFilesList" class="list-group">
                            <!-- Dynamically append files here -->
                        </ul>
                    </div>
                </div>
                <!-- Comment Summary Section -->
                <div id="commentSummaryContainer" class="mt-3">
                    <h6>File Validation Comments</h6>
                    <ul id="commentSummaryList" class="list-group">
                        <!-- Comments will be summarized here -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="filePreviewContainer" style="display: none;"> <!-- Hidden by default -->
                    <iframe id="filePreview" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                </div>
                <div class="mt-3">
                    <label>Validation:</label><br>
                    <input type="radio" name="validationOptions" value="approved" id="approvedOption">
                    <label for="approvedOption">Approve</label><br>
                    <input type="radio" name="validationOptions" value="disapproved" id="disapprovedOption">
                    <label for="disapprovedOption">Disapprove</label>
                </div>
                <div class="mt-3">
                    <label for="validationComments">Comments:</label>
                    <textarea class="form-control" id="validationComments" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveValidationBtn">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


    <!-- View Details Modal -->
    <div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewDetailsModalLabel">Permit Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Text information at the top -->
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Owner Name:</strong> <span id="permitOwnerName"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                        </div>
                    </div>
                
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Permit ID:</strong> <span id="permitIdDisplay"></span></p>
                        </div>
                    </div>
                
                    <!-- Status selection in a row -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="statusSelect" class="form-label">Status</label>
                            <select id="statusSelect" class="form-select">
                                <option value="Pending">Pending</option>
                                <option value="Processing">Processing</option>
                                <option value="To Pay">To Pay</option>
                                <option value="For Approval">For Approval</option>
                                <option value="For Release">For Release</option>
                                <option value="Claimed">Claimed</option>
                            </select>
                        </div>
                    </div>
                
                   
                    <div id="viewDetailsModalBtnGrp">
    
                    </div>
                
                    <!-- Hidden input field to store the permit ID -->
                    <input type="hidden" id="hiddenPermitId">
                </div>
                
                
                <div class="modal-footer">
                   
                    <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const instructionText = document.getElementById("instructionText");
    document.getElementById("typeOption").addEventListener("change", function() {
        document.getElementById("permitInputContainer").classList.remove("d-none");
        document.getElementById("permitSelectContainer").classList.add("d-none");
        instructionText.textContent = "Please type the Building Permit Number.";
    });
    
    document.getElementById("selectOption").addEventListener("change", function() {
        document.getElementById("permitInputContainer").classList.add("d-none");
        document.getElementById("permitSelectContainer").classList.remove("d-none");
        instructionText.textContent = "Please select a Building Permit from the list.";
    });
    
    </script>
    

    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module" src="/Database/firebase.js"></script>
    <script type="module">
      // Import Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc, getDocs, setDoc, deleteDoc, limit, orderBy, onSnapshot, query, where, startAfter, getDoc} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

      // Firebase configuration
      const firebaseConfig = {
          apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
          authDomain: "chsd-mis.firebaseapp.com",
          projectId: "chsd-mis",
          storageBucket: "chsd-mis.appspot.com",
          messagingSenderId: "694967679357",
          appId: "1:694967679357:web:65cffd50f13739f934f414",
          measurementId: "G-XBQTQFRLJ5"
      };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);
  
      // Document Ready
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('submitAppointment').addEventListener('click', async (event) => {
        event.preventDefault();

        const submitButton = document.getElementById('submitAppointment');
        submitButton.disabled = true;

        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.display = 'flex';
        }

        // Collect input values

        const ownerName = document.getElementById("ownerName").value;
        const ownerAddress = document.getElementById("ownerAddress").value;
        const projectLocation = document.getElementById("projectLocation").value;
        const totalFloorArea = document.getElementById("totalFloorArea").value;
        const NOUnits = document.getElementById("NOUnits").value;
        const NOStorey = document.getElementById("NOStorey").value;
        const buildingPermitNo = document.getElementById("buildingPermitNo").value;
        // Required fields validation
        const requiredFields = [
           
            { field: ownerName, name: 'Owner Name' }
        ];

        for (const { field, name } of requiredFields) {
            if (!field) {
                alert(`Please fill out the ${name} field.`);
                submitButton.disabled = false;
                return;
            }
        }

        // File inputs and namePrefix mapping
        const requiredFileInputs = [
            { id: 'buildingPermitCompletionFile', namePrefix: 'buildingPermitCompletion', name: 'Building Permit Completion' },
            { id: 'approvedBuildingPermitFile', namePrefix: 'approvedBuildingPermit', name: 'Approved Building Permit' },
            { id: 'approvedPlanFile', namePrefix: 'approvedPlan', name: 'Approved Plan' },
            { id: 'structurePhotosFile', namePrefix: 'structurePhotos', name: 'Structure Photos' },
            { id: 'sketchFile', namePrefix: 'sketch', name: 'Sketch' }
        ];

        // Validate that all required files are uploaded
        for (const fileInputObj of requiredFileInputs) {
            const fileInput = document.getElementById(fileInputObj.id);
            if (!fileInput || !fileInput.files[0]) {
                alert(`Please upload the ${fileInputObj.name} file.`);
                submitButton.disabled = false;
                loadingScreen.style.display = 'none';
                return;
            }
        }

        try {
            // Ensure the user is authenticated
            const user = await new Promise((resolve, reject) => {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        resolve(user);
                    } else {
                        reject(new Error("No user is authenticated."));
                    }
                });
            });

            const userId = user.uid;

            // Prepare permit data for Firestore
            const permitData = {
              
                ownerUid: userId,
                ownerName,
                projectLocation,
                ownerAddress,
                totalFloorArea,
                NOUnits,
                NOStorey,
                buildingPermitNo,
                status: 'Pending',
                createdAt: serverTimestamp(),
            };

            // Add a new document to Firestore and get the generated document ID
            const permitDocRef = await addDoc(collection(db, "OccupancyPermits"), permitData);
            const permitId = permitDocRef.id;
            const storagePath = `OccupancyPermits/${permitId}`;

            // Handle file uploads and storage
            const uploadPromises = requiredFileInputs.map(async fileInputObj => {
                const fileInput = document.getElementById(fileInputObj.id);
                if (fileInput && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const fileRef = ref(storage, `${storagePath}/${fileInputObj.namePrefix}_${file.name}`);
                    const snapshot = await uploadBytes(fileRef, file);
                    return getDownloadURL(snapshot.ref);
                } else {
                    console.error(`File input missing or undefined for ${fileInputObj.namePrefix}`);
                    return null;
                }
            });

            // Wait for all uploads and store URLs
            const fileURLs = await Promise.all(uploadPromises);

            const fileURLMapping = {
                buildingPermitCompletionURL: fileURLs[0],
                approvedBuildingPermitURL: fileURLs[1],
                approvedPlanURL: fileURLs[2],
                structurePhotosURL: fileURLs[3],
                sketchURL: fileURLs[4],
            };

            // Update Firestore document with file URLs
            const permitDoc = doc(db, "OccupancyPermits", permitId);
            await updateDoc(permitDoc, fileURLMapping);

            // Success feedback
            Swal.fire({
  title: "Success!",
  text: "Application Submitted",
  icon: "success"
});
       

        } catch (error) {
            // Log and alert on error
            console.error("Error during submission:", error);
            alert(`Error submitting application: ${error.message}`);
        } finally {
            // Hide loading screen and re-enable submit button
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            submitButton.disabled = false;
        }
    });
});


       
    // Function to Dynamically Append Buttons to the View Details Modal for Occupancy Permit
function appendButtons(data) {
    const viewDetailsModalBtnGrp = document.getElementById('viewDetailsModalBtnGrp');
    viewDetailsModalBtnGrp.innerHTML = ''; // Clear existing buttons

    // Row 1: View File Uploads
    const firstRow = document.createElement('div');
    firstRow.className = 'row mt-4';

    const col1 = document.createElement('div');
    col1.className = 'col-md-12';
    const btn1 = document.createElement('button');
    btn1.className = 'btn btn-primary w-100';
    btn1.textContent = 'View File Uploads';
    btn1.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide(); // Hide View Details Modal
        openViewUploadsModal(data); // Open View Uploads Modal
    });
    col1.appendChild(btn1);
    firstRow.appendChild(col1);

    // Row 2: Generate Occupancy Permit
    const secondRow = document.createElement('div');
    secondRow.className = 'row mt-2';

    const col2 = document.createElement('div');
    col2.className = 'col-md-12';
    const btn2 = document.createElement('button');
    btn2.className = 'btn btn-primary w-100';
    btn2.textContent = 'Generate Occupancy Permit';
    btn2.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide(); // Hide View Details Modal
        openGenerateOccupancyPermitModal(data); // Open Generate Permit Modal
    });
    col2.appendChild(btn2);
    secondRow.appendChild(col2);

    // Row 3: Generate Order of Payment
    const thirdRow = document.createElement('div');
    thirdRow.className = 'row mt-2';

    const col3 = document.createElement('div');
    col3.className = 'col-md-12';
    const btn3 = document.createElement('button');
    btn3.className = 'btn btn-success w-100';
    btn3.textContent = 'Generate Order of Payment';
    btn3.addEventListener('click', () => {
        generateOrderOfPayment(data); // Generate order of payment

        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide(); // Hide View Details Modal

        const orderOfPaymentModal = new bootstrap.Modal(document.getElementById('orderOfPaymentModal'));
        orderOfPaymentModal.show();

        document.getElementById('orderOfPaymentModal').addEventListener('hidden.bs.modal', function () {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove(); // Ensure the backdrop is removed
        });
    });
    col3.appendChild(btn3);
    thirdRow.appendChild(col3);

    // Row 4: Archive Permit
    const fourthRow = document.createElement('div');
    fourthRow.className = 'row mt-2';

    const col4 = document.createElement('div');
    col4.className = 'col-md-12';
    const btn4 = document.createElement('button');
    btn4.className = 'btn btn-danger w-100';
    btn4.textContent = 'Archive Permit';
    btn4.setAttribute('data-id', data.id);
    btn4.addEventListener('click', (event) => handleArchiveOccupancyPermit(event));
    
    col4.appendChild(btn4);
    fourthRow.appendChild(col4);

    // Append Rows to Button Group
    viewDetailsModalBtnGrp.appendChild(firstRow);
    viewDetailsModalBtnGrp.appendChild(secondRow);
    viewDetailsModalBtnGrp.appendChild(thirdRow);
    viewDetailsModalBtnGrp.appendChild(fourthRow);
}

// Function to Open the Occupancy Permit Modal
async function openGenerateOccupancyPermitModal(permitData) {
    try {
        console.log("Occupancy Permit Data received:", permitData); // Log permitData to ensure it's not empty

        // Fetch the data from the OccupancyPermits collection based on the permitId
        const occupancyFormData = await getDoc(doc(db, "OccupancyPermits", permitData.id));

        if (!occupancyFormData.exists()) {
            console.error("Occupancy Permit not found!");
            alert("Occupancy Permit data is missing!");
            return;
        }

        const data = occupancyFormData.data();
        console.log("Occupancy Permit Data retrieved:", data); // Log the fetched data to ensure it's being retrieved correctly

        // Populate Occupancy Permit Modal Fields
        document.getElementById('certOwnerName').textContent = data.ownerName || "N/A";
        document.getElementById('certOwnerAddress').textContent = data.ownerAddress || "N/A";
        document.getElementById('certProjectLocation').textContent = data.projectLocation || "N/A";
        document.getElementById('certTotalFloorArea').textContent = data.totalFloorArea || "N/A";
        document.getElementById('certNOUnits').textContent = data.NOUnits || "N/A";
        document.getElementById('certNOStorey').textContent = data.NOStorey || "N/A";
        document.getElementById('certBuildingPermitNo').textContent = data.buildingPermitNo || "N/A";
        document.getElementById("aaaBuildingPermitNo").textContent = data.buildingPermitNo || "N/A";
      
const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000) : null;

if (createdAt && !isNaN(createdAt)) {
    const formattedDate = createdAt.toLocaleDateString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
    document.getElementById("aaaIssuedOn").textContent = formattedDate;
} else {
    document.getElementById("aaaIssuedOn").textContent = "Date not available";
}

  
        console.log("Occupancy Permit fields populated");

        // Show the Occupancy Permit Modal
        const occupancyPermitModal = new bootstrap.Modal(document.getElementById('occupancyPermitModal'));
        occupancyPermitModal.show();
    } catch (error) {
        console.error("Error opening Occupancy Permit modal:", error);
        alert("Failed to load Occupancy Permit data.");
    }
}




      // Function to show notification
      function showNotification(message, type) {
          console.log(`Showing notification: ${message}`);
          const notificationContainer = document.getElementById('notification-container');
          if (notificationContainer) {
              const notification = document.createElement('div');
              notification.className = `notification ${type}`;
              notification.textContent = message;
              notificationContainer.appendChild(notification);
          } else {
              console.error('Notification container not found.');
          }
      }
  
// Pagination Variables
let profilesPerPage = 50; // Profiles per page
let currentPage = 1; // Current page
let totalPages = 1; // Total pages

// Function to Load Occupancy Permits and Display in the Table
async function loadOccupancyProfiles() {
    try {
        const querySnapshot = await getDocs(collection(db, "OccupancyPermits")); // Updated collection name
        const occupancyPermitDiv = document.getElementById("profileTableBody");
        const prevPageBtn = document.getElementById("prevPageBtn");
        const nextPageBtn = document.getElementById("nextPageBtn");
        const pageInfo = document.getElementById("pageInfo");

        if (!occupancyPermitDiv) {
            console.error("occupancyPermitDiv not found in the DOM.");
            return;
        }

        occupancyPermitDiv.innerHTML = ""; // Clear existing rows

        // Fetch and Process Permits Data
        const permitsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const uniquePermitsData = Array.from(new Set(permitsData.map(a => a.id)))
            .map(id => permitsData.find(a => a.id === id));

        // Sort by createdAt (ascending)
        uniquePermitsData.sort((a, b) => {
            const aTime = a.createdAt?.seconds || 0;
            const bTime = b.createdAt?.seconds || 0;
            return aTime - bTime;
        });

        // Calculate Total Pages
        totalPages = Math.ceil(uniquePermitsData.length / profilesPerPage);

        // Determine Profiles for Current Page
        const start = (currentPage - 1) * profilesPerPage;
        const end = start + profilesPerPage;
        const currentProfiles = uniquePermitsData.slice(start, end);

        // Loop Through Profiles and Populate Table
        for (const data of currentProfiles) {
            const row = document.createElement("tr");

            // Fetch Representative User Data
            let representativeName = "";
            if (data.ownerUid) {
                try {
                    const userRef = doc(db, "users", data.ownerUid);
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        representativeName = `${userData.firstName} ${userData.lastName}`;
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                }
            }

            const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";

            row.innerHTML = `
                <td>${data.ownerName || "N/A"}</td>
                <td>${representativeName || "N/A"}</td>
                <td>${createdAt}</td>
                <td>${data.status || "N/A"}</td>
                <td>
                    <button class="btn btn-primary btn-sm view-details-btn" data-permit-id="${data.id}">View Details</button>
                </td>
            `;

            occupancyPermitDiv.appendChild(row);

            // Add Event Listener for "View Details" Button
            const viewDetailsBtn = row.querySelector(".view-details-btn");
            if (viewDetailsBtn) {
                viewDetailsBtn.addEventListener("click", () => {
                    openViewDetailsModal(data);
                });
            }
        }

        // Update Pagination Info
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

        // Enable/Disable Pagination Buttons
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;

    } catch (error) {
        console.error("Error loading profiles:", error);
        showNotification("Failed to load profiles.", "error");
    }
}

// Function to Control Progressive Status Selection
function updateStatusOptions(currentStatus) {
    const statusSelect = document.getElementById("statusSelect");

    const statusProgression = {
        "Pending": ["Pending", "Processing"],
        "Processing": ["Processing", "To Pay"],
        "To Pay": ["To Pay", "For Approval"],
        "For Approval": ["For Approval", "For Release"],
        "For Release": ["For Release", "Claimed"],
        "Claimed": ["Claimed"]
    };

    const validStatuses = statusProgression[currentStatus] || [];

    const options = statusSelect.querySelectorAll("option");
    options.forEach(option => {
        if (validStatuses.includes(option.value)) {
            option.style.display = "block"; // Show valid options
        } else {
            option.style.display = "none"; // Hide invalid options
        }
    });

    // Set the statusSelect to the currentStatus
    statusSelect.value = currentStatus;
}

// Function to Open the View Details Modal
function openViewDetailsModal(permitData) {
    // Populate Modal Fields
    const appointmentDate = permitData.appointmentDate ? new Date(permitData.appointmentDate.seconds * 1000).toLocaleString() : "N/A";
    document.getElementById("permitOwnerName").textContent = permitData.ownerName || "N/A";
    document.getElementById("issuedOnDate").textContent = permitData.issuedOn || "N/A";
    document.getElementById("appointmentDateSched").textContent = appointmentDate || "N/A";
    document.getElementById("permitIdDisplay").textContent = permitData.id || "N/A";
    document.getElementById("hiddenPermitId").value = permitData.id || "";

    // Update Status Options
    updateStatusOptions(permitData.status || "Pending");

    // Append Dynamic Buttons
    appendButtons(permitData);

    // Show the Modal
    const viewDetailsModal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
    viewDetailsModal.show();

    // Add Event Listener for the Save Button (Ensure it's not duplicated)
    const saveStatusBtn = document.getElementById("saveStatusBtn");
    saveStatusBtn.onclick = async () => {
        const newStatus = document.getElementById("statusSelect").value;
        try {
            // Update Status in Firestore
            await updateDoc(doc(db, 'OccupancyPermits', permitData.id), { status: newStatus });

            // Trigger Notification
            const message = `${permitData.ownerName}'s occupancy permit is now ${newStatus.toLowerCase()}`;
            showNotification(message, 'info');

            // Store Notification in Firestore
            await addDoc(collection(db, "notifications"), {
                userId: permitData.ownerUid,
                message: message,
                permitId: permitData.id,
                timestamp: serverTimestamp(),
                read: false
            });
            Swal.fire({
  title: "Success!",
  text: "Status Updated Successfully!",
  icon: "success"
});

            // Reload Profiles to Reflect Changes
            loadOccupancyProfiles();

            // Hide Modal
            viewDetailsModal.hide();

        } catch (error) {
            console.error("Error updating permit status:", error);
            showNotification("Failed to update permit status.", "error");
        }
    };
}

// Function to Archive an Occupancy Permit
async function handleArchiveOccupancyPermit(event) {
    event.preventDefault();

    const occupancyPermitId = event.target.getAttribute('data-id');

    if (!occupancyPermitId) {
        console.error("Occupancy Permit ID is null or undefined.");
        showNotification("Error: Occupancy Permit ID is missing.", "error");
        return;
    }

    // SweetAlert for confirmation
    Swal.fire({
        title: "Are you sure?",
        text: "You won't be able to revert this!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, archive it!"
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const occupancyPermitRef = doc(db, "OccupancyPermits", occupancyPermitId);
                const occupancyPermitSnapshot = await getDoc(occupancyPermitRef);

                if (occupancyPermitSnapshot.exists()) {
                    const occupancyPermitData = occupancyPermitSnapshot.data();
                    
                    // Archive document
                    await setDoc(doc(db, "archivedOccupancyPermits", occupancyPermitId), occupancyPermitData);
                    await deleteDoc(occupancyPermitRef);

                    // Remove the row from the table
                    const tableBody = document.querySelector("#profileTableBody"); // Update the correct table body ID if needed
                    const rowToRemove = tableBody.querySelector(`button[data-permit-id="${occupancyPermitId}"]`).closest('tr');
                    if (rowToRemove) rowToRemove.remove();

                    showNotification("Document archived successfully!", "success");

                    // Close the modal
                    const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
                    if (viewDetailsModal) {
                        viewDetailsModal.hide(); // Hide View Details Modal
                    }

                    // Success feedback
                    Swal.fire({
                        title: "Archived!",
                        text: "Your file has been archived successfully.",
                        icon: "success"
                    });

                } else {
                    showNotification("Document not found!", "error");
                }
            } catch (error) {
                console.error("Error archiving document: ", error);
                showNotification(`Failed to archive document: ${error.message}`, "error");
            }
        }
    });
}


let fileValidationStatus = {}; // For tracking validation status and comments

async function openViewUploadsModal(permitData) {
    try {
        console.log("Fetching uploaded files and validation status for occupancy permit:", permitData.id);

        // Fetch the occupancy permit document from Firestore
        const permitDocRef = doc(db, "OccupancyPermits", permitData.id);
        const permitSnapshot = await getDoc(permitDocRef);

        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const commentSummaryList = document.getElementById('commentSummaryList');
        uploadedFilesList.innerHTML = '';  // Clear existing files
        commentSummaryList.innerHTML = ''; // Clear previous comments

        if (!permitSnapshot.exists()) {
            console.warn("No occupancy permit document found.");
            const noFilesItem = document.createElement('li');
            noFilesItem.className = 'list-group-item';
            noFilesItem.textContent = 'No files uploaded.';
            uploadedFilesList.appendChild(noFilesItem);
        } else {
            const permitData = permitSnapshot.data();
            const { approvedBuildingPermitURL, approvedPlanURL, buildingPermitCompletionURL, sketchURL, structurePhotosURL, fileValidationStatus = {} } = permitData;

            if (!approvedBuildingPermitURL && !approvedPlanURL && !buildingPermitCompletionURL && !sketchURL && !structurePhotosURL) {
                const noFilesItem = document.createElement('li');
                noFilesItem.className = 'list-group-item';
                noFilesItem.textContent = 'No files uploaded.';
                uploadedFilesList.appendChild(noFilesItem);
            } else {
                const createFileItem = (fileLabel, fileURL, fileRowId) => {
                    const fileItem = document.createElement('li');
                    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    fileItem.dataset.rowid = fileRowId;  // Use fixed fileRowId

                    fileItem.innerHTML = `
                        <span>${fileLabel}</span>
                        <div>
                            <a href="${fileURL}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-eye"></i></a>
                            <button class="btn btn-sm btn-outline-success validation-btn" data-fileurl="${fileURL}" data-filelabel="${fileLabel}" data-rowid="${fileRowId}"><i class="fa-solid fa-list-check"></i></button>
                        </div>`;

                    const validationButton = fileItem.querySelector('.validation-btn');
                    validationButton.addEventListener('click', (event) => {
                        const fileRow = document.querySelector(`[data-rowid="${event.currentTarget.dataset.rowid}"]`);
                        openValidationModal(event.currentTarget.dataset.fileurl, event.currentTarget.dataset.filelabel, fileRow);
                    });

                    uploadedFilesList.appendChild(fileItem);
                };

                // Display each uploaded file with validation
                if (approvedBuildingPermitURL) createFileItem('Approved Building Permit', approvedBuildingPermitURL, 'approvedBuildingPermit');
                if (approvedPlanURL) createFileItem('Approved Plan', approvedPlanURL, 'approvedPlan');
                if (buildingPermitCompletionURL) createFileItem('Building Permit Completion', buildingPermitCompletionURL, 'buildingPermitCompletion');
                if (sketchURL) createFileItem('Sketch of Location', sketchURL, 'sketch');
                if (structurePhotosURL) createFileItem('Structure Photos', structurePhotosURL, 'structurePhotos');

                // Handle file validation status and comments
                for (const fileRowId in fileValidationStatus) {
                    const { status, comments } = fileValidationStatus[fileRowId];
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1); // Capitalize first letter
                    const commentPrefix = `${fileRowId.replace(/([A-Z])/g, ' $1').trim()} - ${statusText} - `;

                    const commentSummaryItem = document.createElement('li');
                    commentSummaryItem.className = 'list-group-item';
                    commentSummaryItem.dataset.commentid = fileRowId;
                    commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;

                    commentSummaryList.appendChild(commentSummaryItem);
                }
            }
        }

        const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
        viewUploadsModal.show();

    } catch (error) {
        console.error("Error fetching uploads:", error);
        alert("Failed to load uploaded files.");
    }
}

function openValidationModal(fileURL, fileLabel, fileRow) {
    const viewUploadsModal = bootstrap.Modal.getInstance(document.getElementById('viewUploadsModal'));
    viewUploadsModal.hide();

    const validationModalLabel = document.getElementById('validationModalLabel');
    const commentsInput = document.getElementById('validationComments');
    const previewContainer = document.getElementById('filePreviewContainer');
    const filePreview = document.getElementById('filePreview');

    validationModalLabel.textContent = `Validation for ${fileLabel}`;
    commentsInput.value = ''; // Clear previous comments

    previewContainer.style.display = 'none';
    filePreview.src = ''; // Clear previous preview

    if (fileURL.endsWith('.pdf')) {
        filePreview.src = fileURL; 
        previewContainer.style.display = 'block'; 
        filePreview.type = "application/pdf"; 
    } else {
        filePreview.src = fileURL;
        previewContainer.style.display = 'block';
        filePreview.type = "image"; 
    }

    const saveBtn = document.getElementById('saveValidationBtn');
    saveBtn.dataset.filerow = fileRow.dataset.rowid;

    saveBtn.removeEventListener('click', saveValidation);  
    saveBtn.addEventListener('click', saveValidation);      

    const validationModal = new bootstrap.Modal(document.getElementById('validationModal'));
    validationModal.show();
}

async function saveValidation() {
    const selectedOption = document.querySelector('input[name="validationOptions"]:checked');
    if (!selectedOption) {
        alert('Please select an option (approve/disapprove).');
        return;
    }

    const comments = document.getElementById('validationComments').value;
    const fileRowId = document.getElementById('saveValidationBtn').dataset.filerow;
    const fileRow = document.querySelector(`[data-rowid="${fileRowId}"]`);

    fileValidationStatus[fileRowId] = {
        status: selectedOption.value,
        comments: comments
    };

    const permitId = document.getElementById('hiddenPermitId').value;

    if (!permitId) {
        console.error('Permit ID is not available.');
        alert('Error: Permit data is missing.');
        return;
    }

    const permitDocRef = doc(db, "OccupancyPermits", permitId);
    try {
        await updateDoc(permitDocRef, {
            [`fileValidationStatus.${fileRowId}`]: {
                status: selectedOption.value,
                comments: comments
            }
        });
        console.log('Validation saved to Firestore');
        Swal.fire({
  title: "Validated!",
  text: "File Validated Successfully!",
  icon: "success"
});
    } catch (error) {
        console.error("Error saving validation to Firestore:", error);
        alert("Failed to save validation.");
    }

    const validationModal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
    validationModal.hide();

    const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
    viewUploadsModal.show();

    const commentSummaryList = document.getElementById('commentSummaryList');
    let existingComment = commentSummaryList.querySelector(`[data-commentid="${fileRowId}"]`);

    const statusText = selectedOption.value.charAt(0).toUpperCase() + selectedOption.value.slice(1); 
    const commentPrefix = `${fileRow.querySelector('span').textContent} - ${statusText} - `;

    if (existingComment) {
        existingComment.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
    } else {
        const commentSummaryItem = document.createElement('li');
        commentSummaryItem.className = 'list-group-item';
        commentSummaryItem.dataset.commentid = fileRowId; 
        commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
        commentSummaryList.appendChild(commentSummaryItem);
    }
}


// Function to preview file (image or PDF)
function previewFile(fileURL) {
    const previewContainer = document.getElementById('previewContainer');
    previewContainer.innerHTML = ''; // Clear any previous preview

    const fileExtension = fileURL.split('.').pop().toLowerCase();

    let previewElement;

    if (fileExtension === 'jpg' || fileExtension === 'jpeg' || fileExtension === 'png') {
        // Image preview
        previewElement = document.createElement('img');
        previewElement.src = fileURL;
        previewElement.className = 'img-fluid';
        previewElement.alt = 'File Preview';
    } else if (fileExtension === 'pdf') {
        // PDF preview
        previewElement = document.createElement('iframe');
        previewElement.src = fileURL;
        previewElement.className = 'w-100';
        previewElement.style.height = '600px'; // Adjust height as necessary
        previewElement.style.border = 'none';  // Clean border for better UX
    } else {
        // For unsupported file types
        previewElement = document.createElement('p');
        previewElement.textContent = 'Preview not available for this file type.';
    }

    previewContainer.appendChild(previewElement);

    // Scroll to preview section if preview is inside the modal
    previewContainer.scrollIntoView({ behavior: 'smooth' });
}



// Function to Search Permits by Owner or Representative Name
function searchOccupancyPermits() {
    const searchInput = document.getElementById("searchInput").value.toLowerCase();
    const tableRows = document.querySelectorAll("#occupancyPermitDiv tbody tr");

    let resultsFound = false; // To track if any results are found

    tableRows.forEach(row => {
        const ownerName = row.querySelector("td:nth-child(1)").textContent.toLowerCase().includes(searchInput);
        const representativeName = row.querySelector("td:nth-child(2)").textContent.toLowerCase().includes(searchInput);

        if (ownerName || representativeName) {
            row.style.display = ""; // Show matching row
            resultsFound = true;
        } else {
            row.style.display = "none"; // Hide non-matching row
        }
    });

    // If no results are found, show a message
    const noResultsMessage = document.getElementById("noResultsMessage");
    if (resultsFound) {
        noResultsMessage.style.display = "none";
    } else {
        noResultsMessage.style.display = "block";
        noResultsMessage.textContent = "No matching permits found.";
    }
}

// Pagination Event Listeners
document.getElementById("prevPageBtn").addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        loadOccupancyProfiles();
    }
});

document.getElementById("nextPageBtn").addEventListener("click", () => {
    if (currentPage < totalPages) {
        currentPage++;
        loadOccupancyProfiles();
    }
});

// Initial Load of Occupancy Profiles
loadOccupancyProfiles();

document.addEventListener('DOMContentLoaded', () => {
    // Initialize and add event listeners for buttons
    document.getElementById('openPermitModalBtn').addEventListener('click', openPermitSelectionModal);
    document.getElementById('closePermitModalBtn').addEventListener('click', closePermitSelectionModal);
    document.getElementById('closeModalFooterBtn').addEventListener('click', closePermitSelectionModal);

    async function openPermitSelectionModal() {
        const modal = document.getElementById('permitSelectionModal');
        const permitList = document.getElementById('permitList');
        permitList.innerHTML = '';  // Clear previous entries

        // Show a loading indicator (optional)
        permitList.innerHTML = '<li>Loading permits...</li>';

        try {
            // Fetch all building permits
            const buildingPermitsRef = collection(db, "buildingPermits");
            const querySnapshot = await getDocs(buildingPermitsRef);

            permitList.innerHTML = ''; // Clear loading text

            querySnapshot.forEach((doc) => {
                const permit = doc.data();
                const listItem = document.createElement('li');
                listItem.textContent = `${permit.buildingPermitNo} - ${permit.ownerName || 'Unknown Owner'}`;
                listItem.className = "list-group-item list-group-item-action";
                listItem.addEventListener('click', () => selectPermit(doc.id)); // Pass document ID
                permitList.appendChild(listItem);
            });

        } catch (error) {
            console.error("Error fetching permits:", error);
            permitList.innerHTML = '<li>Error loading permits</li>';
        }

        modal.style.display = 'block'; // Show the modal
    }

    function closePermitSelectionModal() {
        document.getElementById('permitSelectionModal').style.display = 'none';
    }

    async function selectPermit(permitId) {
        try {
            const permitRef = doc(db, "buildingPermits", permitId);
            const permitSnap = await getDoc(permitRef);

            if (permitSnap.exists()) {
                const permitData = permitSnap.data();

                // Autofill form fields and apply highlight effect
                autofillField('buildingPermitNo', permitData.buildingPermitNo);
                autofillField('ownerName', permitData.ownerName);
                autofillField('ownerAddress', permitData.addressTelNo);
                autofillField('projectLocation', permitData.projectLocation);
                autofillField('totalFloorArea', permitData.TotalFloorArea);
                autofillField('NOUnits', permitData.NOUnits);
                autofillField('NOStorey', permitData.NOStorey);

                closePermitSelectionModal();
            } else {
                console.error("No such document!");
            }
        } catch (error) {
            console.error("Error fetching permit details:", error);
        }
    }

    function autofillField(fieldId, value) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = value || ''; // Set field value
            field.classList.add('highlight'); // Add highlight class

            // Remove highlight effect after 2 seconds
            setTimeout(() => {
                field.classList.remove('highlight');
            }, 2000);
        }
    }
});


</script>

<script>
    function uploadFile(input, file = null) {
        const selectedFile = file || input.files[0];  // Use the file from input or passed as an argument

        if (selectedFile) {
            const maxSizeMB = 5;  // Set max file size (in MB)
            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];  // Allowed file types

            // Validate file type
            if (!allowedTypes.includes(selectedFile.type)) {
                alert('Invalid file type. Please upload a JPG, PNG, or PDF file.');
                input.value = ''; // Clear the input
                return;
            }

            // Validate file size
            const maxSizeBytes = maxSizeMB * 1024 * 1024;  // Convert MB to bytes
            if (selectedFile.size > maxSizeBytes) {
                alert(`File is too large. Please upload a file smaller than ${maxSizeMB}MB.`);
                input.value = '';  // Clear the input
                return;
            }

            // FileReader to read file details
            const reader = new FileReader();
            reader.onload = function () {
                const fileName = selectedFile.name;
                const fileSize = formatBytes(selectedFile.size);
                const fileItem = `
                    <div class="file-item">
                        <span class="file-name">${fileName} (${fileSize})</span>
                        <span class="btn-delete" onclick="deleteFile(this, '${input.id}')">Delete</span>
                    </div>`;

                // Display file information
                const fileColumn = input.closest('.file-column'); // Get the closest file-column
                if (fileColumn) {
                    fileColumn.insertAdjacentHTML('beforeend', fileItem);  // Append the file item
                } else {
                    console.error('File column not found.');
                }
            };
            reader.readAsDataURL(selectedFile);
        }
    }

    function deleteFile(deleteBtn, inputId) {
        const fileItem = deleteBtn.closest('.file-item');
        if (fileItem) {
            fileItem.remove();  // Remove the displayed file item
            document.getElementById(inputId).value = '';  // Clear the input for re-upload
        }
    }

    // Format file size to a readable string
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Drag-over handler to show drag-and-drop action
    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.dataTransfer.dropEffect = 'copy';  // Change the cursor to indicate a drop is possible
    }

    // Drop handler to process the dropped files
    function handleDrop(event) {
        event.preventDefault();
        event.stopPropagation();

        const files = event.dataTransfer.files;  // Get the dropped files
        const inputFileElement = event.target.closest('.upload-btn-wrapper').querySelector('.file-input');  // Find the corresponding file input

        if (inputFileElement && files.length > 0) {
            limitFiles(inputFileElement, 5, files);  // Limit the number of dropped files and handle each
        }
    }

    // Limit the number of files
    function limitFiles(input, maxFiles = 5, fileList = null) {
        const files = fileList || input.files;
        if (files.length > maxFiles) {
            alert(`You can only upload up to ${maxFiles} files.`);
            input.value = '';  // Clear the input
            return;
        }

        for (let i = 0; i < files.length; i++) {
            uploadFile(input, files[i]);  // Process each file
        }
    }
</script>




    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
