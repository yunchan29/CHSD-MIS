<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }
        @media (max-width: 768px) {
    .wide-modal {
        max-width: 100% !important;
    }
}
   
    </style>
</head>
<body>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
               
               
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <ul class="sideBarList list-unstyled px-2">
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html" class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building Permit</a></li>
              <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html" class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy Permit</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html" class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html" class="text-decoration-none"><i class="fa-solid fa-bell"></i> Notifications</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html" class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>
             
              <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
           <!--Navigation Bar-->
<nav class="navigationBar navbar navbar-expand-lg bg-light">
  <div class="container-fluid">
      <!-- Mobile View -->
      <div class="d-flex justify-content-between d-md-none d-block">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
              <h5 class="mb-0 fs-5">CHSD</h5>
          </a>
          <button class="btn px-1 py-0 open-btn">
              <i class="fa-solid fa-bars-staggered"></i>
          </button>
      </div>

      <!-- Desktop View -->
      <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
              <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
          </a>
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <!-- Additional nav items go here -->
          </ul>
      </div>
  </div>
</nav>
           
            <div class="contentContainer">
               
                <!-- Bootstrap Table -->
            <div class="container">
                
                <h5>Profile</h5>
                <div class="row mt-4">
                    <div class="col">
                        <a class="btn btn-dark text-white" data-bs-toggle="modal" data-bs-target="#buildingPermitModal"><i class="fa-solid fa-plus"></i> Add Profile</a>
                       
                    </div>
                <div class="d-flex justify-content-end mb-3">
                  <input type="text" class="form-control search-bar" placeholder="Search">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                  </div>
                </div>

                <h4 class="text-center">Certificate of Occupancy</h4>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Owner</th>
                      <th>Representative</th>
                      <th>Submitted at</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="profileTableBody">
                    <!-- Rows will be populated by Firebase data -->
                </tbody>
                
                      
                </table>
                  <!-- Pagination Controls -->
                  <div class="pagination-controls text-center">
                    <button id="prevPageBtn" class="btn btn-primary" disabled>Previous</button>
                    <span id="pageInfo"></span>
                    <button id="nextPageBtn" class="btn btn-primary">Next</button>
                </div>


             </div>
             <!-- End of Bootstrap Table -->
            </div>
        </div>
    </div>

     <!-- View Uploads Modal -->
<div class="modal fade" id="viewUploadsModal" tabindex="-1" aria-labelledby="viewUploadsModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewUploadsModalLabel">Uploaded Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Uploaded Files List -->
                    <div class="col-lg-12">
                        <ul id="uploadedFilesList" class="list-group">
                            <!-- Dynamically append files here -->
                        </ul>
                    </div>
                </div>
                <!-- Comment Summary Section -->
                <div id="commentSummaryContainer" class="mt-3">
                    <h6>File Validation Comments</h6>
                    <ul id="commentSummaryList" class="list-group">
                        <!-- Comments will be summarized here -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="filePreviewContainer" style="display: none;"> <!-- Hidden by default -->
                    <iframe id="filePreview" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                </div>
                <div class="mt-3">
                    <label>Validation:</label><br>
                    <input type="radio" name="validationOptions" value="approved" id="approvedOption">
                    <label for="approvedOption">Approve</label><br>
                    <input type="radio" name="validationOptions" value="disapproved" id="disapprovedOption">
                    <label for="disapprovedOption">Disapprove</label>
                </div>
                <div class="mt-3">
                    <label for="validationComments">Comments:</label>
                    <textarea class="form-control" id="validationComments" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveValidationBtn">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


    <!-- View Details Modal -->
    <div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewDetailsModalLabel">Permit Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Text information at the top -->
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Owner Name:</strong> <span id="permitOwnerName"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                        </div>
                    </div>
                
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Permit ID:</strong> <span id="permitIdDisplay"></span></p>
                        </div>
                    </div>
                
                    <!-- Status selection in a row -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="statusSelect" class="form-label">Status</label>
                            <select id="statusSelect" class="form-select">
                                <option value="Pending">Pending</option>
                                <option value="Processing">Processing</option>
                                <option value="To Pay">To Pay</option>
                                <option value="For Approval">For Approval</option>
                                <option value="For Release">For Release</option>
                                <option value="Claimed">Claimed</option>
                            </select>
                        </div>
                    </div>
                
                    <!-- Comments section -->
                    <div class="row">
                        <div class="col-md-12">
                            <label for="officerRemarks">Comments</label>
                            <textarea class="form-control" id="officerRemarks" rows="2"></textarea>
                        </div>
                    </div>
                
                    <div id="viewDetailsModalBtnGrp">
    
                    </div>
                
                    <!-- Hidden input field to store the permit ID -->
                    <input type="hidden" id="hiddenPermitId">
                </div>
                
                
                <div class="modal-footer">
                   
                    <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    

    <script type="module" src="/Database/firebase.js"></script>
    <script type="module">
      // Import Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, getDocs, updateDoc, doc, getDoc, addDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
      // Firebase configuration
      const firebaseConfig = {
          apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
          authDomain: "chsd-mis.firebaseapp.com",
          projectId: "chsd-mis",
          storageBucket: "chsd-mis.appspot.com",
          messagingSenderId: "694967679357",
          appId: "1:694967679357:web:65cffd50f13739f934f414",
          measurementId: "G-XBQTQFRLJ5"
      };
  
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
       
      // Function to Dynamically Append Buttons to the View Details Modal
function appendButtons(data) {
    const viewDetailsModalBtnGrp = document.getElementById('viewDetailsModalBtnGrp');
    viewDetailsModalBtnGrp.innerHTML = ''; // Clear existing buttons

    // First Row for View File Uploads Button
    const firstRow = document.createElement('div');
    firstRow.className = 'row mt-4';

    const col1 = document.createElement('div');
    col1.className = 'col-md-12 mb-2';
    const btn1 = document.createElement('button');
    btn1.className = 'btn btn-primary w-100';
    btn1.textContent = 'View File Uploads';
    btn1.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) {
            viewDetailsModal.hide(); // Hide View Details Modal
        }
        openViewUploadsModal(data); // Open View Uploads Modal
    });
    col1.appendChild(btn1);
    firstRow.appendChild(col1);

    // Second Row for Archive Button
    const secondRow = document.createElement('div');
    secondRow.className = 'row mt-2';

    const col2 = document.createElement('div');
    col2.className = 'col-md-12';
    const btn2 = document.createElement('button');
    btn2.className = 'btn btn-danger w-100 archive-permit-btn';
    btn2.textContent = 'Archive Permit';
    btn2.setAttribute('data-id', data.id);

    // Add event listener for archiving the building permit
    btn2.addEventListener('click', (event) => handleArchiveOccupancyPermit(event));

    col2.appendChild(btn2);
    secondRow.appendChild(col2);

    // Append Rows to Button Group
    viewDetailsModalBtnGrp.appendChild(firstRow);
    viewDetailsModalBtnGrp.appendChild(secondRow);
}


      // Function to show notification
      function showNotification(message, type) {
          console.log(`Showing notification: ${message}`);
          const notificationContainer = document.getElementById('notification-container');
          if (notificationContainer) {
              const notification = document.createElement('div');
              notification.className = `notification ${type}`;
              notification.textContent = message;
              notificationContainer.appendChild(notification);
          } else {
              console.error('Notification container not found.');
          }
      }
  
// Pagination Variables
let profilesPerPage = 50; // Profiles per page
let currentPage = 1; // Current page
let totalPages = 1; // Total pages

// Function to Load Occupancy Permits and Display in the Table
async function loadOccupancyProfiles() {
    try {
        const querySnapshot = await getDocs(collection(db, "OccupancyPermits")); // Updated collection name
        const occupancyPermitDiv = document.getElementById("profileTableBody");
        const prevPageBtn = document.getElementById("prevPageBtn");
        const nextPageBtn = document.getElementById("nextPageBtn");
        const pageInfo = document.getElementById("pageInfo");

        if (!occupancyPermitDiv) {
            console.error("occupancyPermitDiv not found in the DOM.");
            return;
        }

        occupancyPermitDiv.innerHTML = ""; // Clear existing rows

        // Fetch and Process Permits Data
        const permitsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const uniquePermitsData = Array.from(new Set(permitsData.map(a => a.id)))
            .map(id => permitsData.find(a => a.id === id));

        // Sort by createdAt (ascending)
        uniquePermitsData.sort((a, b) => {
            const aTime = a.createdAt?.seconds || 0;
            const bTime = b.createdAt?.seconds || 0;
            return aTime - bTime;
        });

        // Calculate Total Pages
        totalPages = Math.ceil(uniquePermitsData.length / profilesPerPage);

        // Determine Profiles for Current Page
        const start = (currentPage - 1) * profilesPerPage;
        const end = start + profilesPerPage;
        const currentProfiles = uniquePermitsData.slice(start, end);

        // Loop Through Profiles and Populate Table
        for (const data of currentProfiles) {
            const row = document.createElement("tr");

            // Fetch Representative User Data
            let representativeName = "";
            if (data.ownerUid) {
                try {
                    const userRef = doc(db, "users", data.ownerUid);
                    const userDoc = await getDoc(userRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        representativeName = `${userData.firstName} ${userData.lastName}`;
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                }
            }

            const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";

            row.innerHTML = `
                <td>${data.ownerName || "N/A"}</td>
                <td>${representativeName || "N/A"}</td>
                <td>${createdAt}</td>
                <td>${data.status || "N/A"}</td>
                <td>
                    <button class="btn btn-primary btn-sm view-details-btn" data-permit-id="${data.id}">View Details</button>
                </td>
            `;

            occupancyPermitDiv.appendChild(row);

            // Add Event Listener for "View Details" Button
            const viewDetailsBtn = row.querySelector(".view-details-btn");
            if (viewDetailsBtn) {
                viewDetailsBtn.addEventListener("click", () => {
                    openViewDetailsModal(data);
                });
            }
        }

        // Update Pagination Info
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

        // Enable/Disable Pagination Buttons
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;

    } catch (error) {
        console.error("Error loading profiles:", error);
        showNotification("Failed to load profiles.", "error");
    }
}

// Function to Control Progressive Status Selection
function updateStatusOptions(currentStatus) {
    const statusSelect = document.getElementById("statusSelect");

    const statusProgression = {
        "Pending": ["Pending", "Processing"],
        "Processing": ["Processing", "To Pay"],
        "To Pay": ["To Pay", "For Approval"],
        "For Approval": ["For Approval", "For Release"],
        "For Release": ["For Release", "Claimed"],
        "Claimed": ["Claimed"]
    };

    const validStatuses = statusProgression[currentStatus] || [];

    const options = statusSelect.querySelectorAll("option");
    options.forEach(option => {
        if (validStatuses.includes(option.value)) {
            option.style.display = "block"; // Show valid options
        } else {
            option.style.display = "none"; // Hide invalid options
        }
    });

    // Set the statusSelect to the currentStatus
    statusSelect.value = currentStatus;
}

// Function to Open the View Details Modal
function openViewDetailsModal(permitData) {
    // Populate Modal Fields
    const appointmentDate = permitData.appointmentDate ? new Date(permitData.appointmentDate.seconds * 1000).toLocaleString() : "N/A";
    document.getElementById("permitOwnerName").textContent = permitData.ownerName || "N/A";
    document.getElementById("issuedOnDate").textContent = permitData.issuedOn || "N/A";
    document.getElementById("appointmentDateSched").textContent = appointmentDate || "N/A";
    document.getElementById("permitIdDisplay").textContent = permitData.id || "N/A";
    document.getElementById("hiddenPermitId").value = permitData.id || "";

    // Update Status Options
    updateStatusOptions(permitData.status || "Pending");

    // Append Dynamic Buttons
    appendButtons(permitData);

    // Show the Modal
    const viewDetailsModal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
    viewDetailsModal.show();

    // Add Event Listener for the Save Button (Ensure it's not duplicated)
    const saveStatusBtn = document.getElementById("saveStatusBtn");
    saveStatusBtn.onclick = async () => {
        const newStatus = document.getElementById("statusSelect").value;
        try {
            // Update Status in Firestore
            await updateDoc(doc(db, 'OccupancyPermits', permitData.id), { status: newStatus });

            // Trigger Notification
            const message = `${permitData.ownerName}'s occupancy permit is now ${newStatus.toLowerCase()}`;
            showNotification(message, 'info');

            // Store Notification in Firestore
            await addDoc(collection(db, "notifications"), {
                userId: permitData.ownerUid,
                message: message,
                permitId: permitData.id,
                timestamp: serverTimestamp(),
                read: false
            });
            alert("status updated successfully");

            // Reload Profiles to Reflect Changes
            loadOccupancyProfiles();

            // Hide Modal
            viewDetailsModal.hide();

        } catch (error) {
            console.error("Error updating permit status:", error);
            showNotification("Failed to update permit status.", "error");
        }
    };
}

// Function to Archive an Occupancy Permit
async function handleArchiveOccupancyPermit(event) {
    event.preventDefault();

    const occupancyPermitId = event.target.getAttribute('data-id');

    if (!occupancyPermitId) {
        console.error("Occupancy Permit ID is null or undefined.");
        showNotification("Error: Occupancy Permit ID is missing.", "error");
        return;
    }

    const confirmed = confirm("Are you sure you want to archive this document?");
    
    if (!confirmed) {
        return;
    }

    try {
        const occupancyPermitRef = doc(db, "OccupancyPermits", occupancyPermitId); // Updated collection name
        const occupancyPermitSnapshot = await getDoc(occupancyPermitRef);

        if (occupancyPermitSnapshot.exists()) {
            const occupancyPermitData = occupancyPermitSnapshot.data();
            
            await setDoc(doc(db, "archivedOccupancyPermits", occupancyPermitId), occupancyPermitData);
await deleteDoc(occupancyPermitRef);

// Remove the row from the table
const tableBody = document.querySelector("#profileTableBody");  // Update the correct table body ID
const rowToRemove = tableBody.querySelector(`button[data-permit-id="${occupancyPermitId}"]`).closest('tr');
if (rowToRemove) rowToRemove.remove();


            showNotification("Document archived successfully!", "success");

            // Close the modal
            const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
            if (viewDetailsModal) {
                viewDetailsModal.hide(); // Hide View Details Modal
            }

        } else {
            showNotification("Document not found!", "error");
        }
    } catch (error) {
        console.error("Error archiving document: ", error);
        showNotification(`Failed to archive document: ${error.message}`, "error");
    }
}

let fileValidationStatus = {}; // For tracking validation status and comments

async function openViewUploadsModal(permitData) {
    try {
        console.log("Fetching uploaded files and validation status for occupancy permit:", permitData.id);

        // Fetch the occupancy permit document from Firestore
        const permitDocRef = doc(db, "OccupancyPermits", permitData.id);
        const permitSnapshot = await getDoc(permitDocRef);

        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const commentSummaryList = document.getElementById('commentSummaryList');
        uploadedFilesList.innerHTML = '';  // Clear existing files
        commentSummaryList.innerHTML = ''; // Clear previous comments

        if (!permitSnapshot.exists()) {
            console.warn("No occupancy permit document found.");
            const noFilesItem = document.createElement('li');
            noFilesItem.className = 'list-group-item';
            noFilesItem.textContent = 'No files uploaded.';
            uploadedFilesList.appendChild(noFilesItem);
        } else {
            const permitData = permitSnapshot.data();
            const { approvedBuildingPermitURL, approvedPlanURL, buildingPermitCompletionURL, sketchURL, structurePhotosURL, fileValidationStatus = {} } = permitData;

            if (!approvedBuildingPermitURL && !approvedPlanURL && !buildingPermitCompletionURL && !sketchURL && !structurePhotosURL) {
                const noFilesItem = document.createElement('li');
                noFilesItem.className = 'list-group-item';
                noFilesItem.textContent = 'No files uploaded.';
                uploadedFilesList.appendChild(noFilesItem);
            } else {
                const createFileItem = (fileLabel, fileURL, fileRowId) => {
                    const fileItem = document.createElement('li');
                    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    fileItem.dataset.rowid = fileRowId;  // Use fixed fileRowId

                    fileItem.innerHTML = `
                        <span>${fileLabel}</span>
                        <div>
                            <a href="${fileURL}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-eye"></i></a>
                            <button class="btn btn-sm btn-outline-success validation-btn" data-fileurl="${fileURL}" data-filelabel="${fileLabel}" data-rowid="${fileRowId}"><i class="fa-solid fa-list-check"></i></button>
                        </div>`;

                    const validationButton = fileItem.querySelector('.validation-btn');
                    validationButton.addEventListener('click', (event) => {
                        const fileRow = document.querySelector(`[data-rowid="${event.currentTarget.dataset.rowid}"]`);
                        openValidationModal(event.currentTarget.dataset.fileurl, event.currentTarget.dataset.filelabel, fileRow);
                    });

                    uploadedFilesList.appendChild(fileItem);
                };

                // Display each uploaded file with validation
                if (approvedBuildingPermitURL) createFileItem('Approved Building Permit', approvedBuildingPermitURL, 'approvedBuildingPermit');
                if (approvedPlanURL) createFileItem('Approved Plan', approvedPlanURL, 'approvedPlan');
                if (buildingPermitCompletionURL) createFileItem('Building Permit Completion', buildingPermitCompletionURL, 'buildingPermitCompletion');
                if (sketchURL) createFileItem('Sketch of Location', sketchURL, 'sketch');
                if (structurePhotosURL) createFileItem('Structure Photos', structurePhotosURL, 'structurePhotos');

                // Handle file validation status and comments
                for (const fileRowId in fileValidationStatus) {
                    const { status, comments } = fileValidationStatus[fileRowId];
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1); // Capitalize first letter
                    const commentPrefix = `${fileRowId.replace(/([A-Z])/g, ' $1').trim()} - ${statusText} - `;

                    const commentSummaryItem = document.createElement('li');
                    commentSummaryItem.className = 'list-group-item';
                    commentSummaryItem.dataset.commentid = fileRowId;
                    commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;

                    commentSummaryList.appendChild(commentSummaryItem);
                }
            }
        }

        const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
        viewUploadsModal.show();

    } catch (error) {
        console.error("Error fetching uploads:", error);
        alert("Failed to load uploaded files.");
    }
}

function openValidationModal(fileURL, fileLabel, fileRow) {
    const viewUploadsModal = bootstrap.Modal.getInstance(document.getElementById('viewUploadsModal'));
    viewUploadsModal.hide();

    const validationModalLabel = document.getElementById('validationModalLabel');
    const commentsInput = document.getElementById('validationComments');
    const previewContainer = document.getElementById('filePreviewContainer');
    const filePreview = document.getElementById('filePreview');

    validationModalLabel.textContent = `Validation for ${fileLabel}`;
    commentsInput.value = ''; // Clear previous comments

    previewContainer.style.display = 'none';
    filePreview.src = ''; // Clear previous preview

    if (fileURL.endsWith('.pdf')) {
        filePreview.src = fileURL; 
        previewContainer.style.display = 'block'; 
        filePreview.type = "application/pdf"; 
    } else {
        filePreview.src = fileURL;
        previewContainer.style.display = 'block';
        filePreview.type = "image"; 
    }

    const saveBtn = document.getElementById('saveValidationBtn');
    saveBtn.dataset.filerow = fileRow.dataset.rowid;

    saveBtn.removeEventListener('click', saveValidation);  
    saveBtn.addEventListener('click', saveValidation);      

    const validationModal = new bootstrap.Modal(document.getElementById('validationModal'));
    validationModal.show();
}

async function saveValidation() {
    const selectedOption = document.querySelector('input[name="validationOptions"]:checked');
    if (!selectedOption) {
        alert('Please select an option (approve/disapprove).');
        return;
    }

    const comments = document.getElementById('validationComments').value;
    const fileRowId = document.getElementById('saveValidationBtn').dataset.filerow;
    const fileRow = document.querySelector(`[data-rowid="${fileRowId}"]`);

    fileValidationStatus[fileRowId] = {
        status: selectedOption.value,
        comments: comments
    };

    const permitId = document.getElementById('hiddenPermitId').value;

    if (!permitId) {
        console.error('Permit ID is not available.');
        alert('Error: Permit data is missing.');
        return;
    }

    const permitDocRef = doc(db, "OccupancyPermits", permitId);
    try {
        await updateDoc(permitDocRef, {
            [`fileValidationStatus.${fileRowId}`]: {
                status: selectedOption.value,
                comments: comments
            }
        });
        console.log('Validation saved to Firestore');
    } catch (error) {
        console.error("Error saving validation to Firestore:", error);
        alert("Failed to save validation.");
    }

    const validationModal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
    validationModal.hide();

    const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
    viewUploadsModal.show();

    const commentSummaryList = document.getElementById('commentSummaryList');
    let existingComment = commentSummaryList.querySelector(`[data-commentid="${fileRowId}"]`);

    const statusText = selectedOption.value.charAt(0).toUpperCase() + selectedOption.value.slice(1); 
    const commentPrefix = `${fileRow.querySelector('span').textContent} - ${statusText} - `;

    if (existingComment) {
        existingComment.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
    } else {
        const commentSummaryItem = document.createElement('li');
        commentSummaryItem.className = 'list-group-item';
        commentSummaryItem.dataset.commentid = fileRowId; 
        commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
        commentSummaryList.appendChild(commentSummaryItem);
    }
}


// Function to preview file (image or PDF)
function previewFile(fileURL) {
    const previewContainer = document.getElementById('previewContainer');
    previewContainer.innerHTML = ''; // Clear any previous preview

    const fileExtension = fileURL.split('.').pop().toLowerCase();

    let previewElement;

    if (fileExtension === 'jpg' || fileExtension === 'jpeg' || fileExtension === 'png') {
        // Image preview
        previewElement = document.createElement('img');
        previewElement.src = fileURL;
        previewElement.className = 'img-fluid';
        previewElement.alt = 'File Preview';
    } else if (fileExtension === 'pdf') {
        // PDF preview
        previewElement = document.createElement('iframe');
        previewElement.src = fileURL;
        previewElement.className = 'w-100';
        previewElement.style.height = '600px'; // Adjust height as necessary
        previewElement.style.border = 'none';  // Clean border for better UX
    } else {
        // For unsupported file types
        previewElement = document.createElement('p');
        previewElement.textContent = 'Preview not available for this file type.';
    }

    previewContainer.appendChild(previewElement);

    // Scroll to preview section if preview is inside the modal
    previewContainer.scrollIntoView({ behavior: 'smooth' });
}



// Function to Search Permits by Owner or Representative Name
function searchOccupancyPermits() {
    const searchInput = document.getElementById("searchInput").value.toLowerCase();
    const tableRows = document.querySelectorAll("#occupancyPermitDiv tbody tr");

    let resultsFound = false; // To track if any results are found

    tableRows.forEach(row => {
        const ownerName = row.querySelector("td:nth-child(1)").textContent.toLowerCase().includes(searchInput);
        const representativeName = row.querySelector("td:nth-child(2)").textContent.toLowerCase().includes(searchInput);

        if (ownerName || representativeName) {
            row.style.display = ""; // Show matching row
            resultsFound = true;
        } else {
            row.style.display = "none"; // Hide non-matching row
        }
    });

    // If no results are found, show a message
    const noResultsMessage = document.getElementById("noResultsMessage");
    if (resultsFound) {
        noResultsMessage.style.display = "none";
    } else {
        noResultsMessage.style.display = "block";
        noResultsMessage.textContent = "No matching permits found.";
    }
}

// Pagination Event Listeners
document.getElementById("prevPageBtn").addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        loadOccupancyProfiles();
    }
});

document.getElementById("nextPageBtn").addEventListener("click", () => {
    if (currentPage < totalPages) {
        currentPage++;
        loadOccupancyProfiles();
    }
});

// Initial Load of Occupancy Profiles
loadOccupancyProfiles();



</script>



    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
