<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link rel="icon" href="/resources/pictures/chsd.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }
        @media (max-width: 768px) {
    .wide-modal {
        max-width: 100% !important;
    }
}
       /* Highlight effect */
       .highlight {
    background-color: #d3f9d8; /* light green */
    transition: background-color 1s ease-out; /* fades out smoothly */
}
.btn-upload {
        padding: 8px 16px;
        background-color: #4CAF50 !important;
        color: white !important;
        border: none;
        cursor: pointer !important;
    }
    .btn-upload:hover {
        background-color: #45a049;
    }
    .file-item {
        display: flex;
        align-items: center;
    }
    .file-name {
        margin-right: 10px;
    }
    .btn-delete {
        color: red;
        cursor: pointer;
    }
       /* General print styles */
@media print {
  /* Hide everything except the content we want to print */
  body * {
    visibility: hidden;
  }

  /* Make the printable area visible */
  .printArea, .printArea * {
    visibility: visible;
  }

  /* Remove custom margins and allow browser defaults */
  #printOrderContent {
    position: static; /* Let the content position normally */
    width: auto;      /* Allow width to auto-adjust */
    margin: 0 !important; /* Remove any custom margin */
    padding: 0 !important; /* Remove any custom padding */
  }
  /* Ensure the printed content appears at the top */
  .printArea {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    margin: 0 auto;
    padding: 20px;
  }

  /* Adjust for A4 paper */
  @page {
    size: A4;
    margin: 10mm;
  }
}

#watermark {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Ensures it stays behind content */
        opacity: 1; /* Adjust for desired transparency */
        font-size: 3rem;
        color: gray;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none; /* Make sure it's non-interactive */
        transform: rotate(-45deg);
    }

    /* Spread watermark text across the page */
    #watermark span {
        display: inline-block;
        white-space: nowrap;
        margin: 2rem; /* Spacing between each watermark text */
        opacity: 0.2;
    }

.confirm-label {
            padding: 0.2rem 0.5rem;
            background-color: #007bff;
            color: #fff;
            border-radius: 5px;
            font-size: 0.9rem;
            margin-left: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .confirm-label:hover {
            background-color: #0056b3;
        }


   
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
               
               
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html" class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building Permit</a></li>
              <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html" class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy Permit</a></li>
              
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html" class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCLogs.html" class="text-decoration-none"><i class="fa-solid fa-envelope"></i> Notifications</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html" class="text-decoration-none"><i class="fa-solid fa-gear"></i> Settings</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html" class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCReports.html" class="text-decoration-none"><i class="fa-solid fa-chart-simple"></i> Reports</a></li>
             
              <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
           <!--Navigation Bar-->
<nav class="navigationBar navbar navbar-expand-lg bg-light">
  <div class="container-fluid">
      <!-- Mobile View -->
      <div class="d-flex justify-content-between d-md-none d-block">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
              <h5 class="mb-0 fs-5">CHSD</h5>
          </a>
          <button class="btn px-1 py-0 open-btn">
              <i class="fa-solid fa-bars-staggered"></i>
          </button>
      </div>

      <!-- Desktop View -->
      <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
              <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
          </a>
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <!-- Additional nav items go here -->
          </ul>
      </div>
  </div>
</nav>
           
            <div class="contentContainer">
               
                <!-- Bootstrap Table -->
            <div class="container">
                
                <h5>Profile</h5>
                <div class="row mt-4">
                    <div class="col">
                        <a class="btn btn-dark text-white" data-bs-toggle="modal" data-bs-target="#occupancyUploadModal"><i class="fa-solid fa-plus"></i> Add Profile</a>
                       
                    </div>
                <div class="d-flex justify-content-end mb-3">
                  <input type="text" class="form-control search-bar" placeholder="Search">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                  </div>
                </div>

                <h4 class="text-center">Certificate of Occupancy</h4>
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Owner</th>
                      <th>Representative</th>
                      <th>Application Type</th>
                      <th>Submitted at</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="profileTableBody">
                    <!-- Rows will be populated by Firebase data -->
                </tbody>
                
                      
                </table>
                  <!-- Pagination Controls -->
                  <div class="pagination-controls text-center">
                    <button id="prevPageBtn" class="btn btn-primary" disabled>Previous</button>
                    <span id="pageInfo"></span>
                    <button id="nextPageBtn" class="btn btn-primary">Next</button>
                </div>


             </div>
             <!-- End of Bootstrap Table -->
            </div>
        </div>
    </div>

    <!-- Certificate of Occupancy Upload Modal -->
    <div class="modal fade" id="occupancyUploadModal" tabindex="-1" aria-labelledby="occupancyUploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="occupancyUploadModalLabel">Certificate of Occupancy Application</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                   
                    <div class="row">
                        <div class="col-md-4">
                            <label for="applicantMethod">Applicant Type:</label>
                            <select class="form-control" id="applicantMethod" disabled>
                                <option value="walk-in">Walk-in</option>
                                <option value="online">Online Application</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <label for="buildingPermitOption">Building Permit Option</label>
                            
                            <!-- Toggle Buttons for Selection -->
                            <div class="btn-group d-flex" role="group">
                                <input type="radio" class="btn-check" name="permitOption" id="typeOption" autocomplete="off" checked>
                                <label class="btn btn-outline-secondary flex-fill" for="typeOption">Type Permit No.</label>
                    
                                <input type="radio" class="btn-check" name="permitOption" id="selectOption" autocomplete="off">
                                <label class="btn btn-outline-secondary flex-fill" for="selectOption">Select Permit</label>
                            </div>
                    
                            <!-- Dynamic Instructional Text -->
                            <small id="instructionText" class="form-text text-muted mt-2">
                                Please type the Building Permit Number.
                            </small>
                    
                            <!-- Input for Typing Permit Number -->
                            <div id="permitInputContainer" class="mt-2">
                                <input type="text" id="buildingPermitNo" class="form-control" placeholder="ex. 2024-XXXX">
                            </div>
                    
                            <!-- Button for Selecting Permit from Modal -->
                            <div id="permitSelectContainer" class="mt-2 d-none">
                                <button type="button" id="openPermitModalBtn" class="btn btn-outline-secondary w-100">Select Permit from List</button>
                            </div>
                    
                            <!-- Readonly Display of Selected Permit Number -->
                            <div id="selectedPermitDisplay" class="mt-2 d-none">
                                <input type="text" id="selectedPermitNumber" class="form-control" readonly>
                                <small class="form-text text-muted">Selected Permit Number</small>
                            </div>
                        </div>
                    </div>
                    
                    
                    <div class="row">
                        <label for="ownerName">Owner/Applicant Name:</label>
                        <input type="text" class="form-control" id="ownerName" placeholder="Enter Name">
                    </div>
    
                    <div class="row">
                        <div class="col-md-8">
                            <label for="ownerAddress">Address of Owner</label>
                            <input type="text" class="form-control" id="ownerAddress">
                        </div>
                            
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <label for="projectLocation">Location of the Project</label>
                        <input type="text" class="form-control" id="projectLocation">
                        </div>
                        
                     </div>
                      <div class="container">
                    <div class="form-group">
                        <label for="NOUnits">Number of Units<span class="required-asterisk">*</span></label>
                        <select class="form-control" id="NOUnits">
                            <option value="1" selected>1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div id="unitFieldsContainer"></div>
                    <div class="row">
                        <div class="col">
                            <label for="TotalFloorArea">Total Floor Area</label>
                            <input type="number" class="form-control" id="TotalFloorArea" readonly>
                        </div>
                        <div class="col">
                            <label for="TotalEstimatedCost">Total Estimated Cost</label>
                            <input type="number" class="form-control" id="TotalEstimatedCost" disabled>
                        </div>
                    </div>
                    </div>
                    <!-- Content -->
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Requirements</th>
                                <th>File</th>
                                <th><button id="checkAllButton" class="btn btn-primary btn-sm">Check All</button></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Building Permit Completion</td>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="buildingPermitCompletionCheckbox" name="requirements" value="Building Permit Completion">
                                        <label class="form-check-label confirm-label" for="buildingPermitCompletionCheckbox">Confirm</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Approved Building Permit</td>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="approvedBuildingPermitCheckbox" name="requirements" value="Approved Building Permit">
                                        <label class="form-check-label confirm-label" for="approvedBuildingPermitCheckbox">Confirm</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Approved Plan</td>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="approvedPlanCheckbox" name="requirements" value="Approved Plan">
                                        <label class="form-check-label confirm-label" for="approvedPlanCheckbox">Confirm</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Structure Photos</td>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="structurePhotosCheckbox" name="requirements" value="Structure Photos">
                                        <label class="form-check-label confirm-label" for="structurePhotosCheckbox">Confirm</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Sketch</td>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sketchCheckbox" name="requirements" value="Sketch">
                                        <label class="form-check-label confirm-label" for="sketchCheckbox">Confirm</label>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        
                        
                        
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="submitAppointment">Submit</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="permitSelectionModal" tabindex="-1" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Building Permit</h5>
                    <button type="button" id="closePermitModalBtn" class="btn-close"></button>
                </div>
                <div class="modal-body">
                    <ul id="permitList" class="list-group">
                        <!-- Building permits will be loaded here dynamically -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" id="closeModalFooterBtn" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>



<!--Generate Occupancy Permit-->
<div class="modal fade" id="occupancyPermitModal" tabindex="-1" aria-labelledby="occupancyPermitModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Occupancy Permit</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="printArea" id="printHSDContent">
            <div class="d-flex justify-content-center align-items-center mb-2 mt-2">
              <!-- Left Logo -->
              <img src="/resources/pictures/calambaLogo.png" alt="Calamba Logo" style="height: 50px; width: 50px; margin-left: auto;">
              <!-- Center Title -->
              <div class="text-center" style="margin: 0 10px;">
                <h5 class="mb-0">CITY HOUSING AND SETTLEMENTS DEPARTMENT</h5>
                <p class="mb-0">City Government of Calamba</p>
              </div>
              <!-- Right Logo -->
              <img src="/resources/pictures/chsd.png" alt="CHSD Logo" style="height: 50px; width: 50px; margin-right: auto;">
            </div>
            <br>
  
            <h4 class="text-center">CERTIFICATE OF BUILDING COMPLETION</h4>
            <p>This is to certify that the construction of the residential building covered by <strong>Building Permit No. <span id="aaaBuildingPermitNo"></span></strong> under BP220 issued on <strong><span id="aaaIssuedOn"></span></strong> has been constructed and completed under our inspection and supervision pursuant to Section 306 and the National Building Code (PD 1096). Its IRR conforms to the architectural well-being, structural stability, electrical, plumbing, interior design, and fire-protective properties in accordance with the plans and specifications submitted and on file with the City Housing and Settlements Department.</p>
  
            <div class="container">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Name of Owner: </strong><span id="certOwnerName"></span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Address of Owner: </strong><span id="certOwnerAddress"></span></p>
                </div>
              </div>
              <div class="row">
                <div class="col-md-8">
                  <p><strong>Location Of The Project: </strong><span id="certProjectLocation"></span></p>
                </div>
              </div>
       
  
              <hr>
              <p class="text-center">Full-Time Inspector And Supervisor of Construction Works (Representing the Owner)</p>
  
              <hr>
              <div class="row">
                <div class="col-md-6 signature-box">
                  <br><br>
                  <p>Architect or Civil Engineer</p>
                  <p><i>(Signed and Sealed Over Printed Name)</i></p>
                </div>
                <div class="col-md-6 signature-box">
                  <br><br>
                  <p>Architect or Civil Engineer</p>
                  <p><i>(Signed and Sealed Over Printed Name)</i></p>
                </div>
              </div>
  
              <div class="row">
                <div class="col-md-3 info-box">PRC No.:</div>
                <div class="col-md-3 info-box">Validity:</div>
                <div class="col-md-3 info-box">PRC No.:</div>
                <div class="col-md-3 info-box">Validity:</div>
              </div>
  
              <div class="row">
                <div class="col-md-3 info-box">PTR No.:</div>
                <div class="col-md-3 info-box">Date Issued:</div>
                <div class="col-md-3 info-box">PTR No.:</div>
                <div class="col-md-3 info-box">Date Issued:</div>
              </div>
  
              <br>
              <p>HSD Form No.3</p>
  
              <h4 class="text-center">CERTIFICATE OF OCCUPANCY under BP220</h4>
              <div class="row">
                <div class="col-md-4">
                  <p><strong>CO BP220 No.: </strong><span id="certBuildingPermitNo"></span></p>
                </div>
              
              </div>
              <div id="unitsDataContainer"></div> <!-- Units Container -->
  
              <p><i>This certificate of occupancy is issued pursuant to Section 1(b) of Executive Order No. 71, Series of 1993.</i></p>
              <div class="row">
                  <div class="col">
               
                    <div class="form-group">
                        <!-- Issued By Field -->
                        <label for="issuedBy"><strong>Issued By:</strong></label>
                        <input type="text" id="issuedBy" class="form-control" placeholder="Enter name of the person issuing the document">
                    
                        <!-- Position Field (Styled to look like a label but still inputable) -->
                        <label for="position" class="mt-3" style="font-size: 0.9rem; color: gray;">Position</label>
                        <input type="text" id="position" class="form-control" placeholder="Enter position of the issuer" style="font-size: 0.9rem; color: gray;">
                    </div>
                    
                  </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="printHSDForm">Print</button>
        </div>
      </div>
    </div>
  </div>
  

  <!-- Order of Payment Modal -->
<div class="modal fade" id="orderOfPaymentModal" tabindex="-1" aria-labelledby="OrderOfPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="OrderOfPaymentModalLabel">
                    <i class="fa-solid fa-file-invoice"></i> Occupancy Permit - Order of Payment
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <div class="printArea" id="printOrderContent">
                    <div class="row mb-4">
                        <div class="d-flex justify-content-center align-items-center mb-2 mt-2">
                            <!-- Left Logo -->
                            <img src="/resources/pictures/calambaLogo.png" alt="Calamba Logo" style="height: 50px; width: 50px; margin-left: auto;">
                            <!-- Center Title -->
                            <div class="text-center" style="margin: 0 10px;">
                                <h5 class="mb-0">CITY HOUSING AND SETTLEMENTS DEPARTMENT</h5>
                                <p class="mb-0">City Government of Calamba</p>
                            </div>
                            <!-- Right Logo -->
                            <img src="/resources/pictures/chsd.png" alt="CHSD Logo" style="height: 50px; width: 50px; margin-right: auto;">
                        </div>
                    </div>
                    <!-- Order of Payment Form -->
                    <div class="container">
                        <h4 class="text-center">ORDER OF PAYMENT</h4>
                        <p class="text-center"><i>Payee: Treasurer/Cashier-City Treasury Office, City of Calamba</i></p>

                        <!-- Owner/Applicant Input -->
                        <div class="row mb-3">
                            <label for="OPOwnerApplicant">Owner/Applicant:</label>
                            <input type="text" class="form-control" id="paymentOwnerName" readonly>
                        </div>

                        <!-- Location Input -->
                        <div class="row mb-3">
                            <label for="OPLocation">Location</label>
                            <input type="text" class="form-control" id="paymentLocation" readonly>
                        </div>

                        <!-- Floor Area Input -->
                        <div class="row mb-3">
                            <label for="floorArea">Total Floor Area (sqm)</label>
                            <input type="number" class="form-control" id="paymentTotalFloorArea" readonly>
                        </div>

                        <!-- Fee Breakdown -->
                      
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="totalFee">Total Fee</label>
                                <input type="number" class="form-control" id="paymentFee" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-secondary" id="exportOrderButton" disabled>
                    <i class="fa-solid fa-file-excel"></i> Export
                </button>
                <button type="button" class="btn btn-primary" id="printOrderOfPayment">
                    <i class="fa-solid fa-print"></i> Print Order of Payment
                </button>
            </div>
        </div>
    </div>
</div>


     <!-- View Uploads Modal -->
<div class="modal fade" id="viewUploadsModal" tabindex="-1" aria-labelledby="viewUploadsModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewUploadsModalLabel">Uploaded Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Uploaded Files List -->
                    <div class="col-lg-12">
                        <ul id="uploadedFilesList" class="list-group">
                            <!-- Dynamically append files here -->
                        </ul>
                    </div>
                </div>
                <!-- Comment Summary Section -->
                <div id="commentSummaryContainer" class="mt-3">
                    <h6>File Validation Comments</h6>
                    <ul id="commentSummaryList" class="list-group">
                        <!-- Comments will be summarized here -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="filePreviewContainer" style="display: none;"> <!-- Hidden by default -->
                    <iframe id="filePreview" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                </div>
                <div class="mt-3">
                    <label>Validation:</label><br>
                    <input type="radio" name="validationOptions" value="approved" id="approvedOption">
                    <label for="approvedOption">Approve</label><br>
                    <input type="radio" name="validationOptions" value="disapproved" id="disapprovedOption">
                    <label for="disapprovedOption">Disapprove</label>
                </div>
                <div class="mt-3">
                    <label for="validationComments">Comments:</label>
                    <textarea class="form-control" id="validationComments" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveValidationBtn">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


    <!-- Occupancy View Details Modal -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header bg-light text-black">
                <h5 class="modal-title" id="viewDetailsModalLabel">
                    <span id="displayOwnerName"></span>'s Occupancy Permit Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Owner and Verification Section -->
                <div class="row mb-4 g-3">
                    <!-- Owner Details -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-header p-3 border rounded bg-primary text-white">
                                <strong>Owner Information</strong>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <p><strong>Owner Name:</strong> <span id="permitOwnerName" class="text-primary"></span></p>
                                    <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                                    <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                                    <p><strong>Applicant Type:</strong> <span id="applicantType"></span></p>
                                    <p><strong>Building Permit No.:</strong> <span id="permitIdDisplay" class="text-danger"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Applicant Verification -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <strong>Applicant Verification</strong>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Valid ID and Status -->
                                    <div class="col-md-6 d-flex align-items-center mb-3">
                                        <p class="mb-0 me-2"><strong>Valid ID:</strong></p>
                                        <button id="viewValidIdBtn" class="btn btn-sm btn-primary">Validate</button>
                                        <span id="ownerValidId" style="display: none;"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Verification Status:</strong> 
                                            <span id="approvalStatus" class="text-muted">Pending</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Permit Status and Progress Section -->
                <div class="row mb-4 g-3">
                    <!-- Permit Status -->
                    <div class="col-md-6">
                        <div class="p-3 border rounded bg-light">
                            <label for="statusSelect" class="form-label fw-bold">Permit Status</label>
                            <select id="statusSelect" class="form-select">
                                <option value="Pending">Pending</option>
                                <option value="Processing">Processing</option>
                                <option value="To Pay">To Pay</option>
                                <option value="For Approval">For Approval</option>
                                <option value="For Release">For Release</option>
                                <option value="Claimed">Claimed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Progress -->
                    <div class="col-md-6">
                        <div class="p-3 border rounded bg-light">
                            <label class="form-label fw-bold">Progress</label>
                            <div class="progress" style="height: 20px;">
                                <div id="statusProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                    role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    Step 1 of 6
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Buttons -->
                <div id="viewDetailsModalBtnGrp" class="d-flex flex-wrap gap-2 justify-content-between mt-4"></div>

                <!-- Hidden Input Field -->
                <input type="hidden" id="hiddenPermitId">
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer bg-light">
                <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

 <!-- Separate Modal for Viewing the Valid ID -->
 <div class="modal fade" id="validIdModal" tabindex="-1" aria-labelledby="validIdModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validIdModalLabel">View Valid ID</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalValidIdImage" src="" alt="Valid ID" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <button id="approveBtn" class="btn btn-success">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button id="disapproveBtn" class="btn btn-danger">
                    <i class="fas fa-times"></i> Disapprove
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>





    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const checkAllButton = document.getElementById('checkAllButton');
            const checkboxes = document.querySelectorAll('input[name="requirements"]');
    
            if (checkAllButton) {
                checkAllButton.addEventListener('click', () => {
                    const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = !allChecked;
                    });
                });
            }
        });
    </script>
    <script>
        const instructionText = document.getElementById("instructionText");
    document.getElementById("typeOption").addEventListener("change", function() {
        document.getElementById("permitInputContainer").classList.remove("d-none");
        document.getElementById("permitSelectContainer").classList.add("d-none");
        instructionText.textContent = "Please type the Building Permit Number.";
    });
    
    document.getElementById("selectOption").addEventListener("change", function() {
        document.getElementById("permitInputContainer").classList.add("d-none");
        document.getElementById("permitSelectContainer").classList.remove("d-none");
        instructionText.textContent = "Please select a Building Permit from the list.";
    });
    
    </script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const printHSDButton = document.getElementById("printHSDForm");
    if (printHSDButton) {
        printHSDButton.addEventListener("click", function () {
            const printContent = document.querySelector("#printHSDContent").cloneNode(true);

            // Get the building permit number from the form
            const buildingPermitNo = document.getElementById("certBuildingPermitNo").textContent.trim();

            // Get the 'Issued By' value from the input field
            const issuedByInput = document.getElementById("issuedBy");
            const issuedByValue = issuedByInput ? issuedByInput.value.trim() : "N/A";

            // Get the 'Position' value from the input field
            const positionInput = document.getElementById("position");
            const positionValue = positionInput ? positionInput.value.trim() : "N/A";

            // Replace the 'Issued By' input with its value and place it under the label
            const issuedByField = printContent.querySelector("#issuedBy");
            if (issuedByField) {
                const issuedByLabel = issuedByField.previousElementSibling; // The "Issued By" label
                if (issuedByLabel) {
                    const nameElement = document.createElement("div");
                    nameElement.textContent = issuedByValue;
                    nameElement.style.fontWeight = "bold";
                    issuedByLabel.insertAdjacentElement("afterend", nameElement);
                }
                issuedByField.remove(); // Remove the input field
            }

            // Hide the word "Position" and add the position value directly
            const positionField = printContent.querySelector("#position");
            if (positionField) {
                const positionLabel = positionField.previousElementSibling; // The "Position" label
                if (positionLabel) {
                    positionLabel.style.display = "none"; // Hide the label
                }
                const positionElement = document.createElement("div");
                positionElement.textContent = positionValue;
                positionElement.style.fontStyle = "italic";
                positionElement.style.color = "gray";
                positionField.insertAdjacentElement("afterend", positionElement);
                positionField.remove(); // Remove the input field
            }

            // Add watermark
            const watermark = document.createElement("div");
            watermark.id = "watermark";

            // Repeat the watermark text across the page
            for (let i = 0; i < 10; i++) {
                const watermarkText = document.createElement("span");
                watermarkText.textContent = buildingPermitNo;
                watermark.appendChild(watermarkText);
            }

            printContent.appendChild(watermark);

            // Clone the page content for printing
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent.outerHTML;

            // Trigger print
            window.print();

            // Restore original content
            document.body.innerHTML = originalContent;
            window.location.reload();
        });
    }

    const printOrderButton = document.getElementById("printOrderOfPayment");
    if (printOrderButton) {
        printOrderButton.addEventListener("click", function () {
            const printContent = document.querySelector("#printOrderContent").cloneNode(true);

            const inputs = printContent.querySelectorAll("input");
            inputs.forEach(function (input) {
                const value = input.value || "";
                const span = document.createElement("span");
                span.textContent = value;
                span.style.fontWeight = "bold";
                input.replaceWith(span);
            });

            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent.outerHTML;

            window.print();

            document.body.innerHTML = originalContent;
            window.location.reload();
        });
    }
});

</script>

<script>
    const NOUnitsInput = document.getElementById("NOUnits");
    const unitFieldsContainer = document.getElementById("unitFieldsContainer");
    const totalFloorAreaInput = document.getElementById("TotalFloorArea");
    const totalEstimatedCostInput = document.getElementById("TotalEstimatedCost");

    // Initialize with 1 unit field displayed by default
    function initializeUnitFields() {
        const initialNumUnits = parseInt(NOUnitsInput.value) || 1;
        generateUnitFields(initialNumUnits);
        updateTotals();
    }

    // Function to generate fields based on selected number of units
    function generateUnitFields(numUnits) {
        // Clear any existing unit fields
        unitFieldsContainer.innerHTML = "";

        for (let i = 1; i <= numUnits; i++) {
            const unitDiv = document.createElement("div");
            unitDiv.className = "row mb-3";

            unitDiv.innerHTML = `
                <div class="col-6">
                    <label for="Address${i}">Address for Unit ${i}</label>
                   <input type="text" class="form-control" id="Address${i}" placeholder="House Number, Block, Lot, Phase Number, Street" required>

                </div>
                <div class="col-3">
                    <label for="NOStorey${i}">Number of Storeys for Unit ${i}</label>
                    <input type="number" class="form-control" id="NOStorey${i}" placeholder="Number of Storeys">
                </div>
                <div class="col-3">
                    <label for="UnitFloorArea${i}">Floor Area for Unit ${i}</label>
                    <input type="number" class="form-control unit-floor-area" id="UnitFloorArea${i}" placeholder="Floor Area" required>
                </div>
            `;
            unitFieldsContainer.appendChild(unitDiv);
        }
    }

    // Listen for changes to the Number of Units field
    NOUnitsInput.addEventListener("change", function () {
        const numUnits = parseInt(NOUnitsInput.value) || 0;
        generateUnitFields(numUnits);
        updateTotals();
    });

    // Function to calculate totals
    function updateTotals() {
        const floorAreaInputs = document.querySelectorAll(".unit-floor-area");
        let totalFloorArea = 0;

        // Sum all floor area inputs
        floorAreaInputs.forEach(input => {
            const floorArea = parseFloat(input.value) || 0;
            totalFloorArea += floorArea;
        });

        // Set total floor area and total estimated cost
        totalFloorAreaInput.value = totalFloorArea;
        totalEstimatedCostInput.value = totalFloorArea * 10000;
    }

    // Listen for changes to floor area inputs
    unitFieldsContainer.addEventListener("input", function (event) {
        if (event.target.classList.contains("unit-floor-area")) {
            updateTotals();
        }
    });

    // Initialize form with 1 unit field
    initializeUnitFields();
</script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module" src="/Database/firebase.js"></script>
    <script type="module">
      // Import Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc, getDocs, setDoc, deleteDoc, limit, orderBy, onSnapshot, query, where, startAfter, getDoc} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

      // Firebase configuration
      const firebaseConfig = {
          apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
          authDomain: "chsd-mis.firebaseapp.com",
          projectId: "chsd-mis",
          storageBucket: "chsd-mis.appspot.com",
          messagingSenderId: "694967679357",
          appId: "1:694967679357:web:65cffd50f13739f934f414",
          measurementId: "G-XBQTQFRLJ5"
      };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);
  
      document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('submitAppointment').addEventListener('click', async (event) => {
        event.preventDefault();

        const submitButton = document.getElementById('submitAppointment');
        submitButton.disabled = true;

        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.display = 'flex';
        }

        // Collect input values
        const ownerName = document.getElementById("ownerName").value.trim();
        const ownerAddress = document.getElementById("ownerAddress").value.trim();
        const projectLocation = document.getElementById("projectLocation").value.trim();
        const buildingPermitNo = document.getElementById("buildingPermitNo").value.trim();
        const applicantMethod = document.getElementById("applicationMethod").value.trim();

        // Collect dynamic fields (Units Data)
        const numUnits = parseInt(document.getElementById("NOUnits").value) || 0;
        const unitsData = [];
        for (let i = 1; i <= numUnits; i++) {
    const address = document.getElementById(`Address${i}`)?.value.trim();
    const NOStorey = document.getElementById(`NOStorey${i}`)?.value.trim();
    const floorArea = document.getElementById(`UnitFloorArea${i}`)?.value.trim();

    // Validate all fields
    if (!address || !NOStorey || !floorArea) {
        alert(`Please fill out all fields for Unit ${i}.`);
        return;
    }

    unitsData.push({
        address,
        NOStorey: parseInt(NOStorey),
        floorArea: parseFloat(floorArea),
    });
}

        // Calculate total floor area
        const totalFloorArea = unitsData.reduce((sum, unit) => sum + unit.floorArea, 0);

        // Required fields validation
        const requiredFields = [
            { field: ownerName, name: 'Owner Name' },
            { field: ownerAddress, name: 'Owner Address' },
            { field: projectLocation, name: 'Project Location' },
            { field: buildingPermitNo, name: 'Building Permit Number' },
        ];

        for (const { field, name } of requiredFields) {
            if (!field) {
                alert(`Please fill out the ${name} field.`);
                submitButton.disabled = false;
                loadingScreen.style.display = 'none';
                return;
            }
        }

        // Checklist validation
        const checklistItems = [
            { id: 'buildingPermitCompletionCheckbox', name: 'Building Permit Completion' },
            { id: 'approvedBuildingPermitCheckbox', name: 'Approved Building Permit' },
            { id: 'approvedPlanCheckbox', name: 'Approved Plan' },
            { id: 'structurePhotosCheckbox', name: 'Structure Photos' },
            { id: 'sketchCheckbox', name: 'Sketch' },
        ];

        const checkedItems = {};
        for (const item of checklistItems) {
            const checkbox = document.getElementById(item.id);
            if (!checkbox || !checkbox.checked) {
                alert(`Please confirm the ${item.name} checklist item.`);
                submitButton.disabled = false;
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
                return;
            }
            checkedItems[item.name] = true;
        }

        try {
            // Ensure the user is authenticated
            const user = await new Promise((resolve, reject) => {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        resolve(user);
                    } else {
                        reject(new Error("No user is authenticated."));
                    }
                });
            });

            const userId = user.uid;

            // Prepare permit data for Firestore
            const permitData = {
                ownerUid: userId,
                ownerName,
                projectLocation,
                ownerAddress,
                totalFloorArea,
                numUnits,
                unitsData, // Include dynamic fields
                buildingPermitNo,
                applicantMethod,
                checklist: checkedItems,
                status: 'Pending',
                createdAt: serverTimestamp(),
            };

            // Add a new document to Firestore
            await addDoc(collection(db, "OccupancyPermits"), permitData);

            // Success feedback
            Swal.fire({
                title: "Success!",
                text: "Application Submitted",
                icon: "success"
            }).then(() => {
                // Reload the page
                window.location.reload();
            });
        } catch (error) {
            console.error("Error during submission:", error);
            alert(`Error submitting application: ${error.message}`);
        } finally {
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            submitButton.disabled = false;
        }
    });
});

       
// Function to Dynamically Append Buttons to the View Details Modal for Occupancy Permit
function appendButtons(data) {
    const viewDetailsModalBtnGrp = document.getElementById('viewDetailsModalBtnGrp');
    viewDetailsModalBtnGrp.innerHTML = ''; // Clear existing content

    // Container for the buttons
    const container = document.createElement('div');
    container.className = 'container-fluid';

    // Row 1: View File Uploads and Generate Occupancy Permit (Side by Side)
    const firstRow = document.createElement('div');
    firstRow.className = 'row mt-4';

    // Column 1: View File Uploads
    const col1 = document.createElement('div');
    col1.className = 'col-md-6 mb-2'; // Half-width column
    const btn1 = document.createElement('button');
    btn1.className = 'btn btn-primary w-100';
    btn1.textContent = 'View File Uploads';
    if (data.applicationMethod === 'walk-in') {
        btn1.disabled = true; // Disable the button for walk-in applications
        btn1.title = 'File uploads are not available for walk-in applications'; // Add tooltip
    } else {
        btn1.addEventListener('click', () => {
            const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
            if (viewDetailsModal) viewDetailsModal.hide();
            openViewUploadsModal(data);
        });
    }
    col1.appendChild(btn1);

    // Column 2: Generate Occupancy Permit
    const col2 = document.createElement('div');
    col2.className = 'col-md-6 mb-2'; // Half-width column
    const btn2 = document.createElement('button');
    btn2.className = 'btn btn-primary w-100';
    btn2.textContent = 'Generate Occupancy Permit';
    btn2.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide();
        openGenerateOccupancyPermitModal(data);
    });
    col2.appendChild(btn2);

    firstRow.appendChild(col1);
    firstRow.appendChild(col2);

    // Row 2: Generate Order of Payment and Archive Permit (Side by Side)
    const secondRow = document.createElement('div');
    secondRow.className = 'row mt-2';

    // Column 1: Generate Order of Payment
    const col3 = document.createElement('div');
    col3.className = 'col-md-6 mb-2'; // Half-width column
    const btn3 = document.createElement('button');
    btn3.className = 'btn btn-success w-100';
    btn3.textContent = 'Generate Order of Payment';
    btn3.addEventListener('click', () => {
        generateOrderOfPayment(data);
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide();

        const orderOfPaymentModal = new bootstrap.Modal(document.getElementById('orderOfPaymentModal'));
        orderOfPaymentModal.show();

        document.getElementById('orderOfPaymentModal').addEventListener('hidden.bs.modal', function () {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
        });
    });
    col3.appendChild(btn3);

    // Column 2: Archive Permit
    const col4 = document.createElement('div');
    col4.className = 'col-md-6 mb-2'; // Half-width column
    const btn4 = document.createElement('button');
    btn4.className = 'btn btn-danger w-100';
    btn4.textContent = 'Archive Permit';
    btn4.setAttribute('data-id', data.id);
    btn4.addEventListener('click', (event) => handleArchiveOccupancyPermit(event));
    col4.appendChild(btn4);

    secondRow.appendChild(col3);
    secondRow.appendChild(col4);

    // Append Rows to the Container
    container.appendChild(firstRow);
    container.appendChild(secondRow);

    // Add Container to Button Group
    viewDetailsModalBtnGrp.appendChild(container);
}

// Function to Open the Occupancy Permit Modal with Dynamic Data
async function openGenerateOccupancyPermitModal(permitData) {
    try {
        console.log("Occupancy Permit Data received:", permitData); // Log permitData to ensure it's not empty

        // Fetch the data from the OccupancyPermits collection based on the permitId
        const occupancyFormData = await getDoc(doc(db, "OccupancyPermits", permitData.id));

        if (!occupancyFormData.exists()) {
            console.error("Occupancy Permit not found!");
            alert("Occupancy Permit data is missing!");
            return;
        }

        const data = occupancyFormData.data();
        console.log("Occupancy Permit Data retrieved:", data); // Log the fetched data to ensure it's being retrieved correctly

        // Populate Occupancy Permit Modal Fields
        document.getElementById('certOwnerName').textContent = data.ownerName || "N/A";
        document.getElementById('certOwnerAddress').textContent = data.ownerAddress || "N/A";
        document.getElementById('certProjectLocation').textContent = data.projectLocation || "N/A";
        document.getElementById('certBuildingPermitNo').textContent = data.buildingPermitNo || "N/A";
        document.getElementById("aaaBuildingPermitNo").textContent = data.buildingPermitNo || "N/A";

     

     // Populate unit data
const unitsContainer = document.getElementById('unitsDataContainer');
unitsContainer.innerHTML = ''; // Clear existing unit data
data.unitsData.forEach((unit, index) => {
    const unitDiv = document.createElement('div');
    unitDiv.classList.add('unit-details', 'row'); // Add Bootstrap row class
    unitDiv.innerHTML = `
        <div class="col-md-12">
            <p><strong>Unit ${index + 1}:</strong></p>
        </div>
        <div class="col-md-6">
            <p><strong>Block Number:</strong> ${unit.blockNumber || "N/A"}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Lot Number:</strong> ${unit.lotNumber || "N/A"}</p>
        </div>
        <div class="col-md-6">
            <p><strong>No. of Storeys:</strong> ${unit.NOStorey || "N/A"}</p>
        </div>
        <div class="col-md-6">
            <p><strong>Floor Area:</strong> ${unit.floorArea || "N/A"} sqm</p>
        </div>
    `;
    unitsContainer.appendChild(unitDiv);
});


        // Format Created At date for display
        const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000) : null;
        if (createdAt && !isNaN(createdAt)) {
            const formattedDate = createdAt.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            document.getElementById("aaaIssuedOn").textContent = formattedDate;
    
        } else {
            document.getElementById("aaaIssuedOn").textContent = "Date not available";
        }

        console.log("Occupancy Permit fields populated");

        // Show the Occupancy Permit Modal
        const occupancyPermitModal = new bootstrap.Modal(document.getElementById('occupancyPermitModal'));
        occupancyPermitModal.show();
    } catch (error) {
        console.error("Error opening Occupancy Permit modal:", error);
        alert("Failed to load Occupancy Permit data.");
    }
}


async function generateOrderOfPayment(data) {
    try {
        console.log("Generating Order of Payment for:", data); // Debugging

        // Fetch the Occupancy Permit data from Firestore
        const occupancyDoc = await getDoc(doc(db, "OccupancyPermits", data.id));
        if (!occupancyDoc.exists()) {
            console.error("Occupancy Permit not found!");
            Swal.fire('Error', 'Occupancy Permit data is missing!', 'error');
            return;
        }

        const permitData = occupancyDoc.data();

        // Extract relevant fields
        const ownerName = permitData.ownerName || "N/A";
        const location = permitData.projectLocation || "N/A";
        const totalFloorArea = parseFloat(permitData.totalFloorArea) || 0;

        if (totalFloorArea <= 0) {
            Swal.fire('Invalid Data', 'Total Floor Area must be a positive value.', 'warning');
            return;
        }

        // Compute fees based on Citizen's Charter
        const estimatedCost = totalFloorArea * 10000; // Cost in Php
        let fee;

        if (estimatedCost <= 150000) {
            fee = 100.00;
        } else if (estimatedCost <= 400000) {
            fee = 200.00;
        } else if (estimatedCost <= 850000) {
            fee = 400.00;
        } else if (estimatedCost <= 1200000) {
            fee = 800.00;
        } else {
            // Areas exceeding Php 1,200,000
            fee = 800.00 + Math.ceil((estimatedCost - 1200000) / 1000000) * 800.00;
        }

        // Populate modal fields
        const modal = document.getElementById('orderOfPaymentModal');
        modal.querySelector('#paymentOwnerName').value = ownerName;
        modal.querySelector('#paymentLocation').value = location;
        modal.querySelector('#paymentTotalFloorArea').value = totalFloorArea.toFixed(2);
        modal.querySelector('#paymentFee').value = `${fee.toFixed(2)}`;

        console.log(`Order of Payment computed: Owner = ${ownerName}, Location = ${location}, Fee = Php ${fee.toFixed(2)}`);

        // Show the Order of Payment Modal
        const orderOfPaymentModal = new bootstrap.Modal(modal);
        orderOfPaymentModal.show();

    } catch (error) {
        console.error("Error generating Order of Payment:", error);
        Swal.fire('Error', 'Failed to generate Order of Payment. Please try again.', 'error');
    }
}


// Attach 'input' event listeners to fields to trigger automatic calculation
const inputs = ['paymentOwnerName', 'paymentLocation', 'paymentTotalFloorArea', 'paymentFee'];
inputs.forEach(id => {
    document.getElementById(id).addEventListener('input', () => {
        generateOrderOfPayment({}); // Pass an empty object if no Data is available
 
    });
});








      // Function to show notification
      function showNotification(message, type) {
          console.log(`Showing notification: ${message}`);
          const notificationContainer = document.getElementById('notification-container');
          if (notificationContainer) {
              const notification = document.createElement('div');
              notification.className = `notification ${type}`;
              notification.textContent = message;
              notificationContainer.appendChild(notification);
          } else {
              console.error('Notification container not found.');
          }
      }
  
// Pagination Variables
let profilesPerPage = 50; // Profiles per page
let currentPage = 1; // Current page
let lastVisible = null; // For pagination

async function loadOccupancyProfiles() {
    const loadingScreen = document.getElementById("loading-screen"); // Reference to loading screen element

    try {
        // Show the loading screen
        if (loadingScreen) loadingScreen.style.display = "flex";

        const occupancyPermitDiv = document.getElementById("profileTableBody");
        const prevPageBtn = document.getElementById("prevPageBtn");
        const nextPageBtn = document.getElementById("nextPageBtn");
        const pageInfo = document.getElementById("pageInfo");

        if (!occupancyPermitDiv) {
            console.error("occupancyPermitDiv not found in the DOM.");
            return;
        }

        occupancyPermitDiv.innerHTML = ""; // Clear existing rows

        // Firestore Query
        let queryRef = collection(db, "OccupancyPermits");
        queryRef = query(queryRef, orderBy("createdAt", "asc"), limit(profilesPerPage));

        if (lastVisible && currentPage > 1) {
            queryRef = query(queryRef, startAfter(lastVisible));
        }

        const querySnapshot = await getDocs(queryRef);
        if (querySnapshot.docs.length > 0) {
            lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1]; // Save last document for pagination
        }

        const permitsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Fetch Related User Data in Batch
        const userUids = permitsData.map(data => data.ownerUid).filter(uid => uid);
        const userDocsPromises = userUids.map(uid => getDoc(doc(db, "users", uid)));
        const userDocs = await Promise.all(userDocsPromises);

        const userDataMap = {};
        userDocs.forEach(userDoc => {
            if (userDoc.exists()) {
                const data = userDoc.data();
                userDataMap[userDoc.id] = `${data.firstName} ${data.lastName}`;
            }
        });

        // Populate Table
        const fragment = document.createDocumentFragment();
        permitsData.forEach(data => {
            const row = document.createElement("tr");

            const representativeName = userDataMap[data.ownerUid] || "N/A";
            const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";
            const applicationMethodMap = {
    online: "Online Application",
    "walk-in": "Walk-in"
}; 
            // Set the 'Process' button based on status
            const isPending = data.status === "Pending";
            const applicationMethod = applicationMethodMap[data.applicantMethod] || "N/A";
            row.innerHTML = `
                <td>${data.ownerName || "N/A"}</td>
                <td>${representativeName}</td>
                <td>${applicationMethod}</td>
                <td>${createdAt}</td>
                <td>${data.status || "N/A"}</td>
                <td>
                    <button class="btn btn-primary btn-sm view-details-btn" data-permit-id="${data.id}">${isPending ? "Process" : "View Details"}</button>
                </td>
            `;

            const viewDetailsBtn = row.querySelector(".view-details-btn");
            if (viewDetailsBtn) {
                viewDetailsBtn.addEventListener("click", async () => {
                    if (isPending) {
                        // If the permit is pending, trigger the status change
                        const confirmProcessing = await Swal.fire({
                            title: "Do you want to process this permit?",
                            icon: "question",
                            showCancelButton: true,
                            confirmButtonText: "Yes",
                            cancelButtonText: "No"
                        });

                        if (confirmProcessing.isConfirmed) {
                            // Update the status to "Processing" and reload the page
                            await updateDoc(doc(db, "OccupancyPermits", data.id), { status: "Processing" });
                            showNotification("Permit is now processing.", "success");
                            loadOccupancyProfiles(); // Reload the page to reflect status change
                        }
                    } else {
                        // If not pending, simply open the details modal
                        openViewDetailsModal(data);
                    }
                });
            }

            fragment.appendChild(row);
        });

        occupancyPermitDiv.appendChild(fragment);

        // Update Pagination Info
        pageInfo.textContent = `Page ${currentPage}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = querySnapshot.docs.length < profilesPerPage;

        // Add Pagination Event Listeners
        prevPageBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                loadOccupancyProfiles();
            }
        };

        nextPageBtn.onclick = () => {
            if (querySnapshot.docs.length === profilesPerPage) {
                currentPage++;
                loadOccupancyProfiles();
            }
        };

    } catch (error) {
        console.error("Error loading profiles:", error);
        showNotification("Failed to load profiles.", "error");
    } finally {
        // Hide the loading screen
        if (loadingScreen) loadingScreen.style.display = "none";
    }
}


 // Function to control progressive status selection and update the progress bar
 function updateStatusOptions(currentStatus) {
    const statusSelect = document.getElementById("statusSelect");
    const progressBar = document.getElementById("statusProgressBar");

    // Define status progression steps and valid transitions
    const statusProgression = {
        "Pending": ["Pending", "Processing"],
        "Processing": ["Processing", "To Pay"],
        "To Pay": ["To Pay", "For Approval"],
        "For Approval": ["For Approval", "For Release"],
        "For Release": ["For Release", "Claimed"],
        "Claimed": ["Claimed"]
    };

    const progressSteps = {
        "Pending": { step: 1, width: 0 },
        "Processing": { step: 2, width: 20 },
        "To Pay": { step: 3, width: 40 },
        "For Approval": { step: 4, width: 60 },
        "For Release": { step: 5, width: 80 },
        "Claimed": { step: 6, width: 100 }
    };

    // Get valid statuses for the current status
    const validStatuses = statusProgression[currentStatus] || [];

    // Show or hide options based on the valid statuses
    const options = statusSelect.querySelectorAll("option");
    options.forEach(option => {
        option.style.display = validStatuses.includes(option.value) ? "block" : "none";
    });

    // Set the statusSelect value to the currentStatus
    statusSelect.value = currentStatus;

    // Update progress bar based on currentStatus
    const { step, width } = progressSteps[currentStatus] || { step: 1, width: 0 };
    progressBar.style.width = `${width}%`;
    progressBar.setAttribute('aria-valuenow', width);
    progressBar.textContent = `Step ${step} of 6`;
}

// Function to Open the View Details Modal
function openViewDetailsModal(permitData) {
    // Populate Modal Fields
    const appointmentDate = permitData.appointmentDate ? new Date(permitData.appointmentDate.seconds * 1000).toLocaleString() : "N/A";
    document.getElementById("permitOwnerName").textContent = permitData.ownerName || "N/A";
    document.getElementById("appointmentDateSched").textContent = appointmentDate || "N/A";
    document.getElementById("permitIdDisplay").textContent = permitData.buildingPermitNo || "N/A";
    document.getElementById("hiddenPermitId").value = permitData.id || "";
    document.getElementById("displayOwnerName").textContent = permitData.ownerName;
    const applicationMethodMapM = {
  online: "Online Application",
  "walk-in": "Walk-in",
};

document.getElementById('applicantType').textContent = applicationMethodMapM[permitData.applicantMethod];
const createdAt = permitData.createdAt;

if (createdAt) {
    // Convert the seconds to milliseconds and create a new Date object
    const date = new Date(createdAt.seconds * 1000);

    // Format the date into a readable string (e.g., 'MM/DD/YYYY HH:mm:ss')
    const formattedDate = date.toLocaleString(); // Adjust locale if needed

    // Set the formatted date as text content
    document.getElementById("issuedOnDate").textContent = formattedDate;
}
    
     // Handle valid ID button
     const validId = permitData.validId || null;
    const ownerValidIdElement = document.getElementById("ownerValidId");
    const viewValidIdBtn = document.getElementById("viewValidIdBtn");

    if (validId) {
        ownerValidIdElement.textContent = validId; // Store the URL in the hidden span
        viewValidIdBtn.style.display = "inline-block"; // Show the "View" button
    } else {
        ownerValidIdElement.textContent = ""; // Clear the span
        viewValidIdBtn.style.display = "none"; // Hide the button if no valid ID
    }
    // Update Status Options
    updateStatusOptions(permitData.status || "Pending");

    // Append Dynamic Buttons
    appendButtons(permitData);

    // Show the Modal
    const viewDetailsModal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
    viewDetailsModal.show();

    // Add Event Listener for the Save Button (Ensure it's not duplicated)
    const saveStatusBtn = document.getElementById("saveStatusBtn");
    saveStatusBtn.onclick = async () => {
        const newStatus = document.getElementById("statusSelect").value;
        try {
            // Update Status in Firestore
            await updateDoc(doc(db, 'OccupancyPermits', permitData.id), { status: newStatus });

            // Trigger Notification
            const message = `${permitData.ownerName}'s occupancy permit is now ${newStatus.toLowerCase()}`;
            showNotification(message, 'info');

            // Store Notification in Firestore
            await addDoc(collection(db, "notifications"), {
                userId: permitData.ownerUid,
                message: message,
                permitId: permitData.id,
                timestamp: serverTimestamp(),
                read: false
            });
            Swal.fire({
  title: "Success!",
  text: "Status Updated Successfully!",
  icon: "success"
});

            // Reload Profiles to Reflect Changes
            loadOccupancyProfiles();

            // Hide Modal
            viewDetailsModal.hide();

        } catch (error) {
            console.error("Error updating permit status:", error);
            showNotification("Failed to update permit status.", "error");
        }
    };

    
    // Handle Valid ID Modal Interaction
    viewValidIdBtn.addEventListener("click", () => {
        viewDetailsModal.hide(); // Hide View Details Modal
        validIdModal.show(); // Show Valid ID Modal

        // Add listener for validation completion
        validIdModalElement.addEventListener(
            "hidden.bs.modal",
            () => {
                viewDetailsModal.show(); // Reopen View Details Modal when Valid ID Modal is closed
            },
            { once: true } // Ensure listener is added only once
        );
    });

}

// Approval/Disapproval Logic
document.addEventListener("DOMContentLoaded", () => {
    const approveBtn = document.getElementById("approveBtn");
    const disapproveBtn = document.getElementById("disapproveBtn");
    const approvalStatusElement = document.getElementById("approvalStatus");
    const validIdModalElement = document.getElementById("validIdModal");
    const validIdModal = new bootstrap.Modal(validIdModalElement);

    approveBtn.addEventListener("click", () => updateApprovalStatus(true));
    disapproveBtn.addEventListener("click", () => updateApprovalStatus(false));

    async function updateApprovalStatus(isApproved) {
        const permitId = document.getElementById("hiddenPermitId").value; // Get the permit ID from the hidden input

        try {
            const permitDocRef = doc(db, "ElectricalCert", permitId); // Reference to the permit document
            const permitDoc = await getDoc(permitDocRef);

            // Check if 'isApproved' field exists; if not, add it
            if (!permitDoc.exists() || !permitDoc.data().hasOwnProperty("isApproved")) {
                await setDoc(permitDocRef, { isApproved }, { merge: true });
            } else {
                await updateDoc(permitDocRef, { isApproved });
            }

            // Update the UI
            approvalStatusElement.textContent = isApproved ? "Approved" : "Not Approved";
            approvalStatusElement.classList.toggle("text-success", isApproved);
            approvalStatusElement.classList.toggle("text-danger", !isApproved);

           // Show feedback using SweetAlert
await Swal.fire({
    icon: isApproved ? "success" : "error",
    title: isApproved ? "Approved!" : "Disapproved!",
    text: isApproved
        ? "The ID has been successfully verified."
        : "The ID verification has been disapproved.",
    confirmButtonText: "OK",
});


            // Close Valid ID Modal
            validIdModal.hide();
        } catch (error) {
            console.error("Error updating approval status:", error);
            Swal.fire("Error", "Failed to update permit status.", "error");
        }
    }
});

document.addEventListener("DOMContentLoaded", () => {
    const viewValidIdBtn = document.getElementById("viewValidIdBtn");
    const ownerValidIdElement = document.getElementById("ownerValidId");

    // Bind event listener for the "View" button
    viewValidIdBtn.addEventListener("click", () => {
        const validIdUrl = ownerValidIdElement.textContent; // Retrieve the URL from the hidden span
        const modalImage = document.getElementById("modalValidIdImage");

        if (validIdUrl) {
            modalImage.src = validIdUrl; // Set the modal image source
            const validIdModal = new bootstrap.Modal(document.getElementById("validIdModal"));
            validIdModal.show(); // Show the modal
        } else {
            alert("No valid ID available."); // Handle cases where no ID exists
        }
    });
});


// Function to Archive an Occupancy Permit
async function handleArchiveOccupancyPermit(event) {
    event.preventDefault();

    const occupancyPermitId = event.target.getAttribute('data-id');

    if (!occupancyPermitId) {
        console.error("Occupancy Permit ID is null or undefined.");
        showNotification("Error: Occupancy Permit ID is missing.", "error");
        return;
    }

    // SweetAlert for confirmation
    Swal.fire({
        title: "Are you sure?",
        text: "",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, archive it!"
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const occupancyPermitRef = doc(db, "OccupancyPermits", occupancyPermitId);
                const occupancyPermitSnapshot = await getDoc(occupancyPermitRef);

                if (occupancyPermitSnapshot.exists()) {
                    const occupancyPermitData = occupancyPermitSnapshot.data();
                    
                    // Archive document
                    await setDoc(doc(db, "archivedOccupancyPermits", occupancyPermitId), occupancyPermitData);
                    await deleteDoc(occupancyPermitRef);

                    // Remove the row from the table
                    const tableBody = document.querySelector("#profileTableBody"); // Update the correct table body ID if needed
                    const rowToRemove = tableBody.querySelector(`button[data-permit-id="${occupancyPermitId}"]`).closest('tr');
                    if (rowToRemove) rowToRemove.remove();

                    showNotification("Document archived successfully!", "success");

                    // Close the modal
                    const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
                    if (viewDetailsModal) {
                        viewDetailsModal.hide(); // Hide View Details Modal
                    }

                    // Success feedback
                    Swal.fire({
                        title: "Archived!",
                        text: "Your file has been archived successfully.",
                        icon: "success"
                    });

                } else {
                    showNotification("Document not found!", "error");
                }
            } catch (error) {
                console.error("Error archiving document: ", error);
                showNotification(`Failed to archive document: ${error.message}`, "error");
            }
        }
    });
}


let fileValidationStatus = {}; // For tracking validation status and comments

async function openViewUploadsModal(permitData) {
    try {
        console.log("Fetching uploaded files and validation status for occupancy permit:", permitData.id);

        // Fetch the occupancy permit document from Firestore
        const permitDocRef = doc(db, "OccupancyPermits", permitData.id);
        const permitSnapshot = await getDoc(permitDocRef);

        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const commentSummaryList = document.getElementById('commentSummaryList');
        uploadedFilesList.innerHTML = '';  // Clear existing files
        commentSummaryList.innerHTML = ''; // Clear previous comments

        if (!permitSnapshot.exists()) {
            console.warn("No occupancy permit document found.");
            const noFilesItem = document.createElement('li');
            noFilesItem.className = 'list-group-item';
            noFilesItem.textContent = 'No files uploaded.';
            uploadedFilesList.appendChild(noFilesItem);
        } else {
            const permitData = permitSnapshot.data();
            const { approvedBuildingPermitURL, approvedPlanURL, buildingPermitCompletionURL, sketchURL, structurePhotosURL, fileValidationStatus = {} } = permitData;

            if (!approvedBuildingPermitURL && !approvedPlanURL && !buildingPermitCompletionURL && !sketchURL && !structurePhotosURL) {
                const noFilesItem = document.createElement('li');
                noFilesItem.className = 'list-group-item';
                noFilesItem.textContent = 'No files uploaded.';
                uploadedFilesList.appendChild(noFilesItem);
            } else {
                const createFileItem = (fileLabel, fileURL, fileRowId) => {
                    const fileItem = document.createElement('li');
                    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    fileItem.dataset.rowid = fileRowId;  // Use fixed fileRowId

                    fileItem.innerHTML = `
                        <span>${fileLabel}</span>
                        <div>
                            <a href="${fileURL}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-eye"></i></a>
                            <button class="btn btn-sm btn-outline-success validation-btn" data-fileurl="${fileURL}" data-filelabel="${fileLabel}" data-rowid="${fileRowId}"><i class="fa-solid fa-list-check"></i></button>
                        </div>`;

                    const validationButton = fileItem.querySelector('.validation-btn');
                    validationButton.addEventListener('click', (event) => {
                        const fileRow = document.querySelector(`[data-rowid="${event.currentTarget.dataset.rowid}"]`);
                        openValidationModal(event.currentTarget.dataset.fileurl, event.currentTarget.dataset.filelabel, fileRow);
                    });

                    uploadedFilesList.appendChild(fileItem);
                };

                // Display each uploaded file with validation
                if (approvedBuildingPermitURL) createFileItem('Approved Building Permit', approvedBuildingPermitURL, 'approvedBuildingPermit');
                if (approvedPlanURL) createFileItem('Approved Plan', approvedPlanURL, 'approvedPlan');
                if (buildingPermitCompletionURL) createFileItem('Building Permit Completion', buildingPermitCompletionURL, 'buildingPermitCompletion');
                if (sketchURL) createFileItem('Sketch of Location', sketchURL, 'sketch');
                if (structurePhotosURL) createFileItem('Structure Photos', structurePhotosURL, 'structurePhotos');

                // Handle file validation status and comments
                for (const fileRowId in fileValidationStatus) {
                    const { status, comments } = fileValidationStatus[fileRowId];
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1); // Capitalize first letter
                    const commentPrefix = `${fileRowId.replace(/([A-Z])/g, ' $1').trim()} - ${statusText} - `;

                    const commentSummaryItem = document.createElement('li');
                    commentSummaryItem.className = 'list-group-item';
                    commentSummaryItem.dataset.commentid = fileRowId;
                    commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;

                    commentSummaryList.appendChild(commentSummaryItem);
                }
            }
        }

        const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
        viewUploadsModal.show();

    } catch (error) {
        console.error("Error fetching uploads:", error);
        alert("Failed to load uploaded files.");
    }
}

function openValidationModal(fileURL, fileLabel, fileRow) {
    const viewUploadsModal = bootstrap.Modal.getInstance(document.getElementById('viewUploadsModal'));
    viewUploadsModal.hide();

    const validationModalLabel = document.getElementById('validationModalLabel');
    const commentsInput = document.getElementById('validationComments');
    const previewContainer = document.getElementById('filePreviewContainer');
    const filePreview = document.getElementById('filePreview');

    validationModalLabel.textContent = `Validation for ${fileLabel}`;
    commentsInput.value = ''; // Clear previous comments

    previewContainer.style.display = 'none';
    filePreview.src = ''; // Clear previous preview

    if (fileURL.endsWith('.pdf')) {
        filePreview.src = fileURL; 
        previewContainer.style.display = 'block'; 
        filePreview.type = "application/pdf"; 
    } else {
        filePreview.src = fileURL;
        previewContainer.style.display = 'block';
        filePreview.type = "image"; 
    }

    const saveBtn = document.getElementById('saveValidationBtn');
    saveBtn.dataset.filerow = fileRow.dataset.rowid;

    saveBtn.removeEventListener('click', saveValidation);  
    saveBtn.addEventListener('click', saveValidation);      

    const validationModal = new bootstrap.Modal(document.getElementById('validationModal'));
    validationModal.show();
}

async function saveValidation() {
    const selectedOption = document.querySelector('input[name="validationOptions"]:checked');
    if (!selectedOption) {
        alert('Please select an option (approve/disapprove).');
        return;
    }

    const comments = document.getElementById('validationComments').value;
    const fileRowId = document.getElementById('saveValidationBtn').dataset.filerow;
    const fileRow = document.querySelector(`[data-rowid="${fileRowId}"]`);

    fileValidationStatus[fileRowId] = {
        status: selectedOption.value,
        comments: comments
    };

    const permitId = document.getElementById('hiddenPermitId').value;

    if (!permitId) {
        console.error('Permit ID is not available.');
        alert('Error: Permit data is missing.');
        return;
    }

    const permitDocRef = doc(db, "OccupancyPermits", permitId);
    try {
        await updateDoc(permitDocRef, {
            [`fileValidationStatus.${fileRowId}`]: {
                status: selectedOption.value,
                comments: comments
            }
        });
        console.log('Validation saved to Firestore');
        Swal.fire({
  title: "Validated!",
  text: "File Validated Successfully!",
  icon: "success"
});
    } catch (error) {
        console.error("Error saving validation to Firestore:", error);
        alert("Failed to save validation.");
    }

    const validationModal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
    validationModal.hide();

    const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
    viewUploadsModal.show();

    const commentSummaryList = document.getElementById('commentSummaryList');
    let existingComment = commentSummaryList.querySelector(`[data-commentid="${fileRowId}"]`);

    const statusText = selectedOption.value.charAt(0).toUpperCase() + selectedOption.value.slice(1); 
    const commentPrefix = `${fileRow.querySelector('span').textContent} - ${statusText} - `;

    if (existingComment) {
        existingComment.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
    } else {
        const commentSummaryItem = document.createElement('li');
        commentSummaryItem.className = 'list-group-item';
        commentSummaryItem.dataset.commentid = fileRowId; 
        commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
        commentSummaryList.appendChild(commentSummaryItem);
    }
}


// Function to preview file (image or PDF)
function previewFile(fileURL) {
    const previewContainer = document.getElementById('previewContainer');
    previewContainer.innerHTML = ''; // Clear any previous preview

    const fileExtension = fileURL.split('.').pop().toLowerCase();

    let previewElement;

    if (fileExtension === 'jpg' || fileExtension === 'jpeg' || fileExtension === 'png') {
        // Image preview
        previewElement = document.createElement('img');
        previewElement.src = fileURL;
        previewElement.className = 'img-fluid';
        previewElement.alt = 'File Preview';
    } else if (fileExtension === 'pdf') {
        // PDF preview
        previewElement = document.createElement('iframe');
        previewElement.src = fileURL;
        previewElement.className = 'w-100';
        previewElement.style.height = '600px'; // Adjust height as necessary
        previewElement.style.border = 'none';  // Clean border for better UX
    } else {
        // For unsupported file types
        previewElement = document.createElement('p');
        previewElement.textContent = 'Preview not available for this file type.';
    }

    previewContainer.appendChild(previewElement);

    // Scroll to preview section if preview is inside the modal
    previewContainer.scrollIntoView({ behavior: 'smooth' });
}



// Function to Search Permits by Owner or Representative Name
function searchOccupancyPermits() {
    const searchInput = document.getElementById("searchInput").value.toLowerCase();
    const tableRows = document.querySelectorAll("#occupancyPermitDiv tbody tr");

    let resultsFound = false; // To track if any results are found

    tableRows.forEach(row => {
        const ownerName = row.querySelector("td:nth-child(1)").textContent.toLowerCase().includes(searchInput);
        const representativeName = row.querySelector("td:nth-child(2)").textContent.toLowerCase().includes(searchInput);

        if (ownerName || representativeName) {
            row.style.display = ""; // Show matching row
            resultsFound = true;
        } else {
            row.style.display = "none"; // Hide non-matching row
        }
    });

    // If no results are found, show a message
    const noResultsMessage = document.getElementById("noResultsMessage");
    if (resultsFound) {
        noResultsMessage.style.display = "none";
    } else {
        noResultsMessage.style.display = "block";
        noResultsMessage.textContent = "No matching permits found.";
    }
}

// Pagination Event Listeners
document.getElementById("prevPageBtn").addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        loadOccupancyProfiles();
    }
});

document.getElementById("nextPageBtn").addEventListener("click", () => {
    if (currentPage < totalPages) {
        currentPage++;
        loadOccupancyProfiles();
    }
});

// Initial Load of Occupancy Profiles
loadOccupancyProfiles();

document.addEventListener('DOMContentLoaded', () => {
    // Initialize and add event listeners for buttons
    document.getElementById('openPermitModalBtn').addEventListener('click', openPermitSelectionModal);
    document.getElementById('closePermitModalBtn').addEventListener('click', closePermitSelectionModal);
    document.getElementById('closeModalFooterBtn').addEventListener('click', closePermitSelectionModal);

    async function openPermitSelectionModal() {
        const modal = document.getElementById('permitSelectionModal');
        const permitList = document.getElementById('permitList');
        permitList.innerHTML = ''; // Clear previous entries

        // Show a loading indicator (optional)
        permitList.innerHTML = '<li>Loading permits...</li>';

        try {
            // Fetch all building permits
            const buildingPermitsRef = collection(db, "buildingPermits");
            const querySnapshot = await getDocs(buildingPermitsRef);

            permitList.innerHTML = ''; // Clear loading text

            querySnapshot.forEach((doc) => {
                const permit = doc.data();
                const listItem = document.createElement('li');
                listItem.textContent = `${permit.buildingPermitNo} - ${permit.ownerName || 'Unknown Owner'}`;
                listItem.className = "list-group-item list-group-item-action";
                listItem.addEventListener('click', () => selectPermit(doc.id)); // Pass document ID
                permitList.appendChild(listItem);
            });

        } catch (error) {
            console.error("Error fetching permits:", error);
            permitList.innerHTML = '<li>Error loading permits</li>';
        }

        modal.style.display = 'block'; // Show the modal
    }

    function closePermitSelectionModal() {
        document.getElementById('permitSelectionModal').style.display = 'none';
    }

    async function selectPermit(permitId) {
        try {
            const permitRef = doc(db, "buildingPermits", permitId);
            const permitSnap = await getDoc(permitRef);

            if (permitSnap.exists()) {
                const permitData = permitSnap.data();

                // Autofill static form fields
                autofillField('buildingPermitNo', permitData.buildingPermitNo);
                autofillField('ownerName', permitData.ownerName);
                autofillField('ownerAddress', permitData.addressTelNo);
                autofillField('projectLocation', permitData.projectLocation);
                autofillField('totalFloorArea', permitData.TotalFloorArea);
                autofillField('NOStorey', permitData.NOStorey);

                // Autofill dropdown for NOUnits
                const noUnitsDropdown = document.getElementById("NOUnitsDropdown");
                if (noUnitsDropdown) {
                    noUnitsDropdown.value = permitData.NOUnits || ''; // Set the dropdown value
                    noUnitsDropdown.classList.add('highlight'); // Add highlight class
                    setTimeout(() => noUnitsDropdown.classList.remove('highlight'), 2000); // Remove highlight
                    noUnitsDropdown.dispatchEvent(new Event('change')); // Trigger change event if needed
                }

                // Handle dynamic unit data
                const unitFieldsContainer = document.getElementById("unitFieldsContainer");
                const unitsData = permitData.unitsData || []; // Ensure unitsData exists

                // Generate dynamic fields based on unitsData
                unitFieldsContainer.innerHTML = ""; // Clear existing dynamic fields
                unitsData.forEach((unit, index) => {
    const unitIndex = index + 1;

    const unitDiv = document.createElement("div");
    unitDiv.className = "row mb-3";

    unitDiv.innerHTML = `
        <div class="col-6">
            <label for="Address${unitIndex}">Address for Unit ${unitIndex}</label>
            <input type="text" class="form-control" id="Address${unitIndex}" 
                   placeholder="House Number, Block, Lot, Phase Number, Street" required>
        </div>
        <div class="col-3">
            <label for="NOStorey${unitIndex}">Number of Storeys for Unit ${unitIndex}</label>
            <input type="number" class="form-control" id="NOStorey${unitIndex}" 
                   placeholder="Number of Storeys" required>
        </div>
        <div class="col-3">
            <label for="UnitFloorArea${unitIndex}">Floor Area for Unit ${unitIndex}</label>
            <input type="number" class="form-control unit-floor-area" id="UnitFloorArea${unitIndex}" 
                   placeholder="Floor Area" required>
        </div>
    `;

    unitFieldsContainer.appendChild(unitDiv);

    // Autofill and highlight dynamic fields
    autofillField(`Address${unitIndex}`, unit.address);
    autofillField(`NOStorey${unitIndex}`, unit.NOStorey);
    autofillField(`UnitFloorArea${unitIndex}`, unit.floorArea);
});

                // Update totals after autofill
                updateTotals();

                // Show SweetAlert2 notification after autofilling all fields
                Swal.fire({
                    title: 'Fields Populated',
                    text: 'All relevant fields have been successfully populated.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

                closePermitSelectionModal();
            } else {
                console.error("No such document!");
                Swal.fire({
                    title: 'Error',
                    text: 'Permit data not found!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        } catch (error) {
            console.error("Error fetching permit details:", error);
            Swal.fire({
                title: 'Error',
                text: 'An error occurred while fetching permit details.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    }

    // Function to autofill a field and apply highlight effect
    function autofillField(fieldId, value) {
        const field = document.getElementById(fieldId);
        if (field) {
            field.value = value || ''; // Set field value
            field.classList.add('highlight'); // Add highlight class

            // Remove highlight effect after 2 seconds
            setTimeout(() => {
                field.classList.remove('highlight');
            }, 2000);
        }
    }

    
});


</script>

<script>
    function uploadFile(input, file = null) {
        const selectedFile = file || input.files[0];  // Use the file from input or passed as an argument

        if (selectedFile) {
            const maxSizeMB = 5;  // Set max file size (in MB)
            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];  // Allowed file types

            // Validate file type
            if (!allowedTypes.includes(selectedFile.type)) {
                alert('Invalid file type. Please upload a JPG, PNG, or PDF file.');
                input.value = ''; // Clear the input
                return;
            }

            // Validate file size
            const maxSizeBytes = maxSizeMB * 1024 * 1024;  // Convert MB to bytes
            if (selectedFile.size > maxSizeBytes) {
                alert(`File is too large. Please upload a file smaller than ${maxSizeMB}MB.`);
                input.value = '';  // Clear the input
                return;
            }

            // FileReader to read file details
            const reader = new FileReader();
            reader.onload = function () {
                const fileName = selectedFile.name;
                const fileSize = formatBytes(selectedFile.size);
                const fileItem = `
                    <div class="file-item">
                        <span class="file-name">${fileName} (${fileSize})</span>
                        <span class="btn-delete" onclick="deleteFile(this, '${input.id}')">Delete</span>
                    </div>`;

                // Display file information
                const fileColumn = input.closest('.file-column'); // Get the closest file-column
                if (fileColumn) {
                    fileColumn.insertAdjacentHTML('beforeend', fileItem);  // Append the file item
                } else {
                    console.error('File column not found.');
                }
            };
            reader.readAsDataURL(selectedFile);
        }
    }

    function deleteFile(deleteBtn, inputId) {
        const fileItem = deleteBtn.closest('.file-item');
        if (fileItem) {
            fileItem.remove();  // Remove the displayed file item
            document.getElementById(inputId).value = '';  // Clear the input for re-upload
        }
    }

    // Format file size to a readable string
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Drag-over handler to show drag-and-drop action
    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.dataTransfer.dropEffect = 'copy';  // Change the cursor to indicate a drop is possible
    }

    // Drop handler to process the dropped files
    function handleDrop(event) {
        event.preventDefault();
        event.stopPropagation();

        const files = event.dataTransfer.files;  // Get the dropped files
        const inputFileElement = event.target.closest('.upload-btn-wrapper').querySelector('.file-input');  // Find the corresponding file input

        if (inputFileElement && files.length > 0) {
            limitFiles(inputFileElement, 5, files);  // Limit the number of dropped files and handle each
        }
    }

    // Limit the number of files
    function limitFiles(input, maxFiles = 5, fileList = null) {
        const files = fileList || input.files;
        if (files.length > maxFiles) {
            alert(`You can only upload up to ${maxFiles} files.`);
            input.value = '';  // Clear the input
            return;
        }

        for (let i = 0; i < files.length; i++) {
            uploadFile(input, files[i]);  // Process each file
        }
    }
</script>




    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
