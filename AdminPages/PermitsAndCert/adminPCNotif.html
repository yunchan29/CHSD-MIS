<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }

    </style>
    <style>
        .toggle-password {
            top: 60%;
            right: 1rem;
          
            cursor: pointer;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
               
                
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html" class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html" class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy Permit</a></li>
                
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html" class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
                
                <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html" class="text-decoration-none"><i class="fa-solid fa-gear"></i> Settings</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html" class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html" class="text-decoration-none"><i class="fa-solid fa-chart-simple"></i> Reports</a></li>
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
              </ul>
        </div>

        <div class="content">
             <!--Navigation Bar-->
<nav class="navigationBar navbar navbar-expand-lg bg-light">
  <div class="container-fluid">
      <!-- Mobile View -->
      <div class="d-flex justify-content-between d-md-none d-block">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
              <h5 class="mb-0 fs-5">CHSD</h5>
          </a>
          <button class="btn px-1 py-0 open-btn">
              <i class="fa-solid fa-bars-staggered"></i>
          </button>
      </div>

      <!-- Desktop View -->
      <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
              <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
          </a>
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <!-- Additional nav items go here -->
          </ul>
      </div>
  </div>
</nav>

        
            <div class="contentContainer">
                <div class="contentContainer container mt-5">
                    <div class="row g-4">
                        <!-- Avatar Upload Section -->
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 rounded-4">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-4">
                                        <i class="bi bi-person-circle display-6 text-primary me-3"></i>
                                        <h4 class="card-title mb-0">Profile Management</h4>
                                    </div>
                                    <!-- Profile Picture Preview -->
                                    <div class="text-center mb-4">
                                        <img id="profile-picture-preview" src="/resources/pictures/avatar3.png" alt="Avatar Preview" 
                                             class="img-thumbnail rounded-circle shadow-sm" 
                                             style="width: 120px; height: 120px; object-fit: cover;">
                                    </div>
                                    <form id="avatar-upload-form" class="mt-3">
                                        <div class="mb-3">
                                            <label for="avatar-upload" class="form-label fw-semibold">Upload New Avatar</label>
                                            <input type="file" id="avatar-upload" class="form-control" accept="image/*" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-upload me-2"></i>Upload Avatar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                
                        <!-- Password Update Section -->
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 rounded-4">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-4">
                                        <i class="bi bi-key display-6 text-primary me-3"></i>
                                        <h4 class="card-title mb-0">Update Password</h4>
                                    </div>
                                    <form id="password-update-form" class="mt-3">
                                        <div class="mb-3 position-relative">
                                            <label for="current-password" class="form-label fw-semibold">Current Password</label>
                                            <input type="password" id="current-password" class="form-control" placeholder="Enter current password" required>
                                            <i class="fa fa-eye-slash toggle-password position-absolute" data-target="current-password"></i>
                                        </div>
                                        <div class="mb-3 position-relative">
                                            <label for="new-password" class="form-label fw-semibold">New Password</label>
                                            <input type="password" id="new-password" class="form-control" placeholder="Enter new password" required>
                                            <i class="fa fa-eye-slash toggle-password position-absolute" data-target="new-password"></i>
                                        </div>
                                        <div class="mb-3 position-relative">
                                            <label for="confirm-new-password" class="form-label fw-semibold">Confirm New Password</label>
                                            <input type="password" id="confirm-new-password" class="form-control" placeholder="Confirm new password" required>
                                            <i class="fa fa-eye-slash toggle-password position-absolute" data-target="confirm-new-password"></i>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-shield-lock-fill me-2"></i>Update Password
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                
                        <!-- Two-Factor Authentication (2FA) Section -->
                        <div class="col-md-6">
                            <div class="card shadow-sm border-0 rounded-4">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-4">
                                        <i class="bi bi-envelope-lock display-6 text-primary me-3"></i>
                                        <h4 class="card-title mb-0">Two-Factor Authentication</h4>
                                    </div>
                                    <form id="2fa-setup-form" class="mt-3">
                                        <div class="mb-3">
                                            <label for="recovery-email" class="form-label fw-semibold">Recovery Email</label>
                                            <input type="email" id="recovery-email" class="form-control" placeholder="Enter recovery email" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-shield-check me-2"></i>Set Recovery Email
                                        </button>
                                    </form>
                                    <p class="small mt-3 text-muted">
                                        A recovery email will be used as a secondary verification for your account.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
    
    <script type="module" src="/Database/firebase.js"></script>
    <script>
        // Profile picture preview functionality
        document.getElementById('avatar-upload').addEventListener('change', function(event) {
            const preview = document.getElementById('profile-picture-preview');
            const file = event.target.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
            }
        });
    
        // Password visibility toggle functionality
        document.querySelectorAll('.toggle-password').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const targetInput = document.getElementById(this.dataset.target);
                const isPassword = targetInput.getAttribute('type') === 'password';
                targetInput.setAttribute('type', isPassword ? 'text' : 'password');
                this.classList.toggle('fa-eye-slash');
                this.classList.toggle('fa-eye');
            });
        });
    </script>
   
 <!--Navigation Bar-->
 <script>
  document.querySelector('.open-btn').addEventListener('click', function() {
      document.getElementById('side_nav').classList.add('active');
  });

  document.querySelector('.close-btn').addEventListener('click', function() {
      document.getElementById('side_nav').classList.remove('active');
  });
</script>

 <!-- Firebase and custom scripts -->
 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, query, where, orderBy, limit, onSnapshot, startAfter, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
        authDomain: "chsd-mis.firebaseapp.com",
        projectId: "chsd-mis",
        storageBucket: "chsd-mis.appspot.com",
        messagingSenderId: "694967679357",
        appId: "1:694967679357:web:65cffd50f13739f934f414",
        measurementId: "G-XBQTQFRLJ5"
    };

    // Initialize Firebase services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); 
    const db = getFirestore(app);
    const storage = getStorage(app);


    // Profile Management Functions
    function setupProfileManagement(userId) {
        document.getElementById("avatar-upload-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const file = document.getElementById("avatar-upload").files[0];

            if (file) {
                const storageRef = ref(storage, `avatars/${userId}`);
                try {
                    await uploadBytes(storageRef, file);
                    const avatarUrl = await getDownloadURL(storageRef);
                    await updateDoc(doc(db, "users", userId), { avatarUrl });

                    Swal.fire({
                        icon: 'success',
                        title: 'Profile Updated',
                        text: 'Profile picture updated successfully!',
                    });
                } catch (error) {
                    console.error("Error updating avatar:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Update Failed',
                        text: 'Failed to update profile picture.',
                    });
                }
            }
        });

        document.getElementById("password-update-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById("current-password").value;
            const newPassword = document.getElementById("new-password").value;
            const confirmNewPassword = document.getElementById("confirm-new-password").value;

            if (newPassword !== confirmNewPassword) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Password Mismatch',
                    text: 'New password and confirm password do not match.',
                });
                return;
            }

            try {
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(user.email, currentPassword);

                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);

                Swal.fire({
                    icon: 'success',
                    title: 'Password Updated',
                    text: 'Password updated successfully!',
                });
            } catch (error) {
                console.error("Error updating password:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Update Failed',
                    text: 'Failed to update password. Please ensure your current password is correct.',
                });
            }
        });
    }

   // Two-Factor Authentication Setup
function setupTwoFactorAuthentication(userId) {
    const recoveryEmailInput = document.getElementById("recovery-email");

    // Fetch the current recovery email and display it
    async function displayCurrentRecoveryEmail() {
        try {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                if (userData.recoveryEmail) {
                    recoveryEmailInput.value = userData.recoveryEmail; // Display the current recovery email
                }
            } else {
                console.error("User document does not exist.");
            }
        } catch (error) {
            console.error("Error retrieving recovery email:", error);
        }
    }

    // Call display function immediately to load email
    displayCurrentRecoveryEmail();

    // Update recovery email in Firestore
    document.getElementById("2fa-setup-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const recoveryEmail = recoveryEmailInput.value;

        try {
            await updateDoc(doc(db, "users", userId), { recoveryEmail });
            Swal.fire({
                icon: 'success',
                title: 'Recovery Email Updated',
                text: 'Your recovery email has been updated successfully!',
            });
        } catch (error) {
            console.error("Error updating recovery email:", error);
            Swal.fire({
                icon: 'error',
                title: 'Update Failed',
                text: 'Failed to update recovery email.',
            });
        }
    });
}



    document.addEventListener('DOMContentLoaded', handleAuthState);
</script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
