<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .modal-backdrop {
            z-index: 1040 !important; /* Ensure the z-index is set correctly */
        }

        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }

        .wide-modal {
            max-width: 80%;
        }

        .form-control {
            margin-bottom: 1rem; /* Add margin between form controls */
        }

        .form-check {
            margin-bottom: 0.5rem; /* Add margin between checkboxes */
        }

        .row.g-3 .col-md-6,
        .row.g-3 .col-md-4,
        .row.g-3 .col-md-12 {
            margin-bottom: 1rem; /* Add margin to columns */
        }

        .d-flex .me-2 {
            margin-right: 1rem; /* Add margin to the right of the input */
        }

        .modal-content {
            padding: 1.2rem !important;
        }

        @media(max-width: 991px) {
            .wide-modal {
                width: 100%;
                margin: auto;
            }
        }
    </style>
</head>

<body>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i
                        class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html"
                        class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html"
                        class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building
                        Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html"
                        class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy
                        Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html"
                        class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html"
                        class="text-decoration-none"><i class="fa-solid fa-bell"></i> Notifications</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html"
                        class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCUserManager.html"
                        class="text-decoration-none"><i class="fa-solid fa-user-pen"></i> User Manager</a></li>
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log
                        out</a></li>
            </ul>
        </div>

        <div class="content">
            <!-- Navigation Bar -->
            <nav class="navigationBar navbar navbar-expand-lg bg-light">
                <div class="container-fluid">
                    <!-- Mobile View -->
                    <div class="d-flex justify-content-between d-md-none d-block">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40"
                                class="me-2">
                            <h5 class="mb-0 fs-5">CHSD</h5>
                        </a>
                        <button class="btn px-1 py-0 open-btn">
                            <i class="fa-solid fa-bars-staggered"></i>
                        </button>
                    </div>

                    <!-- Desktop View -->
                    <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75"
                                class="me-2">
                            <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
                        </a>
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <!-- Additional nav items go here -->
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="contentContainer">
                <h4 class="text-center">Building Permit</h4>
                <div class="container">
                    <h5>Profile</h5>
                    <div class="row mt-4">
                        <div class="col">
                            <a class="btn btn-dark text-white" data-bs-toggle="modal"
                                data-bs-target="#buildingPermitModal"><i class="fa-solid fa-plus"></i> Add
                                Profile</a>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#viewDetailsModal">
                                Check Remarks
                            </button>
                        </div>

                        <div class="d-flex justify-content-end mb-3">
                            <input type="text" class="form-control search-bar" id="searchInput" placeholder="Search">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"><i
                                        class="fas fa-search"></i></button>
                            </div>
                        </div>

                        <div id="buildingPermitDiv">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Owner</th>
                                        <th>Representative</th>
                                        <th>Submitted at</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
  
                                    <!-- Profile rows will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Controls -->
                        <div class="pagination-controls text-center">
                            <button id="prevPageBtn" class="btn btn-primary" disabled>Previous</button>
                            <span id="pageInfo"></span>
                            <button id="nextPageBtn" class="btn btn-primary">Next</button>
                        </div>

                       <!-- Application Modal -->
<div class="modal fade" id="buildingPermitModal" tabindex="-1" aria-labelledby="BuildingPermitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content buldingPermitApplication">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="BuildingPermitModalLabel">Building Permit Application</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Application Modal Content -->
                <div class="container">
                   <!-- Step Progress Bar -->
                <div class="step-progress mb-4">
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Form</div>
                    </div>
                    <div class="step">
                        <div class="circle"></div>
                        <div class="label">Upload Requirements</div>
                    </div>
                    <div class="step">
                        <div class="circle"></div>
                        <div class="label">Appointment</div>
                    </div>
                </div>
                    <form>
                        <p>Note: Fill up all the fields to proceed to the next step.</p>
                        <p><i>Required fields are marked with <span class="required-asterisk">*</span></i></p>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="hsdFormNo">HSD No.</label>
                                <input type="text" class="form-control me-2" id="hsdFormNo" placeholder="HSD Form No.1">
                                
                            </div>
                            <div class="col-md-4">
                                <label for="ownerEmail">Applicant Email:</label>
                                <input type="email" class="form-control" id="ownerEmail" placeholder="Applicant Email">
                               
                                
                            </div>

                            <div class="col-md-4">
                                <button type="button" class="btn btn-secondary" onclick="window.print();"><i class="fa-solid fa-print"></i> Print</button>
                            </div>

                        </div>
                        <div class="row">
                            
                            
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="buildingPermitNo">Building Permit Number:</label>
                                <input type="text" class="form-control" id="buildingPermitNo" placeholder="Building Permit No.">
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text" id="basic-addon3">Issued on:</span>
                                    <input type="date" class="form-control" id="basic-url" aria-describedby="basic-addon3 basic-addon4">
                                </div>
                            </div>
                        </div>
                      <div class="row g-3">
    <label for="ownerName">Owner/Applicant Name:</label>
    <div class="col-md-3">
        <label for="ownerLastName">Last Name<span class="required-asterisk">*</span></label>
        <input type="text" class="form-control" id="ownerLastName" placeholder="Last Name" required>
    </div>
    <div class="col-md-3">
        <label for="ownerFirstName">First Name<span class="required-asterisk">*</span></label>
        <input type="text" class="form-control" id="ownerFirstName" placeholder="First Name*" required>
    </div>
    <div class="col-md-3">
        <label for="ownerMiddleName">Middle Name</label>
        <input type="text" class="form-control" id="ownerMiddleName" placeholder="Middle Name">
    </div>
    <div class="col-md-3">
        <label for="ownerMaidenName">Maiden Name</label>
        <input type="text" class="form-control" id="ownerMaidenName" placeholder="Maiden Name">
    </div>
</div>


<div class="mb-3">
    <label for="phoneNumber" class="form-label">Cellphone/Telephone Number<span class="required-asterisk">*</span></label>
    <input type="text" class="form-control" id="phoneNumber" required>
</div>



                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="addressTelNo">Address<span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="addressTelNo" placeholder="Address*" required>
                            </div>


                            <div class="col-md-6">
                                <label for="projectLocation">Project Location<span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="projectLocation" placeholder="Project Location*" required>
                            </div>
                        </div>

                    
                        <div class="mb-3">
                            <div class="row g-3">
                                <label for="form-check" class="form-label">Scope of Work<span class="required-asterisk">*</span></label>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scopeOfWork" value="option1" id="option1" required>
                                        <label class="form-check-label" for="option1">New Construction</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scopeOfWork" value="option2" id="option2" required>
                                        <label class="form-check-label" for="option2">Addition</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scopeOfWork" value="option3" id="option3" required>
                                        <label class="form-check-label" for="option3">Repair Renovation</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scopeOfWork" value="option4" id="option4" required onclick="toggleOtherScopeInput()">
                                        <label class="form-check-label" for="option4">Others</label>
                                        <input type="text" class="form-control mt-2" id="otherScopeInput" placeholder="Specify" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="row g-3">
                                <label for="form-check" class="form-label">Project Justification<span class="required-asterisk">*</span></label>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="projectJustification" value="justification1" id="justification1" required>
                                        <label class="form-check-label" for="justification1">Single Attached/Semi-Attached/Duplex</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="projectJustification" value="justification2" id="justification2" required>
                                        <label class="form-check-label" for="justification2">Single/Detached</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="projectJustification" value="justification3" id="justification3" required>
                                        <label class="form-check-label" for="justification3">Row House/Multi-family Dwelling</label>
                                    </div>
                                </div>
                            </div>
                        
                        
                            <div class="row mb-3">
                                <div class="col">
                                    <label for="blockNumber">Block Number<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Block number" id="blockNumber" required>
                                </div>
                                <div class="col">
                                    <label for="lotNumber">Lot Number<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Lot number"  id="lotNumber" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="NOUnits">Number of Units<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="No. of Units" id="NOUnits" required>
                                </div>
                                <div class="col">
                                    <label for="FloorArea">Floor Area Per Unit<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Floor Area Per Unit" id="FloorArea" required>
                                </div>
                                <div class="col">
                                    <label for="TotalFloorArea">Total Floor Area<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Total Floor Area" id="TotalFloorArea" required>
                                </div>
                                <div class="col">
                                    <label for="TotalEstimatedCost">Total Estimated Cost<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Total Estimated Cost" id="TotalEstimatedCost" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary"
                    data-bs-toggle="modal" data-bs-target="#orderOfPaymentModal">
                    Next
                </button>
            </div>
        </div>
    </div>
</div>
              </div>
                <!-- End of Bootstrap Table -->
            </div>
        </div>
    </div>

    

    

                      <!-- View Details Modal -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailsModalLabel">Permit Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Text information at the top -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Owner Name:</strong> <span id="permitOwnerName"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                    </div>
                </div>
            
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Permit ID:</strong> <span id="permitIdDisplay"></span></p>
                    </div>
                </div>
            
                <!-- Status selection in a row -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="statusSelect" class="form-label">Status</label>
                        <select id="statusSelect" class="form-select">
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="To Pay">To Pay</option>
                            <option value="For Approval">For Approval</option>
                            <option value="For Release">For Release</option>
                            <option value="Claimed">Claimed</option>
                        </select>
                    </div>
                </div>
            
                <!-- Comments section -->
                <div class="row">
                    <div class="col-md-12">
                        <label for="officerRemarks">Comments</label>
                        <textarea class="form-control" id="officerRemarks" rows="2"></textarea>
                    </div>
                </div>
            
                <div id="viewDetailsModalBtnGrp">

                </div>
            
                <!-- Hidden input field to store the permit ID -->
                <input type="hidden" id="hiddenPermitId">
            </div>
            
            
            <div class="modal-footer">
               
                <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Order of Payment Modal -->
<div class="modal fade" id="orderOfPaymentModal" tabindex="-1" aria-labelledby="OrderOfPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="OrderOfPaymentModalLabel"><i class="fa-solid fa-file-invoice"></i> Order of Payment</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step Progress Bar -->
                <div class="step-progress mb-4">
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Form</div>
                    </div>
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Order of Payment</div>
                    </div>
                    <div class="step">
                        <div class="circle"></div>
                        <div class="label">Certificate</div>
                    </div>
                </div>
                <!-- Order of Payment Form -->
                <div class="container">
                    <h4 class="text-center">ORDER OF PAYMENT</h4>
                    <p class="text-center"><i>Payee: Treasurer/Cashier-City Treasury Office, City of Calamba</i></p>
                    <div class="row">
                        <label for="OPOwner/Applicant">Owner/Applicant:</label>
                    <input type="text" class="form-control" id="OPOwner/Applicant">
                    </div>

                    <div class="row">
                        <label for="OPLocation">
                        Location
                        </label>
                        <input type="text" class="form-control" id="OPLocation">
                    </div>
                    <label for="bp220">Building Permit-BP220</label>
                    <div class="row">

                        <div class="col-md-2">

                        <label for="bpArea">Area</label>
                        <input type="number" class="form-control" id="bpArea">
                        </div>

                        <div class="col-md-2">
                        <label for="bpLM">Line Meter(LM)</label>
                        <input type="number" class="form-control" id="bpLM">
                        </div>

                        <div class="col-md-2">
                        <label for="bpSAN">Sanitary(SAN)</label>
                        <input type="number" class="form-control" id="bpSAN">
                        </div>
                        <div class="col-md-2">
                        <label for="bpELEC">Electrical Fee(ELEC)</label>
                        <input type="number" class="form-control"  id="bpELEC">
                    </div>

                    <div class="col-md-3 justify-content-end" >
                        <label for="bpTotal">
                            Total
                        </label>
                        <input type="number" class="form-control" id="bpTotal">
                    </div>

                    </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#orderOfPaymentModal">
                    Previous
                  </button>
                <button type="button" id="nextStepButton2" class="btn btn-primary">Next</button>

    </div>
    </div>
    </div>
    </div>
    </div>
    </div>

  <!-- View HSD Form Modal -->
<div class="modal fade" id="viewHSDFormModal" tabindex="-1" aria-labelledby="viewHSDFormModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewHSDFormModalLabel">HSD Form Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Display HSD form details here -->
                <p><strong>Date Submitted:</strong> <span id="hsdFormDateSubmitted"></span></p>
                <p><strong>Owner Name:</strong> <span id="hsdFormOwnerName"></span></p>
                <p><strong>Phone Number:</strong> <span id="hsdPhoneNumber"></span></p>
                <p><strong>Address:</strong> <span id="hsdFormAddress"></span></p>
                <p><strong>Project Location:</strong> <span id="hsdFormProjectLocation"></span></p>
                <p><strong>Scope of Work:</strong> <span id="hsdFormScopeOfWork"></span></p>
                <p><strong>Project Justification:</strong> <span id="hsdFormProjectJustification"></span></p>
                <p><strong>Block Number:</strong> <span id="hsdFormBlockNumber"></span></p>
                <p><strong>Lot Number:</strong> <span id="hsdFormLotNumber"></span></p>
                <p><strong>Number Of Units:</strong> <span id="hsdFormNOUnits"></span></p>
                <p><strong>Floor Area Per Unit:</strong> <span id="hsdFormFloorArea"></span></p>
                <p><strong>Total Floor Area:</strong> <span id="hsdFormTotalFloorArea"></span></p>
                <p><strong>Total Estimated Cost:</strong> <span id="hsdFormTotalEstimatedCost"></span></p>
                

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


                        <script type="module" src="/Database/firebase.js"></script>

                        <script type="module">
                               import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, getDocs, updateDoc, doc, getDoc, addDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
      // Firebase configuration
      const firebaseConfig = {
          apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
          authDomain: "chsd-mis.firebaseapp.com",
          projectId: "chsd-mis",
          storageBucket: "chsd-mis.appspot.com",
          messagingSenderId: "694967679357",
          appId: "1:694967679357:web:65cffd50f13739f934f414",
          measurementId: "G-XBQTQFRLJ5"
      };
  
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
  
      // Notification Function
        function showNotification(message, type) {
            const notificationContainer = document.getElementById('notification-container');
            if (notificationContainer) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notificationContainer.appendChild(notification);
                alert("status updated successfully");

                // Automatically remove notification after 5 seconds
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            } else {
                console.error('Notification container not found.');
            }
        }

        // Pagination Variables
        let profilesPerPage = 5; // Profiles per page
        let currentPage = 1; // Current page
        let totalPages = 1; // Total pages

        // Function to Dynamically Append Buttons to the View Details Modal
        function appendButtons(data) {
            const viewDetailsModalBtnGrp = document.getElementById('viewDetailsModalBtnGrp');
            viewDetailsModalBtnGrp.innerHTML = ''; // Clear existing buttons

            // First Row of Buttons
            const firstRow = document.createElement('div');
            firstRow.className = 'row mt-4';

            // View HSD Form Button
            const col1 = document.createElement('div');
            col1.className = 'col-md-6 mb-2';
            const btn1 = document.createElement('button');
            btn1.className = 'btn btn-primary w-100 view-hsd-btn';
            btn1.setAttribute('data-permit-id', data.id);
            btn1.textContent = 'View HSD Form';
            btn1.addEventListener('click', () => openViewHSDFormModal(data));
            col1.appendChild(btn1);

            // View File Uploads Button
            const col2 = document.createElement('div');
            col2.className = 'col-md-6 mb-2';
            const btn2 = document.createElement('button');
            btn2.className = 'btn btn-primary w-100';
            btn2.textContent = 'View File Uploads';
            // TODO: Add functionality for 'View File Uploads' if needed
            col2.appendChild(btn2);

            firstRow.appendChild(col1);
            firstRow.appendChild(col2);

            // Second Row of Buttons
            const secondRow = document.createElement('div');
            secondRow.className = 'row mt-2';

            const col3 = document.createElement('div');
            col3.className = 'col-md-12';
            const btn3 = document.createElement('button');
            btn3.className = 'btn btn-success w-100';
            btn3.textContent = 'Generate Order of Payment';
            // TODO: Add functionality for 'Generate Order of Payment' if needed
            col3.appendChild(btn3);

            secondRow.appendChild(col3);

            // Append Rows to Button Group
            viewDetailsModalBtnGrp.appendChild(firstRow);
            viewDetailsModalBtnGrp.appendChild(secondRow);
        }

        // Function to Load Building Permits and Display in the Table
        async function loadProfiles() {
            try {
                const querySnapshot = await getDocs(collection(db, "buildingPermits"));
                const buildingPermitDiv = document.getElementById("buildingPermitDiv");
                const prevPageBtn = document.getElementById("prevPageBtn");
                const nextPageBtn = document.getElementById("nextPageBtn");
                const pageInfo = document.getElementById("pageInfo");

                if (!buildingPermitDiv) {
                    console.error("buildingPermitDiv not found in the DOM.");
                    return;
                }

                const tableBody = buildingPermitDiv.querySelector("tbody");
                if (!tableBody) {
                    console.error("Table body not found in buildingPermitDiv.");
                    return;
                }

                tableBody.innerHTML = ""; // Clear existing rows

                // Fetch and Process Permits Data
                const permitsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const uniquePermitsData = Array.from(new Set(permitsData.map(a => a.id)))
                    .map(id => permitsData.find(a => a.id === id));

                // Sort by createdAt (ascending)
                uniquePermitsData.sort((a, b) => {
                    const aTime = a.createdAt?.seconds || 0;
                    const bTime = b.createdAt?.seconds || 0;
                    return aTime - bTime;
                });

                // Calculate Total Pages
                totalPages = Math.ceil(uniquePermitsData.length / profilesPerPage);

                // Determine Profiles for Current Page
                const start = (currentPage - 1) * profilesPerPage;
                const end = start + profilesPerPage;
                const currentProfiles = uniquePermitsData.slice(start, end);

                // Loop Through Profiles and Populate Table
                for (const data of currentProfiles) {
                    const row = document.createElement("tr");

                    // Fetch Representative User Data
                    let representativeName = "";
                    if (data.ownerUid) {
                        try {
                            const userRef = doc(db, "users", data.ownerUid);
                            const userDoc = await getDoc(userRef);
                            if (userDoc.exists()) {
                                const userData = userDoc.data();
                                representativeName = `${userData.firstName} ${userData.lastName}`;
                            }
                        } catch (error) {
                            console.error("Error fetching user data:", error);
                        }
                    }

                    const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";

                    row.innerHTML = `
                        <td>${data.ownerName || "N/A"}</td>
                        <td>${representativeName || "N/A"}</td>
                        <td>${createdAt}</td>
                        <td>${data.status || "N/A"}</td>
                        <td>
                            <button class="btn btn-primary btn-sm view-details-btn" data-permit-id="${data.id}">View Details</button>
                        </td>
                    `;

                    tableBody.appendChild(row);

                    // Add Event Listener for "View Details" Button
                    const viewDetailsBtn = row.querySelector(".view-details-btn");
                    if (viewDetailsBtn) {
                        viewDetailsBtn.addEventListener("click", () => {
                            openViewDetailsModal(data);
                        });
                    }
                }

                // Update Pagination Info
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

                // Enable/Disable Pagination Buttons
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;

            } catch (error) {
                console.error("Error loading profiles:", error);
                showNotification("Failed to load profiles.", "error");
            }
        }

        // Function to Control Progressive Status Selection
        function updateStatusOptions(currentStatus) {
            const statusSelect = document.getElementById("statusSelect");

            const statusProgression = {
                "Pending": ["Pending", "Processing"],
                "Processing": ["Processing", "To Pay"],
                "To Pay": ["To Pay", "For Approval"],
                "For Approval": ["For Approval", "For Release"],
                "For Release": ["For Release", "Claimed"],
                "Claimed": ["Claimed"]
            };

            const validStatuses = statusProgression[currentStatus] || [];

            const options = statusSelect.querySelectorAll("option");
            options.forEach(option => {
                if (validStatuses.includes(option.value)) {
                    option.style.display = "block"; // Show valid options
                } else {
                    option.style.display = "none"; // Hide invalid options
                }
            });

            // Set the statusSelect to the currentStatus
            statusSelect.value = currentStatus;
        }

        // Function to Open the View Details Modal
        function openViewDetailsModal(permitData) {
            // Populate Modal Fields
            document.getElementById("permitOwnerName").textContent = permitData.ownerName || "N/A";
            document.getElementById("issuedOnDate").textContent = permitData.issuedOn || "N/A";
            document.getElementById("appointmentDateSched").textContent = permitData.appointmentDate ? permitData.appointmentDate : "N/A";
            document.getElementById("permitIdDisplay").textContent = permitData.id || "N/A";
            document.getElementById("hiddenPermitId").value = permitData.id || "";

            // Update Status Options
            updateStatusOptions(permitData.status || "Pending");

            // Append Dynamic Buttons
            appendButtons(permitData);

            // Show the Modal
            const viewDetailsModal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
            viewDetailsModal.show();

            // Add Event Listener for the Save Button (Ensure it's not duplicated)
            const saveStatusBtn = document.getElementById("saveStatusBtn");
            saveStatusBtn.onclick = async () => {
                const newStatus = document.getElementById("statusSelect").value;
                try {
                    // Update Status in Firestore
                    await updateDoc(doc(db, 'buildingPermits', permitData.id), { status: newStatus });

                    // Trigger Notification
                    const message = `${permitData.ownerName}'s building permit is now ${newStatus.toLowerCase()}`;
                    showNotification(message, 'info');


                    // Store Notification in Firestore
                    await addDoc(collection(db, "notifications"), {
                        userId: permitData.ownerUid,
                        message: message,
                        permitId: permitData.id,
                        timestamp: serverTimestamp(),
                        read: false
                    });
                    alert("status updated successfully");

                    // Reload Profiles to Reflect Changes
                    loadProfiles();

                    // Hide Modal
                    viewDetailsModal.hide();

                } catch (error) {
                    console.error("Error updating permit status:", error);
                    showNotification("Failed to update permit status.", "error");
                }
            };
        }

      // Function to Open the View HSD Form Modal with Debugging
// Function to Open the View HSD Form Modal
async function openViewHSDFormModal(permitData) {
    try {
        console.log("Permit Data received:", permitData); // Log permitData to ensure it's not empty

        // Fetch the data from the buildingPermits collection based on the permitId
        const hsdFormData = await getDoc(doc(db, "buildingPermits", permitData.id));

        if (!hsdFormData.exists()) {
            console.error("HSD Form (Building Permit) not found!");
            alert("HSD Form data is missing!");
            return;
        }

        const data = hsdFormData.data();
        console.log("HSD Form Data retrieved:", data); // Log the fetched data to ensure it's being retrieved correctly

        // Populate HSD Form Modal Fields
        
        document.getElementById('hsdFormOwnerName').textContent = data.ownerName;
        document.getElementById('hsdFormAddress').textContent = data.projectLocation || "N/A";
        document.getElementById('hsdFormDateSubmitted').textContent = data.issuedOn;
        document.getElementById("hsdPhoneNumber").textContent = data.phoneNumber;
        document.getElementById("hsdFormProjectLocation").textContent= data.projectLocation;
        document.getElementById("hsdFormScopeOfWork").textContent = data.scopeOfWork;
        document.getElementById("hsdFormProjectJustification").textContent = data.projectJustification;
        document.getElementById("hsdFormBlockNumber").textContent = data.blockNumber || "N/A";
        document.getElementById("hsdFormLotNumber").textContent = data.lotNumber || "N/A";
        document.getElementById("hsdFormNOUnits").textContent = data.NOUnits || "N/A";
        document.getElementById("hsdFormFloorArea").textContent = data.FloorArea || "N/A";
        document.getElementById("hsdFormTotalFloorArea").textContent = data.TotalFloorArea || "N/A";
        document.getElementById("hsdFormTotalEstimatedCost").textContent = data.TotalEstimatedCost || "N/A";

        console.log("HSD Form fields populated");

        // Show the HSD Form Modal
        const viewHSDFormModal = new bootstrap.Modal(document.getElementById('viewHSDFormModal'));
        viewHSDFormModal.show();
    } catch (error) {
        console.error("Error opening HSD Form modal:", error);
        alert("Failed to load HSD form data.");
    }
}



        // Function to Archive a Building Permit
        async function handleArchiveBuildingPermit(event) {
            event.preventDefault();

            const buildingPermitId = event.target.getAttribute('data-id');

            if (!buildingPermitId) {
                console.error("Building Permit ID is null or undefined.");
                showNotification("Error: Building Permit ID is missing.", "error");
                return;
            }

            const confirmed = confirm("Are you sure you want to archive this document?");
            
            if (!confirmed) {
                return;
            }

            try {
                const buildingPermitRef = doc(db, "buildingPermits", buildingPermitId);
                const buildingPermitSnapshot = await getDoc(buildingPermitRef);

                if (buildingPermitSnapshot.exists()) {
                    const buildingPermitData = buildingPermitSnapshot.data();
                    
                    await setDoc(doc(db, "archivedBuildingPermits", buildingPermitId), buildingPermitData);
                    await deleteDoc(buildingPermitRef);

                    // Remove the row from the table
                    const tableBody = document.querySelector("#buildingPermitDiv tbody");
                    const rowToRemove = tableBody.querySelector(`button[data-permit-id="${buildingPermitId}"]`).closest('tr');
                    if (rowToRemove) rowToRemove.remove();

                    showNotification("Document archived successfully!", "success");
                } else {
                    showNotification("Document not found!", "error");
                }
            } catch (error) {
                console.error("Error archiving document: ", error);
                showNotification(`Failed to archive document: ${error.message}`, "error");
            }
        }

        // Function to Search Permits by Owner or Representative Name
        function searchPermits() {
            const searchInput = document.getElementById("searchInput").value.toLowerCase();
            const tableRows = document.querySelectorAll("#buildingPermitDiv tbody tr");

            let resultsFound = false; // To track if any results are found

            tableRows.forEach(row => {
                const ownerName = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
                const representativeName = row.querySelector("td:nth-child(2)").textContent.toLowerCase();

                // Check if the search input matches either the owner name or representative name
                if (ownerName.includes(searchInput) || representativeName.includes(searchInput)) {
                    row.style.display = ""; // Show the row
                    resultsFound = true; // Mark that we found results
                } else {
                    row.style.display = "none"; // Hide the row if it doesn't match
                }
            });

            // Display a 'No results found' message if no results match
            const existingNoResults = document.getElementById("noResultsMessage");
            if (!resultsFound) {
                if (!existingNoResults) {
                    const newRow = document.createElement("tr");
                    newRow.id = "noResultsMessage";
                    newRow.innerHTML = `<td colspan="5" class="text-center">No results found</td>`;
                    document.querySelector("#buildingPermitDiv tbody").appendChild(newRow);
                }
            } else if (existingNoResults) {
                existingNoResults.remove(); // Remove the 'No results' message if results are found
            }
        }

        // Initialize Pagination and Load Profiles
        document.addEventListener("DOMContentLoaded", () => {
            const prevPageBtn = document.getElementById("prevPageBtn");
            const nextPageBtn = document.getElementById("nextPageBtn");

            // Event Listener for Previous Page Button
            prevPageBtn.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadProfiles();
                }
            });

            // Event Listener for Next Page Button
            nextPageBtn.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadProfiles();
                }
            });

            // Event Listener for Search Input
            const searchInput = document.getElementById("searchInput");
            searchInput.addEventListener("input", searchPermits);

            // Load Profiles Initially
            loadProfiles();
        });

                        </script>

                        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
                            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
                            crossorigin="anonymous"></script>
                        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
                            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
                            crossorigin="anonymous"></script>
                        <script src="https://kit.fontawesome.com/8d1b0b1c7b.js" crossorigin="anonymous"></script>
                        <!--Navigation Bar-->
                        <script>
                            document.querySelector('.open-btn').addEventListener('click', function () {
                                document.getElementById('side_nav').classList.add('active');
                            });

                            document.querySelector('.close-btn').addEventListener('click', function () {
                                document.getElementById('side_nav').classList.remove('active');
                            });
                        </script>

                        <!-- Toggle Others -->
                        <script>
                            function toggleOtherScopeInput() {
                                const otherInput = document.getElementById("otherScopeInput");
                                const otherRadio = document.getElementById("option4");

                                if (otherRadio.checked) {
                                    otherInput.disabled = false;
                                } else {
                                    otherInput.disabled = true;
                                    otherInput.value = '';  // Clear the input if disabled
                                }
                            }

                            // Call the function on page load to ensure the state is correct
                            window.onload = toggleOtherScopeInput;
                        </script>

                       
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
