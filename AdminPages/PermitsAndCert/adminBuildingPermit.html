<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .modal-backdrop {
            z-index: 1040 !important; /* Ensure the z-index is set correctly */
        }

        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }

        .wide-modal {
            max-width: 80%;
        }

        .form-control {
            margin-bottom: 1rem; /* Add margin between form controls */
        }

        .form-check {
            margin-bottom: 0.5rem; /* Add margin between checkboxes */
        }

        .row.g-3 .col-md-6,
        .row.g-3 .col-md-4,
        .row.g-3 .col-md-12 {
            margin-bottom: 1rem; /* Add margin to columns */
        }

        .d-flex .me-2 {
            margin-right: 1rem; /* Add margin to the right of the input */
        }

        .modal-content {
            padding: 1.2rem !important;
        }

        @media(max-width: 991px) {
            .wide-modal {
                width: 100%;
                margin: auto;
            }
        }
    </style>
</head>

<body>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i
                        class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html"
                        class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html"
                        class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building
                        Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html"
                        class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy
                        Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html"
                        class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html"
                        class="text-decoration-none"><i class="fa-solid fa-bell"></i> Notifications</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html"
                        class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCUserManager.html"
                        class="text-decoration-none"><i class="fa-solid fa-user-pen"></i> User Manager</a></li>
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log
                        out</a></li>
            </ul>
        </div>

        <div class="content">
            <!-- Navigation Bar -->
            <nav class="navigationBar navbar navbar-expand-lg bg-light">
                <div class="container-fluid">
                    <!-- Mobile View -->
                    <div class="d-flex justify-content-between d-md-none d-block">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40"
                                class="me-2">
                            <h5 class="mb-0 fs-5">CHSD</h5>
                        </a>
                        <button class="btn px-1 py-0 open-btn">
                            <i class="fa-solid fa-bars-staggered"></i>
                        </button>
                    </div>

                    <!-- Desktop View -->
                    <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75"
                                class="me-2">
                            <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
                        </a>
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <!-- Additional nav items go here -->
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="contentContainer">
               
                <div class="container">
                    <h5>Profile</h5>
                    <div class="row mt-4">
                        <div class="col">
                            <a class="btn btn-dark text-white" data-bs-toggle="modal"
                                data-bs-target="#buildingPermitModal"><i class="fa-solid fa-plus"></i> Add
                                Profile</a>
                         
                        </div>

                        <div class="d-flex justify-content-end mb-3">
                            <input type="text" class="form-control search-bar" id="searchInput" placeholder="Search">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"><i
                                        class="fas fa-search"></i></button>
                            </div>
                        </div>

                        <h4 class="text-center">Building Permit</h4>

                        <div id="buildingPermitDiv">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Owner</th>
                                        <th>Representative</th>
                                        <th>Submitted at</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
  
                                    <!-- Profile rows will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Controls -->
                        <div class="pagination-controls text-center">
                            <button id="prevPageBtn" class="btn btn-primary" disabled>Previous</button>
                            <span id="pageInfo"></span>
                            <button id="nextPageBtn" class="btn btn-primary">Next</button>
                        </div>

                       <!-- Application Modal -->
<div class="modal fade" id="buildingPermitModal" tabindex="-1" aria-labelledby="BuildingPermitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content buldingPermitApplication">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="BuildingPermitModalLabel">Building Permit Application</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Application Modal Content -->
                <div class="container">
                   <!-- Step Progress Bar -->
                <div class="step-progress mb-4">
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Form</div>
                    </div>
                    <div class="step">
                        <div class="circle"></div>
                        <div class="label">Upload Requirements</div>
                    </div>
                    <div class="step">
                        <div class="circle"></div>
                        <div class="label">Appointment</div>
                    </div>
                </div>
                    <form>
                        <p>Note: Fill up all the fields to proceed to the next step.</p>
                        <p><i>Required fields are marked with <span class="required-asterisk">*</span></i></p>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="hsdFormNo">HSD No.</label>
                                <input type="text" class="form-control me-2" id="hsdFormNo" placeholder="HSD Form No.1">
                                
                            </div>
                            <div class="col-md-4">
                                <label for="ownerEmail">Applicant Email:</label>
                                <input type="email" class="form-control" id="ownerEmail" placeholder="Applicant Email">
                               
                                
                            </div>

                            <div class="col-md-4">
                                <button type="button" class="btn btn-secondary" onclick="window.print();"><i class="fa-solid fa-print"></i> Print</button>
                            </div>

                        </div>
                        <div class="row">
                            
                            
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="buildingPermitNo">Building Permit Number:</label>
                                <input type="text" class="form-control" id="buildingPermitNo" placeholder="Building Permit No.">
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text" id="basic-addon3">Issued on:</span>
                                    <input type="date" class="form-control" id="basic-url" aria-describedby="basic-addon3 basic-addon4">
                                </div>
                            </div>
                        </div>
                      <div class="row g-3">
    <label for="ownerName">Owner/Applicant Name:</label>
    <div class="col-md-3">
        <label for="ownerLastName">Last Name<span class="required-asterisk">*</span></label>
        <input type="text" class="form-control" id="ownerLastName" placeholder="Last Name" required>
    </div>
    <div class="col-md-3">
        <label for="ownerFirstName">First Name<span class="required-asterisk">*</span></label>
        <input type="text" class="form-control" id="ownerFirstName" placeholder="First Name*" required>
    </div>
    <div class="col-md-3">
        <label for="ownerMiddleName">Middle Name</label>
        <input type="text" class="form-control" id="ownerMiddleName" placeholder="Middle Name">
    </div>
    <div class="col-md-3">
        <label for="ownerMaidenName">Maiden Name</label>
        <input type="text" class="form-control" id="ownerMaidenName" placeholder="Maiden Name">
    </div>
</div>


<div class="mb-3">
    <label for="phoneNumber" class="form-label">Cellphone/Telephone Number<span class="required-asterisk">*</span></label>
    <input type="text" class="form-control" id="phoneNumber" required>
</div>



                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="addressTelNo">Address<span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="addressTelNo" placeholder="Address*" required>
                            </div>


                            <div class="col-md-6">
                                <label for="projectLocation">Project Location<span class="required-asterisk">*</span></label>
                                <input type="text" class="form-control" id="projectLocation" placeholder="Project Location*" required>
                            </div>
                        </div>

                    
                        <div class="mb-3">
                            <div class="row g-3">
                                <label for="form-check" class="form-label">Scope of Work<span class="required-asterisk">*</span></label>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scopeOfWork" value="option1" id="option1" required>
                                        <label class="form-check-label" for="option1">New Construction</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scopeOfWork" value="option2" id="option2" required>
                                        <label class="form-check-label" for="option2">Addition</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scopeOfWork" value="option3" id="option3" required>
                                        <label class="form-check-label" for="option3">Repair Renovation</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="scopeOfWork" value="option4" id="option4" required onclick="toggleOtherScopeInput()">
                                        <label class="form-check-label" for="option4">Others</label>
                                        <input type="text" class="form-control mt-2" id="otherScopeInput" placeholder="Specify" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="row g-3">
                                <label for="form-check" class="form-label">Project Justification<span class="required-asterisk">*</span></label>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="projectJustification" value="justification1" id="justification1" required>
                                        <label class="form-check-label" for="justification1">Single Attached/Semi-Attached/Duplex</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="projectJustification" value="justification2" id="justification2" required>
                                        <label class="form-check-label" for="justification2">Single/Detached</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="projectJustification" value="justification3" id="justification3" required>
                                        <label class="form-check-label" for="justification3">Row House/Multi-family Dwelling</label>
                                    </div>
                                </div>
                            </div>
                        
                        
                            <div class="row mb-3">
                                <div class="col">
                                    <label for="blockNumber">Block Number<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Block number" id="blockNumber" required>
                                </div>
                                <div class="col">
                                    <label for="lotNumber">Lot Number<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Lot number"  id="lotNumber" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="NOUnits">Number of Units<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="No. of Units" id="NOUnits" required>
                                </div>
                                <div class="col">
                                    <label for="FloorArea">Floor Area Per Unit<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Floor Area Per Unit" id="FloorArea" required>
                                </div>
                                <div class="col">
                                    <label for="TotalFloorArea">Total Floor Area<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Total Floor Area" id="TotalFloorArea" required>
                                </div>
                                <div class="col">
                                    <label for="TotalEstimatedCost">Total Estimated Cost<span class="required-asterisk">*</span></label>
                                    <input type="text" class="form-control" placeholder="Total Estimated Cost" id="TotalEstimatedCost" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary"
                    data-bs-toggle="modal" data-bs-target="#orderOfPaymentModal">
                    Next
                </button>
            </div>
        </div>
    </div>
</div>
              </div>
                <!-- End of Bootstrap Table -->
            </div>
        </div>
    </div>

    

    

                      <!-- View Details Modal -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailsModalLabel">Permit Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Text information at the top -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Owner Name:</strong> <span id="permitOwnerName"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                    </div>
                </div>
            
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Permit ID:</strong> <span id="permitIdDisplay"></span></p>
                    </div>
                </div>
            
                <!-- Status selection in a row -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="statusSelect" class="form-label">Status</label>
                        <select id="statusSelect" class="form-select">
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="To Pay">To Pay</option>
                            <option value="For Approval">For Approval</option>
                            <option value="For Release">For Release</option>
                            <option value="Claimed">Claimed</option>
                        </select>
                    </div>
                </div>
            
                <!-- Comments section -->
                <div class="row">
                    <div class="col-md-12">
                        <label for="officerRemarks">Comments</label>
                        <textarea class="form-control" id="officerRemarks" rows="2"></textarea>
                    </div>
                </div>
            
                <div id="viewDetailsModalBtnGrp">

                </div>
            
                <!-- Hidden input field to store the permit ID -->
                <input type="hidden" id="hiddenPermitId">
            </div>
            
            
            <div class="modal-footer">
               
                <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<!-- Order of Payment Modal -->
<div class="modal fade" id="orderOfPaymentModal" tabindex="-1" aria-labelledby="OrderOfPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="OrderOfPaymentModalLabel">
                    <i class="fa-solid fa-file-invoice"></i> Order of Payment
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step Progress Bar -->
                <div class="step-progress mb-4">
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Form</div>
                    </div>
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Order of Payment</div>
                    </div>
                    <div class="step">
                        <div class="circle"></div>
                        <div class="label">Certificate</div>
                    </div>
                </div>

                <!-- Order of Payment Form -->
                <div class="container">
                    <h4 class="text-center">ORDER OF PAYMENT</h4>
                    <p class="text-center"><i>Payee: Treasurer/Cashier-City Treasury Office, City of Calamba</i></p>

                    <!-- Owner/Applicant Input -->
                    <div class="row mb-3">
                        <label for="OPOwner/Applicant">Owner/Applicant:</label>
                        <input type="text" class="form-control" id="OPOwner/Applicant">
                    </div>

                    <!-- Location Input -->
                    <div class="row mb-3">
                        <label for="OPLocation">Location</label>
                        <input type="text" class="form-control" id="OPLocation">
                    </div>

                    <!-- New Input Fields for CR, Linear Meter, Floor Area -->
                    
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label for="lineAndGradeFee">Line and Grade</label>
                            <input type="number" class="form-control" id="lineAndGrade">
                        </div>
                        <div class="col-md-2">
                            <label for="electricalFee">Electrical</label>
                            <input type="number" class="form-control" id="electrical">
                        </div>
                        <div class="col-md-2">
                            <label for="numCR">Sanitary</label>
                            <input type="number" class="form-control" id="numCR" min="0" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="lineMeter">Fence Line Meter (LM)</label>
                            <input type="number" class="form-control" id="lineMeter" min="0" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="floorArea">Floor Area (sqm)</label>
                            <input type="number" class="form-control" id="floorArea" min="0" value="0">
                        </div>
                    </div>

                    <!-- Existing Fields for Fee Breakdown -->
                    <label for="bp220">Building Permit-BP220</label>
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label for="bpArea">Area Fee</label>
                            <input type="number" class="form-control" id="bpArea" readonly>
                        </div>

                        <div class="col-md-2">
                            <label for="bpLM">Line Meter Fee (LM)</label>
                            <input type="number" class="form-control" id="bpLM" readonly>
                        </div>

                        <div class="col-md-2">
                            <label for="bpSAN">Sanitary Fee (SAN)</label>
                            <input type="number" class="form-control" id="bpSAN" readonly>
                        </div>

                        <div class="col-md-2">
                            <label for="bpELEC">Electrical Fee (ELEC)</label>
                            <input type="number" class="form-control" id="bpELEC" readonly>
                        </div>

                        <div class="col-md-3">
                            <label for="bpTotal">Total</label>
                            <input type="number" class="form-control" id="bpTotal" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                
                <button type="button" class="btn btn-secondary" id="printOrderButton" disabled>
                    <i class="fa-solid fa-print"></i> Print
                </button>
                
            </div>
        </div>
    </div>
</div>


<!--Hidden Table-->
<table id="orderOfPaymentTable" style="display:none;">
    <tr>
      <th>Field</th>
      <th>Value</th>
    </tr>
    <tr>
      <td>Owner/Applicant</td>
      <td id="tableOwnerApplicant"></td>
    </tr>
    <tr>
      <td>Location</td>
      <td id="tableLocation"></td>
    </tr>
    <tr>
      <td>Line and Grade</td>
      <td id="tableLineAndGrade"></td>
    </tr>
    <tr>
      <td>Electrical</td>
      <td id="tableElectrical"></td>
    </tr>
    <tr>
      <td>Sanitary</td>
      <td id="tableSanitary"></td>
    </tr>
    <tr>
      <td>Fence Line Meter</td>
      <td id="tableLineMeter"></td>
    </tr>
    <tr>
      <td>Floor Area</td>
      <td id="tableFloorArea"></td>
    </tr>
    <tr>
      <td>Building Permit Area</td>
      <td id="tableBpArea"></td>
    </tr>
    <tr>
      <td>Building Permit Line Meter Fee</td>
      <td id="tableBpLM"></td>
    </tr>
    <tr>
      <td>Building Permit Sanitary Fee</td>
      <td id="tableBpSAN"></td>
    </tr>
    <tr>
      <td>Building Permit Electrical Fee</td>
      <td id="tableBpELEC"></td>
    </tr>
    <tr>
      <td>Total</td>
      <td id="tableBpTotal"></td>
    </tr>
  </table>
  

  <!-- View HSD Form Modal -->
<div class="modal fade" id="viewHSDFormModal" tabindex="-1" aria-labelledby="viewHSDFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- Made the modal larger for better presentation -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewHSDFormModalLabel">HSD Form Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            
                <!-- Display HSD form details organized in rows and columns -->
                <div class="container">
                    <!-- Row 1 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Date Submitted:</strong> <span id="hsdFormDateSubmitted"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Owner Name:</strong> <span id="hsdFormOwnerName"></span></p>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Phone Number:</strong> <span id="hsdPhoneNumber"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Address:</strong> <span id="hsdFormAddress"></span></p>
                        </div>
                    </div>
                    <!-- Row 3 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Project Location:</strong> <span id="hsdFormProjectLocation"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Scope of Work:</strong> <span id="hsdFormScopeOfWork"></span></p>
                        </div>
                    </div>
                    <!-- Row 4 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Project Justification:</strong> <span id="hsdFormProjectJustification"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Block Number:</strong> <span id="hsdFormBlockNumber"></span></p>
                        </div>
                    </div>
                    <!-- Row 5 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Lot Number:</strong> <span id="hsdFormLotNumber"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Number Of Units:</strong> <span id="hsdFormNOUnits"></span></p>
                        </div>
                    </div>
                    <!-- Row 6 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Floor Area Per Unit:</strong> <span id="hsdFormFloorArea"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Floor Area:</strong> <span id="hsdFormTotalFloorArea"></span></p>
                        </div>
                    </div>
                    <!-- Row 7 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Total Estimated Cost:</strong> <span id="hsdFormTotalEstimatedCost"></span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            
                    <button type="button" class="btn btn-primary" onclick="exportToExcel()"><i class="fa-solid fa-print"></i>  Print</button>
            

            </div>
        </div>
    </div>
</div>

 <!-- View Uploads Modal -->
 <div class="modal fade" id="viewUploadsModal" tabindex="-1" aria-labelledby="viewUploadsModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewUploadsModalLabel">Uploaded Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Uploaded Files List -->
                    <div class="col-lg-12">
                        <ul id="uploadedFilesList" class="list-group">
                            <!-- Dynamically append files here -->
                        </ul>
                    </div>
                </div>
                <!-- Comment Summary Section -->
                <div id="commentSummaryContainer" class="mt-3">
                    <h6>File Validation Comments</h6>
                    <ul id="commentSummaryList" class="list-group">
                        <!-- Comments will be summarized here -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="filePreviewContainer" style="display: none;"> <!-- Hidden by default -->
                    <iframe id="filePreview" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                </div>
                <div class="mt-3">
                    <label>Validation:</label><br>
                    <input type="radio" name="validationOptions" value="approved" id="approvedOption">
                    <label for="approvedOption">Approve</label><br>
                    <input type="radio" name="validationOptions" value="disapproved" id="disapprovedOption">
                    <label for="disapprovedOption">Disapprove</label>
                </div>
                <div class="mt-3">
                    <label for="validationComments">Comments:</label>
                    <textarea class="form-control" id="validationComments" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveValidationBtn">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="notificationContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050; display: none;">
    <!-- Notifications will be dynamically added here -->
</div>


                        <script type="module" src="/Database/firebase.js"></script>

                        <script type="module">
                               import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, getDocs, updateDoc, doc, getDoc, addDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  
      // Firebase configuration
      const firebaseConfig = {
          apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
          authDomain: "chsd-mis.firebaseapp.com",
          projectId: "chsd-mis",
          storageBucket: "chsd-mis.appspot.com",
          messagingSenderId: "694967679357",
          appId: "1:694967679357:web:65cffd50f13739f934f414",
          measurementId: "G-XBQTQFRLJ5"
      };
  
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
  
      async function addBuildingPermit(event) {
    event.preventDefault();

    // Show the loading screen
    document.getElementById('loading-screen').style.display = 'flex';

    const buildingPermitNo = document.getElementById('buildingPermitNo').value;
    const issuedOn = document.getElementById('basic-url').value;
    const addressTelNo = document.getElementById('addressTelNo').value;
    const projectLocation = document.getElementById('projectLocation').value;
    const hsdFormNo = document.getElementById('hsdFormNo').value;
    const phoneNumber = document.getElementById('phoneNumber').value;
    const ownerLastName = document.getElementById('ownerLastName').value;
    const ownerFirstName = document.getElementById('ownerFirstName').value;
    const ownerMiddleName = document.getElementById('ownerMiddleName').value;
    const ownerMaidenName = document.getElementById('ownerMaidenName').value;
    const ownerEmail = document.getElementById('ownerEmail') ? document.getElementById('ownerEmail').value : null;

    const ownerName = `${ownerLastName} ${ownerFirstName} ${ownerMiddleName} ${ownerMaidenName}`;

    const scopeOfWork = document.querySelector('input[name="scopeOfWork"]:checked').nextElementSibling.textContent;
    const projectJustification = document.querySelector('input[name="projectJustification"]:checked').nextElementSibling.textContent;
    
    const otherScopeInput = document.getElementById("otherScopeInput").value;
    const finalScopeOfWork = (scopeOfWork === 'Others' && otherScopeInput) ? otherScopeInput : scopeOfWork;
   
    const blockNumber = document.getElementById("blockNumber").value;
    const lotNumber = document.getElementById("lotNumber").value;
    const NOUnits = document.getElementById("NOUnits").value;
    const FloorArea = document.getElementById("FloorArea").value;
    const TotalFloorArea = document.getElementById("TotalFloorArea").value;
    const TotalEstimatedCost = document.getElementById("TotalEstimatedCost").value;
    try {
        const user = auth.currentUser;
        if (!user) {
            console.error("No user logged in.");
            return;
        }

        const { isAdminPC, isAdminIS } = await checkUserRole(user.uid);
        const isAdmin = isAdminPC || isAdminIS;

        let ownerUid;

        if (isAdmin && ownerEmail) {
            const defaultPassword = 'sample'; 
            const userCredential = await createUserWithEmailAndPassword(auth, ownerEmail, defaultPassword);
            const newUser = userCredential.user;
            ownerUid = newUser.uid;
        } else {
            ownerUid = user.uid;
        }

        const permitDocRef = await addDoc(collection(db, "buildingPermits"), {
            buildingPermitNo,
            issuedOn,
            ownerName,
            phoneNumber,
            addressTelNo,
            projectLocation,
            hsdFormNo,
            scopeOfWork: finalScopeOfWork,
            projectJustification,
            ownerUid: ownerUid,
            status: 'Pending',
            blockNumber,
            lotNumber,
            NOUnits,
            FloorArea,
            TotalFloorArea,
            TotalEstimatedCost,
            createdAt: Timestamp.now()
        });

        await updateDoc(doc(db, 'users', ownerUid), {
            buildingPermits: arrayUnion({
                permitId: permitDocRef.id,
                buildingPermitNo,
                issuedOn,
                status: 'Pending',
                projectLocation
            })
        });

        // Open the modal
        const applicationModal = new bootstrap.Modal(document.getElementById('applicationAppliedModal'));
        applicationModal.show();

    } catch (error) {
        console.error("Error adding profile or creating user:", error);

        if (error.code === "auth/missing-email") {
            alert("User creation is not allowed for non-admin users. Please contact an administrator.");
        } else {
            alert("Failed to submit application. Please try again later.");
        }
    } finally {
        // Hide the loading screen
        document.getElementById('loading-screen').style.display = 'none';
    }
}



      // Notification Function
        function showNotification(message, type) {
            const notificationContainer = document.getElementById('notification-container');
            if (notificationContainer) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notificationContainer.appendChild(notification);
                alert("status updated successfully");

                // Automatically remove notification after 5 seconds
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            } else {
                console.error('Notification container not found.');
            }
        }

    
// Function to Dynamically Append Buttons to the View Details Modal
function appendButtons(data) {
    const viewDetailsModalBtnGrp = document.getElementById('viewDetailsModalBtnGrp');
    viewDetailsModalBtnGrp.innerHTML = ''; // Clear existing buttons

    // First Row of Buttons
    const firstRow = document.createElement('div');
    firstRow.className = 'row mt-4';

    // View HSD Form Button
    const col1 = document.createElement('div');
    col1.className = 'col-md-6 mb-2';
    const btn1 = document.createElement('button');
    btn1.className = 'btn btn-primary w-100 view-hsd-btn';
    btn1.setAttribute('data-permit-id', data.id);
    btn1.textContent = 'View HSD Form';
    btn1.addEventListener('click', () => {
    const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
    if (viewDetailsModal) {
        viewDetailsModal.hide(); // Hide View Details Modal
    }
    // Open View HSD Form Modal
    openViewHSDFormModal(data); // Open HSD Form Modal
});

col1.appendChild(btn1);

    // View File Uploads Button
    const col2 = document.createElement('div');
    col2.className = 'col-md-6 mb-2';
    const btn2 = document.createElement('button');
    btn2.className = 'btn btn-primary w-100';
    btn2.textContent = 'View File Uploads';
    btn2.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) {
            viewDetailsModal.hide(); // Hide View Details Modal
        }
        openViewUploadsModal(data); // Open View Uploads Modal
    });
    col2.appendChild(btn2);

    firstRow.appendChild(col1);
    firstRow.appendChild(col2);

    // Second Row of Buttons
    const secondRow = document.createElement('div');
    secondRow.className = 'row mt-2';

    const col3 = document.createElement('div');
    col3.className = 'col-md-12';
    const btn3 = document.createElement('button');
    btn3.className = 'btn btn-success w-100 generate-order-payment-btn';
    btn3.textContent = 'Generate Order of Payment';

    // Add event listener for generating Order of Payment
    btn3.addEventListener('click', () => {
        generateOrderOfPayment(data); // Generate order of payment using the data
        
        // Hide the View Details modal
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) {
            viewDetailsModal.hide(); // Hide View Details Modal
        }

        // Trigger Order of Payment Modal
        const orderOfPaymentModal = new bootstrap.Modal(document.getElementById('orderOfPaymentModal'));
        orderOfPaymentModal.show();

        // Remove the backdrop manually after the modal closes to avoid the lingering backdrop
        document.getElementById('orderOfPaymentModal').addEventListener('hidden.bs.modal', function () {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove(); // Ensure the backdrop is removed
            }
        });
    });

    col3.appendChild(btn3);
    secondRow.appendChild(col3);

    // Third Row for Archive Button
    const thirdRow = document.createElement('div');
    thirdRow.className = 'row mt-2';

    const col4 = document.createElement('div');
    col4.className = 'col-md-12';
    const btn4 = document.createElement('button');
    btn4.className = 'btn btn-danger w-100 archive-permit-btn';
    btn4.textContent = 'Archive Permit';
    btn4.setAttribute('data-id', data.id);

    // Add event listener for archiving the building permit
    btn4.addEventListener('click', (event) => handleArchiveBuildingPermit(event));

    col4.appendChild(btn4);
    thirdRow.appendChild(col4);

    // Append Rows to Button Group
    viewDetailsModalBtnGrp.appendChild(firstRow);
    viewDetailsModalBtnGrp.appendChild(secondRow);
    viewDetailsModalBtnGrp.appendChild(thirdRow);
}


let fileValidationStatus = {}; // For tracking file validation status and comments

async function openViewUploadsModal(permitData) {
    try {
        console.log("Fetching uploaded files and validation status for permit:", permitData.id);

        // Fetch the building permit document from Firestore
        const permitDocRef = doc(db, "buildingPermits", permitData.id);
        const permitSnapshot = await getDoc(permitDocRef);

        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const commentSummaryList = document.getElementById('commentSummaryList');
        uploadedFilesList.innerHTML = '';  // Clear existing files
        commentSummaryList.innerHTML = ''; // Clear previous comments

        if (!permitSnapshot.exists()) {
            const noFilesItem = document.createElement('li');
            noFilesItem.className = 'list-group-item';
            noFilesItem.textContent = 'No files uploaded.';
            uploadedFilesList.appendChild(noFilesItem);
        } else {
            const permitData = permitSnapshot.data();
            const { buildingPlanURL, proofOwnershipURL, fileValidationStatus = {} } = permitData;

            if (!buildingPlanURL && !proofOwnershipURL) {
                const noFilesItem = document.createElement('li');
                noFilesItem.className = 'list-group-item';
                noFilesItem.textContent = 'No files uploaded.';
                uploadedFilesList.appendChild(noFilesItem);
            } else {
                const createFileItem = (fileLabel, fileURL, fileRowId) => {
                    const fileItem = document.createElement('li');
                    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    fileItem.dataset.rowid = fileRowId;

                    fileItem.innerHTML = `
                        <span>${fileLabel}</span>
                        <div>
                            <a href="${fileURL}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-eye"></i></a>
                            <button class="btn btn-sm btn-outline-success validation-btn" data-fileurl="${fileURL}" data-filelabel="${fileLabel}" data-rowid="${fileRowId}"><i class="fa-solid fa-list-check"></i></button>
                        </div>`;

                    // Attach validation event to open the validation modal
                    const validationButton = fileItem.querySelector('.validation-btn');
                    validationButton.addEventListener('click', (event) => {
                        const fileRow = document.querySelector(`[data-rowid="${event.currentTarget.dataset.rowid}"]`);
                        openValidationModal(event.currentTarget.dataset.fileurl, event.currentTarget.dataset.filelabel, fileRow);
                    });

                    uploadedFilesList.appendChild(fileItem);
                };

                // Display each uploaded file
                if (buildingPlanURL) createFileItem('Building Plan', buildingPlanURL, 'buildingPlan');
                if (proofOwnershipURL) createFileItem('Proof of Ownership', proofOwnershipURL, 'proofOwnership');

                // Check for validation comments and status
                for (const fileRowId in fileValidationStatus) {
                    const { status, comments } = fileValidationStatus[fileRowId];
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1); // Capitalize first letter
                    const commentPrefix = `${fileRowId.replace(/([A-Z])/g, ' $1').trim()} - ${statusText} - `;

                    const commentSummaryItem = document.createElement('li');
                    commentSummaryItem.className = 'list-group-item';
                    commentSummaryItem.dataset.commentid = fileRowId;
                    commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;

                    commentSummaryList.appendChild(commentSummaryItem);
                }
            }
        }

        // Show the View Uploads Modal
        const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
        viewUploadsModal.show();

    } catch (error) {
        console.error("Error fetching uploads:", error);
        alert("Failed to load uploaded files.");
    }
}

function openValidationModal(fileURL, fileLabel, fileRow) {
    // Hide view uploads modal
    const viewUploadsModal = bootstrap.Modal.getInstance(document.getElementById('viewUploadsModal'));
    viewUploadsModal.hide();

    const validationModalLabel = document.getElementById('validationModalLabel');
    const commentsInput = document.getElementById('validationComments');
    const previewContainer = document.getElementById('filePreviewContainer');
    const filePreview = document.getElementById('filePreview');

    validationModalLabel.textContent = `Validation for ${fileLabel}`;
    commentsInput.value = ''; // Clear previous comments

    // Reset preview
    previewContainer.style.display = 'none';
    filePreview.src = ''; // Clear previous preview

    // Check file type for preview
    if (fileURL.endsWith('.pdf')) {
        filePreview.src = fileURL; // Set PDF URL for preview
        previewContainer.style.display = 'block'; // Show the preview container for PDFs
        filePreview.type = "application/pdf"; // Ensure it's treated as PDF
    } else {
        // For images and other types, show image preview
        filePreview.src = fileURL;
        previewContainer.style.display = 'block'; // Show preview for images
        filePreview.type = "image"; // Treat as image for other formats
    }

    // Store fileRow ID in save button for later validation
    const saveBtn = document.getElementById('saveValidationBtn');
    saveBtn.dataset.filerow = fileRow.dataset.rowid;

    saveBtn.removeEventListener('click', saveValidation);  // Remove previous listener
    saveBtn.addEventListener('click', saveValidation);      // Add new listener

    // Show the validation modal
    const validationModal = new bootstrap.Modal(document.getElementById('validationModal'));
    validationModal.show();
}

async function saveValidation() {
    const selectedOption = document.querySelector('input[name="validationOptions"]:checked');
    if (!selectedOption) {
        alert('Please select an option (approve/disapprove).');
        return;
    }

    const comments = document.getElementById('validationComments').value;
    const fileRowId = document.getElementById('saveValidationBtn').dataset.filerow;
    const fileRow = document.querySelector(`[data-rowid="${fileRowId}"]`);

    fileValidationStatus[fileRowId] = {
        status: selectedOption.value,
        comments: comments
    };

    const permitId = document.getElementById('hiddenPermitId').value;

    if (!permitId) {
        console.error('Permit ID is not available.');
        alert('Error: Permit data is missing.');
        return;
    }

    const permitDocRef = doc(db, "buildingPermits", permitId);
    try {
        await updateDoc(permitDocRef, {
            [`fileValidationStatus.${fileRowId}`]: {
                status: selectedOption.value,
                comments: comments
            }
        });
        console.log('Validation saved to Firestore');
    } catch (error) {
        console.error("Error saving validation to Firestore:", error);
        alert("Failed to save validation.");
    }

    // Close validation modal and reopen the view uploads modal
    const validationModal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
    validationModal.hide();

    const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
    viewUploadsModal.show();

    // Update the comment summary section
    const commentSummaryList = document.getElementById('commentSummaryList');
    let existingComment = commentSummaryList.querySelector(`[data-commentid="${fileRowId}"]`);

    const statusText = selectedOption.value.charAt(0).toUpperCase() + selectedOption.value.slice(1); // Capitalize the first letter
    const commentPrefix = `${fileRow.querySelector('span').textContent} - ${statusText} - `;

    if (existingComment) {
        // Update the existing comment
        existingComment.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
    } else {
        // Create a new comment if not already existing
        const commentSummaryItem = document.createElement('li');
        commentSummaryItem.className = 'list-group-item';
        commentSummaryItem.dataset.commentid = fileRowId; // Use the same fileRowId to identify the comment
        commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
        commentSummaryList.appendChild(commentSummaryItem);
    }
}

// Function to check if all required fields are filled
function checkIfAllFieldsFilled() {
    const numCR = document.getElementById('numCR').value.trim();
    const lineMeter = document.getElementById('lineMeter').value.trim();
    const floorArea = document.getElementById('floorArea').value.trim();
    const lineAndGrade = document.getElementById('lineAndGrade').value.trim();
    const electrical = document.getElementById('electrical').value.trim();
    const ownerName = document.getElementById("OPOwner/Applicant").value.trim();
    const location = document.getElementById("OPLocation").value.trim();

    // Enable button only if all fields are filled
    const printButton = document.getElementById('printOrderButton');
    if (numCR && lineMeter && floorArea && lineAndGrade && electrical && ownerName && location) {
        printButton.disabled = false; // Enable the button
    } else {
        printButton.disabled = true; // Disable the button
    }
}

// Function to generate Order of Payment with calculations
function generateOrderOfPayment(Data) {
    try {
        // Fetch and set owner and location data if provided
        const ownerNameField = document.getElementById("OPOwner/Applicant");
        const locationField = document.getElementById("OPLocation");

        if (Data && Data.ownerName) {
            ownerNameField.value = Data.ownerName;  // Set owner name from Data
        }
        if (Data && Data.projectLocation) {
            locationField.value = Data.projectLocation;  // Set location from Data
        }

        // Get numeric values from input fields, default to 0 if not a valid number
        const numCR = parseFloat(document.getElementById('numCR').value) || 0;
        const lineMeter = parseFloat(document.getElementById('lineMeter').value) || 0;
        const floorArea = parseFloat(document.getElementById('floorArea').value) || 0;
        const lineAndGrade = parseFloat(document.getElementById('lineAndGrade').value) || 0;
        const electrical = parseFloat(document.getElementById('electrical').value) || 0;

        // Calculate fees
        const crFee = numCR * 100.00;
        const fenceFee = lineMeter * 7.00;
        const floorAreaFee = floorArea * 7.20;
        const lineAndGradeFee = lineAndGrade * 120.00;
        const electricalFee = electrical * 200.00;

        // Calculate total payment
        const total = lineAndGradeFee + electricalFee + crFee + fenceFee + floorAreaFee;

        // Populate Order of Payment Modal Fields with calculated values
        document.getElementById('bpArea').value = floorAreaFee.toFixed(2);
        document.getElementById('bpLM').value = fenceFee.toFixed(2);
        document.getElementById('bpSAN').value = crFee.toFixed(2);
        document.getElementById('bpELEC').value = electricalFee.toFixed(2);
        document.getElementById('bpTotal').value = total.toFixed(2);

        console.log("Order of Payment calculated and modal populated.");
        
    } catch (error) {
        console.error("Error generating Order of Payment:", error);
        alert("Failed to generate order of payment.");
    }
}

// Attach 'input' event listeners to fields to trigger automatic calculation
const inputs = ['numCR', 'lineMeter', 'floorArea', 'lineAndGrade', 'electrical', 'OPOwner/Applicant', 'OPLocation'];
inputs.forEach(id => {
    document.getElementById(id).addEventListener('input', () => {
        generateOrderOfPayment({}); // Pass an empty object if no Data is available
        checkIfAllFieldsFilled(); // Check if the button should be enabled
    });
});

// Initial check in case fields are already filled (e.g., from previous inputs)
checkIfAllFieldsFilled();



    // Pagination Variables
        let profilesPerPage = 50; // Profiles per page
        let currentPage = 1; // Current page
        let totalPages = 1; // Total pages
        // Function to Load Building Permits and Display in the Table
        async function loadProfiles() {
            try {
                const querySnapshot = await getDocs(collection(db, "buildingPermits"));
                const buildingPermitDiv = document.getElementById("buildingPermitDiv");
                const prevPageBtn = document.getElementById("prevPageBtn");
                const nextPageBtn = document.getElementById("nextPageBtn");
                const pageInfo = document.getElementById("pageInfo");

                if (!buildingPermitDiv) {
                    console.error("buildingPermitDiv not found in the DOM.");
                    return;
                }

                const tableBody = buildingPermitDiv.querySelector("tbody");
                if (!tableBody) {
                    console.error("Table body not found in buildingPermitDiv.");
                    return;
                }

                tableBody.innerHTML = ""; // Clear existing rows

                // Fetch and Process Permits Data
                const permitsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const uniquePermitsData = Array.from(new Set(permitsData.map(a => a.id)))
                    .map(id => permitsData.find(a => a.id === id));

                // Sort by createdAt (ascending)
                uniquePermitsData.sort((a, b) => {
                    const aTime = a.createdAt?.seconds || 0;
                    const bTime = b.createdAt?.seconds || 0;
                    return aTime - bTime;
                });

                // Calculate Total Pages
                totalPages = Math.ceil(uniquePermitsData.length / profilesPerPage);

                // Determine Profiles for Current Page
                const start = (currentPage - 1) * profilesPerPage;
                const end = start + profilesPerPage;
                const currentProfiles = uniquePermitsData.slice(start, end);

                // Loop Through Profiles and Populate Table
                for (const data of currentProfiles) {
                    const row = document.createElement("tr");

                    // Fetch Representative User Data
                    let representativeName = "";
                    if (data.ownerUid) {
                        try {
                            const userRef = doc(db, "users", data.ownerUid);
                            const userDoc = await getDoc(userRef);
                            if (userDoc.exists()) {
                                const userData = userDoc.data();
                                representativeName = `${userData.firstName} ${userData.lastName}`;
                            }
                        } catch (error) {
                            console.error("Error fetching user data:", error);
                        }
                    }

                    const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";

                    row.innerHTML = `
                        <td>${data.ownerName || "N/A"}</td>
                        <td>${representativeName || "N/A"}</td>
                        <td>${createdAt}</td>
                        <td>${data.status || "N/A"}</td>
                        <td>
                            <button class="btn btn-primary btn-sm view-details-btn" data-permit-id="${data.id}">View Details</button>
                        </td>
                    `;

                    tableBody.appendChild(row);

                    // Add Event Listener for "View Details" Button
                    const viewDetailsBtn = row.querySelector(".view-details-btn");
                    if (viewDetailsBtn) {
                        viewDetailsBtn.addEventListener("click", () => {
                            openViewDetailsModal(data);
                        });
                    }
                }

                // Update Pagination Info
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

                // Enable/Disable Pagination Buttons
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;

            } catch (error) {
                console.error("Error loading profiles:", error);
                showNotification("Failed to load profiles.", "error");
            }
        }

        // Function to Control Progressive Status Selection
        function updateStatusOptions(currentStatus) {
            const statusSelect = document.getElementById("statusSelect");

            const statusProgression = {
                "Pending": ["Pending", "Processing"],
                "Processing": ["Processing", "To Pay"],
                "To Pay": ["To Pay", "For Approval"],
                "For Approval": ["For Approval", "For Release"],
                "For Release": ["For Release", "Claimed"],
                "Claimed": ["Claimed"]
            };

            const validStatuses = statusProgression[currentStatus] || [];

            const options = statusSelect.querySelectorAll("option");
            options.forEach(option => {
                if (validStatuses.includes(option.value)) {
                    option.style.display = "block"; // Show valid options
                } else {
                    option.style.display = "none"; // Hide invalid options
                }
            });

            // Set the statusSelect to the currentStatus
            statusSelect.value = currentStatus;
        }

        // Function to Open the View Details Modal
        function openViewDetailsModal(permitData) {
            // Populate Modal Fields

            const appointmentDate = permitData.appointmentDate ? new Date(permitData.appointmentDate.seconds * 1000).toLocaleString() : "N/A";
            document.getElementById("permitOwnerName").textContent = permitData.ownerName || "N/A";
            document.getElementById("issuedOnDate").textContent = permitData.issuedOn || "N/A";
            document.getElementById("appointmentDateSched").textContent = appointmentDate || "N/A";
            document.getElementById("permitIdDisplay").textContent = permitData.id || "N/A";
            document.getElementById("hiddenPermitId").value = permitData.id || "";

            // Update Status Options
            updateStatusOptions(permitData.status || "Pending");

            // Append Dynamic Buttons
            appendButtons(permitData);

            // Show the Modal
            const viewDetailsModal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
            viewDetailsModal.show();

            // Add Event Listener for the Save Button (Ensure it's not duplicated)
            const saveStatusBtn = document.getElementById("saveStatusBtn");
            saveStatusBtn.onclick = async () => {
                const newStatus = document.getElementById("statusSelect").value;
                try {
                    // Update Status in Firestore
                    await updateDoc(doc(db, 'buildingPermits', permitData.id), { status: newStatus });

                    // Trigger Notification
                    const message = `${permitData.ownerName}'s building permit is now ${newStatus.toLowerCase()}`;
                    showNotification(message, 'info');


                    // Store Notification in Firestore
                    await addDoc(collection(db, "notifications"), {
                        userId: permitData.ownerUid,
                        message: message,
                        permitId: permitData.id,
                        timestamp: serverTimestamp(),
                        read: false
                    });
                    alert("status updated successfully");

                    // Reload Profiles to Reflect Changes
                    loadProfiles();

                    // Hide Modal
                    viewDetailsModal.hide();

                } catch (error) {
                    console.error("Error updating permit status:", error);
                    showNotification("Failed to update permit status.", "error");
                }
            };
        }

      // Function to Open the View HSD Form Modal with Debugging
// Function to Open the View HSD Form Modal
async function openViewHSDFormModal(permitData) {
    try {
        console.log("Permit Data received:", permitData); // Log permitData to ensure it's not empty

        // Fetch the data from the buildingPermits collection based on the permitId
        const hsdFormData = await getDoc(doc(db, "buildingPermits", permitData.id));

        if (!hsdFormData.exists()) {
            console.error("HSD Form (Building Permit) not found!");
            alert("HSD Form data is missing!");
            return;
        }

        const data = hsdFormData.data();
        console.log("HSD Form Data retrieved:", data); // Log the fetched data to ensure it's being retrieved correctly

        // Populate HSD Form Modal Fields
        
        document.getElementById('hsdFormOwnerName').textContent = data.ownerName;
        document.getElementById('hsdFormAddress').textContent = data.projectLocation || "N/A";
        document.getElementById('hsdFormDateSubmitted').textContent = data.issuedOn;
        document.getElementById("hsdPhoneNumber").textContent = data.phoneNumber;
        document.getElementById("hsdFormProjectLocation").textContent= data.projectLocation;
        document.getElementById("hsdFormScopeOfWork").textContent = data.scopeOfWork;
        document.getElementById("hsdFormProjectJustification").textContent = data.projectJustification;
        document.getElementById("hsdFormBlockNumber").textContent = data.blockNumber || "N/A";
        document.getElementById("hsdFormLotNumber").textContent = data.lotNumber || "N/A";
        document.getElementById("hsdFormNOUnits").textContent = data.NOUnits || "N/A";
        document.getElementById("hsdFormFloorArea").textContent = data.FloorArea || "N/A";
        document.getElementById("hsdFormTotalFloorArea").textContent = data.TotalFloorArea || "N/A";
        document.getElementById("hsdFormTotalEstimatedCost").textContent = data.TotalEstimatedCost || "N/A";

        console.log("HSD Form fields populated");

        // Show the HSD Form Modal
        const viewHSDFormModal = new bootstrap.Modal(document.getElementById('viewHSDFormModal'));
        viewHSDFormModal.show();
    } catch (error) {
        console.error("Error opening HSD Form modal:", error);
        alert("Failed to load HSD form data.");
    }
}



        // Function to Archive a Building Permit
async function handleArchiveBuildingPermit(event) {
    event.preventDefault();

    const buildingPermitId = event.target.getAttribute('data-id');

    if (!buildingPermitId) {
        console.error("Building Permit ID is null or undefined.");
        showNotification("Error: Building Permit ID is missing.", "error");
        return;
    }

    const confirmed = confirm("Are you sure you want to archive this document?");
    
    if (!confirmed) {
        return;
    }

    try {
        const buildingPermitRef = doc(db, "buildingPermits", buildingPermitId);
        const buildingPermitSnapshot = await getDoc(buildingPermitRef);

        if (buildingPermitSnapshot.exists()) {
            const buildingPermitData = buildingPermitSnapshot.data();
            
            await setDoc(doc(db, "archivedBuildingPermits", buildingPermitId), buildingPermitData);
            await deleteDoc(buildingPermitRef);

            // Remove the row from the table
            const tableBody = document.querySelector("#buildingPermitDiv tbody");
            const rowToRemove = tableBody.querySelector(`button[data-permit-id="${buildingPermitId}"]`).closest('tr');
            if (rowToRemove) rowToRemove.remove();

            showNotification("Document archived successfully!", "success");

            // Close the modal
            const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
            if (viewDetailsModal) {
                viewDetailsModal.hide(); // Hide View Details Modal
            }

        } else {
            showNotification("Document not found!", "error");
        }
    } catch (error) {
        console.error("Error archiving document: ", error);
        showNotification(`Failed to archive document: ${error.message}`, "error");
    }
}

        // Function to Search Permits by Owner or Representative Name
        function searchPermits() {
            const searchInput = document.getElementById("searchInput").value.toLowerCase();
            const tableRows = document.querySelectorAll("#buildingPermitDiv tbody tr");

            let resultsFound = false; // To track if any results are found

            tableRows.forEach(row => {
                const ownerName = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
                const representativeName = row.querySelector("td:nth-child(2)").textContent.toLowerCase();

                // Check if the search input matches either the owner name or representative name
                if (ownerName.includes(searchInput) || representativeName.includes(searchInput)) {
                    row.style.display = ""; // Show the row
                    resultsFound = true; // Mark that we found results
                } else {
                    row.style.display = "none"; // Hide the row if it doesn't match
                }
            });

            // Display a 'No results found' message if no results match
            const existingNoResults = document.getElementById("noResultsMessage");
            if (!resultsFound) {
                if (!existingNoResults) {
                    const newRow = document.createElement("tr");
                    newRow.id = "noResultsMessage";
                    newRow.innerHTML = `<td colspan="5" class="text-center">No results found</td>`;
                    document.querySelector("#buildingPermitDiv tbody").appendChild(newRow);
                }
            } else if (existingNoResults) {
                existingNoResults.remove(); // Remove the 'No results' message if results are found
            }
        }

        // Initialize Pagination and Load Profiles
        document.addEventListener("DOMContentLoaded", () => {
            const prevPageBtn = document.getElementById("prevPageBtn");
            const nextPageBtn = document.getElementById("nextPageBtn");

            // Event Listener for Previous Page Button
            prevPageBtn.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadProfiles();
                }
            });

            // Event Listener for Next Page Button
            nextPageBtn.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadProfiles();
                }
            });

            // Event Listener for Search Input
            const searchInput = document.getElementById("searchInput");
            searchInput.addEventListener("input", searchPermits);

            // Load Profiles Initially
            loadProfiles();
        });

                        </script>

                        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
                            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
                            crossorigin="anonymous"></script>
                        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
                            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
                            crossorigin="anonymous"></script>
                        <script src="https://kit.fontawesome.com/8d1b0b1c7b.js" crossorigin="anonymous"></script>
                        <!--Navigation Bar-->
                        <script>
                            document.querySelector('.open-btn').addEventListener('click', function () {
                                document.getElementById('side_nav').classList.add('active');
                            });

                            document.querySelector('.close-btn').addEventListener('click', function () {
                                document.getElementById('side_nav').classList.remove('active');
                            });
                        </script>

                        <!-- Toggle Others -->
                        <script>
                            function toggleOtherScopeInput() {
                                const otherInput = document.getElementById("otherScopeInput");
                                const otherRadio = document.getElementById("option4");

                                if (otherRadio.checked) {
                                    otherInput.disabled = false;
                                } else {
                                    otherInput.disabled = true;
                                    otherInput.value = '';  // Clear the input if disabled
                                }
                            }

                            // Call the function on page load to ensure the state is correct
                            window.onload = toggleOtherScopeInput;
                        </script>

                       
                    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script>
        const fetchHSDFormData = () => {
    return {
        dateSubmitted: document.getElementById("hsdFormDateSubmitted").textContent,
        ownerName: document.getElementById("hsdFormOwnerName").textContent,
        phoneNumber: document.getElementById("hsdPhoneNumber").textContent,
        address: document.getElementById("hsdFormAddress").textContent,
        projectLocation: document.getElementById("hsdFormProjectLocation").textContent,
        scopeOfWork: document.getElementById("hsdFormScopeOfWork").textContent,
        projectJustification: document.getElementById("hsdFormProjectJustification").textContent,
        blockNumber: document.getElementById("hsdFormBlockNumber").textContent,
        lotNumber: document.getElementById("hsdFormLotNumber").textContent,
        numberOfUnits: document.getElementById("hsdFormNOUnits").textContent,
        floorAreaPerUnit: document.getElementById("hsdFormFloorArea").textContent,
        totalFloorArea: document.getElementById("hsdFormTotalFloorArea").textContent,
        totalEstimatedCost: document.getElementById("hsdFormTotalEstimatedCost").textContent
    };
};

const formatDataForExport = (formData) => {
    return [
        ["Date Submitted", formData.dateSubmitted],
        ["Owner Name", formData.ownerName],
        ["Phone Number", formData.phoneNumber],
        ["Address", formData.address],
        ["Project Location", formData.projectLocation],
        ["Scope of Work", formData.scopeOfWork],
        ["Project Justification", formData.projectJustification],
        ["Block Number", formData.blockNumber],
        ["Lot Number", formData.lotNumber],
        ["Number Of Units", formData.numberOfUnits],
        ["Floor Area Per Unit", formData.floorAreaPerUnit],
        ["Total Floor Area", formData.totalFloorArea],
        ["Total Estimated Cost", formData.totalEstimatedCost]
    ];
};

const exportToExcel = () => {
    const formData = fetchHSDFormData();
    const formattedData = formatDataForExport(formData);

    // Create a new workbook and add the formatted data
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(formattedData);

    // Append the worksheet to the workbook
    XLSX.utils.book_append_sheet(wb, ws, "HSD Form");

    // Export the workbook
    XLSX.writeFile(wb, "HSD_Form.xlsx");
};


    </script>



<script>
async function exportOrderOfPaymentToExcel() {
    try {
        // Load the Excel template
        const templatePath = 'Order-of-Payment.xlsx';

        const response = await fetch(templatePath);
        if (!response.ok) {
            throw new Error('Failed to fetch template: ' + response.statusText);
        }

        const templateData = await response.arrayBuffer();
        const workbook = XLSX.read(templateData, { type: 'array' });

        const worksheet = workbook.Sheets[workbook.SheetNames[0]];

        // Gather data from the modal inputs
        const ownerApplicant = document.getElementById('OPOwner/Applicant').value;
        const location = document.getElementById('OPLocation').value;
        const bpArea = document.getElementById('bpArea').value;
        const bpLM = document.getElementById('bpLM').value;
        const bpSAN = document.getElementById('bpSAN').value;
        const bpELEC = document.getElementById('bpELEC').value;
        const bpTotal = document.getElementById('bpTotal').value;

        // Fill in the data in the Excel template
        worksheet['D8'] = { v: ownerApplicant, t: 's' };  // Owner/Applicant
        worksheet['D10'] = { v: location, t: 's' };       // Location

        // Populate Building Permit - BP220 Section
        worksheet['E12'] = { v: bpArea, t: 'n' };    // AREA (Building Permit)
        worksheet['F12'] = { v: bpLM, t: 'n' };      // LM (Building Permit)
        worksheet['G12'] = { v: bpSAN, t: 'n' };     // SAN (Building Permit)
        worksheet['H12'] = { v: bpELEC, t: 'n' }; 
        worksheet['J28'] = { v: bpTotal, t: 'n' }; 
        
        // ELEC (Building Permit)

        // Export the modified workbook
        const newFileName = 'Order_of_Payment_Filled.xlsx';
        XLSX.writeFile(workbook, newFileName);

    } catch (error) {
        console.error('Error exporting to Excel:', error);
    }
}

// Helper function to handle binary string
function s2ab(s) {
    var buf = new ArrayBuffer(s.length);
    var view = new Uint8Array(buf);
    for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
    return buf;
}

// Add event listener for the Print button with the id 'printOrderButton'
document.getElementById('printOrderButton').addEventListener('click', exportOrderOfPaymentToExcel);


function populateTableWithFormData() {
    document.getElementById('tableOwnerApplicant').textContent = document.getElementById('OPOwner/Applicant').value;
    document.getElementById('tableLocation').textContent = document.getElementById('OPLocation').value;
    document.getElementById('tableLineAndGrade').textContent = document.getElementById('lineAndGrade').value;
    document.getElementById('tableElectrical').textContent = document.getElementById('electrical').value;
    document.getElementById('tableSanitary').textContent = document.getElementById('numCR').value;
    document.getElementById('tableLineMeter').textContent = document.getElementById('lineMeter').value;
    document.getElementById('tableFloorArea').textContent = document.getElementById('floorArea').value;
    document.getElementById('tableBpArea').textContent = document.getElementById('bpArea').value;
    document.getElementById('tableBpLM').textContent = document.getElementById('bpLM').value;
    document.getElementById('tableBpSAN').textContent = document.getElementById('bpSAN').value;
    document.getElementById('tableBpELEC').textContent = document.getElementById('bpELEC').value;
    document.getElementById('tableBpTotal').textContent = document.getElementById('bpTotal').value;
}


</script>
</body>

</html>
