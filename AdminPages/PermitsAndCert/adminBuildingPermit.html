<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link rel="icon" href="/resources/pictures/chsd.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

        
    <style>
        .modal-backdrop {
            z-index: 1040 !important; /* Ensure the z-index is set correctly */
        }

        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }

        .wide-modal {
            max-width: 80%;
        }

        .form-control {
            margin-bottom: 1rem; /* Add margin between form controls */
        }

        .form-check {
            margin-bottom: 0.5rem; /* Add margin between checkboxes */
        }

        .row.g-3 .col-md-6,
        .row.g-3 .col-md-4,
        .row.g-3 .col-md-12 {
            margin-bottom: 1rem; /* Add margin to columns */
        }

        .d-flex .me-2 {
            margin-right: 1rem; /* Add margin to the right of the input */
        }

        .modal-content {
            padding: 1.2rem !important;
        }

        @media(max-width: 991px) {
            .wide-modal {
                width: 100%;
                margin: auto;
            }
        }
        .btn-upload {
        padding: 8px 16px;
        background-color: #4CAF50 !important;
        color: white !important;
        border: none;
        cursor: pointer !important;
    }
    .btn-upload:hover {
        background-color: #45a049;
    }
    .file-item {
        display: flex;
        align-items: center;
    }
    .file-name {
        margin-right: 10px;
    }
    .btn-delete {
        color: red;
        cursor: pointer;
    }



    @media print {
  /* Hide all elements except the printable content */
  body * {
    visibility: hidden;
  }

  /* Make the printable content visible */
  .printArea, .printArea * {
    visibility: visible;
  }

  /* Ensure the print content adapts properly */
  .printArea {
    position: relative; /* Allow normal flow */
    width: 100%;
    height: auto;
    margin: 0 auto;
    padding: 10mm; /* Minimal padding for readability */
    box-sizing: border-box; /* Include padding in dimensions */
  }

  /* Specific styles for the Order of Payment content */
  #printOrderContent {
    position: static; /* Reset positioning */
    width: 100%; /* Take full width of the page */
    height: 50%; /* Restrict to half the page height */
    margin: 0 auto; /* Center horizontally */
    padding: 10mm; /* Padding for spacing */
    box-sizing: border-box;
    background: white; /* Ensure clean background for printing */
    overflow: hidden; /* Prevent overflow beyond half the page */
  }

  /* Define the A4 page size and margins */
  @page {
    size: A4; /* Set page size to A4 */
    margin: 10mm; /* Standard print margin */
  }

  /* Optional: Add clear separation for half-page print areas */
  #printOrderContent::after {
    content: '';
    display: block;
    height: 1px;
    background-color: #000; /* Optional divider line */
    margin-top: 10px; /* Space below the half-page content */
  }
}




#watermark {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Ensures it stays behind content */
        opacity: 1; /* Adjust for desired transparency */
        font-size: 3rem;
        color: gray;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none; /* Make sure it's non-interactive */
        transform: rotate(-45deg);
    }

    /* Spread watermark text across the page */
    #watermark span {
        display: inline-block;
        white-space: nowrap;
        margin: 2rem; /* Spacing between each watermark text */
        opacity: 0.2;
    }

    .file-approved {
    background-color: #d4edda !important; /* Light green */
}

.file-disapproved {
    background-color: #f8d7da !important; /* Light red */
}




    


    </style>
</head>

<body>
    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i
                        class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html"
                        class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html"
                        class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building
                        Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html"
                        class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy
                        Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html"
                        class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
                        <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCLogs.html" class="text-decoration-none"><i class="fa-solid fa-envelope"></i> Notifications</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html" class="text-decoration-none"><i class="fa-solid fa-gear"></i> Settings</a></li>
                
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html"
                        class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>
     
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log
                        out</a></li>
            </ul>
        </div>

        <div class="content">
            <!-- Navigation Bar -->
            <nav class="navigationBar navbar navbar-expand-lg bg-light">
                <div class="container-fluid">
                    <!-- Mobile View -->
                    <div class="d-flex justify-content-between d-md-none d-block">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40"
                                class="me-2">
                            <h5 class="mb-0 fs-5">CHSD</h5>
                        </a>
                        <button class="btn px-1 py-0 open-btn">
                            <i class="fa-solid fa-bars-staggered"></i>
                        </button>
                    </div>

                    <!-- Desktop View -->
                    <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75"
                                class="me-2">
                            <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
                        </a>
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <!-- Additional nav items go here -->
                        </ul>
                    </div>
                </div>
            </nav>

            <div class="contentContainer">
               
                <div class="container">
                    <h5>Profile</h5>
                    <div class="row mt-4">
                        <div class="col">
                            <a class="btn btn-dark text-white" data-bs-toggle="modal"
                                data-bs-target="#buildingPermitModal"><i class="fa-solid fa-plus"></i> Add
                                Profile</a>
                         
                        </div>

                        <div class="d-flex justify-content-end mb-3">
                            <input type="text" class="form-control search-bar" id="searchInput" placeholder="Search">
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button"><i
                                        class="fas fa-search"></i></button>
                            </div>
                        </div>

                        <h4 class="text-center">Building Permit</h4>

                        <div id="buildingPermitDiv">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Owner</th>
                                        <th>Representative</th>
                                        <th>Application Type</th>
                                        <th>Submitted at</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    
  
                                    <!-- Profile rows will be loaded here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Controls -->
                        <div class="pagination-controls text-center">
                            <button id="prevPageBtn" class="btn btn-primary" disabled>Previous</button>
                            <span id="pageInfo"></span>
                            <button id="nextPageBtn" class="btn btn-primary">Next</button>
                        </div>

                       <!-- Application Modal -->
<div class="modal fade" id="buildingPermitModal" tabindex="-1" aria-labelledby="BuildingPermitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content buldingPermitApplication">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="BuildingPermitModalLabel">Building Permit Application</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Application Modal Content -->
                <div class="container">
                  
               
                <form>
                   
                    <p><i>Required fields are marked with <span class="required-asterisk">*</span></i></p>
                   
                    <div class="row">
                        <div class="col-md-4">
                            <label for="buildingPermitNo">Building Permit Number:</label>
                            <input type="text" class="form-control" id="buildingPermitNo" placeholder="The Building Permit No. is Autogenerated" disabled>
                        </div>

                      
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableCredentials">
                                <label class="form-check-label" for="enableCredentials">Create Email and Password</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                       
                        <div class="col-md-4"> 
                            <label for="ownerEmail">Applicant Email:</label>
                            <input type="email" class="form-control" id="applicantEmail" placeholder="Applicant Email" disabled>
                        </div>
                    
                        <div class="col-md-4">
                            <label for="ownerPassword">Password:</label>
                            <input type="password" class="form-control" id="applicantPassword" placeholder="Applicant Password" disabled>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text" id="basic-addon3">Issued on:</span>
                                <input type="date" class="form-control" id="basic-url" aria-describedby="basic-addon3 basic-addon4">
                            </div>
                        </div>
                    </div>
                  <div class="row g-3">
<label for="ownerName">Owner/Applicant Name:</label>
<div class="col-md-3">
    <label for="ownerLastName">Last Name<span class="required-asterisk">*</span></label>
    <input type="text" class="form-control" id="ownerLastName" placeholder="Last Name" required>
</div>
<div class="col-md-3">
    <label for="ownerFirstName">First Name<span class="required-asterisk">*</span></label>
    <input type="text" class="form-control" id="ownerFirstName" placeholder="First Name*" required>
</div>
<div class="col-md-3">
    <label for="ownerMiddleName">Middle Name</label>
    <input type="text" class="form-control" id="ownerMiddleName" placeholder="Middle Name">
</div>
<div class="col-md-3">
    <label for="ownerMaidenName">Maiden Name</label>
    <input type="text" class="form-control" id="ownerMaidenName" placeholder="Maiden Name">
</div>
</div>


<div class="mb-3">
<div class="col-md-4">
<label for="phoneNumber" class="form-label">Cellphone/Telephone Number<span class="required-asterisk">*</span></label>
<input type="text" class="form-control" id="phoneNumber" required>
</div>
</div>



                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="addressTelNo">Address<span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control" id="addressTelNo" placeholder="Address*" required>
                        </div>


                        <div class="col-md-6">
                            <label for="projectLocation">Project Location<span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control" id="projectLocation" placeholder="Project Location*" required>
                        </div>
                    </div>

                
                    <div class="mb-3">
                        <div class="row g-3">
                            <label for="form-check" class="form-label">Scope of Work<span class="required-asterisk">*</span></label>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="scopeOfWork" value="option1" id="option1" required>
                                    <label class="form-check-label" for="option1">New Construction</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="scopeOfWork" value="option2" id="option2" required>
                                    <label class="form-check-label" for="option2">Addition</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="scopeOfWork" value="option3" id="option3" required>
                                    <label class="form-check-label" for="option3">Repair Renovation</label>
                                </div>
                               
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="row g-3">
                            <label for="form-check" class="form-label">Project Justification<span class="required-asterisk">*</span></label>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="projectJustification" value="justification1" id="justification1" required>
                                    <label class="form-check-label" for="justification1">Single Attached/Semi-Attached/Duplex</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="projectJustification" value="justification2" id="justification2" required>
                                    <label class="form-check-label" for="justification2">Single/Detached</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="projectJustification" value="justification3" id="justification3" required>
                                    <label class="form-check-label" for="justification3">Row House/Multi-family Dwelling</label>
                                </div>
                            </div>
                        </div>
                    
                        <div class="container">
                            <!-- Number of Units Field -->
                            <div class="form-group">
                                <label for="NOUnits">Number of Units<span class="required-asterisk">*</span></label>
                                <select class="form-control" id="NOUnits">
                                    <option value="1" selected>1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        
                            <!-- Placeholder for dynamically added unit fields -->
                            <div id="unitFieldsContainer"></div>
                        
                            <!-- Total Floor Area and Estimated Cost -->
                            <div class="row">
                                <div class="col">
                                    <label for="TotalFloorArea">Total Floor Area</label>
                                    <input type="number" class="form-control" id="TotalFloorArea" readonly>
                                </div>
                                <div class="col">
                                    <label for="TotalEstimatedCost">Total Estimated Cost</label>
                                    <input type="number" class="form-control" id="TotalEstimatedCost" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!--Content-->
        <table class="table">
            <thead>
                <tr>
                    <th>Requirements</th>
                    <th>File</th>
                    
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Building Plan</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                 ondrop="handleDrop(event, 'buildingPlanFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('buildingPlanFile').click()">Upload</button>
                            <input type="file" class="file-input" id="buildingPlanFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="buildingPlanFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Proof of Ownership</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                 ondrop="handleDrop(event, 'proofOwnershipFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('proofOwnershipFile').click()">Upload</button>
                            <input type="file" class="file-input" id="proofOwnershipFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="proofOwnershipFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Photocopy of Tax Declaration & Current Tax Receipt</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" ondrop="handleDrop(event, 'taxReceiptFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('taxReceiptFile').click()">Upload</button>
                            <input type="file" class="file-input" id="taxReceiptFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="taxReceiptFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Brgy. Clearance of Building Permit</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" ondrop="handleDrop(event, 'brgyClearanceFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('brgyClearanceFile').click()">Upload</button>
                            <input type="file" class="file-input" id="brgyClearanceFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="brgyClearanceFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Bill of Materials & Specification</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" ondrop="handleDrop(event, 'billMaterialsFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('billMaterialsFile').click()">Upload</button>
                            <input type="file" class="file-input" id="billMaterialsFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="billMaterialsFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Photocopy of PRC IC/PTR of all signing engineers</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" ondrop="handleDrop(event, 'prcFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('prcFile').click()">Upload</button>
                            <input type="file" class="file-input" id="prcFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="prcFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Certification of Exemption Location Clearance from CPDO</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" ondrop="handleDrop(event, 'certExemptionFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('certExemptionFile').click()">Upload</button>
                            <input type="file" class="file-input" id="certExemptionFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="certExemptionFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Structural Analysis (2-Storey and up)</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" ondrop="handleDrop(event, 'structuralAnalysisFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('structuralAnalysisFile').click()">Upload</button>
                            <input type="file" class="file-input" id="structuralAnalysisFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="structuralAnalysisFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Fire Clearance</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" ondrop="handleDrop(event, 'fireClearanceFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('fireClearanceFile').click()">Upload</button>
                            <input type="file" class="file-input" id="fireClearanceFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="fireClearanceFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Boring Test</td>
                    <td class="file-column">
                        <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                            <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" ondrop="handleDrop(event, 'boringTestFile')" ondragover="handleDragOver(event)">
                                <p>Drag & drop file</p>
                            </div>
                            <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('boringTestFile').click()">Upload</button>
                            <input type="file" class="file-input" id="boringTestFile" style="display: none;" onchange="uploadFile(this)">
                            <div id="boringTestFileName" class="file-column"></div>
                        </div>
                    </td>
                </tr>
            </tbody>
            
            
        </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitProfile">Submit</button>
            </div>
        </div>
    </div>
</div>
              </div>
                <!-- End of Bootstrap Table -->
            </div>
        </div>
    </div>
    <div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" data-bs-backdrop="static" data-bs-keyboard="false" aria-hidden="true">
        <div class="wide-modal modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header bg-light text-black">
                    <h5 class="modal-title" id="viewDetailsModalLabel">
                        <span id="OwnerName"></span>'s Permit Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
    
                <!-- Modal Body -->
                <div class="modal-body">
                    <!-- Owner and Verification Section -->
                    <div class="row mb-4 g-3">
                        <!-- Owner Details -->
                        <div class="col-md-6">
                            <div class="p-3 border rounded bg-light">
                                <h6 class="fw-bold mb-3">Owner Information</h6>
                                <p><strong>Owner Name:</strong> <span id="permitOwnerName" class="text-primary"></span></p>
                                <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                                <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                                <p><strong>Building Permit No.:</strong> <span id="permitIdDisplay" class="text-danger"></span></p>
                            </div>
                        </div>
    
                        <!-- Applicant Verification -->
                        <div class="col-md-6">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <strong>Applicant Verification</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <!-- Valid ID and Status -->
                                        <div class="col-md-6 d-flex align-items-center mb-3">
                                            <p class="mb-0 me-2"><strong>Valid ID:</strong></p>
                                            <button id="viewValidIdBtn" class="btn btn-sm btn-primary">Validate</button>
                                            <span id="ownerValidId" style="display: none;"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Verification Status:</strong> 
                                                <span id="approvalStatus" class="text-muted">Pending</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <!-- Permit Status and Progress Section -->
                    <div class="row mb-4 g-3">
                        <!-- Permit Status -->
                        <div class="col-md-6">
                            <div class="p-3 border rounded bg-light">
                                <label for="statusSelect" class="form-label fw-bold">Permit Status</label>
                                <select id="statusSelect" class="form-select">
                                    <option value="Pending">Pending</option>
                                    <option value="Processing">Processing</option>
                                    <option value="To Pay">To Pay</option>
                                    <option value="For Approval">For Approval</option>
                                    <option value="For Release">For Release</option>
                                    <option value="Claimed">Claimed</option>
                                </select>
                            </div>
                        </div>
    
                        <!-- Progress -->
                        <div class="col-md-6">
                            <div class="p-3 border rounded bg-light">
                                <label class="form-label fw-bold">Progress</label>
                                <div class="progress" style="height: 20px;">
                                    <div id="statusProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                        role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        Step 1 of 6
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <!-- Dynamic Buttons -->
                    <div id="viewDetailsModalBtnGrp" class="d-flex flex-wrap gap-2 justify-content-between mt-4"></div>
    
                    <!-- Hidden Input Field -->
                    <input type="hidden" id="hiddenPermitId">
                </div>
    
                <!-- Modal Footer -->
                <div class="modal-footer bg-light">
                    <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
 <!-- Separate Modal for Viewing the Valid ID -->
<div class="modal fade" id="validIdModal" tabindex="-1" aria-labelledby="validIdModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validIdModalLabel">View Valid ID</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalValidIdImage" src="" alt="Valid ID" style="max-width: 100%; height: auto;">
            </div>
            <div class="modal-footer">
                <button id="approveBtn" class="btn btn-success">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button id="disapproveBtn" class="btn btn-danger">
                    <i class="fas fa-times"></i> Disapprove
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    
<!-- Order of Payment Modal -->
<div class="modal fade" id="orderOfPaymentModal" tabindex="-1" aria-labelledby="OrderOfPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="OrderOfPaymentModalLabel">
                    <i class="fa-solid fa-file-invoice"></i> Order of Payment
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
               <div class="printArea" id="printOrderContent">
                <div class="row mb-4">
                    <div class="d-flex justify-content-center align-items-center mb-2 mt-2">
                        <!-- Left Logo -->
                        <img src="/resources/pictures/calambaLogo.png" alt="Calamba Logo" style="height: 50px; width: 50px; margin-left: auto;">
                        <!-- Center Title -->
                        <div class="text-center" style="margin: 0 10px;">
                            <h5 class="mb-0">CITY HOUSING AND SETTLEMENTS DEPARTMENT</h5>
                            <p class="mb-0">City Government of Calamba</p>
                        </div>
                        <!-- Right Logo -->
                        <img src="/resources/pictures/chsd.png" alt="CHSD Logo" style="height: 50px; width: 50px; margin-right: auto;">
                    </div> <!-- Closing div for logo container -->
                </div>
                <!-- Order of Payment Form -->
                <div class="container">
                    <h4 class="text-center">ORDER OF PAYMENT</h4>
                    <p class="text-center"><i>Payee: Treasurer/Cashier-City Treasury Office, City of Calamba</i></p>

                    <!-- Owner/Applicant Input -->
                    <div class="row mb-3">
                        <label for="OPOwner/Applicant">Owner/Applicant:</label>
                        <input type="text" class="form-control" id="OPOwner/Applicant">
                    </div>

                    <!-- Location Input -->
                    <div class="row mb-3">
                        <label for="OPLocation">Location</label>
                        <input type="text" class="form-control" id="OPLocation">
                    </div>

                    <!-- New Input Fields for CR, Linear Meter, Floor Area -->
                    
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label for="lineAndGradeFee">Line and Grade</label>
                            <input type="number" class="form-control" id="lineAndGrade">
                        </div>
                        <div class="col-md-2">
                            <label for="electricalFee">Electrical</label>
                            <input type="number" class="form-control" id="electrical">
                        </div>
                        <div class="col-md-2">
                            <label for="numCR">Sanitary</label>
                            <input type="number" class="form-control" id="numCR" min="0" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="lineMeter">Fence Line Meter (LM)</label>
                            <input type="number" class="form-control" id="lineMeter" min="0" value="0">
                        </div>
                        <div class="col-md-2">
                            <label for="floorArea">Floor Area (sqm)</label>
                            <input type="number" class="form-control" id="floorArea" min="0" value="0">
                        </div>
                    </div>

                    <!-- Existing Fields for Fee Breakdown -->
                    <label for="bp220">Building Permit-BP220</label>
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <label for="bpArea">Area Fee</label>
                            <input type="number" class="form-control" id="bpArea" readonly>
                        </div>

                        <div class="col-md-2">
                            <label for="bpLM">Line Meter Fee (LM)</label>
                            <input type="number" class="form-control" id="bpLM" readonly>
                        </div>

                        <div class="col-md-2">
                            <label for="bpSAN">Sanitary Fee (SAN)</label>
                            <input type="number" class="form-control" id="bpSAN" readonly>
                        </div>

                        <div class="col-md-2">
                            <label for="bpELEC">Electrical Fee (ELEC)</label>
                            <input type="number" class="form-control" id="bpELEC" readonly>
                        </div>

                        <div class="col-md-3">
                            <label for="bpTotal">Total</label>
                            <input type="number" class="form-control" id="bpTotal" readonly>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                
                <button type="button" class="btn btn-secondary" id="printOrderButton" disabled>
                    <i class="fa-solid fa-file-excel"></i> Export
                </button>
                <button type="button" class="btn btn-primary" id="printOrderOfPayment">
                    <i class="fa-solid fa-print"></i> Print Order of Payment
                </button>
                

                
                
            </div>
        </div>
    </div>
</div>


<!--Hidden Table-->
<table id="orderOfPaymentTable" style="display:none;">
    <tr>
      <th>Field</th>
      <th>Value</th>
    </tr>
    <tr>
      <td>Owner/Applicant</td>
      <td id="tableOwnerApplicant"></td>
    </tr>
    <tr>
      <td>Location</td>
      <td id="tableLocation"></td>
    </tr>
    <tr>
      <td>Line and Grade</td>
      <td id="tableLineAndGrade"></td>
    </tr>
    <tr>
      <td>Electrical</td>
      <td id="tableElectrical"></td>
    </tr>
    <tr>
      <td>Sanitary</td>
      <td id="tableSanitary"></td>
    </tr>
    <tr>
      <td>Fence Line Meter</td>
      <td id="tableLineMeter"></td>
    </tr>
    <tr>
      <td>Floor Area</td>
      <td id="tableFloorArea"></td>
    </tr>
    <tr>
      <td>Building Permit Area</td>
      <td id="tableBpArea"></td>
    </tr>
    <tr>
      <td>Building Permit Line Meter Fee</td>
      <td id="tableBpLM"></td>
    </tr>
    <tr>
      <td>Building Permit Sanitary Fee</td>
      <td id="tableBpSAN"></td>
    </tr>
    <tr>
      <td>Building Permit Electrical Fee</td>
      <td id="tableBpELEC"></td>
    </tr>
    <tr>
      <td>Total</td>
      <td id="tableBpTotal"></td>
    </tr>
  </table>
  

 <!-- View HSD Form Modal -->
<div class="modal fade" id="viewHSDFormModal" tabindex="-1" aria-labelledby="viewHSDFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewHSDFormModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="printArea" id="printHSDContent">
                    <div id="watermark" class="watermark"></div>
                <!-- Display HSD form details organized in rows and columns -->
                <div class="container p-3 border rounded">
                    <div class="row mb-4">
                        <div class="d-flex justify-content-center align-items-center mb-2 mt-2">
                            <!-- Left Logo -->
                            <img src="/resources/pictures/calambaLogo.png" alt="Calamba Logo" style="height: 50px; width: 50px; margin-left: auto;">
                            <!-- Center Title -->
                            <div class="text-center" style="margin: 0 10px;">
                                <h5 class="mb-0">CITY HOUSING AND SETTLEMENTS DEPARTMENT</h5>
                                <p class="mb-0">City Government of Calamba</p>
                            </div>
                            <!-- Right Logo -->
                            <img src="/resources/pictures/chsd.png" alt="CHSD Logo" style="height: 50px; width: 50px; margin-right: auto;">
                        </div> <!-- Closing div for logo container -->
                    </div>
                    
                   <h4 class="text-center mb-3 mt-3">Building Permit Under BP220</h4>
                   <p>HSD Form No.1</p>

                   <div class="row">
                    <div class="col-md-6">
                        <p><strong>Building Permit No.</strong> <span id="hsdFormBuildingPermitNo"></span></p>
                    </div>
                   </div>

                    <!-- Row 1 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Owner Name:</strong> <span id="hsdFormOwnerName"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Date Submitted:</strong> <span id="hsdFormDateSubmitted"></span></p>
                        </div>
                      
                    </div>

                    <!-- Row 2 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Address:</strong> <span id="hsdFormAddress"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Phone Number:</strong> <span id="hsdPhoneNumber"></span></p>
                        </div>
                       
                    </div>

                    <!-- Row 3 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <p><strong>Project Location:</strong> <span id="hsdFormProjectLocation"></span></p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Scope of Work:</strong> <span id="hsdFormScopeOfWork"></span></p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Project Justification:</strong> <span id="hsdFormProjectJustification"></span></p>
                        </div>
                    </div>
                 

                    
                

                  <!-- Dynamic Units Section -->
<div id="hsdFormUnitsContainer">
    <h5>Unit Details</h5>
    <div id="hsdFormUnitDetails">
        <!-- Dynamically populated -->
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <p><strong>Total Estimated Cost: </strong><span id="hsdFormTotalEstimatedCost"></span></p>
    </div>
    <div class="col-md-6">
        <p><strong>Total Floor Area: </strong><span id="hsdFormTotalFloorArea"></span></p>
    </div>
</div>



                    <hr>

                    <p class="text-center">Full Time Inspector And Supervisor of Construction Works(Representing the Owner)</p>
                    
                    <hr>
                    <div class="row">
                        <div class="col-md-6" style="border: 0.5px solid black; padding: 2px;">
                            <br>
                            <br>
                            <p class="text-center">Architect or Civil Engineer</p>
                            <p class="text-center"><i>(Signed and Sealed Over Printed Name)</i></p>
                        </div>
                    
                        <div class="col-md-6" style="border: 0.5px solid black; padding: 2px;">
                            <br>
                            <br>
                            <p class="text-center">Architect or Civil Engineer</p>
                            <p class="text-center"><i>(Signed and Sealed Over Printed Name)</i></p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>PRC No.:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>Validity:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>PRC No.:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>Validity:</p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>PTR No.:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>Date Issued:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>PTR No.:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>Date Issued:</p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6" style="border: 0.5px solid black; padding: 2px;">
                            <br>
                            <br>
                            <p class="text-center">Architect or Civil Engineer</p>
                            <p class="text-center"><i>(Signed and Sealed Over Printed Name)</i></p>
                        </div>
                    
                        <div class="col-md-6" style="border: 0.5px solid black; padding: 2px;">
                            <br>
                            <br>
                            <p class="text-center">Architect or Civil Engineer</p>
                            <p class="text-center"><i>(Signed and Sealed Over Printed Name)</i></p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>PRC No.:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>Validity:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>PRC No.:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>Validity:</p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>PTR No.:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>Date Issued:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>PTR No.:</p>
                        </div>
                        <div class="col-md-3" style="border: 0.5px solid black; padding: 2px;">
                            <p>Date Issued:</p>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printHSDForm">
                    <i class="fa-solid fa-print"></i> Print
                  </button>
                  
                  
            </div>
        </div>
    </div>
</div>


 <!-- View Uploads Modal -->
<div class="modal fade" id="viewUploadsModal" tabindex="-1" aria-labelledby="viewUploadsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewUploadsModalLabel">Uploaded Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Uploaded Files List -->
                    <div class="col-lg-12">
                        <ul id="uploadedFilesList" class="list-group">
                            <!-- Dynamically append files here -->
                        </ul>
                    </div>
                </div>
                <!-- Comment Summary Section -->
                <div id="commentSummaryContainer" class="mt-4">
                    <h6>File Validation Comments</h6>
                    <ul id="commentSummaryList" class="list-group">
                        <!-- Comments will be dynamically appended here -->
                    </ul>
                    <div id="validationSummary" class="mt-3 text-muted">
                        <strong>0/0</strong> files validated
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Validation Modal -->
<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">Validate File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="filePreviewContainer" class="mb-3" style="display: none;">
                    <!-- Preview Container for PDF or Image -->
                    <iframe id="filePreview" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                </div>
                <!-- Validation Options -->
                <div>
                    <label class="form-label">Validation Options:</label>
                    <div class="btn-group w-100" role="group" aria-label="Validation Options">
                        <input type="radio" class="btn-check" name="validationOptions" value="approved" id="approvedOption" autocomplete="off">
                        <label class="btn btn-outline-success d-flex align-items-center justify-content-center" for="approvedOption">
                            <i class="fas fa-check-circle me-2"></i> Approve
                        </label>
                        
                        <input type="radio" class="btn-check" name="validationOptions" value="disapproved" id="disapprovedOption" autocomplete="off">
                        <label class="btn btn-outline-danger d-flex align-items-center justify-content-center" for="disapprovedOption">
                            <i class="fas fa-times-circle me-2"></i> Disapprove
                        </label>
                    </div>
                </div>
                <!-- Comments Section -->
                <div class="mt-3">
                    <label for="validationComments" class="form-label">Comments:</label>
                    <textarea class="form-control" id="validationComments" rows="3" placeholder="Add your comments here..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveValidationBtn">Save</button>
                <button type="button" class="btn btn-secondary" id="backToViewUploadsBtn">Back to Uploads</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<div id="notificationContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050; display: none;">
    <!-- Notifications will be dynamically added here -->
</div>

<script>
    const NOUnitsInput = document.getElementById("NOUnits");
    const unitFieldsContainer = document.getElementById("unitFieldsContainer");
    const totalFloorAreaInput = document.getElementById("TotalFloorArea");
    const totalEstimatedCostInput = document.getElementById("TotalEstimatedCost");

    // Initialize with 1 unit field displayed by default
    function initializeUnitFields() {
        const initialNumUnits = parseInt(NOUnitsInput.value) || 1;
        generateUnitFields(initialNumUnits);
        updateTotals();
    }

    // Function to generate fields based on selected number of units
    function generateUnitFields(numUnits) {
        // Clear any existing unit fields
        unitFieldsContainer.innerHTML = "";

        for (let i = 1; i <= numUnits; i++) {
            const unitDiv = document.createElement("div");
            unitDiv.className = "row mb-3";

            unitDiv.innerHTML = `
                <div class="col">
                    <label for="BlockNumber${i}">Block Number for Unit ${i}</label>
                    <input type="text" class="form-control" id="BlockNumber${i}" placeholder="Block Number">
                </div>
                <div class="col">
                    <label for="LotNumber${i}">Lot Number for Unit ${i}</label>
                    <input type="text" class="form-control" id="LotNumber${i}" placeholder="Lot Number">
                </div>
                <div class="col">
                    <label for="NOStorey${i}">Number of Storeys for Unit ${i}</label>
                    <input type="number" class="form-control" id="NOStorey${i}" placeholder="Number of Storeys">
                </div>
                <div class="col">
                    <label for="UnitFloorArea${i}">Floor Area for Unit ${i}</label>
                    <input type="number" class="form-control unit-floor-area" id="UnitFloorArea${i}" placeholder="Floor Area" required>
                </div>
            `;
            unitFieldsContainer.appendChild(unitDiv);
        }
    }

    // Listen for changes to the Number of Units field
    NOUnitsInput.addEventListener("change", function () {
        const numUnits = parseInt(NOUnitsInput.value) || 0;
        generateUnitFields(numUnits);
        updateTotals();
    });

    // Function to calculate totals
    function updateTotals() {
        const floorAreaInputs = document.querySelectorAll(".unit-floor-area");
        let totalFloorArea = 0;

        // Sum all floor area inputs
        floorAreaInputs.forEach(input => {
            const floorArea = parseFloat(input.value) || 0;
            totalFloorArea += floorArea;
        });

        // Set total floor area and total estimated cost
        totalFloorAreaInput.value = totalFloorArea;
        totalEstimatedCostInput.value = totalFloorArea * 10000;
    }

    // Listen for changes to floor area inputs
    unitFieldsContainer.addEventListener("input", function (event) {
        if (event.target.classList.contains("unit-floor-area")) {
            updateTotals();
        }
    });

    // Initialize form with 1 unit field
    initializeUnitFields();
</script>

<script>
    // Toggle email and password fields based on checkbox
    document.getElementById('enableCredentials').addEventListener('change', function () {
        const emailField = document.getElementById('applicantEmail');
        const passwordField = document.getElementById('applicantPassword');
        
        // Enable or disable fields based on checkbox status
        if (this.checked) {
            emailField.disabled = false;
            passwordField.disabled = false;
        } else {
            emailField.disabled = true;
            passwordField.disabled = true;
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* Style for watermark */
    #watermark {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Ensures it stays behind content */
        opacity: 0.1; /* Adjust for desired transparency */
        font-size: 3rem;
        color: gray;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none; /* Make sure it's non-interactive */
        transform: rotate(-45deg);
    }

    /* Spread watermark text across the page */
    #watermark span {
        display: inline-block;
        white-space: nowrap;
        margin: 2rem; /* Spacing between each watermark text */
        opacity: 0.2;
    }
</style>
<script>
    // Function to update the progress bar based on the selected status
document.getElementById('statusSelect').addEventListener('change', function () {
    const status = this.value;
    const progressBar = document.getElementById('statusProgressBar');
    
    // Define the step and width for each status option
    let step = 1;
    let width = 0;
    
    switch (status) {
        case 'Pending':
            step = 1;
            width = 0;
            break;
        case 'Processing':
            step = 2;
            width = 20;
            break;
        case 'To Pay':
            step = 3;
            width = 40;
            break;
        case 'For Approval':
            step = 4;
            width = 60;
            break;
        case 'For Release':
            step = 5;
            width = 80;
            break;
        case 'Claimed':
            step = 6;
            width = 100;
            break;
    }

    // Update progress bar
    progressBar.style.width = `${width}%`;
    progressBar.setAttribute('aria-valuenow', width);
    progressBar.textContent = `Step ${step} of 6`;
});

</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const A4_HEIGHT_PX = 1123; // Approximate A4 height in pixels at 96 DPI
        const A4_WIDTH_PX = 794;  // Approximate A4 width in pixels at 96 DPI

        /**
         * Scales content to fit within A4 dimensions and prevents bottom cutoff.
         * @param {HTMLElement} content The content to scale and adjust.
         */
        function scaleAndCenterContent(content) {
            const actualHeight = content.offsetHeight;
            const actualWidth = content.offsetWidth;

            const heightScale = A4_HEIGHT_PX / actualHeight;
            const widthScale = A4_WIDTH_PX / actualWidth;
            const scale = Math.min(heightScale, widthScale);

            // Apply scaling if necessary
            if (scale < 1) {
                content.style.transform = `scale(${scale})`;
                content.style.transformOrigin = 'top left';
            }

            // Center the content vertically within the A4 page
            const scaledHeight = actualHeight * scale;
            const verticalOffset = Math.max((A4_HEIGHT_PX - scaledHeight) / 2, 0);
            content.style.marginTop = `${verticalOffset}px`;

            // Prevent cutoff by adding bottom padding to fit content
            const bottomPadding = Math.max((A4_HEIGHT_PX - scaledHeight - verticalOffset), 0);
            content.style.paddingBottom = `${bottomPadding}px`;
        }

        /**
         * Handles the print functionality.
         * @param {string} contentSelector The selector for the content to print.
         * @param {function} [preProcess] Optional callback for additional processing.
         * @param {boolean} [isHalfPage] Set to true to print content on half of the page.
         */
        function handlePrint(contentSelector, preProcess, isHalfPage = false) {
            const printContent = document.querySelector(contentSelector).cloneNode(true);

            if (preProcess) {
                preProcess(printContent);
            }

            // Determine container height based on isHalfPage flag
            const containerHeight = isHalfPage ? A4_HEIGHT_PX / 2 : A4_HEIGHT_PX;

            // Wrap content in a container for consistent printing
            const container = document.createElement("div");
            container.style.width = `${A4_WIDTH_PX}px`;
            container.style.height = `${containerHeight}px`;
            container.style.overflow = "hidden"; // Prevent overflow issues
            container.style.display = "flex";
            container.style.flexDirection = "column";
            container.style.justifyContent = "center"; // Center content vertically
            container.style.background = "white"; // Clean white background for printing

            // Apply specific height and overflow settings for half-page prints
            if (isHalfPage) {
                printContent.style.height = `${containerHeight}px`;
                printContent.style.overflow = "hidden";
            }

            container.appendChild(printContent);

            // Clone and print the content
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = container.outerHTML;

            // Trigger print
            window.print();

            // Restore original content
            document.body.innerHTML = originalContent;
            window.location.reload();
        }

        // Print HSD Form
        const printHSDButton = document.getElementById("printHSDForm");
        if (printHSDButton) {
            printHSDButton.addEventListener("click", function () {
                handlePrint("#printHSDContent", (content) => {
                    const buildingPermitNo = document.getElementById("hsdFormOwnerName").textContent.trim();
                    const watermark = document.createElement("div");
                    watermark.id = "watermark";
                    watermark.style.position = "absolute";
                    watermark.style.top = "50%";
                    watermark.style.left = "50%";
                    watermark.style.transform = "translate(-50%, -50%)";
                    watermark.style.opacity = "0.1";
                    watermark.style.fontSize = "4rem";
                    watermark.style.pointerEvents = "none";

                    for (let i = 0; i < 10; i++) {
                        const watermarkText = document.createElement("div");
                        watermarkText.textContent = buildingPermitNo;
                        watermarkText.style.marginBottom = "10px";
                        watermark.appendChild(watermarkText);
                    }

                    content.appendChild(watermark);
                });
            });
        }

        // Print Order of Payment
        const printOrderButton = document.getElementById("printOrderOfPayment");
        if (printOrderButton) {
            printOrderButton.addEventListener("click", function () {
                handlePrint("#printOrderContent", (content) => {
                    // Replace inputs with spans for static printing
                    const inputs = content.querySelectorAll('input');
                    inputs.forEach(function (input) {
                        const value = input.value || '';
                        const span = document.createElement('span');
                        span.textContent = value;
                        span.style.fontWeight = 'bold';
                        input.replaceWith(span);
                    });
                }, true); // Pass true for half-page printing
            });
        }
    });
</script>


<script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
</script>
<script type="text/javascript">
   (function(){
      emailjs.init({
        publicKey: "VtfvHWTpFE6-TDb0r",
      });
   })();
</script>


    
    
                        <script type="module" src="/Database/firebase.js"></script>

                        <script type="module">
                               import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, getDocs, updateDoc, doc, getDoc, addDoc, setDoc, deleteDoc, serverTimestamp, query, startAfter, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
      // Firebase configuration
      const firebaseConfig = {
          apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
          authDomain: "chsd-mis.firebaseapp.com",
          projectId: "chsd-mis",
          storageBucket: "chsd-mis.appspot.com",
          messagingSenderId: "694967679357",
          appId: "1:694967679357:web:65cffd50f13739f934f414",
          measurementId: "G-XBQTQFRLJ5"
      };
  
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);
      document.addEventListener('DOMContentLoaded', () => {
    const submitProfileButton = document.getElementById('submitProfile');
    const loadingScreen = document.getElementById('loading-screen');

    if (submitProfileButton) {
    submitProfileButton.addEventListener('click', async (event) => {
        event.preventDefault();

        // Collect input values
        const issuedOn = document.getElementById('basic-url').value.trim();
        const addressTelNo = document.getElementById('addressTelNo').value.trim();
        const projectLocation = document.getElementById('projectLocation').value.trim();
        const phoneNumber = document.getElementById('phoneNumber').value.trim();
        const ownerLastName = document.getElementById('ownerLastName').value.trim();
        const ownerFirstName = document.getElementById('ownerFirstName').value.trim();
        const ownerMiddleName = document.getElementById('ownerMiddleName').value.trim();
        const ownerName = `${ownerLastName} ${ownerFirstName} ${ownerMiddleName}`.trim();

        const scopeOfWork = document.querySelector('input[name="scopeOfWork"]:checked') ?
            document.querySelector('input[name="scopeOfWork"]:checked').nextElementSibling.textContent : '';
        const projectJustification = document.querySelector('input[name="projectJustification"]:checked') ?
            document.querySelector('input[name="projectJustification"]:checked').nextElementSibling.textContent : '';
    

        const blockNumber = document.getElementById("blockNumber").value;
        const lotNumber = document.getElementById("lotNumber").value;
        const NOUnits = document.getElementById("NOUnits").value;
        const FloorArea = document.getElementById("FloorArea").value;
        const TotalFloorArea = document.getElementById("TotalFloorArea").value;
        const TotalEstimatedCost = document.getElementById("TotalEstimatedCost").value;

        const applicantEmail = document.getElementById('applicantEmail').value.trim();
        const applicantPassword = document.getElementById('applicantPassword').value.trim();
        const enableCredentials = document.getElementById('enableCredentials').checked;

        // Required field validation
        const requiredFields = [
            { field: issuedOn, name: 'Issued On' },
            { field: addressTelNo, name: 'Address/Tel No' },
            { field: projectLocation, name: 'Project Location' },
            { field: phoneNumber, name: 'Phone Number' },
            { field: ownerName, name: 'Owner Name' }
        ];

        if (enableCredentials) {
            requiredFields.push(
                { field: applicantEmail, name: 'Applicant Email' },
                { field: applicantPassword, name: 'Applicant Password' }
            );
        }

        for (const { field, name } of requiredFields) {
            if (!field) {
                alert(`Please fill out the ${name} field.`);
                return;
            }
        }

        // Required file inputs validation
        const requiredFileInputs = [
            { id: 'buildingPlanFile', name: 'Building Plan' },
            { id: 'proofOwnershipFile', name: 'Proof of Ownership' },
            { id: 'taxReceiptFile', name: 'Photocopy of Tax Declaration & Current Tax Receipt' },
            { id: 'brgyClearanceFile', name: 'Brgy. Clearance of Building Permit' },
            { id: 'billMaterialsFile', name: 'Bill of Materials & Specification' },
            { id: 'prcFile', name: 'Photocopy of PRC IC/PTR of all signing engineers' },
            { id: 'certExemptionFile', name: 'Certification of Exemption Location Clearance from CPDO' },
            { id: 'structuralAnalysisFile', name: 'Structural Analysis (2-Storey and up)' }
        ];

        for (const { id, name } of requiredFileInputs) {
            const fileInput = document.getElementById(id);
            if (!fileInput || !fileInput.files[0]) {
                alert(`Please upload the ${name} file.`);
                return;
            }
        }

        if (loadingScreen) {
            loadingScreen.style.display = 'flex';
        }

        try {
            let userId = null;

            // Step 1: Create a new user account for the applicant if checkbox is checked
            if (enableCredentials) {
                const userCredential = await createUserWithEmailAndPassword(auth, applicantEmail, applicantPassword);
                userId = userCredential.user.uid;

                // Save user information in the "users" collection
                await setDoc(doc(db, "users", userId), {
                    firstName: ownerFirstName,
                    middleName: ownerMiddleName,
                    lastName: ownerLastName,
                    email: applicantEmail,
                    createdAt: serverTimestamp()
                });
            }

            // Step 2: Generate building permit number
            const currentYear = new Date().getFullYear();
            const permitCounterRef = doc(db, "permitCounters", currentYear.toString());
            const permitCounterDoc = await getDoc(permitCounterRef);

            let newPermitNumber = permitCounterDoc.exists() ? permitCounterDoc.data().lastNumber + 1 : 1;
            const buildingPermitNo = `${currentYear}-${newPermitNumber.toString().padStart(4, '0')}`;
            await setDoc(permitCounterRef, { lastNumber: newPermitNumber });

            // Step 3: Prepare and save the permit data
            const permitData = {
                buildingPermitNo,
                issuedOn,
                ownerName,
                phoneNumber,
                addressTelNo,
                projectLocation,
                scopeOfWork: finalScopeOfWork,
                projectJustification,
                ownerUid: userId,
                status: 'Pending',
                blockNumber,
                lotNumber,
                NOUnits,
                FloorArea,
                TotalFloorArea,
                TotalEstimatedCost,
                createdAt: serverTimestamp(),
            };

            const permitDocRef = await addDoc(collection(db, "buildingPermits"), permitData);
            const permitId = permitDocRef.id;

            // Step 4: Upload files to Firebase Storage
            const storagePath = `buildingPermits/${permitId}`;
            const uploadPromises = requiredFileInputs.map(async file => {
                const fileInput = document.getElementById(file.id);
                const fileRef = ref(storage, `${storagePath}/${file.name.replace(/\s+/g, '')}_${fileInput.files[0].name}`);
                const snapshot = await uploadBytes(fileRef, fileInput.files[0]);
                return getDownloadURL(snapshot.ref);
            });

            const fileURLs = await Promise.all(uploadPromises);
            const fileURLMapping = {
                buildingPlanURL: fileURLs[0],
                proofOwnershipURL: fileURLs[1],
                taxReceiptURL: fileURLs[2],
                brgyClearanceURL: fileURLs[3],
                billMaterialsURL: fileURLs[4],
                prcURL: fileURLs[5],
                certExemptionURL: fileURLs[6],
                structuralAnalysisURL: fileURLs[7]
            };

            await updateDoc(doc(db, "buildingPermits", permitId), fileURLMapping);

            Swal.fire({
                title: "Success",
                text: "Application Submitted",
                icon: "success"
            });

        } catch (error) {
            console.error("Error during submission:", error);
            alert(`Error submitting application: ${error.message}`);
        } finally {
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
        }
    });
}


});




      // Notification Function
        function showNotification(message, type) {
            const notificationContainer = document.getElementById('notification-container');
            if (notificationContainer) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notificationContainer.appendChild(notification);
                Swal.fire({
  title: "Good job!",
  text: "You clicked the button!",
  icon: "success"
});

                // Automatically remove notification after 5 seconds
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            } else {
                console.error('Notification container not found.');
            }
        }

    
// Function to Dynamically Append Buttons to the View Details Modal as a Multi-Step Form
function appendButtons(data) {
    const viewDetailsModalBtnGrp = document.getElementById('viewDetailsModalBtnGrp');
    viewDetailsModalBtnGrp.innerHTML = ''; // Clear existing content

    // Container for the buttons
    const container = document.createElement('div');
    container.className = 'container-fluid';

    // Row 1: View File Uploads and Generate BP Certificate (Side by Side)
    const firstRow = document.createElement('div');
    firstRow.className = 'row mt-4';

    // Column 1: View File Uploads
    const col1 = document.createElement('div');
    col1.className = 'col-md-6 mb-2'; // Half-width column
    const btn1 = document.createElement('button');
    btn1.className = 'btn btn-primary w-100';
    btn1.textContent = 'View File Uploads';
    btn1.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide();
        openViewUploadsModal(data);
    });
    col1.appendChild(btn1);

    // Column 2: Generate BP Certificate
    const col2 = document.createElement('div');
    col2.className = 'col-md-6 mb-2'; // Half-width column
    const btn2 = document.createElement('button');
    btn2.className = 'btn btn-primary w-100';
    btn2.textContent = 'Generate BP Certificate';
    btn2.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide();
        openViewHSDFormModal(data);
    });
    col2.appendChild(btn2);

    firstRow.appendChild(col1);
    firstRow.appendChild(col2);

    // Row 2: Generate Order of Payment and Archive Permit (Side by Side)
    const secondRow = document.createElement('div');
    secondRow.className = 'row mt-2';

    // Column 1: Generate Order of Payment
    const col3 = document.createElement('div');
    col3.className = 'col-md-6 mb-2'; // Half-width column
    const btn3 = document.createElement('button');
    btn3.className = 'btn btn-success w-100';
    btn3.textContent = 'Generate Order of Payment';
    btn3.addEventListener('click', () => {
        generateOrderOfPayment(data);
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide();

        const orderOfPaymentModal = new bootstrap.Modal(document.getElementById('orderOfPaymentModal'));
        orderOfPaymentModal.show();

        document.getElementById('orderOfPaymentModal').addEventListener('hidden.bs.modal', function () {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
        });
    });
    col3.appendChild(btn3);

    // Column 2: Archive Permit
    const col4 = document.createElement('div');
    col4.className = 'col-md-6 mb-2'; // Half-width column
    const btn4 = document.createElement('button');
    btn4.className = 'btn btn-danger w-100';
    btn4.textContent = 'Archive Permit';
    btn4.setAttribute('data-id', data.id);
    btn4.addEventListener('click', (event) => handleArchiveBuildingPermit(event));
    col4.appendChild(btn4);

    secondRow.appendChild(col3);
    secondRow.appendChild(col4);

    // Append Rows to the Container
    container.appendChild(firstRow);
    container.appendChild(secondRow);

    // Add Container to Button Group
    viewDetailsModalBtnGrp.appendChild(container);
}

// JavaScript Code for Managing File Validations
let fileValidationStatus = {}; // Tracks file validation status, comments, and approval
async function openViewUploadsModal(permitData) {
    try {
        console.log("Fetching uploaded files and validation status for permit:", permitData.id);

        const permitDocRef = doc(db, "buildingPermits", permitData.id);
        const permitSnapshot = await getDoc(permitDocRef);

        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const commentSummaryList = document.getElementById('commentSummaryList');
        uploadedFilesList.innerHTML = '';
        commentSummaryList.innerHTML = '';

        if (!permitSnapshot.exists()) {
            uploadedFilesList.innerHTML = '<li class="list-group-item">No files uploaded.</li>';
            commentSummaryList.innerHTML = '<li class="list-group-item">No comments available.</li>';
        } else {
            const permitData = permitSnapshot.data();
            const {
                buildingPlanURL,
                proofOwnershipURL,
                taxReceiptURL,
                brgyClearanceURL,
                billMaterialsURL,
                prcURL,
                certExemptionURL,
                structuralAnalysisURL,
                fileValidationStatus: fileValidationFromDB = {} // Fetch latest validation status
            } = permitData;

            // Assign the fetched validation data to the local object
            fileValidationStatus = fileValidationFromDB;

            let totalUploadedFiles = 0;
            let validatedFilesCount = 0;

            const createFileItem = (index, fileLabel, fileURL, fileRowId) => {
                totalUploadedFiles++;

                // Retrieve the validation and approval statuses
                const fileValidation = fileValidationStatus[fileRowId] || {};
                const { status, approved } = fileValidation;

                // Approval Badge Logic
                const approvalBadge = 
                    approved === 'approved'
                        ? `<span class="badge bg-success ms-2">Approved</span>` 
                        : approved === 'disapproved'
                            ? `<span class="badge bg-danger ms-2">Disapproved</span>` 
                            : (status ? `<span class="badge bg-success ms-2">Validated</span>` 
                                      : `<span class="badge bg-warning text-dark ms-2">Pending</span>`);

                const fileItem = document.createElement('li');
                fileItem.className = 'list-group-item';
                fileItem.dataset.rowid = fileRowId;

                // Create row with file label, status badges, and action buttons
                fileItem.innerHTML = `
                    <div class="row align-items-center">
                        <!-- File Label and Status -->
                        <div class="col-md-8 col-12 d-flex align-items-center">
                            <span class="me-2">${index}. ${fileLabel}</span>
                            ${approvalBadge}
                        </div>

                        <!-- Action Buttons -->
                        <div class="col-md-4 col-12 text-end">
                            <a href="${fileURL}" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-success validation-btn" 
                                    data-fileurl="${fileURL}" 
                                    data-filelabel="${fileLabel}" 
                                    data-rowid="${fileRowId}">
                                <i class="fa-solid fa-list-check"></i>
                            </button>
                        </div>
                    </div>`;

                // Add event listener to the validation button
                const validationButton = fileItem.querySelector('.validation-btn');
                validationButton.addEventListener('click', (event) => {
                    const fileRow = document.querySelector(`[data-rowid="${event.currentTarget.dataset.rowid}"]`);
                    openValidationModal(event.currentTarget.dataset.fileurl, event.currentTarget.dataset.filelabel, fileRow);
                });

                // Track validated and approved files count
                if (approved === 'approved' || approved === 'disapproved' || status) {
                    validatedFilesCount++;
                }

                // Append file item to the uploaded files list
                uploadedFilesList.appendChild(fileItem);

                // Add comments to the comment summary list
                const commentText = fileValidation?.comments || 'No comments provided.';
                const commentItem = document.createElement('li');
                commentItem.className = 'list-group-item';
                commentItem.innerHTML = `<strong>${index}. ${fileLabel}</strong>: ${commentText}`;
                commentSummaryList.appendChild(commentItem);
            };

            // Add files to the list with numbering
            let fileIndex = 1;
            if (buildingPlanURL) createFileItem(fileIndex++, 'Building Plan', buildingPlanURL, 'buildingPlan');
            if (proofOwnershipURL) createFileItem(fileIndex++, 'Proof of Ownership', proofOwnershipURL, 'proofOwnership');
            if (taxReceiptURL) createFileItem(fileIndex++, 'Photocopy of Tax Declaration & Current Tax Receipt', taxReceiptURL, 'taxReceipt');
            if (brgyClearanceURL) createFileItem(fileIndex++, 'Brgy. Clearance of Building Permit', brgyClearanceURL, 'brgyClearance');
            if (billMaterialsURL) createFileItem(fileIndex++, 'Bill of Materials & Specification', billMaterialsURL, 'billMaterials');
            if (prcURL) createFileItem(fileIndex++, 'Photocopy of PRC IC/PTR of all signing engineers', prcURL, 'prc');
            if (certExemptionURL) createFileItem(fileIndex++, 'Certification of Exemption Location Clearance from CPDO', certExemptionURL, 'certExemption');
            if (structuralAnalysisURL) createFileItem(fileIndex++, 'Structural Analysis (2-Storey and up)', structuralAnalysisURL, 'structuralAnalysis');

            updateValidationSummary(validatedFilesCount, totalUploadedFiles);
        }

        const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
        viewUploadsModal.show();

    } catch (error) {
        console.error("Error fetching uploads:", error);
        alert("Failed to load uploaded files.");
    }
}

// Updates the validation summary displayed in the modal
function updateValidationSummary(validatedFiles, totalFiles) {
    const validationSummary = document.getElementById('validationSummary');
    validationSummary.textContent = `${validatedFiles}/${totalFiles} files validated`;
}


// Function to load comment summary dynamically
function loadCommentSummary() {
    const commentSummaryList = document.getElementById('commentSummaryList');
    commentSummaryList.innerHTML = ''; // Clear previous data

    Object.entries(fileValidationStatus).forEach(([fileRowId, validation]) => {
        const fileLabel = getFileLabelFromId(fileRowId);
        const statusText = validation.status ? validation.status.charAt(0).toUpperCase() + validation.status.slice(1) : 'Pending';

        const commentSummaryItem = document.createElement('li');
        commentSummaryItem.className = 'list-group-item';
        commentSummaryItem.dataset.commentid = fileRowId;

        commentSummaryItem.innerHTML = `
            <strong>${fileLabel} - ${statusText}</strong>
            <p>${validation.comments || 'No comments'}</p>
        `;

        commentSummaryList.appendChild(commentSummaryItem);
    });
}



// Opens the validation modal
function openValidationModal(fileURL, fileLabel, fileRow) {
    const viewUploadsModal = bootstrap.Modal.getInstance(document.getElementById('viewUploadsModal'));
    if (viewUploadsModal) viewUploadsModal.hide();

    const validationModalLabel = document.getElementById('validationModalLabel');
    const commentsInput = document.getElementById('validationComments');
    const previewContainer = document.getElementById('filePreviewContainer');
    const filePreview = document.getElementById('filePreview');

    validationModalLabel.textContent = `Validation for ${fileLabel}`;
    commentsInput.value = '';

    previewContainer.style.display = 'block';
    filePreview.src = fileURL;

    const saveBtn = document.getElementById('saveValidationBtn');
    saveBtn.dataset.filerow = fileRow.dataset.rowid;
    saveBtn.removeEventListener('click', saveValidation);
    saveBtn.addEventListener('click', saveValidation);

    const validationModal = new bootstrap.Modal(document.getElementById('validationModal'));
    validationModal.show();
}

// Saves validation and updates Firestore
async function saveValidation() {
    const selectedOption = document.querySelector('input[name="validationOptions"]:checked');
    const commentsInput = document.getElementById('validationComments').value.trim();

    if (!selectedOption || !commentsInput) {
        Swal.fire({
            title: 'Incomplete Validation',
            text: 'Please select a status and provide comments.',
            icon: 'warning',
            confirmButtonText: 'OK'
        });
        return;
    }

    const fileRowId = document.getElementById('saveValidationBtn').dataset.filerow;
    const permitId = document.getElementById('hiddenPermitId').value;
    const status = selectedOption.value;

    fileValidationStatus[fileRowId] = { status, comments: commentsInput };

    try {
        await updateDoc(doc(db, "buildingPermits", permitId), {
            [`fileValidationStatus.${fileRowId}`]: fileValidationStatus[fileRowId]
        });

        Swal.fire({
            title: 'Validation Saved',
            text: 'The validation status and comments have been updated.',
            icon: 'success',
            confirmButtonText: 'OK'
        });

        loadCommentSummary();
        updateValidationSummary(
            Object.values(fileValidationStatus).filter(file => file.status).length,
            Object.keys(fileValidationStatus).length
        );

        const validationModal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
        validationModal.hide();

        const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
        viewUploadsModal.show();

    } catch (error) {
        console.error("Error saving validation:", error);
        Swal.fire({
            title: 'Error',
            text: 'Could not save validation. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    }
}

// Maps file row IDs to readable labels
function getFileLabelFromId(fileRowId) {
    const labels = {
        buildingPlan: 'Building Plan',
        proofOwnership: 'Proof of Ownership',
        taxReceipt: 'Photocopy of Tax Declaration & Current Tax Receipt',
        brgyClearance: 'Brgy. Clearance of Building Permit',
        billMaterials: 'Bill of Materials & Specification',
        prc: 'Photocopy of PRC IC/PTR of all signing engineers',
        certExemption: 'Certification of Exemption Location Clearance from CPDO',
        structuralAnalysis: 'Structural Analysis (2-Storey and up)'
    };
    return labels[fileRowId] || 'Unknown File';
}


// Function to check if all required fields are filled
function checkIfAllFieldsFilled() {
    const numCR = document.getElementById('numCR').value.trim();
    const lineMeter = document.getElementById('lineMeter').value.trim();
    const floorArea = document.getElementById('floorArea').value.trim();
    const lineAndGrade = document.getElementById('lineAndGrade').value.trim();
    const electrical = document.getElementById('electrical').value.trim();
    const ownerName = document.getElementById("OPOwner/Applicant").value.trim();
    const location = document.getElementById("OPLocation").value.trim();

    // Enable button only if all fields are filled
    const printButton = document.getElementById('printOrderButton');
    if (numCR && lineMeter && floorArea && lineAndGrade && electrical && ownerName && location) {
        printButton.disabled = false; // Enable the button
    } else {
        printButton.disabled = true; // Disable the button
    }
}

// Function to generate Order of Payment with calculations
function generateOrderOfPayment(Data) {
    try {
        // Fetch and set owner and location data if provided
        const ownerNameField = document.getElementById("OPOwner/Applicant");
        const locationField = document.getElementById("OPLocation");

        if (Data && Data.ownerName) {
            ownerNameField.value = Data.ownerName;  // Set owner name from Data
        }
        if (Data && Data.projectLocation) {
            locationField.value = Data.projectLocation;  // Set location from Data
        }

        // Get numeric values from input fields, default to 0 if not a valid number
        const numCR = parseFloat(document.getElementById('numCR').value) || 0;
        const lineMeter = parseFloat(document.getElementById('lineMeter').value) || 0;
        const floorArea = parseFloat(document.getElementById('floorArea').value) || 0;
        const lineAndGrade = parseFloat(document.getElementById('lineAndGrade').value) || 0;
        const electrical = parseFloat(document.getElementById('electrical').value) || 0;

        // Calculate fees
        const crFee = numCR * 100.00;
        const fenceFee = lineMeter * 7.00;
        const floorAreaFee = floorArea * 7.20;
        const lineAndGradeFee = lineAndGrade * 120.00;
        const electricalFee = electrical * 200.00;

        // Calculate total payment
        const total = lineAndGradeFee + electricalFee + crFee + fenceFee + floorAreaFee;

        // Populate Order of Payment Modal Fields with calculated values
        document.getElementById('bpArea').value = floorAreaFee.toFixed(2);
        document.getElementById('bpLM').value = fenceFee.toFixed(2);
        document.getElementById('bpSAN').value = crFee.toFixed(2);
        document.getElementById('bpELEC').value = electricalFee.toFixed(2);
        document.getElementById('bpTotal').value = total.toFixed(2);

        console.log("Order of Payment calculated and modal populated.");
        
    } catch (error) {
        console.error("Error generating Order of Payment:", error);
        alert("Failed to generate order of payment.");
    }
}

// Attach 'input' event listeners to fields to trigger automatic calculation
const inputs = ['numCR', 'lineMeter', 'floorArea', 'lineAndGrade', 'electrical', 'OPOwner/Applicant', 'OPLocation'];
inputs.forEach(id => {
    document.getElementById(id).addEventListener('input', () => {
        generateOrderOfPayment({}); // Pass an empty object if no Data is available
        checkIfAllFieldsFilled(); // Check if the button should be enabled
    });
});

// Initial check in case fields are already filled (e.g., from previous inputs)
checkIfAllFieldsFilled();



 
let currentPage = 1;
const profilesPerPage = 10; // Adjust this as needed
let lastVisible = null;

async function loadProfiles() {
    const loadingScreen = document.getElementById("loading-screen");

    try {
        // Show loading screen
        if (loadingScreen) loadingScreen.style.display = "flex";

        const buildingPermitDiv = document.getElementById("buildingPermitDiv");
        const prevPageBtn = document.getElementById("prevPageBtn");
        const nextPageBtn = document.getElementById("nextPageBtn");
        const pageInfo = document.getElementById("pageInfo");

        if (!buildingPermitDiv) {
            console.error("buildingPermitDiv not found in the DOM.");
            return;
        }

        const tableBody = buildingPermitDiv.querySelector("tbody");
        if (!tableBody) {
            console.error("Table body not found in buildingPermitDiv.");
            return;
        }

        tableBody.innerHTML = ""; // Clear existing rows

        // Firestore Query
        let queryRef = collection(db, "buildingPermits");
        queryRef = query(queryRef, orderBy("createdAt", "asc"), limit(profilesPerPage));

        if (lastVisible && currentPage > 1) {
            queryRef = query(queryRef, startAfter(lastVisible));
        }

        const querySnapshot = await getDocs(queryRef);
        if (querySnapshot.docs.length > 0) {
            lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1]; // Save last document for pagination
        }

        const permitsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Fetch related user data in batch
        const userUids = permitsData.map(data => data.ownerUid).filter(uid => uid);
        const userDocsPromises = userUids.map(uid => getDoc(doc(db, "users", uid)));
        const userDocs = await Promise.all(userDocsPromises);

        const userDataMap = {};
        userDocs.forEach(userDoc => {
            if (userDoc.exists()) {
                const data = userDoc.data();
                userDataMap[userDoc.id] = `${data.firstName} ${data.lastName}`;
            }
        });


        const applicationMethodMap = {
    online: "Online Application",
    "walk-in": "Walk-in"
}; 
        // Populate table
        const fragment = document.createDocumentFragment();
        permitsData.forEach(data => {
            const row = document.createElement("tr");
            
            const representativeName = userDataMap[data.ownerUid] || "N/A";
            const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";
            const applicationMethod = applicationMethodMap[data.applicationMethod] || "N/A";
            row.innerHTML = `
                <td>${data.ownerName || "N/A"}</td>
                <td>${representativeName}</td>
                <td>${applicationMethod}</td>
                <td>${createdAt}</td>
                <td>${data.status || "N/A"}</td>
                <td>
                    <button class="btn btn-primary btn-sm process-btn" data-permit-id="${data.id}">
                        ${data.status === "Pending" ? "Process" : "View Details"}
                    </button>
                </td>
            `;

            // Attach click event to the button
            const processBtn = row.querySelector(".process-btn");
            if (processBtn) {
                processBtn.addEventListener("click", () => {
                    if (data.status === "Pending") {
                        confirmProcessPermit(data); // Confirm before processing
                    } else {
                        openViewDetailsModal(data); // Open the details modal
                    }
                });
            }

            fragment.appendChild(row);
        });

        tableBody.appendChild(fragment);

        // Update pagination info
        pageInfo.textContent = `Page ${currentPage}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = querySnapshot.docs.length < profilesPerPage;

        // Add pagination event listeners
        prevPageBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                loadProfiles();
            }
        };

        nextPageBtn.onclick = () => {
            if (querySnapshot.docs.length === profilesPerPage) {
                currentPage++;
                loadProfiles();
            }
        };

    } catch (error) {
        console.error("Error loading profiles:", error);
        showNotification("Failed to load profiles.", "error");
    } finally {
        // Hide loading screen
        if (loadingScreen) loadingScreen.style.display = "none";
    }
}

// Function to confirm processing of the permit using SweetAlert2
async function confirmProcessPermit(permitData) {
    const result = await Swal.fire({
        title: 'Are you sure?',
        text: 'Do you want to process this permit?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Process it!',
        cancelButtonText: 'Cancel',
        reverseButtons: true
    });

    if (result.isConfirmed) {
        processPermit(permitData); // Proceed to process the permit
    }
}

// Function to process the permit (change status to "Processing")
async function processPermit(permitData) {
    try {
        // Update the status to 'Processing' in Firestore
        await updateDoc(doc(db, 'buildingPermits', permitData.id), { status: "Processing" });

        showNotification(`${permitData.ownerName}'s building permit is now Processing.`, 'info');
        loadProfiles(); // Reload profiles to reflect the updated status

    } catch (error) {
        console.error("Error processing permit:", error);
        showNotification("Failed to update permit status.", "error");
    }
}


    // Function to control progressive status selection and update the progress bar
function updateStatusOptions(currentStatus) {
    const statusSelect = document.getElementById("statusSelect");
    const progressBar = document.getElementById("statusProgressBar");

    // Define status progression steps and valid transitions
    const statusProgression = {
        "Pending": ["Pending", "Processing"],
        "Processing": ["Processing", "To Pay"],
        "To Pay": ["To Pay", "For Approval"],
        "For Approval": ["For Approval", "For Release"],
        "For Release": ["For Release", "Claimed"],
        "Claimed": ["Claimed"]
    };

    const progressSteps = {
        "Pending": { step: 1, width: 0 },
        "Processing": { step: 2, width: 20 },
        "To Pay": { step: 3, width: 40 },
        "For Approval": { step: 4, width: 60 },
        "For Release": { step: 5, width: 80 },
        "Claimed": { step: 6, width: 100 }
    };

    // Get valid statuses for the current status
    const validStatuses = statusProgression[currentStatus] || [];

    // Show or hide options based on the valid statuses
    const options = statusSelect.querySelectorAll("option");
    options.forEach(option => {
        option.style.display = validStatuses.includes(option.value) ? "block" : "none";
    });

    // Set the statusSelect value to the currentStatus
    statusSelect.value = currentStatus;

    // Update progress bar based on currentStatus
    const { step, width } = progressSteps[currentStatus] || { step: 1, width: 0 };
    progressBar.style.width = `${width}%`;
    progressBar.setAttribute('aria-valuenow', width);
    progressBar.textContent = `Step ${step} of 6`;
}





// Function to Open the View Details Modal
function openViewDetailsModal(permitData) {
    const viewDetailsModalElement = document.getElementById("viewDetailsModal");
    const validIdModalElement = document.getElementById("validIdModal");
    const viewDetailsModal = new bootstrap.Modal(viewDetailsModalElement);
    const validIdModal = new bootstrap.Modal(validIdModalElement);

    // Populate Modal Fields
    const appointmentDate = permitData.appointmentDate
        ? new Date(permitData.appointmentDate.seconds * 1000).toLocaleString()
        : "N/A";

    document.getElementById("permitOwnerName").textContent = permitData.ownerName || "N/A";
    document.getElementById("OwnerName").textContent = permitData.ownerName || "N/A";
    document.getElementById("issuedOnDate").textContent = permitData.issuedOn || "N/A";
    document.getElementById("appointmentDateSched").textContent = appointmentDate || "N/A";
    document.getElementById("permitIdDisplay").textContent = permitData.buildingPermitNo || "N/A";
    document.getElementById("hiddenPermitId").value = permitData.id || "";

    // Handle valid ID button
    const validId = permitData.validId || null;
    const ownerValidIdElement = document.getElementById("ownerValidId");
    const viewValidIdBtn = document.getElementById("viewValidIdBtn");

    if (validId) {
        ownerValidIdElement.textContent = validId; // Store the URL in the hidden span
        viewValidIdBtn.style.display = "inline-block"; // Show the "View" button
    } else {
        ownerValidIdElement.textContent = ""; // Clear the span
        viewValidIdBtn.style.display = "none"; // Hide the button if no valid ID
    }

    // Update Status Options
    updateStatusOptions(permitData.status || "Pending");

    // Append Dynamic Buttons
    appendButtons(permitData);

    // Show the Modal
    viewDetailsModal.show();

    // Add Event Listener for the Save Button (Ensure it's not duplicated)
    const saveStatusBtn = document.getElementById("saveStatusBtn");
    saveStatusBtn.onclick = async () => {
        const newStatus = document.getElementById("statusSelect").value;
        const permitId = permitData.id || "";
        try {
            // Update Status in Firestore
            await updateDoc(doc(db, "buildingPermits", permitId), { status: newStatus });

            // Fetch owner email using ownerUid from Firestore
            const userDocRef = doc(db, "users", permitData.ownerUid);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const ownerEmail = userDoc.data().email;

                // Trigger Notification
                const message = `${permitData.ownerName}'s building permit is now ${newStatus.toLowerCase()}`;
                showNotification(message, "info");

                // Store Notification in Firestore
                await addDoc(collection(db, "notifications"), {
                    userId: permitData.ownerUid,
                    message: message,
                    permitId: permitId,
                    timestamp: serverTimestamp(),
                    read: false
                });

                // Show success alert
                Swal.fire({
                    title: "Success",
                    text: "Status Updated!",
                    icon: "success"
                });

                // Reload Profiles to Reflect Changes
                loadProfiles();

                // Hide View Details Modal
                viewDetailsModal.hide();
            } else {
                console.error("Owner document not found in Firestore.");
                showNotification("Failed to send email: Owner data not found.", "error");
            }
        } catch (error) {
            console.error("Error updating permit status:", error);
            showNotification("Failed to update permit status.", "error");
        }
    };

    // Handle Valid ID Modal Interaction
    viewValidIdBtn.addEventListener("click", () => {
        viewDetailsModal.hide(); // Hide View Details Modal
        validIdModal.show(); // Show Valid ID Modal

        // Add listener for validation completion
        validIdModalElement.addEventListener(
            "hidden.bs.modal",
            () => {
                viewDetailsModal.show(); // Reopen View Details Modal when Valid ID Modal is closed
            },
            { once: true } // Ensure listener is added only once
        );
    });
}

// Approval/Disapproval Logic
document.addEventListener("DOMContentLoaded", () => {
    const approveBtn = document.getElementById("approveBtn");
    const disapproveBtn = document.getElementById("disapproveBtn");
    const approvalStatusElement = document.getElementById("approvalStatus");
    const validIdModalElement = document.getElementById("validIdModal");
    const validIdModal = new bootstrap.Modal(validIdModalElement);

    approveBtn.addEventListener("click", () => updateApprovalStatus(true));
    disapproveBtn.addEventListener("click", () => updateApprovalStatus(false));

    async function updateApprovalStatus(isApproved) {
        const permitId = document.getElementById("hiddenPermitId").value; // Get the permit ID from the hidden input

        try {
            const permitDocRef = doc(db, "buildingPermits", permitId); // Reference to the permit document
            const permitDoc = await getDoc(permitDocRef);

            // Check if 'isApproved' field exists; if not, add it
            if (!permitDoc.exists() || !permitDoc.data().hasOwnProperty("isApproved")) {
                await setDoc(permitDocRef, { isApproved }, { merge: true });
            } else {
                await updateDoc(permitDocRef, { isApproved });
            }

            // Update the UI
            approvalStatusElement.textContent = isApproved ? "Approved" : "Not Approved";
            approvalStatusElement.classList.toggle("text-success", isApproved);
            approvalStatusElement.classList.toggle("text-danger", !isApproved);

            // Show feedback using SweetAlert
            await Swal.fire({
                icon: isApproved ? "success" : "error",
                title: isApproved ? "Approved!" : "Disapproved!",
                text: isApproved
                    ? "Permit approved successfully."
                    : "Permit disapproved successfully.",
                confirmButtonText: "OK",
            });

            // Close Valid ID Modal
            validIdModal.hide();
        } catch (error) {
            console.error("Error updating approval status:", error);
            Swal.fire("Error", "Failed to update permit status.", "error");
        }
    }
});

document.addEventListener("DOMContentLoaded", () => {
    const viewValidIdBtn = document.getElementById("viewValidIdBtn");
    const ownerValidIdElement = document.getElementById("ownerValidId");

    // Bind event listener for the "View" button
    viewValidIdBtn.addEventListener("click", () => {
        const validIdUrl = ownerValidIdElement.textContent; // Retrieve the URL from the hidden span
        const modalImage = document.getElementById("modalValidIdImage");

        if (validIdUrl) {
            modalImage.src = validIdUrl; // Set the modal image source
            const validIdModal = new bootstrap.Modal(document.getElementById("validIdModal"));
            validIdModal.show(); // Show the modal
        } else {
            alert("No valid ID available."); // Handle cases where no ID exists
        }
    });
});

      // Function to Open the View HSD Form Modal with Debugging
// Function to Open the View HSD Form Modal
// Function to Open the View HSD Form Modal
async function openViewHSDFormModal(permitData) {
    try {
        console.log("Permit Data received:", permitData); // Log permitData to ensure it's not empty

        // Fetch the data from the buildingPermits collection based on the permitId
        const hsdFormData = await getDoc(doc(db, "buildingPermits", permitData.id));

        if (!hsdFormData.exists()) {
            console.error("HSD Form (Building Permit) not found!");
            alert("HSD Form data is missing!");
            return;
        }

        const data = hsdFormData.data();
        console.log("HSD Form Data retrieved:", data); // Log the fetched data to ensure it's being retrieved correctly

        // Populate HSD Form Modal Fields
        document.getElementById('hsdFormOwnerName').textContent = data.ownerName;
        document.getElementById('hsdFormAddress').textContent = data.addressTelNo || "N/A";
        document.getElementById('hsdFormDateSubmitted').textContent = data.issuedOn;
        document.getElementById("hsdPhoneNumber").textContent = data.phoneNumber;
        document.getElementById("hsdFormProjectLocation").textContent = data.projectLocation;
        document.getElementById("hsdFormScopeOfWork").textContent = data.scopeOfWork;
        document.getElementById("hsdFormProjectJustification").textContent = data.projectJustification;
        document.getElementById("hsdFormTotalFloorArea").textContent = data.totalFloorArea || "N/A";
        document.getElementById("hsdFormTotalEstimatedCost").textContent = data.totalEstimatedCost || "N/A";
        document.getElementById("hsdFormBuildingPermitNo").textContent = data.buildingPermitNo;

        // Clear existing unit details
        const unitDetailsContainer = document.getElementById("hsdFormUnitDetails");
        unitDetailsContainer.innerHTML = "";

        // Check if `unitsData` exists and iterate over it
        if (Array.isArray(data.unitsData) && data.unitsData.length > 0) {
            data.unitsData.forEach((unit, index) => {
                const unitElement = document.createElement("div");
                unitElement.className = "unit-details mb-3";

                unitElement.innerHTML = `
                <div class="row align-items-center">
            <div class="col-md-2"><h6>Unit ${index + 1}</h6></div>
            <div class="col-md-2"><p><strong>Block No.:</strong> ${unit.blockNumber || "N/A"}</p></div>
            <div class="col-md-2"><p><strong>Lot No.:</strong> ${unit.lotNumber || "N/A"}</p></div>
            <div class="col-md-3"><p><strong>No. of Storeys:</strong> ${unit.NOStorey || "N/A"}</p></div>
            <div class="col-md-3"><p><strong>Floor Area:</strong> ${unit.floorArea || "N/A"} sqm</p></div>
        </div>
                `;
                unitDetailsContainer.appendChild(unitElement);
            });
        } else {
            unitDetailsContainer.innerHTML = "<p>No unit details available.</p>";
        }

        console.log("HSD Form fields populated");

        // Show the HSD Form Modal
        const viewHSDFormModal = new bootstrap.Modal(document.getElementById('viewHSDFormModal'));
        viewHSDFormModal.show();
    } catch (error) {
        console.error("Error opening HSD Form modal:", error);
        alert("Failed to load HSD form data.");
    }
}


// Function to Archive a Building Permit
async function handleArchiveBuildingPermit(event) {
    event.preventDefault();

    const buildingPermitId = event.target.getAttribute('data-id');

    if (!buildingPermitId) {
        console.error("Building Permit ID is null or undefined.");
        showNotification("Error: Building Permit ID is missing.", "error");
        return;
    }

    // SweetAlert for confirmation
    Swal.fire({
        title: "Are you sure?",
        text: "",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, archive it!"
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const buildingPermitRef = doc(db, "buildingPermits", buildingPermitId);
                const buildingPermitSnapshot = await getDoc(buildingPermitRef);

                if (buildingPermitSnapshot.exists()) {
                    const buildingPermitData = buildingPermitSnapshot.data();
                    
                    // Archive document
                    await setDoc(doc(db, "archivedBuildingPermits", buildingPermitId), buildingPermitData);
                    await deleteDoc(buildingPermitRef);

                    // Remove the row from the table
                    const tableBody = document.querySelector("#buildingPermitDiv tbody");
                    const rowToRemove = tableBody.querySelector(`button[data-permit-id="${buildingPermitId}"]`).closest('tr');
                    if (rowToRemove) rowToRemove.remove();

                    showNotification("Document archived successfully!", "success");

                    // Close the modal
                    const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
                    if (viewDetailsModal) {
                        viewDetailsModal.hide();
                    }

                    // Success feedback
                    Swal.fire({
                        title: "Archived!",
                        text: "Your file has been archived successfully.",
                        icon: "success"
                    });

                } else {
                    showNotification("Document not found!", "error");
                }
            } catch (error) {
                console.error("Error archiving document: ", error);
                showNotification(`Failed to archive document: ${error.message}`, "error");
            }
        }
    });
}

        // Function to Search Permits by Owner or Representative Name
        function searchPermits() {
            const searchInput = document.getElementById("searchInput").value.toLowerCase();
            const tableRows = document.querySelectorAll("#buildingPermitDiv tbody tr");

            let resultsFound = false; // To track if any results are found

            tableRows.forEach(row => {
                const ownerName = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
                const representativeName = row.querySelector("td:nth-child(2)").textContent.toLowerCase();

                // Check if the search input matches either the owner name or representative name
                if (ownerName.includes(searchInput) || representativeName.includes(searchInput)) {
                    row.style.display = ""; // Show the row
                    resultsFound = true; // Mark that we found results
                } else {
                    row.style.display = "none"; // Hide the row if it doesn't match
                }
            });

            // Display a 'No results found' message if no results match
            const existingNoResults = document.getElementById("noResultsMessage");
            if (!resultsFound) {
                if (!existingNoResults) {
                    const newRow = document.createElement("tr");
                    newRow.id = "noResultsMessage";
                    newRow.innerHTML = `<td colspan="5" class="text-center">No results found</td>`;
                    document.querySelector("#buildingPermitDiv tbody").appendChild(newRow);
                }
            } else if (existingNoResults) {
                existingNoResults.remove(); // Remove the 'No results' message if results are found
            }
        }

        // Initialize Pagination and Load Profiles
        document.addEventListener("DOMContentLoaded", () => {
            const prevPageBtn = document.getElementById("prevPageBtn");
            const nextPageBtn = document.getElementById("nextPageBtn");

            // Event Listener for Previous Page Button
            prevPageBtn.addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadProfiles();
                }
            });

            // Event Listener for Next Page Button
            nextPageBtn.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadProfiles();
                }
            });

            // Event Listener for Search Input
            const searchInput = document.getElementById("searchInput");
            searchInput.addEventListener("input", searchPermits);

            // Load Profiles Initially
            loadProfiles();
        });

                        </script>

                        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
                            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
                            crossorigin="anonymous"></script>
                        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
                            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
                            crossorigin="anonymous"></script>
                        <script src="https://kit.fontawesome.com/8d1b0b1c7b.js" crossorigin="anonymous"></script>
                        <!--Navigation Bar-->
                        <script>
                            document.querySelector('.open-btn').addEventListener('click', function () {
                                document.getElementById('side_nav').classList.add('active');
                            });

                            document.querySelector('.close-btn').addEventListener('click', function () {
                                document.getElementById('side_nav').classList.remove('active');
                            });
                        </script>

                       

                       
                    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script>
        const fetchHSDFormData = () => {
    return {
        dateSubmitted: document.getElementById("hsdFormDateSubmitted").textContent,
        ownerName: document.getElementById("hsdFormOwnerName").textContent,
        phoneNumber: document.getElementById("hsdPhoneNumber").textContent,
        address: document.getElementById("hsdFormAddress").textContent,
        projectLocation: document.getElementById("hsdFormProjectLocation").textContent,
        scopeOfWork: document.getElementById("hsdFormScopeOfWork").textContent,
        projectJustification: document.getElementById("hsdFormProjectJustification").textContent,
        blockNumber: document.getElementById("hsdFormBlockNumber").textContent,
        lotNumber: document.getElementById("hsdFormLotNumber").textContent,
        numberOfUnits: document.getElementById("hsdFormNOUnits").textContent,
        floorAreaPerUnit: document.getElementById("hsdFormFloorArea").textContent,
        totalFloorArea: document.getElementById("hsdFormTotalFloorArea").textContent,
        totalEstimatedCost: document.getElementById("hsdFormTotalEstimatedCost").textContent
    };
};

const formatDataForExport = (formData) => {
    return [
        ["Date Submitted", formData.dateSubmitted],
        ["Owner Name", formData.ownerName],
        ["Phone Number", formData.phoneNumber],
        ["Address", formData.address],
        ["Project Location", formData.projectLocation],
        ["Scope of Work", formData.scopeOfWork],
        ["Project Justification", formData.projectJustification],
        ["Block Number", formData.blockNumber],
        ["Lot Number", formData.lotNumber],
        ["Number Of Units", formData.numberOfUnits],
        ["Floor Area Per Unit", formData.floorAreaPerUnit],
        ["Total Floor Area", formData.totalFloorArea],
        ["Total Estimated Cost", formData.totalEstimatedCost]
    ];
};

const exportToExcel = () => {
    const formData = fetchHSDFormData();
    const formattedData = formatDataForExport(formData);

    // Create a new workbook and add the formatted data
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(formattedData);

    // Append the worksheet to the workbook
    XLSX.utils.book_append_sheet(wb, ws, "HSD Form");

    // Export the workbook
    XLSX.writeFile(wb, "HSD_Form.xlsx");
};


    </script>



<script>
async function exportOrderOfPaymentToExcel() {
    try {
        // Load the Excel template
        const templatePath = 'Order-of-Payment.xlsx';

        const response = await fetch(templatePath);
        if (!response.ok) {
            throw new Error('Failed to fetch template: ' + response.statusText);
        }

        const templateData = await response.arrayBuffer();
        const workbook = XLSX.read(templateData, { type: 'array' });

        const worksheet = workbook.Sheets[workbook.SheetNames[0]];

        // Gather data from the modal inputs
        const ownerApplicant = document.getElementById('OPOwner/Applicant').value;
        const location = document.getElementById('OPLocation').value;
        const bpArea = document.getElementById('bpArea').value;
        const bpLM = document.getElementById('bpLM').value;
        const bpSAN = document.getElementById('bpSAN').value;
        const bpELEC = document.getElementById('bpELEC').value;
        const bpTotal = document.getElementById('bpTotal').value;

        // Fill in the data in the Excel template
        worksheet['D8'] = { v: ownerApplicant, t: 's' };  // Owner/Applicant
        worksheet['D10'] = { v: location, t: 's' };       // Location

        // Populate Building Permit - BP220 Section
        worksheet['E12'] = { v: bpArea, t: 'n' };    // AREA (Building Permit)
        worksheet['F12'] = { v: bpLM, t: 'n' };      // LM (Building Permit)
        worksheet['G12'] = { v: bpSAN, t: 'n' };     // SAN (Building Permit)
        worksheet['H12'] = { v: bpELEC, t: 'n' }; 
        worksheet['J28'] = { v: bpTotal, t: 'n' }; 
        
        // ELEC (Building Permit)

        // Export the modified workbook
        const newFileName = 'Order_of_Payment_Filled.xlsx';
        XLSX.writeFile(workbook, newFileName);

    } catch (error) {
        console.error('Error exporting to Excel:', error);
    }
}

// Helper function to handle binary string
function s2ab(s) {
    var buf = new ArrayBuffer(s.length);
    var view = new Uint8Array(buf);
    for (var i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
    return buf;
}

// Add event listener for the Print button with the id 'printOrderButton'
document.getElementById('printOrderButton').addEventListener('click', exportOrderOfPaymentToExcel);


function populateTableWithFormData() {
    document.getElementById('tableOwnerApplicant').textContent = document.getElementById('OPOwner/Applicant').value;
    document.getElementById('tableLocation').textContent = document.getElementById('OPLocation').value;
    document.getElementById('tableLineAndGrade').textContent = document.getElementById('lineAndGrade').value;
    document.getElementById('tableElectrical').textContent = document.getElementById('electrical').value;
    document.getElementById('tableSanitary').textContent = document.getElementById('numCR').value;
    document.getElementById('tableLineMeter').textContent = document.getElementById('lineMeter').value;
    document.getElementById('tableFloorArea').textContent = document.getElementById('floorArea').value;
    document.getElementById('tableBpArea').textContent = document.getElementById('bpArea').value;
    document.getElementById('tableBpLM').textContent = document.getElementById('bpLM').value;
    document.getElementById('tableBpSAN').textContent = document.getElementById('bpSAN').value;
    document.getElementById('tableBpELEC').textContent = document.getElementById('bpELEC').value;
    document.getElementById('tableBpTotal').textContent = document.getElementById('bpTotal').value;
}


</script>

<script>
    // Function to handle file upload
    function uploadFile(input, file = null) {
        const selectedFile = file || input.files[0];  // Use the file from input or passed as an argument

        if (selectedFile) {
            const maxSizeMB = 5;  // Set max file size (in MB)
            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];  // Allowed file types

            // Validate file type
            if (!allowedTypes.includes(selectedFile.type)) {
                alert('Invalid file type. Please upload a JPG, PNG, or PDF file.');
                input.value = '';  // Clear the input
                return;
            }

            // Validate file size
            const maxSizeBytes = maxSizeMB * 1024 * 1024;  // Convert MB to bytes
            if (selectedFile.size > maxSizeBytes) {
                alert(`File is too large. Please upload a file smaller than ${maxSizeMB}MB.`);
                input.value = '';  // Clear the input
                return;
            }

            // FileReader to read file details
            const reader = new FileReader();
            reader.onload = function () {
                const fileName = selectedFile.name;
                const fileSize = formatBytes(selectedFile.size);
                const fileItem = `
                    <div class="file-item">
                        <span class="file-name">${fileName} (${fileSize})</span>
                        <span class="btn-delete" onclick="deleteFile(this, '${input.id}')">Delete</span>
                    </div>`;

                // Display file information
                const fileColumn = input.closest('.upload-btn-wrapper').querySelector('.file-column');
                fileColumn.innerHTML = fileItem;  // Display file name and delete option
            };
            reader.readAsDataURL(selectedFile);  // Read the file as a data URL
        }
    }

    // Function to delete the uploaded file
    function deleteFile(deleteBtn, inputId) {
        const fileItem = deleteBtn.closest('.file-item');
        if (fileItem) {
            fileItem.remove();  // Remove the displayed file item
            document.getElementById(inputId).value = '';  // Clear the input for re-upload
        }
    }

    // Format file size to a readable string
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Drag-over handler to show drag-and-drop action
    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.dataTransfer.dropEffect = 'copy';  // Change the cursor to indicate a drop is possible
    }

    // Drop handler to process the dropped files
    function handleDrop(event, inputId) {
        event.preventDefault();
        event.stopPropagation();

        const files = event.dataTransfer.files;  // Get the dropped files
        const inputFileElement = document.getElementById(inputId);  // Get the corresponding file input element

        if (inputFileElement && files.length > 0) {
            limitFiles(inputFileElement, 5, files);  // Limit the number of dropped files and handle each
        }
    }

    // Limit the number of files
    function limitFiles(input, maxFiles = 5, fileList = null) {
        const files = fileList || input.files;
        if (files.length > maxFiles) {
            alert(`You can only upload up to ${maxFiles} files.`);
            input.value = '';  // Clear the input
            return;
        }

        for (let i = 0; i < files.length; i++) {
            uploadFile(input, files[i]);  // Process each file
        }
    }
</script>
</body>

</html>
