<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link rel="icon" href="/resources/pictures/chsd.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
 <style>
    /* General container styles */
.content-container {
    overflow-y: auto;
    padding: 20px;
}

/* Flexbox for responsive layout */
.card-container {
    display: flex;
    gap: 20px;
    justify-content: space-around;
    padding-top: 20px;
    flex-wrap: wrap;
}

/* Individual card styles */
.permit-card {
    width: 300px;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s, box-shadow 0.3s;
    color: #333;
    background-color: #f9f9f9;
}

.permit-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

/* Icon size and margin */
.card-icon {
    font-size: 40px;
    margin-bottom: 15px;
}

/* Card-specific styles */
.building-card {
    background-color: #e6f4ea;
    color: #256228;
}

.occupancy-card {
    background-color: #fff7e6;
    color: #a97402;
}

.electrical-card {
    background-color: #e3f2fd;
    color: #104f97;
}

/* Button alignment */
button {
    margin-top: 15px;
}

 </style>

 <!-- Neumorphism Styling -->
<style>


    .clickable-card {
        cursor: pointer;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: none;
        border-radius: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px; /* Ensure consistent card height */
      
    }

    .clickable-card:hover {
        transform: translateY(-4px);
      
    }

    .neu-card {
        border-radius: 12px;
        box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.2), -8px -8px 20px rgba(255, 255, 255, 0.7);
        padding: 20px;
        width:100%;
        display:flex;
        justify-content: center;
        align-items:center;
        flex-direction: column;
    }

    .neu-card:hover {
        box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.3), -4px -4px 12px rgba(255, 255, 255, 0.6);
    }

    .card-title {
        font-size: 1.2rem;
        margin-top: 1rem;
    }
</style>

</head>
<body>
    
    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html" class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html" class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy Permit</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html" class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCLogs.html" class="text-decoration-none"><i class="fa-solid fa-envelope"></i> Notifications</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html" class="text-decoration-none"><i class="fa-solid fa-gear"></i> Settings</a></li>
                <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html" class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>
                <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminPCReports.html" class="text-decoration-none"><i class="fa-solid fa-chart-simple"></i> Reports</a></li>
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
            <!--Navigation Bar-->
            <nav class="navigationBar navbar navbar-expand-lg bg-light">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between d-md-none d-block">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
                            <h5 class="mb-0 fs-5">CHSD</h5>
                        </a>
                        <button class="btn px-1 py-0 open-btn">
                            <i class="fa-solid fa-bars-staggered"></i>
                        </button>
                    </div>
                    <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
                            <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
                        </a>
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
                    </div>
                </div>
            </nav>

            <div class="content-container">
                        <div class="contentContainer">
                             <!-- Monthly Reports Card -->
                             <div class="container my-5">
                                <div class="row justify-content-center">
                                    <!-- Monthly Reports Card -->
                                    <div class="col-md-3 mx-3">
                                        <div class="card text-center clickable-card justify-content-center align-items-center" id="generateMonthlyReports">
                                            <div class="card-body bg-primary text-white neu-card">
                                                <i class="fa-solid fa-file-export fa-3x"></i>
                                                <h5 class="card-title mt-3">Monthly Reports</h5>
                                            </div>
                                        </div>
                                    </div>
                            
                                    <!-- Annual Reports Card -->
                                    <div class="col-md-3 mx-3">
                                        <div class="card text-center clickable-card justify-content-center align-items-center" id="generateAnnualReports">
                                            <div class="card-body bg-success text-white neu-card">
                                                <i class="fa-solid fa-file-export fa-3x"></i>
                                                <h5 class="card-title mt-3">Annual Reports</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>



                        </div>    
            </div>
        </div>
    </div>

    <!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- jsPDF AutoTable Plugin CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  


    <script type="module" src="/Database/firebase.js"></script>
    <script>
        document.querySelector('.open-btn').addEventListener('click', function() {
            document.getElementById('side_nav').classList.add('active');
        });

        document.querySelector('.close-btn').addEventListener('click', function() {
            document.getElementById('side_nav').classList.remove('active');
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, Timestamp, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
            authDomain: "chsd-mis.firebaseapp.com",
            projectId: "chsd-mis",
            storageBucket: "chsd-mis.appspot.com",
            messagingSenderId: "694967679357",
            appId: "1:694967679357:web:65cffd50f13739f934f414",
            measurementId: "G-XBQTQFRLJ5"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        // Function to generate reports
        async function generateReport(collectionName, startDate, endDate, reportTitle, fileName) {
            const collectionRef = collection(db, collectionName);
            const q = query(
                collectionRef,
                where("createdAt", ">=", startDate),
                where("createdAt", "<=", endDate)
            );
    
            try {
                const querySnapshot = await getDocs(q);
                const reports = [];
    
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    reports.push({
                        id: data.buildingPermitNo || data.electricalCertNo || "N/A",
                        ownerName: data.ownerName || "N/A",
                        projectLocation: data.projectLocation || "N/A",
                        createdAt: data.createdAt?.toDate().toLocaleDateString() || "N/A",
                    });
                });
    
                const totalRecords = reports.length;
                if (totalRecords === 0) {
                    await Swal.fire({
                        icon: "info",
                        title: "No Records Found",
                        text: "No records found for the specified date range.",
                    });
                    return;
                }
    
                // Map collection names for the PDF subtitle
                const collectionNameMapping = {
                    buildingPermits: "Building Permits",
                    OccupancyPermits: "Occupancy Permits",
                    ElectricalCert: "Certificate of Final Electrical Inspection",
                };
    
                const mappedName = collectionNameMapping[collectionName] || "Unknown Collection";
    
                // Generate the PDF report using jsPDF with autoTable
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
    
                // Add the report title
                pdf.setFontSize(18);
                pdf.setTextColor(40);
                pdf.text(reportTitle, pdf.internal.pageSize.width / 2, 15, { align: "center" });
    
                pdf.setFontSize(14);
                pdf.setTextColor(80);
                pdf.text(`${mappedName}`, pdf.internal.pageSize.width / 2, 25, { align: "center" });
    
                // Add summary section
                pdf.setFontSize(12);
                pdf.setTextColor(50);
                pdf.text("Summary", 15, 40);
    
                pdf.setFontSize(10);
                const summaryDetails = [
                    `Total Records: ${totalRecords}`,
                    `Report Period: ${startDate.toDate().toLocaleDateString()} to ${endDate.toDate().toLocaleDateString()}`,
                ];
    
                summaryDetails.forEach((detail, index) => {
                    pdf.text(detail, 20, 50 + index * 10);
                });
    
                // Add a line separator
                pdf.setLineWidth(0.5);
                pdf.line(10, 70, pdf.internal.pageSize.width - 10, 70);
    
                // Prepare table headers and rows
                const headers = [["Permit Number", "Owner Name", "Project Location", "Date Created"]];
                const rows = reports.map((report) => [
                    report.id,
                    report.ownerName,
                    report.projectLocation,
                    report.createdAt,
                ]);
    
                // Add table with autoTable
                pdf.autoTable({
                    startY: 75,
                    head: headers,
                    body: rows,
                    styles: {
                        fontSize: 10,
                        cellPadding: 5,
                    },
                    headStyles: {
                        fillColor: [22, 160, 133],
                        textColor: 255,
                        fontSize: 12,
                        halign: "center",
                    },
                    alternateRowStyles: { fillColor: [240, 240, 240] },
                    margin: { top: 10, left: 10, right: 10 },
                });
    
                // Save the generated PDF
                pdf.save(fileName);
    
                await Swal.fire({
                    icon: "success",
                    title: "Report Generated",
                    text: `Report successfully generated and saved as ${fileName}`,
                });
            } catch (error) {
                console.error("Error generating report:", error);
                await Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "An error occurred while generating the report. Please try again.",
                });
            }
        }
    
        // Event listeners for report generation
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("generateMonthlyReports").addEventListener("click", async () => {
                const { value: result } = await Swal.fire({
                    title: "Generate Monthly Report",
                    html: `
                        <div class="container">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="collection-select" class="form-label">Permit Type</label>
                                    <select id="collection-select" class="form-select">
                                        <option value="buildingPermits">Building Permits</option>
                                        <option value="OccupancyPermits">Occupancy Permits</option>
                                        <option value="ElectricalCert">Electrical Certificates</option>
                                    </select>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="month-select" class="form-label">Month</label>
                                    <select id="month-select" class="form-select">
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="year-input" class="form-label">Year</label>
                                    <input type="number" id="year-input" class="form-control" placeholder="Enter Year" min="1000">
                                </div>
                            </div>
                        </div>
                    `,
                    preConfirm: () => {
                        const collectionName = document.getElementById("collection-select").value;
                        const month = document.getElementById("month-select").value;
                        const year = document.getElementById("year-input").value;
                        if (!collectionName || !month || !year) {
                            Swal.showValidationMessage("All fields are required!");
                            return false;
                        }
                        return { collectionName, month: parseInt(month), year: parseInt(year) };
                    },
                    showCancelButton: true,
                    confirmButtonText: "Generate",
                    cancelButtonText: "Cancel",
                    customClass: {
                        popup: "swal-wide",
                    },
                });
    
                if (result) {
                    const { collectionName, month, year } = result;
                    const startDate = Timestamp.fromDate(new Date(year, month - 1, 1));
                    const endDate = Timestamp.fromDate(new Date(year, month, 0, 23, 59, 59));
                    const reportTitle = `Monthly Report - ${new Date(year, month - 1).toLocaleString("default", {
                        month: "long",
                    })} ${year}`;
                    const fileName = `Monthly_Report_${collectionName}_${month}_${year}.pdf`;
                    await generateReport(collectionName, startDate, endDate, reportTitle, fileName);
                }
            });
    
            document.getElementById("generateAnnualReports").addEventListener("click", async () => {
                const { value: result } = await Swal.fire({
                    title: "Generate Annual Report",
                    html: `
                        <div class="container">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="collection-select" class="form-label">Permit Type</label>
                                    <select id="collection-select" class="form-select">
                                        <option value="buildingPermits">Building Permits</option>
                                        <option value="OccupancyPermits">Occupancy Permits</option>
                                        <option value="ElectricalCert">Electrical Certificates</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="year-input" class="form-label">Year</label>
                                    <input type="number" id="year-input" class="form-control" placeholder="Enter Year" min="1000">
                                </div>
                            </div>
                        </div>
                    `,
                    preConfirm: () => {
                        const collectionName = document.getElementById("collection-select").value;
                        const year = document.getElementById("year-input").value;
                        if (!collectionName || !year) {
                            Swal.showValidationMessage("All fields are required!");
                            return false;
                        }
                        return { collectionName, year: parseInt(year) };
                    },
                    showCancelButton: true,
                    confirmButtonText: "Generate",
                    cancelButtonText: "Cancel",
                    customClass: {
                        popup: "swal-wide",
                    },
                });
    
                if (result) {
                    const { collectionName, year } = result;
                    const startDate = Timestamp.fromDate(new Date(year, 0, 1));
                    const endDate = Timestamp.fromDate(new Date(year, 11, 31, 23, 59, 59));
                    const reportTitle = `Annual Report - ${year}`;
                    const fileName = `Annual_Report_${collectionName}_${year}.pdf`;
                    await generateReport(collectionName, startDate, endDate, reportTitle, fileName);
                }
            });
        });
    </script>
    
      
    
    
    


    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
