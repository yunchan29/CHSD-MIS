<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link rel="icon" href="/resources/pictures/chsd.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }

        #previewContainer {
    resize: both; /* Allow resizing in both directions */
    overflow: auto; /* Scroll if the content overflows */
    min-width: 300px; /* Set a minimum width */
    min-height: 300px; /* Set a minimum height */
    max-width: 100%; /* Prevent it from exceeding the container */
    max-height: 600px; /* Set a reasonable max height */
    border: 1px solid #ddd; /* Optional: add a border for clarity */
}


/* Custom class for approved status with high specificity */
#uploadedFilesList .approved-file {
    background-color: #d4edda !important; /* Light green */
    color: #155724 !important;            /* Dark green */
}

/* Custom class for disapproved status with high specificity */
#uploadedFilesList .disapproved-file {
    background-color: #f8d7da !important; /* Light red */
    color: #721c24 !important;            /* Dark red */
}

/* Custom styles for status badges */
#uploadedFilesList .status-approved {
    background-color: #28a745 !important; /* Bootstrap success green */
    color: white !important;
}

#uploadedFilesList .status-disapproved {
    background-color: #dc3545 !important; /* Bootstrap danger red */
    color: white !important;
}


@media (max-width: 768px) {
    .wide-modal {
        max-width: 100% !important;
    }
}
   
.btn-upload {
        padding: 8px 16px;
        background-color: #4CAF50 !important;
        color: white !important;
        border: none;
        cursor: pointer !important;
    }
    .btn-upload:hover {
        background-color: #45a049;
    }
    .file-item {
        display: flex;
        align-items: center;
    }
    .file-name {
        margin-right: 10px;
    }
    .btn-delete {
        color: red;
        cursor: pointer;
    }
   

    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center px-2 pt-3 pb-4">
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
            </div>
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminDashboardP&C.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminBuildingPermit.html" class="text-decoration-none"><i class="fa-solid fa-building-circle-check"></i> Building Permit</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminCertofOcc.html" class="text-decoration-none"><i class="fa-solid fa-person-shelter"></i> Occupancy Permit</a></li>
              <li class="sideNav active"><a href="/AdminPages/PermitsAndCert/adminCertofElec.html" class="text-decoration-none"><i class="fa-solid fa-bolt"></i> Electrical Inspection</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCNotif.html" class="text-decoration-none"><i class="fa-solid fa-gear"></i> Settings</a></li>
              <li class="sideNav"><a href="/AdminPages/PermitsAndCert/adminPCArchive.html" class="text-decoration-none"><i class="fa-solid fa-box-archive"></i> Archive</a></li>

              <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
           <!--Navigation Bar-->
           <nav class="navigationBar navbar navbar-expand-lg bg-light">
              <div class="container-fluid">
                  <!-- Mobile View -->
                  <div class="d-flex justify-content-between d-md-none d-block">
                      <a class="navbar-brand d-flex align-items-center" href="#">
                          <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
                          <h5 class="mb-0 fs-5">CHSD</h5>
                      </a>
                      <button class="btn px-1 py-0 open-btn">
                          <i class="fa-solid fa-bars-staggered"></i>
                      </button>
                  </div>

                  <!-- Desktop View -->
                  <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
                      <a class="navbar-brand d-flex align-items-center" href="#">
                          <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
                          <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
                      </a>
                      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                          <!-- Additional nav items go here -->
                      </ul>
                  </div>
              </div>
          </nav>
           
            <div class="contentContainer">
               
                <!-- Bootstrap Table -->
            <div class="container">
                
                <h5>Profile</h5>
                <div class="row mt-4">
                    <div class="col">
                        <a class="btn btn-dark text-white" data-bs-toggle="modal" data-bs-target="#electricalInspectionModal"><i class="fa-solid fa-plus"></i> Add Profile</a>
                    </div>
                <div class="d-flex justify-content-end mb-3">
                  <input type="text" class="form-control search-bar" placeholder="Search">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                  </div>
                </div>

                <h4 class="text-center">Electrical Inspection</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                          <th>Owner</th>
                          <th>Representative</th>
                          <th>Submitted at</th>
                          <th>Status</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                  <tbody id="profileTableBody">
                    <!-- Rows will be populated by Firebase data -->
                </tbody>
                </table>
             </div>
             <!-- End of Bootstrap Table -->
            </div>
        </div>
    </div>

   <!-- View Uploads Modal -->
<div class="modal fade" id="viewUploadsModal" tabindex="-1" aria-labelledby="viewUploadsModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewUploadsModalLabel">Uploaded Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Uploaded Files List -->
                    <div class="col-lg-12">
                        <ul id="uploadedFilesList" class="list-group">
                            <!-- Dynamically append files here -->
                        </ul>
                    </div>
                </div>
                <!-- Comment Summary Section -->
                <div id="commentSummaryContainer" class="mt-3">
                    <h6>File Validation Comments</h6>
                    <ul id="commentSummaryList" class="list-group">
                        <!-- Comments will be summarized here -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

  
  <!-- View Details Modal -->
  <div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="viewDetailsModalLabel">Permit Details</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <!-- Text information at the top -->
                  <div class="row">
                      <div class="col-md-6">
                          <p><strong>Owner Name:</strong> <span id="permitOwnerName"></span></p>
                      </div>
                      <div class="col-md-6">
                          <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                      </div>
                  </div>
              
                  <div class="row">
                      <div class="col-md-6">
                          <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                      </div>
                      <div class="col-md-6">
                          <p><strong>Permit ID:</strong> <span id="permitIdDisplay"></span></p>
                      </div>
                  </div>
              
                  <!-- Status selection in a row -->
                  <div class="row mb-3">
                      <div class="col-md-12">
                          <label for="statusSelect" class="form-label">Status</label>
                          <select id="statusSelect" class="form-select">
                              <option value="Pending">Pending</option>
                              <option value="Processing">Processing</option>
                              <option value="To Pay">To Pay</option>
                              <option value="For Approval">For Approval</option>
                              <option value="For Release">For Release</option>
                              <option value="Claimed">Claimed</option>
                          </select>
                      </div>
                  </div>
              
                  <!-- Comments section -->
                  <div class="row">
                      <div class="col-md-12">
                          <label for="officerRemarks">Comments</label>
                          <textarea class="form-control" id="officerRemarks" rows="2"></textarea>
                      </div>
                  </div>
              
                  <div id="viewDetailsModalBtnGrp">
  
                  </div>
              
                  <!-- Hidden input field to store the permit ID -->
                  <input type="hidden" id="hiddenPermitId">
              </div>
              
              
              <div class="modal-footer">
                 
                  <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
          </div>
      </div>
  </div>


  <div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="filePreviewContainer" style="display: none;"> <!-- Hidden by default -->
                    <iframe id="filePreview" style="width: 100%; height: 400px;" frameborder="0"></iframe>
                </div>
                <div class="mt-3">
                    <label>Validation:</label><br>
                    <input type="radio" name="validationOptions" value="approved" id="approvedOption">
                    <label for="approvedOption">Approve</label><br>
                    <input type="radio" name="validationOptions" value="disapproved" id="disapprovedOption">
                    <label for="disapprovedOption">Disapprove</label>
                </div>
               
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="saveValidationBtn">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
  <!-- Order of Payment Modal -->
  <div class="modal fade" id="orderOfPaymentModal" tabindex="-1" aria-labelledby="OrderOfPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="OrderOfPaymentModalLabel">
                    <i class="fa-solid fa-file-invoice"></i> Occupancy Permit - Order of Payment
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step Progress Bar -->
                <div class="step-progress mb-4">
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Form</div>
                    </div>
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Order of Payment</div>
                    </div>
                    <div class="step">
                        <div class="circle"></div>
                        <div class="label">Occupancy Certificate</div>
                    </div>
                </div>
                <div class="printArea" id="printOrderContent">
                    <div class="row mb-4">
                        <div class="d-flex justify-content-center align-items-center mb-2 mt-2">
                            <!-- Left Logo -->
                            <img src="/resources/pictures/calambaLogo.png" alt="Calamba Logo" style="height: 50px; width: 50px; margin-left: auto;">
                            <!-- Center Title -->
                            <div class="text-center" style="margin: 0 10px;">
                                <h5 class="mb-0">CITY HOUSING AND SETTLEMENTS DEPARTMENT</h5>
                                <p class="mb-0">City Government of Calamba</p>
                            </div>
                            <!-- Right Logo -->
                            <img src="/resources/pictures/chsd.png" alt="CHSD Logo" style="height: 50px; width: 50px; margin-right: auto;">
                        </div>
                    </div>
                    <!-- Order of Payment Form -->
                    <div class="container">
                        <h4 class="text-center">ORDER OF PAYMENT</h4>
                        <p class="text-center"><i>Payee: Treasurer/Cashier-City Treasury Office, City of Calamba</i></p>

                        <!-- Owner/Applicant Input -->
                        <div class="row mb-3">
                            <label for="OPOwnerApplicant">Owner/Applicant:</label>
                            <input type="text" class="form-control" id="paymentOwnerName" readonly>
                        </div>

                        <!-- Location Input -->
                        <div class="row mb-3">
                            <label for="OPLocation">Location</label>
                            <input type="text" class="form-control" id="paymentLocation" readonly>
                        </div>

                        <!-- Fee Breakdown -->
                      
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="totalFee">Fee</label>
                                <input type="number" class="form-control" id="paymentFee" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-secondary" id="exportOrderButton" disabled>
                    <i class="fa-solid fa-file-excel"></i> Export
                </button>
                <button type="button" class="btn btn-primary" id="printOrderOfPayment">
                    <i class="fa-solid fa-print"></i> Print Order of Payment
                </button>
            </div>
        </div>
    </div>
</div>

  <!-- Generate Electrical Cert Modal -->
  <div class="modal fade" id="generateElectricalCertModal" tabindex="-1" aria-labelledby="generateElectricalCertModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="generateElectricalCertModalLabel">Certificate OF Final Electrical Inspection</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="d-flex justify-content-center align-items-center mb-2 mt-2">
                <!-- Left Logo -->
                <img src="/resources/pictures/calambaLogo.png" alt="Calamba Logo" style="height: 40px; width: 40px; margin-left: auto;">
                <!-- Center Title -->
                <div class="text-center" style="margin: 0 10px;">
                    <h5 class="mb-0">CITY HOUSING AND SETTLEMENTS DEPARTMENT</h5>
                    <p class="mb-0">City Government of Calamba</p>
                </div>
                <!-- Right Logo -->
                <img src="/resources/pictures/chsd.png" alt="CHSD Logo" style="height: 40px; width: 40px; margin-right: auto;">
            </div>
            <h6 class="text-center">CERTIFICATE OF FINAL ELECTRICAL INSPECTION</h6>
            <div class="row">
                <div class="col-md-2">
                    
                    <p><strong>Date:</strong><span id="certIssuedOn"></span></p>
                </div>
            </div>
            <p class="px-3">
                THIS CERTIFIES that the electrical wiring systems and the electrical equipment enumerated here under located at 
                <input type="text" id="aaaProjectLocation" class="form-control form-control-sm d-inline-block" style="width: 120px;" placeholder="Project Location">
                Calamba City, Laguna, were inspected and/or tested on 
                <input type="date" id="testingDate" class="form-control form-control-sm d-inline-block" style="width: 100px;">
                and were found to be installed in compliance with the existing laws/ordinances and rules and regulations set forth in the Philippine Electric Code.
            </p>
            
    
            <h6 class="text-center">L O A D</h6>
            <div class="row">
                <div class="col-md-4">
                   
                    <p><strong>Light: </strong><span id="certLight"></span></p>
                </div>
                <div class="col-md-4">
                   
                    <p><strong>Switch: </strong><span id="certSwitch"></span></p>
                </div>
                <div class="col-md-4">
                   
                    <p><strong>Electrical Motor: </strong><span id="certElectricalMotor"></span></p>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                   
                    <p><strong>Convenience Outlet: </strong><span id="certConvOutlet"</p>
                </div>
                <div class="col-md-6">
                   
                    <p><strong>Other Apparatus: </strong><span id="certOtherApparatus"></span></p>
                </div>
            </div>
    
            <div class="row">
                <div class="col-md-6">
                
                    <p><strong>Owner/Occupant: </strong><span id="certOwnerName"></span></p>
                </div>
                <div class="col-md-6">
                   
                    <p><strong>Total KVA: </strong><span id="certTotalKVA"></span></p>
                </div>
            </div>
    
            <div class="row">
                <div class="col-md-12">
                  
                    <p><strong>Nature of Work: </strong><span id="certNatureOfWork"></span></p>
                </div>
             </div>
    
             <h6>REMARKS: IN COMPLIANCE</h6>
             <div class="row">
                <div class="col-md-3">
                   <label for="fee">
                    Fee
                   </label>
                   <input type="number" class="form-control" id="fee">
                </div>
                <div class="col-md-3">
                    <label for="ORNo">OR No.</label>
                    <input type="input" class="form-control" id="ORNo">
                </div>
                <div class="col-md-3">
                    <label for="dateRemarks">Date</label>
                    <input type="date" class="form-control" id="dateRemarks">
                </div>
                <p>NOTE: This certification is valid only for Six(6) months from date if inspection hereof unless sooner revoked by the Electrical Ibnspector for legal reason. this certification is not valid without HSD dry seal.</p>
                <br>
                <div class="row">
                    <div class="col-md-3">
                        
                        <label for="inspectedBy">Inspected By:</label>
                        <input type="text"class="form-control" id="inspectedBy">
                    </div>
                    <div class="col-md-3">
                        
                    </div>
                    <div class="col-md-3">
                       
                        <label for="issuedBy">Issued By:</label>
                        <input type="text" class="form-control" id="issuedBy">
                    </div>
                </div>
             </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>


   <!-- Certificate of Electrical Inspection Upload Modal -->
   <div class="modal fade" id="electricalInspectionModal" tabindex="-1" aria-labelledby="electricalInspectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="electricalInspectionModalLabel">Certificate of Electrical Inspection</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step Progress Bar -->
                <div class="step-progress mb-4">
                    <div class="step completed">
                        <div class="circle"></div>
                        <div class="label">Upload Requirements</div>
                    </div>
                    <div class="step">
                        <div class="circle"></div>
                        <div class="label">Appointment</div>
                    </div>
                </div>
                <!-- Content -->
                <div class="row g-3">
                    <label for="ownerName">Owner/Applicant Name:</label>
                     <input type="text" id="ownerName" name="ownerName" class="form-control" placeholder="Last Name, First Name, Middle Name">
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <label for="light">Light</label>
                        <select class="form-control" id="light">
                            <option value="">Select Light Type</option>
                            <option value="LED - Residential">LED - Residential</option>
                            <option value="Fluorescent - Residential">Fluorescent - Residential</option>
                            <option value="Incandescent - Residential">Incandescent - Residential</option>
                            <option value="LED - Commercial">LED - Commercial</option>
                            <option value="Fluorescent - Commercial">Fluorescent - Commercial</option>
                            <option value="Halogen - Commercial">Halogen - Commercial</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="switch">Switch</label>
                        <select class="form-control" id="switch">
                            <option value="">Select Switch Type</option>
                            <option value="Single Pole (Residential)">Single Pole (Residential)</option>
                            <option value="Double Pole (Residential)">Double Pole (Residential)</option>
                            <option value="Three-Way (Residential)">Three-Way (Residential)</option>
                            <option value="Single Pole (Commercial)">Single Pole (Commercial)</option>
                            <option value="Double Pole (Commercial)">Double Pole (Commercial)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="electricalMotor">Electrical Motor</label>
                        <select class="form-control" id="electricalMotor">
                            <option value="">Select Motor Type</option>
                            <option value="0.5 HP (Residential)">0.5 HP (Residential)</option>
                            <option value="1 HP (Residential)">1 HP (Residential)</option>
                            <option value="3 HP (Commercial)">3 HP (Commercial)</option>
                            <option value="5 HP (Commercial)">5 HP (Commercial)</option>
                            <option value="10 HP (Industrial)">10 HP (Industrial)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="convOutlet">Convenience Outlet</label>
                        <select class="form-control" id="convOutlet">
                            <option value="">Select Number of Outlets</option>
                            <option value="1 Outlet - 15A (Residential)">1 Outlet - 15A (Residential)</option>
                            <option value="2 Outlets - 15A (Residential)">2 Outlets - 15A (Residential)</option>
                            <option value="1 Outlet - 20A (Commercial)">1 Outlet - 20A (Commercial)</option>
                            <option value="2 Outlets - 20A (Commercial)">2 Outlets - 20A (Commercial)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="otherApparatus">Other Apparatus</label>
                        <select class="form-control" id="otherApparatus">
                            <option value="">Select Apparatus Type</option>
                            <option value="Generator (Residential)">Generator (Residential)</option>
                            <option value="UPS (Residential)">UPS (Residential)</option>
                            <option value="Generator (Commercial)">Generator (Commercial)</option>
                            <option value="UPS (Commercial)">UPS (Commercial)</option>
                            <option value="Inverter (Solar)">Inverter (Solar)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="totalKVA">Total KVA</label>
                        <select class="form-control" id="totalKVA">
                            <option value="">Select KVA Rating</option>
                            <option value="1 KVA (Residential)">1 KVA (Residential)</option>
                            <option value="2 KVA (Residential)">2 KVA (Residential)</option>
                            <option value="5 KVA (Commercial)">5 KVA (Commercial)</option>
                            <option value="10 KVA (Commercial)">10 KVA (Commercial)</option>
                            <option value="50 KVA (Industrial)">50 KVA (Industrial)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="col-md-12">
                        <label for="natureOfWork">Nature of Work</label>
                        <select class="form-control" id="natureOfWork">
                            <option value="">Select Nature of Work</option>
                            <option value="New Installation">New Installation</option>
                            <option value="Repair">Repair</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Modification">Modification</option>
                            <option value="Temporary Service">Temporary Service</option>
                        </select>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Requirements</th>
                            <th>File</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Photocopy of Meralco Service Application</td>
                            <td class="file-column">
                                <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                    <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                         ondrop="handleDrop(event, 'meralcoServiceFile')" ondragover="handleDragOver(event)">
                                        <p>Drag & drop file</p>
                                    </div>
                                    <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('meralcoServiceFile').click()">Upload</button>
                                    <input type="file" class="file-input" id="meralcoServiceFile" style="display: none;" onchange="uploadFile(this)">
                                    <div id="meralcoServiceFileName" class="file-column"></div> <!-- Display file details here -->
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Photocopy of Barangay Clearance</td>
                            <td class="file-column">
                                <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                    <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                         ondrop="handleDrop(event, 'barangayClearanceFile')" ondragover="handleDragOver(event)">
                                        <p>Drag & drop file</p>
                                    </div>
                                    <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('barangayClearanceFile').click()">Upload</button>
                                    <input type="file" class="file-input" id="barangayClearanceFile" style="display: none;" onchange="uploadFile(this)">
                                    <div id="barangayClearanceFileName" class="file-column"></div> <!-- Display file details here -->
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Proof of Ownership</td>
                            <td class="file-column">
                                <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                    <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                         ondrop="handleDrop(event, 'ownershipFile')" ondragover="handleDragOver(event)">
                                        <p>Drag & drop file</p>
                                    </div>
                                    <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('ownershipFile').click()">Upload</button>
                                    <input type="file" class="file-input" id="ownershipFile" style="display: none;" onchange="uploadFile(this)">
                                    <div id="ownershipFileName" class="file-column"></div> <!-- Display file details here -->
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Photocopy of Certificate of Occupancy-Building Permit</td>
                            <td class="file-column">
                                <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                    <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                         ondrop="handleDrop(event, 'occupancyFile')" ondragover="handleDragOver(event)">
                                        <p>Drag & drop file</p>
                                    </div>
                                    <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('occupancyFile').click()">Upload</button>
                                    <input type="file" class="file-input" id="occupancyFile" style="display: none;" onchange="uploadFile(this)">
                                    <div id="occupancyFileName" class="file-column"></div> <!-- Display file details here -->
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Picture of Structure and Contact Number</td>
                            <td class="file-column">
                                <div class="upload-btn-wrapper" style="display: flex; align-items: center;">
                                    <div class="drag-drop-area" style="border: 1px dashed #ccc; padding: 10px; margin-right: 10px;" 
                                         ondrop="handleDrop(event, 'structurePhotoFile')" ondragover="handleDragOver(event)">
                                        <p>Drag & drop file</p>
                                    </div>
                                    <button class="btn btn-upload" style="margin-left: 10px;" onclick="document.getElementById('structurePhotoFile').click()">Upload</button>
                                    <input type="file" class="file-input" id="structurePhotoFile" style="display: none;" onchange="uploadFile(this)">
                                    <div id="structurePhotoFileName" class="file-column"></div> <!-- Display file details here -->
                                </div>
                            </td>
                        </tr>
                    </tbody>
                    
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitAppointment">Submit</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <script type="module" src="/Database/firebase.js"></script>
    <script type="module">
      // Import Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc, getDocs, setDoc, deleteDoc, limit, orderBy, onSnapshot, query, where, startAfter, getDoc} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
        authDomain: "chsd-mis.firebaseapp.com",
        projectId: "chsd-mis",
        storageBucket: "chsd-mis.appspot.com",
        messagingSenderId: "694967679357",
        appId: "1:694967679357:web:65cffd50f13739f934f414",
        measurementId: "G-XBQTQFRLJ5"
      };
    
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

    document.addEventListener('DOMContentLoaded', () => {
    let formSubmitted = false;

    document.getElementById('submitAppointment').addEventListener('click', async (event) => {
        event.preventDefault();
        const submitButton = document.getElementById('submitAppointment');
        submitButton.disabled = true;

        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.style.display = 'flex';
        }

        // Collect input values
        const ownerName = document.getElementById("ownerName").value.trim();
        const light = document.getElementById("light").value.trim();
        const switchType = document.getElementById("switch").value.trim();
        const electricalMotor = document.getElementById("electricalMotor").value.trim();
        const convOutlet = document.getElementById("convOutlet").value.trim();
        const otherApparatus = document.getElementById("otherApparatus").value.trim();
        const totalKVA = document.getElementById("totalKVA").value.trim();
        const natureOfWork = document.getElementById("natureOfWork").value.trim();

        // Required field validation
        const requiredFields = [
            { field: ownerName, name: 'Owner Name' }
        ];

        for (const { field, name } of requiredFields) {
            if (!field) {
                alert(`Please fill out the ${name} field.`);
                submitButton.disabled = false;
                return;
            }
        }

        // File inputs for Electrical Inspection
        const requiredFileInputs = [
            { id: 'meralcoServiceFile', name: 'Meralco Service', namePrefix: 'meralcoService' },
            { id: 'barangayClearanceFile', name: 'Barangay Clearance', namePrefix: 'barangayClearance' },
            { id: 'ownershipFile', name: 'Proof of Ownership', namePrefix: 'ownership' },
            { id: 'occupancyFile', name: 'Occupancy', namePrefix: 'occupancy' },
            { id: 'structurePhotoFile', name: 'Structure Photo', namePrefix: 'structurePhoto' }
        ];

        // Validate that each required file is uploaded
        for (const { id, name } of requiredFileInputs) {
            const fileInput = document.getElementById(id);
            if (!fileInput || !fileInput.files[0]) {
                alert(`Please upload the ${name} file.`);
                submitButton.disabled = false;
                return;
            }
        }

        try {
            // Ensure the user is authenticated
            const user = await new Promise((resolve, reject) => {
                onAuthStateChanged(auth, user => {
                    if (user) {
                        resolve(user);
                    } else {
                        reject(new Error("No user is authenticated."));
                    }
                });
            });

            const userId = user.uid;

            // Prepare inspection data for Firestore
            const inspectionData = {
                ownerUid: userId,
                ownerName,
                light,
                switchType,
                electricalMotor,
                convOutlet,
                otherApparatus,
                totalKVA,
                natureOfWork,
                status: 'Pending',
                createdAt: serverTimestamp(),
            };

            // Add a new document to Firestore for Electrical Inspection
            const inspectionDocRef = await addDoc(collection(db, "ElectricalCert"), inspectionData);
            const inspectionId = inspectionDocRef.id;
            const storagePath = `ElectricalCert/${inspectionId}`;

            // Handle file uploads and storage
            const uploadPromises = requiredFileInputs.map(async fileInputObj => {
                const fileInput = document.getElementById(fileInputObj.id);
                if (fileInput && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const sanitizedFileName = fileInputObj.namePrefix + '_' + file.name.replace(/\s+/g, '');
                    const fileRef = ref(storage, `${storagePath}/${sanitizedFileName}`);
                    const snapshot = await uploadBytes(fileRef, file);
                    return getDownloadURL(snapshot.ref);
                } else {
                    console.error(`File input missing or undefined for ${fileInputObj.name}`);
                    return null;
                }
            });

            // Wait for all uploads and store URLs
            const fileURLs = await Promise.all(uploadPromises);

            const fileURLMapping = {
                meralcoServiceURL: fileURLs[0],
                barangayClearanceURL: fileURLs[1],
                ownershipURL: fileURLs[2],
                occupancyURL: fileURLs[3],
                structurePhotoURL: fileURLs[4],
            };

            // Update Firestore document with file URLs
            const inspectionDoc = doc(db, "ElectricalCert", inspectionId);
            await updateDoc(inspectionDoc, fileURLMapping);
            
            // Set formSubmitted to true after successful submission
            formSubmitted = true;

            Swal.fire({
                title: "Success!",
                text: "Application Submitted",
                icon: "success"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Hide both modals after confirmation
                    const uploadModal = bootstrap.Modal.getInstance(document.getElementById('electricalInspectionModal'));
                    const appointmentModal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
                    
                    if (uploadModal) uploadModal.hide();
                    if (appointmentModal) appointmentModal.hide();
                }
            });

        } catch (error) {
            console.error("Error during submission:", error);
            alert(`Error submitting application: ${error.message}`);
        } finally {
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            submitButton.disabled = false;
        }
    });
});



    // Function to Dynamically Append Buttons to the View Details Modal for Electrical Certificates
function appendButtons(data) {
    const viewDetailsModalBtnGrp = document.getElementById('viewDetailsModalBtnGrp');
    viewDetailsModalBtnGrp.innerHTML = ''; // Clear existing buttons

    // First Row for View File Uploads and Generate Electrical Certificate
    const firstRow = document.createElement('div');
    firstRow.className = 'row mt-4';

    // View Electrical Certificate Uploads Button
    const col1 = document.createElement('div');
    col1.className = 'col-md-6 mb-2';
    const btn1 = document.createElement('button');
    btn1.className = 'btn btn-primary w-100';
    btn1.textContent = 'View File Uploads';
    btn1.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) {
            viewDetailsModal.hide(); // Hide View Details Modal
        }
        openViewUploadsModal(data); // Open View Uploads Modal for Electrical Certificates
    });
    col1.appendChild(btn1);

    // Generate Electrical Certificate Button
    const col2 = document.createElement('div');
    col2.className = 'col-md-6 mb-2';
    const btn2 = document.createElement('button');
    btn2.className = 'btn btn-primary w-100';
    btn2.textContent = 'Generate Certificate';
    btn2.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) {
            viewDetailsModal.hide(); // Hide View Details Modal
        }
        openGenerateElectricalCertModal(data); // Open Generate Electrical Certificate Modal
    });
    col2.appendChild(btn2);

    firstRow.appendChild(col1);
    firstRow.appendChild(col2);

    // Second Row for Generate Order of Payment Button
    const secondRow = document.createElement('div');
    secondRow.className = 'row mt-2';

    const col3 = document.createElement('div');
    col3.className = 'col-md-12';
    const btn3 = document.createElement('button');
    btn3.className = 'btn btn-success w-100 generate-order-payment-btn';
    btn3.textContent = 'Generate Order of Payment';

    // Add event listener for generating Order of Payment
    btn3.addEventListener('click', () => {
        generateOrderOfPayment(data); // Generate order of payment using the data
        
        // Hide the View Details modal
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) {
            viewDetailsModal.hide(); // Hide View Details Modal
        }

        // Trigger Order of Payment Modal
        const orderOfPaymentModal = new bootstrap.Modal(document.getElementById('orderOfPaymentModal'));
        orderOfPaymentModal.show();

        // Remove the backdrop manually after the modal closes to avoid the lingering backdrop
        document.getElementById('orderOfPaymentModal').addEventListener('hidden.bs.modal', function () {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove(); // Ensure the backdrop is removed
            }
        });
    });

    col3.appendChild(btn3);
    secondRow.appendChild(col3);

    // Third Row for Archive Button
    const thirdRow = document.createElement('div');
    thirdRow.className = 'row mt-2';

    const col4 = document.createElement('div');
    col4.className = 'col-md-12';
    const btn4 = document.createElement('button');
    btn4.className = 'btn btn-danger w-100 archive-electrical-cert-btn';
    btn4.textContent = 'Archive Electrical Certificate';
    btn4.setAttribute('data-id', data.id);

    // Add event listener for archiving the electrical certificate
    btn4.addEventListener('click', (event) => handleArchiveElectricalCert(event));

    col4.appendChild(btn4);
    thirdRow.appendChild(col4);

    // Append Rows to Button Group
    viewDetailsModalBtnGrp.appendChild(firstRow);
    viewDetailsModalBtnGrp.appendChild(secondRow);
    viewDetailsModalBtnGrp.appendChild(thirdRow);
}

async function generateOrderOfPayment(data) {
    try {
        console.log("Generating Order of Payment for:", data); // Debugging

        // Fetch the Occupancy Permit data from Firestore
        const electricalDoc = await getDoc(doc(db, "ElectricalCert", data.id));
        if (!electricalDoc.exists()) {
            console.error("Electrical Permit not found!");
            Swal.fire('Error', 'Electrical Permit data is missing!', 'error');
            return;
        }

        const permitData = electricalDoc.data();

        // Extract relevant fields
        const ownerName = permitData.ownerName || "N/A";
        const location = permitData.projectLocation || "N/A";
        const fee = 200.00;
      

        // Populate modal fields
        const modal = document.getElementById('orderOfPaymentModal');
        modal.querySelector('#paymentOwnerName').value = ownerName;
        modal.querySelector('#paymentLocation').value = location;
        modal.querySelector('#paymentFee').value = fee;

        // Show the Order of Payment Modal
        const orderOfPaymentModal = new bootstrap.Modal(modal);
        orderOfPaymentModal.show();

    } catch (error) {
        console.error("Error generating Order of Payment:", error);
        Swal.fire('Error', 'Failed to generate Order of Payment. Please try again.', 'error');
    }
}


// Function to Open the Electrical Certificate Modal
async function openGenerateElectricalCertModal(certData) {
    try {
        console.log("Electrical Certificate Data received:", certData); // Log certData to ensure it's not empty

        // Fetch the data from the ElectricalCerts collection based on the certId
        const electricalCertData = await getDoc(doc(db, "ElectricalCert", certData.id));

        if (!electricalCertData.exists()) {
            console.error("Electrical Certificate not found!");
            alert("Electrical Certificate data is missing!");
            return;
        }

        const data = electricalCertData.data();
        console.log("Electrical Certificate Data retrieved:", data); // Log the fetched data to ensure it's being retrieved correctly
        const certLight = document.getElementById("certLight").textContent = data.light;
        const certSwitch = document.getElementById("certSwitch").textContent = data.switchType;
        const certElectricalMotor = document.getElementById("certElectricalMotor").textContent = data.electricalMotor;
        const certConvOutlet = document.getElementById("certConvOutlet").textContent = data.convOutlet;
        const certApparatus = document.getElementById("certOtherApparatus").textContent = data.otherApparatus;
        const certNatureOfWork = document.getElementById("certNatureOfWork").textContent = data.natureOfWork;
        const certTotalKVA = document.getElementById("certTotalKVA").textContent = data.totalKVA;
        const certOwnerName = document.getElementById("certOwnerName").textContent = data.ownerName;
      
        const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000) : null;

        if (createdAt && !isNaN(createdAt)) {
            const formattedDate = createdAt.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            document.getElementById("certIssuedOn").textContent = formattedDate;
        } else {
            document.getElementById("certIssuedOn").textContent = "Date not available";
        }

        console.log("Electrical Certificate fields populated");

        // Show the Electrical Certificate Modal
        const electricalCertModal = new bootstrap.Modal(document.getElementById('generateElectricalCertModal'));
        electricalCertModal.show();
    } catch (error) {
        console.error("Error opening Electrical Certificate modal:", error);
        alert("Failed to load Electrical Certificate data.");
    }
}




      // Function to show notification
      function showNotification(message, type) {
        console.log(`Showing notification: ${message}`);
        const notificationContainer = document.getElementById('notification-container');
        if (notificationContainer) {
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.textContent = message;
          notificationContainer.appendChild(notification);
        } else {
          console.error('Notification container not found.');
        }
      }
    
   // Pagination Variables
let profilesPerPage = 50; // Profiles per page
let currentPage = 1; // Current page
let lastVisible = null; // For pagination

async function loadElectricalProfiles() {
    const loadingScreen = document.getElementById("loading-screen"); // Reference to loading screen element

    try {
        // Show the loading screen
        if (loadingScreen) loadingScreen.style.display = "flex";

        const electricalCertDiv = document.getElementById("profileTableBody");
        const prevPageBtn = document.getElementById("prevPageBtn");
        const nextPageBtn = document.getElementById("nextPageBtn");
        const pageInfo = document.getElementById("pageInfo");

        if (!electricalCertDiv) {
            console.error("electricalCertDiv not found in the DOM.");
            return;
        }

        electricalCertDiv.innerHTML = ""; // Clear existing rows

        // Firestore Query
        let queryRef = collection(db, "ElectricalCert");
        queryRef = query(queryRef, orderBy("createdAt", "asc"), limit(profilesPerPage));

        if (lastVisible && currentPage > 1) {
            queryRef = query(queryRef, startAfter(lastVisible));
        }

        const querySnapshot = await getDocs(queryRef);
        if (querySnapshot.docs.length > 0) {
            lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1]; // Save last document for pagination
        }

        const certificatesData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Fetch Related User Data in Batch
        const userUids = certificatesData.map(data => data.ownerUid).filter(uid => uid);
        const userDocsPromises = userUids.map(uid => getDoc(doc(db, "users", uid)));
        const userDocs = await Promise.all(userDocsPromises);

        const userDataMap = {};
        userDocs.forEach(userDoc => {
            if (userDoc.exists()) {
                const data = userDoc.data();
                userDataMap[userDoc.id] = `${data.firstName} ${data.lastName}`;
            }
        });

        // Populate Table
        const fragment = document.createDocumentFragment();
        certificatesData.forEach(data => {
            const row = document.createElement("tr");

            const representativeName = userDataMap[data.ownerUid] || "N/A";
            const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";

            row.innerHTML = `
                <td>${data.ownerName || "N/A"}</td>
                <td>${representativeName}</td>
                <td>${createdAt}</td>
                <td>${data.status || "N/A"}</td>
                <td>
                    <button class="btn btn-primary btn-sm view-details-btn" data-permit-id="${data.id}">View Details</button>
                </td>
            `;

            const viewDetailsBtn = row.querySelector(".view-details-btn");
            if (viewDetailsBtn) {
                viewDetailsBtn.addEventListener("click", () => openViewDetailsModal(data));
            }

            fragment.appendChild(row);
        });

        electricalCertDiv.appendChild(fragment);

        // Update Pagination Info
        pageInfo.textContent = `Page ${currentPage}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = querySnapshot.docs.length < profilesPerPage;

        // Add Pagination Event Listeners
        prevPageBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                loadElectricalProfiles();
            }
        };

        nextPageBtn.onclick = () => {
            if (querySnapshot.docs.length === profilesPerPage) {
                currentPage++;
                loadElectricalProfiles();
            }
        };

    } catch (error) {
        console.error("Error loading profiles:", error);
        showNotification("Failed to load profiles.", "error");
    } finally {
        // Hide the loading screen
        if (loadingScreen) loadingScreen.style.display = "none";
    }
}

let fileValidationStatus = {};

async function openViewUploadsModal(permitData) {
    try {
        console.log("Fetching uploaded files and validation status for permit:", permitData.id);

        const permitDocRef = doc(db, "ElectricalCert", permitData.id);
        const permitSnapshot = await getDoc(permitDocRef);

        const uploadedFilesList = document.getElementById('uploadedFilesList');
        const commentSummaryList = document.getElementById('commentSummaryList');
        uploadedFilesList.innerHTML = '';  // Clear existing files
        commentSummaryList.innerHTML = ''; // Clear previous comments

        if (!permitSnapshot.exists()) {
            const noFilesItem = document.createElement('li');
            noFilesItem.className = 'list-group-item';
            noFilesItem.textContent = 'No files uploaded.';
            uploadedFilesList.appendChild(noFilesItem);
        } else {
            const permitData = permitSnapshot.data();
            const { barangayClearanceURL, meralcoServiceURL, occupancyURL, ownershipURL, structurePhotoURL, fileValidationStatus = {} } = permitData;

            if (!barangayClearanceURL && !meralcoServiceURL && !occupancyURL && !ownershipURL && !structurePhotoURL) {
                const noFilesItem = document.createElement('li');
                noFilesItem.className = 'list-group-item';
                noFilesItem.textContent = 'No files uploaded.';
                uploadedFilesList.appendChild(noFilesItem);
            } else {
                const createFileItem = (fileLabel, fileURL, fileRowId) => {
    const fileItem = document.createElement('li');
    fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
    fileItem.dataset.rowid = fileRowId;  // Use fixed fileRowId

    fileItem.innerHTML = `
        <span>${fileLabel}</span>
        <div>
            <a href="${fileURL}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-eye"></i></a>
            <button class="btn btn-sm btn-outline-success validation-btn" data-fileurl="${fileURL}" data-filelabel="${fileLabel}" data-rowid="${fileRowId}"><i class="fa-solid fa-list-check"></i></button>
        </div>`;

    // Attach validation event to open the validation modal
    const validationButton = fileItem.querySelector('.validation-btn');
    validationButton.addEventListener('click', (event) => {
        const fileRow = document.querySelector(`[data-rowid="${event.currentTarget.dataset.rowid}"]`);
        openValidationModal(event.currentTarget.dataset.fileurl, event.currentTarget.dataset.filelabel, fileRow);
    });

    uploadedFilesList.appendChild(fileItem);
};


                // Display each uploaded file
                if (barangayClearanceURL) createFileItem('Barangay Clearance', barangayClearanceURL, 'barangayClearance');
                if (meralcoServiceURL) createFileItem('Meralco Service', meralcoServiceURL, 'meralcoService');
                if (occupancyURL) createFileItem('Occupancy', occupancyURL, 'occupancy');
                if (ownershipURL) createFileItem('Proof of Ownership', ownershipURL, 'ownership');
                if (structurePhotoURL) createFileItem('Structure Photo', structurePhotoURL, 'structurePhoto');

                // Check for validation comments and status
                for (const fileRowId in fileValidationStatus) {
                    const { status, comments } = fileValidationStatus[fileRowId];
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1); // Capitalize first letter
                    const commentPrefix = `${fileRowId.replace(/([A-Z])/g, ' $1').trim()} - ${statusText} - `;

                    const commentSummaryItem = document.createElement('li');
                    commentSummaryItem.className = 'list-group-item';
                    commentSummaryItem.dataset.commentid = fileRowId;
                    commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;

                    commentSummaryList.appendChild(commentSummaryItem);
                }
            }
        }

        const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
        viewUploadsModal.show();

    } catch (error) {
        console.error("Error fetching uploads:", error);
        alert("Failed to load uploaded files.");
    }
}


function openValidationModal(fileURL, fileLabel, fileRow) {
    // Hide view uploads modal
    const viewUploadsModal = bootstrap.Modal.getInstance(document.getElementById('viewUploadsModal'));
    viewUploadsModal.hide();

    const validationModalLabel = document.getElementById('validationModalLabel');
    const commentsInput = document.getElementById('validationComments');
    const previewContainer = document.getElementById('filePreviewContainer');
    const filePreview = document.getElementById('filePreview');

    validationModalLabel.textContent = `Validation for ${fileLabel}`;
    commentsInput.value = ''; // Clear previous comments

    // Reset preview
    previewContainer.style.display = 'none';
    filePreview.src = ''; // Clear previous preview

    // Check file type for preview
    if (fileURL.endsWith('.pdf')) {
        filePreview.src = fileURL; // Set PDF URL for preview
        previewContainer.style.display = 'block'; // Show the preview container for PDFs
        filePreview.type = "application/pdf"; // Ensure it's treated as PDF
    } else {
        // For images and other types, show image preview
        filePreview.src = fileURL;
        previewContainer.style.display = 'block'; // Show preview for images
        filePreview.type = "image"; // Treat as image for other formats
    }

    // Store fileRow ID in save button for later validation
    const saveBtn = document.getElementById('saveValidationBtn');
    saveBtn.dataset.filerow = fileRow.dataset.rowid;

    saveBtn.removeEventListener('click', saveValidation);  // Remove previous listener
    saveBtn.addEventListener('click', saveValidation);      // Add new listener

    // Show the validation modal
    const validationModal = new bootstrap.Modal(document.getElementById('validationModal'));
    validationModal.show();
}

async function saveValidation() {
    const selectedOption = document.querySelector('input[name="validationOptions"]:checked');
    if (!selectedOption) {
        alert('Please select an option (approve/disapprove).');
        return;
    }

    const comments = document.getElementById('validationComments').value;
    const fileRowId = document.getElementById('saveValidationBtn').dataset.filerow;
    const fileRow = document.querySelector(`[data-rowid="${fileRowId}"]`);

    fileValidationStatus[fileRowId] = {
        status: selectedOption.value,
        comments: comments
    };

    const permitId = document.getElementById('hiddenPermitId').value;

    if (!permitId) {
        console.error('Permit ID is not available.');
        alert('Error: Permit data is missing.');
        return;
    }

    const permitDocRef = doc(db, "ElectricalCert", permitId);
    try {
        await updateDoc(permitDocRef, {
            [`fileValidationStatus.${fileRowId}`]: {
                status: selectedOption.value,
                comments: comments
            }
        });
        console.log('Validation saved to Firestore');
        Swal.fire({
  title: "Validated!",
  text: "File Validation Successful!",
  icon: "success"
});
    } catch (error) {
        console.error("Error saving validation to Firestore:", error);
        alert("Failed to save validation.");
    }

    // Close validation modal and reopen the view uploads modal
    const validationModal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
    validationModal.hide();

    const viewUploadsModal = new bootstrap.Modal(document.getElementById('viewUploadsModal'));
    viewUploadsModal.show();

    // Update the comment summary section
    const commentSummaryList = document.getElementById('commentSummaryList');
    let existingComment = commentSummaryList.querySelector(`[data-commentid="${fileRowId}"]`);

    const statusText = selectedOption.value.charAt(0).toUpperCase() + selectedOption.value.slice(1); // Capitalize the first letter
    const commentPrefix = `${fileRow.querySelector('span').textContent} - ${statusText} - `;

    if (existingComment) {
        // Update the existing comment
        existingComment.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
    } else {
        // Create a new comment if not already existing
        const commentSummaryItem = document.createElement('li');
        commentSummaryItem.className = 'list-group-item';
        commentSummaryItem.dataset.commentid = fileRowId; // Use the same fileRowId to identify the comment
        commentSummaryItem.innerHTML = `<strong>${commentPrefix}</strong> ${comments ? comments : 'No comments'}`;
        commentSummaryList.appendChild(commentSummaryItem);
    }
}


// Initialize modal for validation
document.addEventListener('DOMContentLoaded', () => {
    const validationModal = document.getElementById('validationModal');
    const saveValidationBtn = document.getElementById('saveValidationBtn');

    // Clear modal content when closed
    validationModal.addEventListener('hidden.bs.modal', () => {
        const validationOptions = document.querySelectorAll('input[name="validationOptions"]');
        validationOptions.forEach(option => option.checked = false);
        document.getElementById('validationComments').value = '';

        // Reset file preview
        const previewContainer = document.getElementById('filePreviewContainer');
        previewContainer.style.display = 'none'; // Hide the preview
        document.getElementById('filePreview').src = ''; // Clear preview source
    });

    // Initialize event listener for the save button
    saveValidationBtn.addEventListener('click', saveValidation);
});

// Function to Control Progressive Status Selection for Electrical Certificates
function updateStatusOptions(currentStatus) {
    const statusSelect = document.getElementById("statusSelect");

    const statusProgression = {
        "Pending": ["Pending", "Processing"],
        "Processing": ["Processing", "To Pay"],
        "To Pay": ["To Pay", "For Inspection"],
        "For Inspection": ["For Inspection", "For Approval"],
        "For Approval": ["For Approval", "For Release"],
        "For Release": ["For Release", "Claimed"],
        "Claimed": ["Claimed"]
    };

    const validStatuses = statusProgression[currentStatus] || [];

    const options = statusSelect.querySelectorAll("option");
    options.forEach(option => {
        if (validStatuses.includes(option.value)) {
            option.style.display = "block"; // Show valid options
        } else {
            option.style.display = "none"; // Hide invalid options
        }
    });

    // Set the statusSelect to the currentStatus
    statusSelect.value = currentStatus;
}


// Function to Open the View Details Modal
function openViewDetailsModal(permitData) {
    // Populate Modal Fields
    const appointmentDate = permitData.appointmentDate ? new Date(permitData.appointmentDate.seconds * 1000).toLocaleString() : "N/A";
    document.getElementById("permitOwnerName").textContent = permitData.ownerName || "N/A";
    document.getElementById("issuedOnDate").textContent = permitData.issuedOn || "N/A";
    document.getElementById("appointmentDateSched").textContent = appointmentDate || "N/A";
    document.getElementById("permitIdDisplay").textContent = permitData.id || "N/A";
    document.getElementById("hiddenPermitId").value = permitData.id || "";

    // Update Status Options
    updateStatusOptions(permitData.status || "Pending");

    // Append Dynamic Buttons
    appendButtons(permitData);

    // Show the Modal
    const viewDetailsModal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
    viewDetailsModal.show();

    // Add Event Listener for the Save Button (Ensure it's not duplicated)
    const saveStatusBtn = document.getElementById("saveStatusBtn");
    saveStatusBtn.onclick = async () => {
        const newStatus = document.getElementById("statusSelect").value;
        try {
            // Update Status in Firestore
            await updateDoc(doc(db, 'ElectricalCert', permitData.id), { status: newStatus });

            // Trigger Notification
            const message = `${permitData.ownerName}'s electrical certificate is now ${newStatus.toLowerCase()}`;
            showNotification(message, 'info');

            // Store Notification in Firestore
            await addDoc(collection(db, "notifications"), {
                userId: permitData.ownerUid,
                message: message,
                permitId: permitData.id,
                timestamp: serverTimestamp(),
                read: false
            });
            Swal.fire({
  title: "Success!",
  text: "Application Submitted",
  icon: "success"
});

            // Reload Profiles to Reflect Changes
            loadElectricalProfiles();

            // Hide Modal
            viewDetailsModal.hide();

        } catch (error) {
            console.error("Error updating certificate status:", error);
            showNotification("Failed to update certificate status.", "error");
        }
    };
}

// Function to Archive an Electrical Certificate
async function handleArchiveElectricalCert(event) {
    event.preventDefault();

    const electricalCertId = event.target.getAttribute('data-id');

    if (!electricalCertId) {
        console.error("Electrical Certificate ID is null or undefined.");
        showNotification("Error: Electrical Certificate ID is missing.", "error");
        return;
    }

    // SweetAlert for confirmation
    Swal.fire({
        title: "Are you sure?",
        text: "",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, archive it!"
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const electricalCertRef = doc(db, "ElectricalCert", electricalCertId);
                const electricalCertSnapshot = await getDoc(electricalCertRef);

                if (electricalCertSnapshot.exists()) {
                    const electricalCertData = electricalCertSnapshot.data();
                    
                    // Archive document
                    await setDoc(doc(db, "archivedElectricalCerts", electricalCertId), electricalCertData);
                    await deleteDoc(electricalCertRef);

                    // Remove the row from the table
                    const tableBody = document.querySelector("#profileTableBody");
                    const rowToRemove = tableBody.querySelector(`button[data-permit-id="${electricalCertId}"]`).closest('tr');
                    if (rowToRemove) rowToRemove.remove();

                    showNotification("Document archived successfully!", "success");

                    // Close the modal
                    const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
                    if (viewDetailsModal) {
                        viewDetailsModal.hide();
                    }

                    // Success feedback
                    Swal.fire({
                        title: "Archived!",
                        text: "Your file has been archived successfully.",
                        icon: "success"
                    });

                } else {
                    showNotification("Document not found!", "error");
                }
            } catch (error) {
                console.error("Error archiving document: ", error);
                showNotification(`Failed to archive document: ${error.message}`, "error");
            }
        }
    });
}

// Initial Load of Electrical Profiles
loadElectricalProfiles();

    </script>
    
    
    <script>
      document.querySelector('.open-btn').addEventListener('click', function() {
          document.getElementById('side_nav').classList.add('active');
      });
    
      document.querySelector('.close-btn').addEventListener('click', function() {
          document.getElementById('side_nav').classList.remove('active');
      });
    </script>

<script>
    function uploadFile(input, file = null) {
        const selectedFile = file || input.files[0];  // Use the file from input or passed as an argument

        if (selectedFile) {
            const maxSizeMB = 5;  // Set max file size (in MB)
            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];  // Allowed file types

            // Validate file type
            if (!allowedTypes.includes(selectedFile.type)) {
                alert('Invalid file type. Please upload a JPG, PNG, or PDF file.');
                input.value = ''; // Clear the input
                return;
            }

            // Validate file size
            const maxSizeBytes = maxSizeMB * 1024 * 1024;  // Convert MB to bytes
            if (selectedFile.size > maxSizeBytes) {
                alert(`File is too large. Please upload a file smaller than ${maxSizeMB}MB.`);
                input.value = '';  // Clear the input
                return;
            }

            // FileReader to read file details
            const reader = new FileReader();
            reader.onload = function () {
                const fileName = selectedFile.name;
                const fileSize = formatBytes(selectedFile.size);
                const fileItem = `
                    <div class="file-item">
                        <span class="file-name">${fileName} (${fileSize})</span>
                        <span class="btn-delete" onclick="deleteFile(this, '${input.id}')">Delete</span>
                    </div>`;

                // Display file information
                const fileColumn = input.closest('.file-column'); // Get the closest file-column
                if (fileColumn) {
                    fileColumn.insertAdjacentHTML('beforeend', fileItem);  // Append the file item
                } else {
                    console.error('File column not found.');
                }
            };
            reader.readAsDataURL(selectedFile);
        }
    }

    function deleteFile(deleteBtn, inputId) {
        const fileItem = deleteBtn.closest('.file-item');
        if (fileItem) {
            fileItem.remove();  // Remove the displayed file item
            document.getElementById(inputId).value = '';  // Clear the input for re-upload
        }
    }

    // Format file size to a readable string
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Drag-over handler to show drag-and-drop action
    function handleDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        event.dataTransfer.dropEffect = 'copy';  // Change the cursor to indicate a drop is possible
    }

    // Drop handler to process the dropped files
    function handleDrop(event) {
        event.preventDefault();
        event.stopPropagation();

        const files = event.dataTransfer.files;  // Get the dropped files
        const inputFileElement = event.target.closest('.upload-btn-wrapper').querySelector('.file-input');  // Find the corresponding file input

        if (inputFileElement && files.length > 0) {
            limitFiles(inputFileElement, 5, files);  // Limit the number of dropped files and handle each
        }
    }

    // Limit the number of files
    function limitFiles(input, maxFiles = 5, fileList = null) {
        const files = fileList || input.files;
        if (files.length > maxFiles) {
            alert(`You can only upload up to ${maxFiles} files.`);
            input.value = '';  // Clear the input
            return;
        }

        for (let i = 0; i < files.length; i++) {
            uploadFile(input, files[i]);  // Process each file
        }
    }
</script>



    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
