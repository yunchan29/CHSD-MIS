<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link rel="icon" href="/resources/pictures/chsd.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        .content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .content-container {
            overflow-y: auto;
            padding: 20px;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .step {
            display: inline-block;
            margin-right: 20px;
            opacity: 0.5;
        }
        .step.completed .circle {
            background-color: green;
        }
        .step.active {
            opacity: 1;
        }


         /* General print styles */
@media print {
  /* Hide everything except the content we want to print */
  body * {
    visibility: hidden;
  }

  /* Make the printable area visible */
  .printArea, .printArea * {
    visibility: visible;
  }

  /* Ensure the printed content appears at the top */
  .printArea {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    margin: 0 auto;
    padding: 20px;
  }

  /* Adjust for A4 paper */
  @page {
    size: A4;
    margin: 10mm;
  }
}



    </style>
</head>
<body>

    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center">
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-white"><i class="fal fa-stream"></i>Menu</button>
            </div>
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/adminDashboardInformalSettlers.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li class="sideNav active"><a href="/AdminPages/InformalSettlers/InformalSettlersApplication.html" class="text-decoration-none"><i class="fa-solid fa-folder"></i> Housing Application</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/InformalSettlersReport.html" class="text-decoration-none"><i class="fa-solid fa-chart-column"></i> Application Report</a></a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/followup.html" class="text-decoration-none"><i class="fa-solid fa-bullhorn"></i> Follow up</a></li>
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
            <nav class="navigationBar navbar navbar-expand-lg bg-light">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between d-md-none d-block">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
                            <h5 class="mb-0 fs-5">CHSD</h5>
                        </a>
                        <button class="btn px-1 py-0 open-btn">
                            <i class="fa-solid fa-bars-staggered"></i>
                        </button>
                    </div>

                    <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
                            <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
                        </a>
                    </div>
                </div>
            </nav>

          <div class="contentContainer">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <!-- Add Profile Button on the left -->
                <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#housingApplicationModal">
                    <i class="fa-solid fa-plus"></i> Add Profile
                </button>
            
                <div class="input-group" style="width: auto;">
                    <!-- Search Bar -->
                    <input type="text" class="form-control" id="searchBar" placeholder="Search...">
                
                    <!-- Sort/Filter Dropdown -->
                    <div class="input-group-append">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="sortFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort/Filter
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortFilterDropdown">
                            <!-- Sorting Options -->
                            <li><a class="dropdown-item sort-by-name" href="#">Sort by Name</a></li>
                            <li><a class="dropdown-item sort-by-date" href="#">Sort by Date Profiled</a></li>
                            <!-- Filtering Options -->
                            <li><a class="dropdown-item filter-pending" href="#">Filter by Pending</a></li>
                            <li><a class="dropdown-item filter-approved" href="#">Filter by Approved</a></li>
                            <li><a class="dropdown-item filter-archived" href="#">Filter by Archived</a></li>
                        </ul>
                    </div>
                </div>
                
                
                
                
            </div>
            
            <!-- Table Section -->
            <h4 class="text-center mt-2 mb-2">Housing Applications</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        
                        <th>Household Head</th>
                        <th>Date Submitted</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody class="housingDiv">
                    <!-- Profiles will be inserted here by JavaScript -->
                </tbody>
            </table>
            
                <div id="paginationControls">
                    <button class="btn btn-primary" id="prevPageBtn" disabled>Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button class="btn btn-primary" id="nextPageBtn" disabled>Next</button>
                </div>
                
           
            

                <div class="modal fade" id="housingApplicationModal" tabindex="-1" aria-labelledby="housingApplicationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">

                    <div class="modal-dialog modal-dialog-centered wide-modal">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h1 class="modal-title fs-5" id="housingApplicationModalLabel">Housing Application</h1>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            
                                
                
                               
                                <div class="step-progress mb-4">
                                    <div class="step completed" id="step-1">
                                        <div class="circle"></div>
                                        <div class="label">Information of Household</div>
                                    </div>
                                    <div class="step" id="step-2">
                                        <div class="circle"></div>
                                        <div class="label">Household Members</div>
                                    </div>
                                    <div class="step" id="step-3">
                                        <div class="circle"></div>
                                        <div class="label">Lot and House Characteristics</div>
                                    </div>
                                </div>
                               
                              <!-- Form Steps -->
                               <form id="housingApplicationForm">
            
                <div class="form-step active" id="form-step-1">
                    <p>Note: Fill up all the fields to proceed to the next step.</p>
                                    <p><i>Required fields are marked with <span class="required-asterisk">*</span></i></p>
                    <h5>Household Head Details</h5>
                    <div class="row">
                        <div class="col">
                            <label for="surveyNo">Survey No.</label>
                            <input type="text" id="surveyNo" class="form-control">
                        </div>
                        <div class="col">
                            <label for="dateApplied">Date<span class="required-asterisk">*</span></label>
                            <input type="date" id="dateApplied" class="form-control" required>
                        </div>
                        <div class="col">
                            <label for="barangay">Barangay<span class="required-asterisk">*</span></label>
                            <select class="form-control" id="barangay" required>
                                <option value="">Select Barangay</option>
                                <option>Barangay Uno</option>
                                <option>Barangay Dos</option>
                                <option>Barangay Tres</option>
                                <option>Barangay Kwatro</option>
                                <option>Barangay Singko</option>
                                <option>Barangay Sais</option>
                                <option>Barangay Syete</option>
                                <option>Bagong Kalsada</option>
                                <option>Banadero</option>
                                <option>Banlic</option>
                                <option>Barandal</option>
                                <option>Batino</option>
                                <option>Bubuyan</option>
                                <option>Bucal</option>
                                <option>Bunggo</option>
                                <option>Burol</option>
                                <option>Camaligan</option>
                                <option>Canlubang</option>
                                <option>Halang</option>
                                <option>Hornalan</option>
                                <option>Kay-Anlog</option>
                                <option>Laguerta</option>
                                <option>Lamesa</option>
                                <option>Lawa</option>
                                <option>Lecheria</option>
                                <option>Lingga</option>
                                <option>Looc</option>
                                <option>Mabato</option>
                                <option>Makiling</option>
                                <option>Majada Out</option>
                                <option>Mapagong</option>
                                <option>Masili</option>
                                <option>Maunong</option>
                                <option>Mayapa</option>
                                <option>Milagrosa</option>
                                <option>Palingon</option>
                                <option>Paciano Rizal</option>
                                <option>Palo Alto</option>
                                <option>Pansol</option>
                                <option>Parian</option>
                                <option>Prinza</option>
                                <option>Punta</option>
                                <option>Puting Lupa</option>
                                <option>Real</option>
                                <option>Saimsim</option>
                                <option>Sampiruhan</option>
                                <option>San Cristobal</option>
                                <option>San Jose</option>
                                <option>San Juan</option>
                                <option>Sirang Lupa</option>
                                <option>Sucol</option>
                                <option>Turbina</option>
                                <option>Ulango</option>
                                <option>Uwisan</option>
                            </select>                
                            
                        </div>
                        <div class="col">
                            <label for="sitioPurok">Sitio/Purok<span class="required-asterisk">*</span></label>
                            <select class="form-control" id="sitioPurok" required>
                                <option value="">Select Purok/Sitio</option>
                                <option>Purok 1</option>
                                <option>Purok 2</option>
                                <option>Purok 3</option>
                                <option>Purok 4</option>
                                <option>Purok 5</option>
                                <option>Purok 6</option>
                                <option>Purok 7</option>
                                <option>Purok 8</option>
                                <option>Purok 9</option>
                                <option>Purok 10</option>
                                <option>Sitio Kapayapaan</option>
                                <option>Sitio Lumot</option>
                                <option>Sitio Putol</option>
                                <option>Sitio Hulo</option>
                                <option>Sitio Masaya</option>
                                <option>Sitio Sungi</option>
                                <option>Sitio Banlic</option>
                                <option>Sitio Ilaya</option>
                                <option>Sitio Calero</option>
                                <option>Sitio Masiit</option>
                                <option>Sitio Tubigan</option>
                                <option>Sitio Sibulo</option>
                                <option>Sitio Sto. Tomas</option>
                                <option>Sitio Ronggot</option> 
                            </select>
                        </div>
                        
                    </div>
                
                    <div class="row">
                        <div class="col-md-4">
                           <label for="classificationArea">Classification Area<span class="required-asterisk">*</span></label>
                           <select class="form-control" id="classificationArea" required>
                            <option>Danger Zone</option>
                            <option>Not Danger Zone</option>
                           </select>
            
                        </div>
                       
                    </div>
                
                    <div class="row">
                        <div class="col-md-3">
                           <label for="householdBirthday">Date of Birth<span class="required-asterisk">*</span></label>
                           <input type="date" class="form-control" id="householdBirthday" required>
                        </div>
                        <div class="col-md-3">
                            <label for="householdSex">Sex<span class="required-asterisk">*</span></label>
                            <select class="form-control" id="householdSex" required>
                                <option>Male</option>
                                <option>Female</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="householdCivilStatus">Civil Status<span class="required-asterisk">*</span></label>
                            <select class="form-control" id="householdCivilStatus" required>
                                <option>Single</option>
                                <option>Married</option>
                                <option>Live in</option>
                                <option>Widowed</option>
                                <option>Single Parent</option>
                                <option>Separated</option>
            
                            </select>
                        </div>
                    </div>
                
                
                    <div class="row">
                        <div class="col-md-3">
                            <label for="householdLastName">Last Name<span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control" id="householdLastName">
                        </div>
                        <div class="col-md-3">
                            <label for="householdFirstName">First Name<span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control" id="householdFirstName">
                        </div>
                        <div class="col-md-3">
                            <label for="householdMiddleName">Middle Name</label>
                            <input type="text" class="form-control" id="householdMiddleName">
                        </div>
                        <div class="col-md-3">
                            <label for="householdMaidenName">Maiden Name</label>
                            <input type="text" class="form-control" id="householdMaidenName">
                        </div>
                    </div>
                
                    <div class="row">
                       <div class="col-md-6">
                        <label for="householdOccupation">Occupation<span class="required-asterisk">*</span></label>
                        <input type="text" class="form-control" id="householdOccupation" required>
                       </div>
                
                       <div class="col-md-6">
                         <label for="householdPlaceOfWork">Place Of Work<span class="required-asterisk">*</span></label>
                         <input type="text" class="form-control" id="householdPlaceOfWork" required>
                       </div>
                    </div>
                
                    <div class="row">
                        <div class="col">
                            <label for="householdAddress">Present Address<span class="required-asterisk">*</span></label>
                            <textarea class="form-control" id="householdAddress" rows="1" required></textarea>
                        </div>
                    </div>
                
                    <div class="row">
                
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <!-- Checkbox to toggle spouse fields -->
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="hasSpouse">
                                <label class="form-check-label" for="hasSpouse">
                                    Check if you have a spouse
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Spouse fields -->
                    <div class="row">
                        <h5>Name of Spouse</h5>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="spouseLastName">Last Name</label>
                            <input type="text" class="form-control" id="spouseLastName" disabled>
                        </div>
                        <div class="col-md-3">
                            <label for="spouseFirstName">First Name</label>
                            <input type="text" class="form-control" id="spouseFirstName" disabled>
                        </div>
                        <div class="col-md-3">
                            <label for="spouseMiddleName">Middle Name</label>
                            <input type="text" class="form-control" id="spouseMiddleName" disabled>
                        </div>
                        <div class="col-md-3">
                            <label for="spouseMaidenName">Maiden Name</label>
                            <input type="text" class="form-control" id="spouseMaidenName" disabled>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <label for="spouseBirthday">Date of Birth</label>
                            <input type="date" class="form-control" id="spouseBirthday" disabled>
                        </div>
                    </div>
                    
                
                    <div class="row">
                        <div class="col-md-4">
                           <label for="classificationOfSurveyHousehold">Classification Of Survey Household<span class="required-asterisk">*</span></label>
                           <select class="form-control" id="classificationOfSurveyHousehold" required>
                            <option>Caretaker</option>
                            <option>Co-Owner</option>
                            <option>Owner</option>
                            <option>Renter</option>
                            <option>RFO</option>
                            <option>Sharer</option>
                           </select>
                        </div>
                       
                        <div class="col-md-6">
                            <label for="structureOwner">Structure Owner<span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control" id="structureOwner" required>
                        </div>
                    </div>
                
                    <div class="row">
                        <div class="col-md-6">
                             <label for="provinceOfOrigin">Province Of Origin<span class="required-asterisk">*</span></label>
                             <input type="text" class="form-control" id="provinceOfOrigin" required>
                        </div>
                        <div class="col-md-3">
                            <label for="householdSize">Household Size<span class="required-asterisk">*</span></label>
                            <input type="number" class="form-control" id="householdSize" required>
                        </div>
                        <div class="col-md-3">
                            <label for="yearOfResidency">Year of Residency<span class="required-asterisk">*</span></label>
                            <input type="text" class="form-control" id="yearOfResidency" required>
                        </div>
                    </div>
                
                    <div class="row">
                
                        <label for="reasonsForEstablishing">Reasons For Establishing Residence In The Area<span class="required-asterisk">*</span></label>
                        <select class="form-control" id="reasonsForEstablishing">
                            <option>Proximity of Livelihood</option>
                            <option>Rent Free or Affordable Rental Rates</option>
                            <option>Acquired Right</option>
                            <option>Family Ties</option>
                            <option>Near School</option>
                            <option>No Other Place to Go</option>
                        </select>
                    </div>
                
                   
                    
                        
                
                
                   
                  
                
                    <div class="row justify-content-end mt-4">
                        <div class="col">
                           
                        </div>
                    </div>
                </div>
                
                
                                <div class="form-step" id="form-step-2">
                                    
                                    
                                    <h5>Household Members Information</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="memberName">Name<span class="required-asterisk">*</span></label>
                                            <input type="text" id="memberName" class="form-control" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="relationToHead">Relation To The Household Head<span class="required-asterisk">*</span></label>
                                            <select class="form-control" id="relationToHead" required>
                                                <option>Father</option>
                                                <option>Mother</option>
                                                <option>Child</option>
                                                <option>Sibling</option>
                                                <option>Husband</option>
                                                <option>Wife</option>
                                                <option>Uncle</option>
                                                <option>Aunt</option>
                                                <option>Grandmother</option>
                                                <option>Grandfather</option>
                                                <option>Others</option>
                                                </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-2">
                                            <label for="memberAge">Age<span class="required-asterisk">*</span></label>
                                            <input type="number" class="form-control" id="memberAge" required>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="memberGender">Gender<span class="required-asterisk">*</span></label>
                                            <select class="form-control" id="memberGender" required>
                                                <option>Male</option>
                                                <option>Female</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="memberCivilStatus">Civil Status<span class="required-asterisk">*</span></label>
                                            <select class="form-control" id="memberCivilStatus" required>
                                                <option>Single</option>
                                                <option>Married</option>
                                                <option>Live in</option>
                                                <option>Widowed</option>
                                                <option>Single Parent</option>
                                                <option>Separated</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="memberEducationalAttainment">Educational Attainment<span class="required-asterisk">*</span></label>
                                            <select class="form-control" id="memberEducationalAttainment" required>
                                                <option>Highest Educational Attainment</option>
                                                <option>Elementary Undergraduate</option>
                                                <option>Elementary Graduate</option>
                                                <option>High School Undergraduate</option>
                                                <option>High School Graduate</option>
                                                <option>College Undergraduate</option>
                                                <option>College Graduate</option>
                                            </select>
            
            
            
                                        </div>
                                    </div>
                
                                    <div class="row">
                                        <div class="col-md-2">
                                            <label for="memberEmployed">Employed<span class="required-asterisk">*</span></label>
                                            <select class="form-control" id="memberEmployed" required>
                                                <option>Yes</option>
                                                <option>No</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="memberOccupation">Occupation<span class="required-asterisk">*</span></label>
                                            <input type="text" class="form-control" id="memberOccupation" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="memberPlaceOfWork">Place of Work<span class="required-asterisk">*</span></label>
                                            <input type="text" class="form-control" id="memberPlaceOfWork" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="memberMonthlyIncome">Monthly Income(PHP)<span class="required-asterisk">*</span></label>
                                            <select class="form-control" id="memberMonthlyIncome" required>
                                                <option>Below 20,000</option>
                                                <option>20,000-25,000</option>
                                                <option>25,000-30,000</option>
                                                <option>Above 30,000</option>
                                            </select>
                                        </div>
                                        
                                    </div>
                
                                    <div class="row justify-content-end mt-4">
                                        <div class="col">
                                           
                                        </div>
                                    </div>
                                    
            
                                    <div id="addHouseholdLoading" class="spinner-border text-primary" role="status" style="display: none;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col text-end">
                                            <button class="btn btn-secondary" type="button" id="addHouseholdBtn"><i class="fa-solid fa-plus"></i> Add</button>
                                            <button class="btn btn-secondary" type="button" id="clearHouseholdBtn"><i class="fa-solid fa-delete-left"></i> Clear</button>
                                            <button class="btn btn-secondary" type="button" id="editHouseholdBtn"><i class="fa-solid fa-pencil"></i> Edit</button>
                                            <button class="btn btn-secondary" type="button" id="deleteHouseholdBtn"><i class="fa-solid fa-trash"></i> Delete</button>
                                        </div>
                                    </div>
                
                                    <div class="contentContainer">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Relation</th>
                                                    <th>Age</th>
                                                    <th>Gender</th>
                                                    <th>Civil Status</th>
                                                    <th>Educational Attainment</th>
                                                    <th>Employed</th>
                                                    <th>Occupation</th>
                                                    <th>Place of Work</th>
                                                    <th>Monthly Income</th>
                                                </tr>
                                            </thead>
                                            <tbody id="householdMembersTableBody"> <!-- Added id to tbody -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                </div>
                
                                <div class="form-step" id="form-step-3">
                                    <h5>Lot Information</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="lotOwner">Owner</label>
                                            <input type="text" class="form-control" id="lotOwner">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="construction">Construction/Building Materials Used</label>
                                            <select class="form-control" id="construction">
                                                <option>Concrete</option>
                                                <option>Wood/Nipa</option>
                                                <option>Plastic Roof Only</option>
                                                <option>Tent</option>
                                                <option>Mixed Materials</option>
                                                <option>Sharer</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="NOStoreys">Number Of Storeys</label>
                                            <input type="number" id="NOStoreys" class="form-control">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="estimatedFloorArea">Estimated Floor Area</label>
                                            <input type="number" class="form-control" id="estimatedFloorArea">
                                        </div>
                                    </div>
                
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="comfortRoom">Comfort Room</label>
                                            <select class="form-control" id="comfortRoom">
                                                <option>With Septic Tank Vault</option>
                                                <option>Without Septic</option>
                                                <option>None</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="utilities">Utilities/Facilities Present Power(Electricity)</label>
                                            <select class="form-control" id="utilities">
                                                <option>Meralco</option>
                                                <option>Connected To Other Subscriber</option>
                                                <option>None</option>
                                            </select>
                                        </div>
                                    </div>
                
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="sourceOfWater">Source of Water</label>
                                            <select class="form-control" id="sourceOfWater">
                                                <option value="">Select Source of Water</option>
                                                <option value="local_water_district">Local Water District</option>
                                                <option value="deep_well">Deep Well</option>
                                                <option value="shallow_well">Shallow Well</option>
                                                <option value="water_delivery">Water Delivery (Private Supplier)</option>
                                                <option value="communal_faucet">Communal Faucet System (Barangay/Community)</option>
                                                <option value="rainwater">Rainwater Collection</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <label for="telephone">Cellphone Number:</label>
                                            <input type="number" class="form-control" id="telephone">
                                        </div>
                                    </div>
                
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="modeOfHouse">Mode Of House/Structure Acquistion</label>
                                            <select class="form-control" id="modeOfHouse">
                                                <option>Sold Rights</option>
                                                <option>Transfer Rights</option>
                                                <option>Constructed</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="infoAboutLot">Information About The Surveyed Lot</label>
                                            <select class="form-control" id="infoAboutLot">
                                                <option>Caretaker</option>
                                                <option>Co-Owner</option>
                                                <option>Renter</option>
                                                <option>RFO</option>
                                                <option>Sharer</option>
                                            </select>
                                        </div>
                
                                        <div class="col-md-2">
                                            <label for="amountToPay">Amount To Pay</label>
                                            <input type="number" id="amountToPay" class="form-control">
                                        </div>
                                    </div>
                
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="relationshipWithOwner">Relationship With The Owner</label>
                                            <select class="form-control" id="relationshipWithOwner">
                                                <option>Lot Owner</option>
                                                <option>Child</option>
                                                <option>Parent</option>
                                                <option>Relative</option>
                                                <option>Others</option>
                                            </select>
                                        </div>
                
                                        <div class="col-md-6">
                                            <label for="typeOfStructure">Type Of Structure</label>
                                            <select class="form-control" id="typeOfStructure">
                                                <option>Residential</option>
                                                <option>Commercial</option>
                                                <option>Apartment</option>
                                                <option>Institution</option>
                                                <option>Others</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!--<div class="row">
                                        <div class="col-md-3"></div> 
                                        <div class="row justify-content-center">
                                            <div class="col-md-6">
                                                <label for="appointmentDate">Date</label>
                                                <input type="date" class="form-control" id="appointmentDate">
                                            </div>
                                        </div>
                                        <div class="col-md-3"></div> 
                                    </div>-->
                                   
                                   
                                   </form>
                                
                            </div>
                        </div>
                        <div class="modal-footer"> 
                            <button type="button" class="btn btn-primary" id="nextBtn1">Next</button>
                            <button type="button" class="btn btn-secondary" id="prevBtn2" style="display:none;">Previous</button>
                            <button type="button" class="btn btn-primary" id="nextBtn2" style="display:none;">Next</button>
                            <button type="button" class="btn btn-secondary" id="prevBtn3" style="display:none;">Previous</button>
                            <button type="button" class="btn btn-primary" id="submitBtn" style="display:none;">Submit</button>
                        </div>
                        
                          
                      </div>
                    </div>
            </div>
            </div>
            </div>


    <div class="modal fade" id="viewHousingApplicationModal" tabindex="-1" aria-labelledby="housingApplicationModalTitle" aria-hidden="true">
        <div class="wide-modal modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="housingApplicationModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="printArea" id="printHousingContent">
                <div class="modal-body" id="housingApplicationModalBody">
                    <!-- Housing application details will be populated here -->
                </div>
                </div>
                <div class="modal-footer">
                    <!-- Print Button -->
              
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printHousingForm">
                        <i class="fa-solid fa-print"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>
    

    
     <!-- View Details Modal --> 
<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailsModalLabel">Permit Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Text information at the top -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Owner Name:</strong> <span id="housingOwnerName"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                    </div>
                </div>
            
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Permit ID:</strong> <span id="permitIdDisplay"></span></p>
                    </div>
                </div>
            
                <!-- Status selection in a row -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="statusSelect" class="form-label">Status</label>
                        <select id="statusSelect" class="form-select">
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                           
                            <option value="Submitted">Submitted</option>
                        </select>
                    </div>
                </div>
            
               
            
                <div id="viewDetailsModalBtnGrp">
                    <!-- Any additional buttons can be added here if needed -->
                </div>
            
                <!-- Hidden input field to store the permit ID -->
                <input type="hidden" id="profileIdInput"> <!-- Update this to match your JavaScript -->
            </div>
            
            <div class="modal-footer">
                <button type="button" id="saveStatusButton" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div id="notification-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050; display: none;">
    <!-- Notifications will be dynamically added here -->
</div>


    <!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" ></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <script type="module" src="/Database/firebase.js"></script>
<!--Print-->
    <script>
 document.addEventListener("DOMContentLoaded", function() {
      
      const printHousingButton = document.getElementById("printHousingForm");
      if (printHousingButton) {
        printHousingButton.addEventListener("click", function() {
          const printContent = document.querySelector("#printHousingContent").outerHTML;
          const originalContent = document.body.innerHTML;
    
          document.body.innerHTML = printContent;
          window.print();
          document.body.innerHTML = originalContent;
          window.location.reload();
        });
      }
    
});

    </script>
    <script>
        // Get the elements
        const memberEmployed = document.getElementById('memberEmployed');
        const memberOccupation = document.getElementById('memberOccupation');
        const memberPlaceOfWork = document.getElementById('memberPlaceOfWork');
        const memberMonthlyIncome = document.getElementById('memberMonthlyIncome');
    
        // Function to enable/disable fields based on employment status
        function toggleEmploymentFields() {
            if (memberEmployed.value === 'No') {
                memberOccupation.disabled = true;
                memberPlaceOfWork.disabled = true;
                memberMonthlyIncome.disabled = true;
    
                // Clear the values of the disabled fields
                memberOccupation.value = '';
                memberPlaceOfWork.value = '';
                memberMonthlyIncome.value = '';
            } else {
                memberOccupation.disabled = false;
                memberPlaceOfWork.disabled = false;
                memberMonthlyIncome.disabled = false;
            }
        }
    
        // Add event listener to the dropdown to trigger the function when the value changes
        memberEmployed.addEventListener('change', toggleEmploymentFields);
    
        // Run the function on page load to set the initial state
        toggleEmploymentFields();
    </script>
    <script>
    
        document.addEventListener("DOMContentLoaded", function () {
        // Set the default value for "Date Applied" to today's date
        const dateAppliedInput = document.getElementById("dateApplied");
        const today = new Date().toISOString().split('T')[0];
        dateAppliedInput.value = today;
    
        // Disable future dates and the current date for the household birthday and spouse birthday
        const householdBirthdayInput = document.getElementById("householdBirthday");
        const spouseBirthdayInput = document.getElementById("spouseBirthday");
        const minAgeDate = new Date();
        minAgeDate.setFullYear(minAgeDate.getFullYear() - 18); // At least 18 years old
        
        // Setting the max date for birthdates to ensure 18+ age
        const maxDate = minAgeDate.toISOString().split('T')[0];
        householdBirthdayInput.max = maxDate;
        spouseBirthdayInput.max = maxDate;
        
        // Disable today and future dates for the household and spouse birthday
        householdBirthdayInput.setAttribute('max', maxDate);
        spouseBirthdayInput.setAttribute('max', maxDate);
    
        // Enable or disable spouse fields based on the "hasSpouse" checkbox
        const hasSpouseCheckbox = document.getElementById("hasSpouse");
        const spouseFields = [
            document.getElementById("spouseLastName"),
            document.getElementById("spouseFirstName"),
            document.getElementById("spouseMiddleName"),
            document.getElementById("spouseMaidenName"),
            document.getElementById("spouseBirthday")
        ];
    
        hasSpouseCheckbox.addEventListener("change", function () {
            spouseFields.forEach(field => {
                field.disabled = !hasSpouseCheckbox.checked;
            });
        });
    });
    
        </script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, serverTimestamp, getDoc, setDoc, deleteDoc, query, where, orderBy, limit, addDoc, Timestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
            authDomain: "chsd-mis.firebaseapp.com",
            projectId: "chsd-mis",
            storageBucket: "chsd-mis.appspot.com",
            messagingSenderId: "694967679357",
            appId: "1:694967679357:web:65cffd50f13739f934f414",
            measurementId: "G-XBQTQFRLJ5"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
    
        // Declare the householdMembers array to store all household members from step 2
        let householdMembers = [];
        
        // Input fields for household members
        const memberNameInput = document.getElementById('memberName');
        const relationToHeadInput = document.getElementById('relationToHead');
        const memberAgeInput = document.getElementById('memberAge');
        const memberGenderInput = document.getElementById('memberGender');
        const memberCivilStatusInput = document.getElementById('memberCivilStatus');
        const memberEducationalAttainmentInput = document.getElementById('memberEducationalAttainment');
        const memberEmployedInput = document.getElementById('memberEmployed');
        const memberOccupationInput = document.getElementById('memberOccupation');
        const memberPlaceOfWorkInput = document.getElementById('memberPlaceOfWork');
        const memberMonthlyIncomeInput = document.getElementById('memberMonthlyIncome');
        const tableBody = document.getElementById('householdMembersTableBody');
    
        // Loading spinner for household member addition
        const addMemberLoadingSpinner = document.getElementById('addHouseholdLoading');
    
        // Function to add household member
        function addHouseholdMember(e) {
            // Prevent form submission behavior
            e.preventDefault();
            e.stopPropagation();
    
            // Show loading spinner
            addMemberLoadingSpinner.style.display = 'inline-block';
    
            const member = {
                name: memberNameInput.value,
                relation: relationToHeadInput.value,
                age: memberAgeInput.value,
                gender: memberGenderInput.value,
                civilStatus: memberCivilStatusInput.value,
                education: memberEducationalAttainmentInput.value,
                employed: memberEmployedInput.value,
                occupation: memberOccupationInput.value,
                placeOfWork: memberPlaceOfWorkInput.value,
                income: memberMonthlyIncomeInput.value,
            };
    
            // Validate required fields
            if (!member.name || !member.relation || !member.age || !member.gender) {
                alert('Please fill in all required fields.');
                addMemberLoadingSpinner.style.display = 'none';
                return;
            }
    
            // Add the new member to the householdMembers array
            householdMembers.push(member);
    
            // Append the new household member to the table
            appendHouseholdMemberRow(member);
    
            // Clear input fields after adding
            clearHouseholdMemberInputs();
    
            // Hide the loading spinner
            setTimeout(() => {
                addMemberLoadingSpinner.style.display = 'none';
            }, 500);
        }
    
        // Function to append the new household member to the table without reloading
        function appendHouseholdMemberRow(member) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${member.name}</td>
                <td>${member.relation}</td>
                <td>${member.age}</td>
                <td>${member.gender}</td>
                <td>${member.civilStatus}</td>
                <td>${member.education}</td>
                <td>${member.employed}</td>
                <td>${member.occupation}</td>
                <td>${member.placeOfWork}</td>
                <td>${member.income}</td>
            `;
            tableBody.appendChild(row);
        }
    
        // Function to clear input fields
        function clearHouseholdMemberInputs() {
            memberNameInput.value = '';
            relationToHeadInput.value = '';
            memberAgeInput.value = '';
            memberGenderInput.value = '';
            memberCivilStatusInput.value = '';
            memberEducationalAttainmentInput.value = '';
            memberEmployedInput.value = '';
            memberOccupationInput.value = '';
            memberPlaceOfWorkInput.value = '';
            memberMonthlyIncomeInput.value = '';
        }
    
        // Add event listener to the "Add" button to trigger the add household member function
        document.getElementById('addHouseholdBtn').addEventListener('click', function (e) {
            addHouseholdMember(e); // Call the function to add the member and stop form submission
        });
    
        // Function to handle Step 3 (Lot and House Characteristics)
        async function addLotAndHouseDetails() {
            const lotOwner = document.getElementById('lotOwner').value;
            const construction = document.getElementById('construction').value;
            const NOStoreys = document.getElementById('NOStoreys').value;
            const estimatedFloorArea = document.getElementById('estimatedFloorArea').value;
            const comfortRoom = document.getElementById('comfortRoom').value;
            const utilities = document.getElementById('utilities').value;
            const sourceOfWater = document.getElementById('sourceOfWater').value;
            const telephone = document.getElementById('telephone').value;
            const modeOfHouse = document.getElementById('modeOfHouse').value;
            const infoAboutLot = document.getElementById('infoAboutLot').value;
            const amountToPay = document.getElementById('amountToPay').value;
            const relationshipWithOwner = document.getElementById('relationshipWithOwner').value;
            const typeOfStructure = document.getElementById('typeOfStructure').value;
    
            // Validate required fields
            if (!lotOwner || !NOStoreys || !estimatedFloorArea) {
                alert('Please fill in all required fields in the Lot and House Characteristics section.');
                return;
            }
    
            return {
                lotOwner,
                construction,
                NOStoreys,
                estimatedFloorArea,
                comfortRoom,
                utilities,
                sourceOfWater,
                telephone,
                modeOfHouse,
                infoAboutLot,
                amountToPay,
                relationshipWithOwner,
                typeOfStructure
            };
        }
    
        // Add event listener to the submit button to trigger the form submission
        document.getElementById('submitBtn').addEventListener('click', addHousingApplication);
    
        async function generateSurveyNo() {
const currentYear = new Date().getFullYear();
let newNumber = '0001'; // Default starting number if no entries exist

// Query Firestore for housing applications with the current year in surveyNo
const querySnapshot = await getDocs(query(
    collection(db, "Housing"),
    where("surveyNo", ">=", `${currentYear}-0000`),
    where("surveyNo", "<", `${currentYear + 1}-0000`),
    orderBy("surveyNo", "desc"),
    limit(1)
));

if (!querySnapshot.empty) {
    // Get the latest survey number and increment the numeric part
    const latestSurveyNo = querySnapshot.docs[0].data().surveyNo;
    const latestNumber = parseInt(latestSurveyNo.split('-')[1]);
    newNumber = String(latestNumber + 1).padStart(4, '0');
}

return `${currentYear}-${newNumber}`;
}

async function addHousingApplication(event) {
event.preventDefault();

// Show the loading screen
document.getElementById('loading-screen').style.display = 'flex';

setTimeout(async () => {
    // Generate survey number
    const surveyNo = await generateSurveyNo();

    // Gather Step 1 data (Household Head Details)
    const dateApplied = document.getElementById('dateApplied').value;
    const barangay = document.getElementById('barangay').value;
    const sitioPurok = document.getElementById('sitioPurok').value;
    const classificationArea = document.getElementById('classificationArea').value;
    
    const householdBirthday = document.getElementById('householdBirthday').value;
    const householdSex = document.getElementById('householdSex').value;
    const householdCivilStatus = document.getElementById('householdCivilStatus').value;
    const householdLastName = document.getElementById('householdLastName').value;
    const householdFirstName = document.getElementById('householdFirstName').value;
    const householdMiddleName = document.getElementById('householdMiddleName').value;
    const householdMaidenName = document.getElementById('householdMaidenName').value;
    const householdOccupation = document.getElementById('householdOccupation').value;
    const householdPlaceOfWork = document.getElementById('householdPlaceOfWork').value;
    const householdAddress = document.getElementById('householdAddress').value;

    // Spouse information (optional)
    const spouseLastName = document.getElementById('spouseLastName').value;
    const spouseFirstName = document.getElementById('spouseFirstName').value;
    const spouseMiddleName = document.getElementById('spouseMiddleName').value;
    const spouseMaidenName = document.getElementById('spouseMaidenName').value;
    const spouseBirthday = document.getElementById('spouseBirthday').value;

    // Additional Step 1 details
    const classificationOfSurveyHousehold = document.getElementById('classificationOfSurveyHousehold').value;
    
    const structureOwner = document.getElementById('structureOwner').value;
    const provinceOfOrigin = document.getElementById('provinceOfOrigin').value;
    const householdSize = document.getElementById('householdSize').value;
    const yearOfResidency = document.getElementById('yearOfResidency').value;
    const reasonsForEstablishing = document.getElementById('reasonsForEstablishing').value;

    const householdHeadName = `${householdLastName} ${householdFirstName} ${householdMiddleName} ${householdMaidenName}`;

    // Get appointment date (new field)
   // const appointmentDate = document.getElementById('appointmentDate').value;

    // Step 3: Lot and House Details
    const lotHouseDetails = await addLotAndHouseDetails();

    try {
        const user = auth.currentUser;
        if (!user) {
            console.error("No user logged in.");
            return;
        }

        // Include household members from Step 2
        if (householdMembers.length === 0) {
            alert("Please add at least one household member.");
            return;
        }

        const housingDocRef = await addDoc(collection(db, "Housing"), {
            surveyNo,
            dateApplied,
            barangay,
            sitioPurok,
            classificationArea,
            householdBirthday,
            householdSex,
            householdCivilStatus,
            householdHeadName,
            householdOccupation,
            householdPlaceOfWork,
            householdAddress,
            spouseName: `${spouseLastName} ${spouseFirstName} ${spouseMiddleName} ${spouseMaidenName}`,
            spouseBirthday,
            classificationOfSurveyHousehold,
            structureOwner,
            provinceOfOrigin,
            householdSize,
            yearOfResidency,
            reasonsForEstablishing,
            householdMembers,
           // appointmentDate: appointmentDate ? Timestamp.fromDate(new Date(appointmentDate)) : null,
            ...lotHouseDetails,
            ownerUid: user.uid,
            status: 'Pending',
            createdAt: Timestamp.now(),
        });

        await updateDoc(doc(db, 'users', user.uid), {
            housingApplications: arrayUnion({
                applicationId: housingDocRef.id,
                surveyNo,
                status: 'Pending',
            }),
        });

        const housingModal = bootstrap.Modal.getInstance(document.getElementById('housingApplicationModal'));
        housingModal.hide();

        Swal.fire({
            title: "Success!",
            text: "Application Submitted",
            icon: "success"
        });

    } catch (error) {
        console.error("Error submitting housing application:", error);
        alert("Failed to submit application. Please try again later.");
    } finally {
        document.getElementById('loading-screen').style.display = 'none';
    }
}, 100);
}

  // Function to dynamically append buttons to the View Details Modal for Housing
function appendButtons(data) {
    const viewDetailsModalBtnGrp = document.getElementById('viewDetailsModalBtnGrp');
    viewDetailsModalBtnGrp.innerHTML = ''; // Clear existing buttons

    // First row for 'View Housing Application' 
    const firstRow = document.createElement('div');
    firstRow.className = 'row mt-4';

    const col1 = document.createElement('div');
    col1.className = 'col-md-12 mb-2';
    const btn1 = document.createElement('button');
    btn1.className = 'btn btn-primary w-100 view-housing-btn';
    btn1.setAttribute('data-permit-id', data.id);
    btn1.textContent = 'View Housing Application';
    btn1.addEventListener('click', () => {
        const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
        if (viewDetailsModal) viewDetailsModal.hide();

        // Call openViewHousingApplicationModal to display data
        // Modified to pass the entire data object instead of just data.id
        openViewHousingApplicationModal(data);
    });
    col1.appendChild(btn1);

    firstRow.appendChild(col1);

    // Second row for 'Archive Application'
    const secondRow = document.createElement('div');
    secondRow.className = 'row mt-2';

    const col3 = document.createElement('div');
    col3.className = 'col-md-12 mb-2';
    const btn3 = document.createElement('button');
    btn3.className = 'btn btn-danger w-100 archive-btn';
    btn3.textContent = 'Archive Application';
    btn3.setAttribute('data-id', data.id);
    btn3.addEventListener('click', handleArchiveHousingApplication);
    col3.appendChild(btn3);

    secondRow.appendChild(col3);

    // Append both rows to the modal button group
    viewDetailsModalBtnGrp.appendChild(firstRow);
    viewDetailsModalBtnGrp.appendChild(secondRow);
}


    // Loading Screen Controls
function showLoading() {
    const loadingScreen = document.getElementById("loading-screen");
    if (loadingScreen) {
        loadingScreen.style.display = "flex"; // Show the loading screen
    }
}

function hideLoading() {
    const loadingScreen = document.getElementById("loading-screen");
    if (loadingScreen) {
        loadingScreen.style.display = "none"; // Hide the loading screen
    }
}

// Global Variables
let paginationStack = []; // Tracks pagination state
let searchTerm = ""; // Search input
let currentFilterStatus = null; // Filter by status
let currentSortOption = null; // Sorting option
let profilesPerPage = 10; // Number of profiles per page
let currentPage = 1; // Current page

// Load Profiles from Firestore
async function loadProfiles() {
    try {
        showLoading();

        // Base Firestore collection
        let profilesQuery = collection(db, "Housing");

        // Apply server-side filters
        if (searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            profilesQuery = query(
                profilesQuery,
                where("householdHeadName_lowercase", ">=", lowerCaseSearchTerm),
                where("householdHeadName_lowercase", "<=", lowerCaseSearchTerm + "\uf8ff")
            );
        }
        if (currentFilterStatus) {
            profilesQuery = query(profilesQuery, where("status", "==", currentFilterStatus));
        }

        // Apply sorting
        if (currentSortOption) {
            profilesQuery = query(profilesQuery, orderBy(currentSortOption.field, currentSortOption.direction));
        }

        // Apply pagination
        if (paginationStack.length && currentPage > paginationStack.length) {
            profilesQuery = query(profilesQuery, startAfter(paginationStack[paginationStack.length - 1]), limit(profilesPerPage));
        } else if (currentPage > 1 && paginationStack[currentPage - 2]) {
            profilesQuery = query(profilesQuery, startAfter(paginationStack[currentPage - 2]), limit(profilesPerPage));
        } else {
            profilesQuery = query(profilesQuery, limit(profilesPerPage));
        }

        // Fetch data from Firestore
        const querySnapshot = await getDocs(profilesQuery);
        const housingData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Update pagination stack
        if (housingData.length > 0) {
            paginationStack[currentPage - 1] = querySnapshot.docs[querySnapshot.docs.length - 1];
        }

        // Render profiles in the DOM
        renderProfiles(housingData);

        // Update pagination controls
        const isLastPage = querySnapshot.size < profilesPerPage;
        document.getElementById("pageInfo").textContent = `Page ${currentPage}`;
        document.getElementById("nextPageBtn").disabled = isLastPage;

        hideLoading();
    } catch (error) {
        console.error("Error loading profiles:", error);
        showNotification("Failed to load profiles.", "error");
        hideLoading();
    }
}

// Render Profiles in the DOM
function renderProfiles(profiles) {
    const profilesTableBody = document.querySelector("tbody");
    profilesTableBody.innerHTML = ''; // Clear previous entries

    profiles.forEach(data => {
        const row = document.createElement("tr");
        const representativeName = data.householdHeadName || "N/A";
        const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";

        row.innerHTML = `
            <td>${representativeName}</td>
            <td>${createdAt}</td>
            <td>${data.status || "N/A"}</td>
            <td>
                <button class="btn btn-primary btn-sm process-btn" data-id="${data.id}">
                    ${data.status === "Pending" ? "Process" : "View Details"}
                </button>
            </td>
        `;
        profilesTableBody.appendChild(row);

        // Add event listener for "Process" button (only for Pending status)
        row.querySelector(".process-btn").addEventListener("click", () => {
            if (data.status === "Pending") {
                confirmProcessHousing(data); // Confirm before processing
            } else {
                openViewDetailsModal(data); // Open the details modal
            }
        });
    });
}

// Function to confirm processing of the housing profile using SweetAlert2
async function confirmProcessHousing(housingData) {
    const result = await Swal.fire({
        title: 'Are you sure?',
        text: 'Do you want to process this housing application?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Process it!',
        cancelButtonText: 'Cancel',
        reverseButtons: true
    });

    if (result.isConfirmed) {
        processHousing(housingData); // Proceed to process the housing profile
    }
}

// Function to process the housing profile (change status to "Processing")
async function processHousing(housingData) {
    try {
        // Update the status to 'Processing' in Firestore
        await updateDoc(doc(db, 'Housing', housingData.id), { status: "Processing" });

        showNotification(`${housingData.householdHeadName}'s housing application is now Processing.`, 'info');
        loadProfiles(); // Reload profiles to reflect the updated status

    } catch (error) {
        console.error("Error processing housing profile:", error);
        showNotification("Failed to update housing profile status.", "error");
    }
}

// Pagination Controls
const prevPageBtn = document.getElementById("prevPageBtn");
const nextPageBtn = document.getElementById("nextPageBtn");

prevPageBtn.addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        loadProfiles();
    }
});

nextPageBtn.addEventListener("click", () => {
    currentPage++;
    loadProfiles();
});

// Search Input Handler
const searchBar = document.getElementById("searchBar");
searchBar.addEventListener("input", () => {
    searchTerm = searchBar.value.trim(); // Get the input value
    resetPaginationAndLoad();
});

// Sort Profiles by Name
document.querySelector(".sort-by-name").addEventListener("click", (e) => {
    e.preventDefault();
    setSortOption("householdHeadName", "asc");
});

// Sort Profiles by Date
document.querySelector(".sort-by-date").addEventListener("click", (e) => {
    e.preventDefault();
    setSortOption("createdAt", "desc");
});

// Filter Profiles by Status
document.querySelectorAll(".filter-status").forEach(filterButton => {
    filterButton.addEventListener("click", (e) => {
        e.preventDefault();
        const status = filterButton.dataset.status; // Get status from data attribute
        filterByStatus(status);
    });
});

// Utility Function: Reset Pagination and Reload Profiles
function resetPaginationAndLoad() {
    currentPage = 1; // Reset to the first page
    loadProfiles(); // Reload profiles with updated settings
}

// Utility Function: Set Sort Option
function setSortOption(field, direction) {
    currentSortOption = { field, direction }; // Dynamically set sort option
    resetPaginationAndLoad();
}

// Utility Function: Filter Profiles
function filterByStatus(status) {
    currentFilterStatus = status; // Set the filter status
    resetPaginationAndLoad();
}

async function updateDocumentsToLowerCase() {
    const querySnapshot = await getDocs(collection(db, "Housing"));
    const updates = querySnapshot.docs.map(async (docSnapshot) => {
        const data = docSnapshot.data();
        const lowerCaseName = (data.householdHeadName || "").toLowerCase();

        await updateDoc(doc(db, "Housing", docSnapshot.id), {
            householdHeadName_lowercase: lowerCaseName
        });
    });

    await Promise.all(updates);
    console.log("All documents updated with lowercase names.");
}

updateDocumentsToLowerCase();


// Notification Display
function showNotification(message, type) {
    const notificationDiv = document.createElement("div");
    notificationDiv.className = `notification ${type}`;
    notificationDiv.textContent = message;
    document.body.appendChild(notificationDiv);

    setTimeout(() => notificationDiv.remove(), 3000); // Auto-remove after 3 seconds
}
        function openViewHousingApplicationModal(data) {
    // Get the modal elements
    const modalTitle = document.getElementById('housingApplicationModalTitle');
    const modalBody = document.getElementById('housingApplicationModalBody');

    // Set modal title
    modalTitle.textContent = `Housing Application - ${data.householdHeadName}`;

    // Check if householdMembers is an array, if not, set it as an empty array
    const householdMembers = Array.isArray(data.householdMembers) ? data.householdMembers : [];

    modalBody.innerHTML = `
    <div class="container">
        <!-- Header Section with Logos -->
      <div class="d-flex justify-content-center align-items-center mb-2 mt-2">
    <!-- Left Logo -->
    <img src="/resources/pictures/calambaLogo.png" alt="Calamba Logo" style="height: 50px; width: 50px; margin-left: auto;">
    <!-- Center Title -->
    <div class="text-center" style="margin: 0 10px;">
        <h5 class="mb-0">CITY HOUSING AND SETTLEMENTS DEPARTMENT</h5>
        <p class="mb-0">City Government of Calamba</p>
    </div>
    <!-- Right Logo -->
    <img src="/resources/pictures/chsd.png" alt="CHSD Logo" style="height: 50px; width: 50px; margin-right: auto;">
</div>
<br>
<hr>
        
        <!-- Step 1: General Information -->
        <div class="row mb-2">
            <div class="col-md-6">
                <strong>Survey No.:</strong> ${data.surveyNo}
                </div>
                </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Barangay:</strong> ${data.barangay}</div>
            <div class="col-md-6"><strong>Classification Area:</strong> ${data.classificationArea}</div>
        </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Sitio/Purok:</strong> ${data.sitioPurok}</div>
            <div class="col-md-6"><strong>Cellphone No.:</strong> ${data.telephone}</div>
        </div>
        <hr>
          <h5 class="text-center mt-3">Household Head Information</h5>
        <div class="row mb-2">
            <div class="col-md-12"><strong>Name of the Household Head:</strong> ${data.householdHeadName}</div>
        </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Sex:</strong> ${data.householdSex}</div>
             <div class="col-md-6"><strong>Household Address:</strong> ${data.householdAddress}</div>
             
        </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Date Applied:</strong> ${data.dateApplied}</div>
            <div class="col-md-6"><strong>Province of Origin:</strong> ${data.provinceOfOrigin}</div>
        </div>

        <!-- Step 2: Household Members -->
        <h5 class="text-center mt-3">Household Members:</h5>
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Age</th>
                    <th>Gender</th>
                    <th>Civil Status</th>
                    <th>Education</th>
                    <th>Employed</th>
                    <th>Occupation</th>
                    <th>Place of Work</th>
                    <th>Relation</th>
                </tr>
            </thead>
            <tbody>
                ${householdMembers.map((member, index) => `
                <tr>
                    <td>${member.name}</td>
                    <td>${member.age}</td>
                    <td>${member.gender}</td>
                    <td>${member.civilStatus}</td>
                    <td>${member.education}</td>
                    <td>${member.employed}</td>
                    <td>${member.occupation || 'N/A'}</td>
                    <td>${member.placeOfWork || 'N/A'}</td>
                    <td>${member.relation}</td>
                </tr>`).join('')}
            </tbody>
        </table>

        <!-- Step 3: Lot Information -->
        <h5 class="text-center mt-3">Lot Information:</h5>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Lot Owner:</strong> ${data.lotOwner}</div>
            <div class="col-md-6"><strong>Construction:</strong> ${data.construction}</div>
        </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Comfort Room:</strong> ${data.comfortRoom}</div>
            <div class="col-md-6"><strong>Number of Storeys:</strong> ${data.NOStoreys}</div>
        </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Estimated Floor Area:</strong> ${data.estimatedFloorArea} SQ.M</div>
            <div class="col-md-6"><strong>Utilities:</strong> ${data.utilities}</div>
        </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Mode of House Acquisition:</strong> ${data.modeOfHouse}</div>
            <div class="col-md-6"><strong>Type of Structure:</strong> ${data.typeOfStructure}</div>
        </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Relationship with Owner:</strong> ${data.relationshipWithOwner}</div>
            <div class="col-md-6"><strong>Amount to Pay:</strong> ${data.amountToPay}</div>
        </div>
        <div class="row mb-2">
            <div class="col-md-6"><strong>Info About Lot:</strong> ${data.infoAboutLot}</div>
            <div class="col-md-6"><strong>Year of Residency:</strong> ${data.yearOfResidency}</div>
        </div>


        <hr>
        <div class="row">
             <div class="col">
                
                <p>____________________________</p>
                <p><i>Signature of Housing Officer</i></p>
             </div>

              <div class="col">
                <p>___________________________</p>
                <p><i>Signature of Household Head</i></p>
            </div>
        </div>
        
    </div>
`;


    // Show the modal
    const modalInstance = new bootstrap.Modal(document.getElementById('viewHousingApplicationModal'));
    modalInstance.show();
}



  // Function to Handle Status Update
async function updateStatusOptions() {
    const selectedProfileId = document.getElementById("profileIdInput").value;
    const newStatus = document.getElementById("statusSelect").value;
    const timestamp = serverTimestamp();

    if (!selectedProfileId) {
        console.error("No profile selected for status update.");
        return;
    }

    try {
        // Retrieve the current status from Firestore
        const profileRef = doc(db, "Housing", selectedProfileId);
        const profileSnapshot = await getDoc(profileRef);

        if (!profileSnapshot.exists()) {
            console.error("Profile not found in Firestore.");
            return;
        }

        const currentStatus = profileSnapshot.data().status;

        // Only proceed if the status has changed
        if (newStatus === currentStatus) {
            console.log("No changes to the status.");
            return; // Exit if there's no change
        }

        // Show confirmation dialog with SweetAlert2
        const { isConfirmed } = await Swal.fire({
            title: "Update Status?",
            text: `Are you sure you want to update the status to "${newStatus}"?`,
            icon: "question",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, update it!"
        });

        if (!isConfirmed) return;

        // Proceed with the status update
        await updateDoc(profileRef, {
            status: newStatus,
            updatedAt: timestamp
        });

        // Success notification
        Swal.fire({
            title: "Success!",
            text: "Status updated successfully!",
            icon: "success",
            timer: 2000,
            showConfirmButton: false
        });

        loadProfiles();  // Refresh profiles after status update
        closeModal("viewDetailsModal"); // Close the modal after updating
    } catch (error) {
        console.error("Error updating status:", error);
        showNotification("Failed to update status.", "error");
    }
}

// Get the save button element
const saveStatusButton = document.getElementById("saveStatusButton");

// Add a click event listener to the save button
saveStatusButton.addEventListener("click", updateStatusOptions);

        // Function to Archive a Housing Application
async function handleArchiveHousingApplication(event) {
    event.preventDefault();
    const housingAppId = event.target.getAttribute('data-id');

    if (!housingAppId) {
        console.error("Housing Application ID is null or undefined.");
        showNotification("Error: Housing Application ID is missing.", "error");
        return;
    }

    // Use SweetAlert2 for confirmation dialog
    const { isConfirmed } = await Swal.fire({
        title: "Archive Housing Application?",
        text: "Are you sure you want to archive this housing application?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, archive it!"
    });

    if (!isConfirmed) return;

    try {
        const housingAppRef = doc(db, "Housing", housingAppId);
        const housingAppSnapshot = await getDoc(housingAppRef);

        if (housingAppSnapshot.exists()) {
            const housingAppData = housingAppSnapshot.data();

            // Move document to archivedHousingApplications collection
            await setDoc(doc(db, "archivedHousingApplications", housingAppId), housingAppData);
            await deleteDoc(housingAppRef);

            // Remove the row from the table
            const tableBody = document.querySelector(".housingDiv");  // Use class selector since tbody has class="housingDiv"
            if (tableBody) {
                const rowToRemove = tableBody.querySelector(`button[data-permit-id="${housingAppId}"]`)?.closest('tr');
                if (rowToRemove) rowToRemove.remove();
            } else {
                console.error(".housingDiv not found in the DOM.");
                showNotification("Error: Failed to locate the housing application row.", "error");
            }

            // Hide the modal if it's open
            const viewDetailsModal = bootstrap.Modal.getInstance(document.getElementById('viewDetailsModal'));
            if (viewDetailsModal) {
                viewDetailsModal.hide();
            }

            // Success notification
            Swal.fire({
                title: "Archived!",
                text: "The housing application has been archived.",
                icon: "success",
                timer: 2000,
                showConfirmButton: false
            });
        } else {
            showNotification("Housing application not found!", "error");
        }
    } catch (error) {
        console.error("Error archiving housing application: ", error);
        showNotification(`Failed to archive housing application: ${error.message}`, "error");
    }
}

        function closeModal(modalId) {
    const modalElement = document.getElementById(modalId);
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) {
        modalInstance.hide();
    } else {
        console.error(`No modal found with ID: ${modalId}`);
    }
}

        // Function to Open the View Details Modal
        function openViewDetailsModal(data) {
            let representativeName = data.householdHeadName || "N/A";
            const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";
    
            document.getElementById("housingOwnerName").textContent = representativeName;
            document.getElementById("issuedOnDate").textContent = createdAt;
            document.getElementById("statusSelect").value = data.status || "N/A";
            document.getElementById("profileIdInput").value = data.id;
    
            updateStatusOptions(data.status);
            appendButtons(data);
    
            const viewDetailsModal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
            viewDetailsModal.show();
        }
    
        // Initialize the Table with Profiles
        document.addEventListener("DOMContentLoaded", loadProfiles);
    
        // Pagination Buttons
        document.getElementById("prevPageBtn").addEventListener("click", () => {
            if (currentPage > 1) {
                currentPage--;
                loadProfiles();
            }
        });
    
        document.getElementById("nextPageBtn").addEventListener("click", () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadProfiles();
            }
        });
    </script>
    
    <script>
       // Function to show the next form step and control button visibility
function showNextStep(currentStep, nextStep) {
    document.getElementById(`form-step-${currentStep}`).classList.remove('active');
    document.getElementById(`form-step-${nextStep}`).classList.add('active');
    document.getElementById(`step-${currentStep}`).classList.add('completed');
    document.getElementById(`step-${nextStep}`).classList.add('active');
    document.getElementById(`step-${currentStep}`).classList.remove('active');

    // Handle button visibility
    handleButtonVisibility(nextStep);
}

// Function to show the previous form step and control button visibility
function showPreviousStep(currentStep, prevStep) {
    document.getElementById(`form-step-${currentStep}`).classList.remove('active');
    document.getElementById(`form-step-${prevStep}`).classList.add('active');
    document.getElementById(`step-${currentStep}`).classList.remove('completed');
    document.getElementById(`step-${prevStep}`).classList.add('active');

    // Handle button visibility
    handleButtonVisibility(prevStep);
}

// Function to handle button visibility based on the step
function handleButtonVisibility(step) {
    // Initially hide all buttons
    document.getElementById('nextBtn1').style.display = 'none';
    document.getElementById('prevBtn2').style.display = 'none';
    document.getElementById('nextBtn2').style.display = 'none';
    document.getElementById('prevBtn3').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';

    // Show buttons based on the step
    if (step === 1) {
        document.getElementById('nextBtn1').style.display = 'inline-block';
    } else if (step === 2) {
        document.getElementById('prevBtn2').style.display = 'inline-block';
        document.getElementById('nextBtn2').style.display = 'inline-block';
    } else if (step === 3) {
        document.getElementById('prevBtn3').style.display = 'inline-block';
        document.getElementById('submitBtn').style.display = 'inline-block';
    }
}

// Event Listeners for Next and Previous Buttons
document.getElementById('nextBtn1').addEventListener('click', function() {
    showNextStep(1, 2); // Move from step 1 to step 2
});

document.getElementById('nextBtn2').addEventListener('click', function() {
    showNextStep(2, 3); // Move from step 2 to step 3
});

document.getElementById('prevBtn2').addEventListener('click', function() {
    showPreviousStep(2, 1); // Move from step 2 to step 1
});

document.getElementById('prevBtn3').addEventListener('click', function() {
    showPreviousStep(3, 2); // Move from step 3 to step 2
});

    </script>



</body>
</html>
