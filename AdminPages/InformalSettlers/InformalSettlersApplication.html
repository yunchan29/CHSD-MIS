<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        .content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .content-container {
            overflow-y: auto;
            padding: 20px;
        }
        .form-step {
            display: none;
        }
        .form-step.active {
            display: block;
        }
        .step {
            display: inline-block;
            margin-right: 20px;
            opacity: 0.5;
        }
        .step.completed .circle {
            background-color: green;
        }
        .step.active {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center">
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-white"><i class="fal fa-stream"></i>Menu</button>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav active"><a href="/AdminPages/InformalSettlers/InformalSettlersApplication.html" class="text-decoration-none"><i class="fa-solid fa-folder"></i> Housing Application</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/InformalSettlersReport.html" class="text-decoration-none"><i class="fa-solid fa-chart-column"></i> Application Report</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/InformalSettlersUserManager.html" class="text-decoration-none"><i class="fa-solid fa-user-pen"></i> User Manager</a></li>
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
            <nav class="navigationBar navbar navbar-expand-lg bg-light">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between d-md-none d-block">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
                            <h5 class="mb-0 fs-5">CHSD</h5>
                        </a>
                        <button class="btn px-1 py-0 open-btn">
                            <i class="fa-solid fa-bars-staggered"></i>
                        </button>
                    </div>

                    <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
                        <a class="navbar-brand d-flex align-items-center" href="#">
                            <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
                            <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
                        </a>
                    </div>
                </div>
            </nav>

          <div class="contentContainer">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#housingApplicationModal">
                Add Profile
              </button><br>
                <p><strong>Application Count:<span id="housingCounts"></span></strong></p>
                <h3>Application</h3> <!-- Moved outside of the tbody -->
                <table class="table">
                    <thead>
                        <tr>
                            <th>Survey Number</th>
                            <th>Name</th>
                            <th>Date Profiled</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody class="housingDiv">
                        <!-- Profiles will be inserted here by JavaScript -->
                    </tbody>
                </table>

                <div id="paginationControls">
                    <button class="btn btn-primary" id="prevPageBtn" disabled>Previous</button>
                    <span id="pageInfo">Page 1 of 1</span>
                    <button class="btn btn-primary" id="nextPageBtn" disabled>Next</button>
                </div>
                
           
            

  
  <div class="modal fade" id="housingApplicationModal" tabindex="-1" aria-labelledby="housingApplicationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered wide-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="housingApplicationModalLabel">Housing Application</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            
                

               
                <div class="step-progress mb-4">
                    <div class="step completed" id="step-1">
                        <div class="circle"></div>
                        <div class="label">Information of Household</div>
                    </div>
                    <div class="step" id="step-2">
                        <div class="circle"></div>
                        <div class="label">Household Members</div>
                    </div>
                    <div class="step" id="step-3">
                        <div class="circle"></div>
                        <div class="label">Lot and House Characteristics</div>
                    </div>
                </div>
               
              <!-- Form Steps -->
<div class="form-step active" id="form-step-1">
    <h5>Household Head Details</h5>
    <div class="row">
        <div class="col">
            <label for="surveyNo">Survey No.</label>
            <input type="text" id="surveyNo" class="form-control">
        </div>
        <div class="col">
            <label for="dateApplied">Date</label>
            <input type="date" id="dateApplied" class="form-control">
        </div>
        <div class="col">
            <label for="barangay">Barangay</label>
            <select class="form-control" id="barangay">
              <option>Barangay 1</option>
              <option>Barangay 2</option>
              <option>Barangay 3</option>
            </select>
        </div>
        <div class="col">
            <label for="sitioPurok">Sitio/Purok</label>
            <select class="form-control" id="sitioPurok">
                <option>Purok 1</option>
                <option></option>
                <option></option>
                <option></option>

            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
           <label for="classificationArea">Classification Area</label>
           <input type="text" class="form-control" id="classificationArea">
        </div>
        <div class="col-md-8">
           <label for="householdRemarks">Remarks</label>
           <textarea class="form-control" id="householdRemarks" rows="1">
           </textarea>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
           <label for="householdBirthday">Date of Birth</label>
           <input type="date" class="form-control" id="householdBirthday">
        </div>
        <div class="col-md-3">
            <label for="householdSex">Sex</label>
            <select class="form-control" id="householdSex">
                <option>Male</option>
                <option>Female</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="householdCivilStatus">Civil Status</label>
            <select class="form-control" id="householdCivilStatus">
                <option></option>
                <option></option>
            </select>
        </div>
    </div>


    <div class="row">
        <div class="col-md-3">
            <label for="householdLastName">Last Name</label>
            <input type="text" class="form-control" id="householdLastName">
        </div>
        <div class="col-md-3">
            <label for="householdFirstName">First Name</label>
            <input type="text" class="form-control" id="householdFirstName">
        </div>
        <div class="col-md-3">
            <label for="householdMiddleName">Middle Name</label>
            <input type="text" class="form-control" id="householdMiddleName">
        </div>
        <div class="col-md-3">
            <label for="householdMaidenName">Maiden Name</label>
            <input type="text" class="form-control" id="householdMaidenName">
        </div>
    </div>

    <div class="row">
       <div class="col-md-6">
        <label for="householdOccupation">Occupation</label>
        <input type="text" class="form-control" id="householdOccupation">
       </div>

       <div class="col-md-6">
         <label for="householdPlaceOfWork">Place Of Work</label>
         <input type="text" class="form-control" id="householdPlaceOfWork">
       </div>
    </div>

    <div class="row">
        <div class="col">
            <label for="householdAddress">Present Address</label>
            <textarea class="form-control" id="householdAddress" rows="1"></textarea>
        </div>
    </div>

    <div class="row">

    </div>

    <div class="row">
        <h5>Name of Spouse</h5>
    </div>
    <div class="row">
        <div class="col-md-3">
            <label for="spouseLastName">Last Name</label>
            <input type="text" class="form-control" id="spouseLastName">
        </div>
        <div class="col-md-3">
            <label for="spouseFirstName">First Name</label>
            <input type="text" class="form-control" id="spouseFirstName">
        </div>
        <div class="col-md-3">
            <label for="spouseMiddleName">Middle Name</label>
            <input type="text" class="form-control" id="spouseMiddleName">
        </div>
        <div class="col-md-3">
            <label for="spouseMaidenName">Maiden Name</label>
            <input type="text" class="form-control" id="spouseMaidenName">
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <label for="spouseBirthday">Date of Birth</label>
            <input type="date" class="form-control" id="spouseBirthday">
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
           <label for="classificationOfSurveyHousehold">Classification Of Survey Household</label>
           <select class="form-control" id="classificationOfSurveyHousehold">
            <option></option>
           </select>
        </div>
        <div class="col-md-2">
            <label for="householdAmount">Amount</label>
            <input type="number" class="form-control" id="householdAmount">
        </div>
        <div class="col-md-6">
            <label for="structureOwner">Structure Owner</label>
            <input type="text" class="form-control" id="structureOwner">
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
             <label for="provinceOfOrigin">Province Of Origin</label>
             <input type="text" class="form-control" id="provinceOfOrigin">
        </div>
        <div class="col-md-3">
            <label for="householdSize">Household Size</label>
            <input type="number" class="form-control" id="householdSize">
        </div>
        <div class="col-md-3">
            <label for="yearOfResidency">Year of Residency</label>
            <input type="text" class="form-control" id="yearOfResidency">
        </div>
    </div>

    <div class="row">

        <label for="reasonsForEstablishing">Reasons For Establishing Residence In The Area</label>
        <textarea class="form-control" id="reasonsForEstablishing"></textarea>
    </div>

   
    
        


   
  

    <div class="row justify-content-end mt-4">
        <div class="col">
           
        </div>
    </div>
</div>


                <div class="form-step" id="form-step-2">
                    
                    
                    <h5>Household Members Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="memberName">Name</label>
                            <input type="text" id="memberName" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="relationToHead">Relation To The Household Head</label>
                            <input type="text" class="form-control" id="relationToHead">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-2">
                            <label for="memberAge">Age</label>
                            <input type="number" class="form-control" id="memberAge">
                        </div>
                        <div class="col-md-2">
                            <label for="memberGender">Gender</label>
                            <select class="form-control" id="memberGender">
                                <option>Male</option>
                                <option>Female</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="memberCivilStatus">Civil Status</label>
                            <select class="form-control" id="memberCivilStatus">
                                <option>Single</option>
                                <option></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="memberEducationalAttainment">Educational Attainment</label>
                            <input type="text" class="form-control" id="memberEducationalAttainment">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-2">
                            <label for="memberEmployed">Employed</label>
                            <select class="form-control" id="memberEmployed">
                                <option></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="memberOccupation">Occupation</label>
                            <input type="text" class="form-control" id="memberOccupation">
                        </div>
                        <div class="col-md-3">
                            <label for="memberPlaceOfWork">Place of Work</label>
                            <input type="text" class="form-control" id="memberPlaceOfWork">
                        </div>
                        <div class="col-md-3">
                            <label for="memberMonthlyIncome">Monthly Income(PHP)</label>
                            <input type="number" class="form-control" id="memberMonthlyIncome">
                        </div>
                        
                    </div>

                    <div class="row justify-content-end mt-4">
                        <div class="col">
                           
                        </div>
                    </div>

                    <div class="row">
                        <div class="col text-end">
                            <button class="btn btn-secondary"><i class="fa-solid fa-plus"></i> Add</button>
                            <button class="btn btn-secondary"><i class="fa-solid fa-delete-left"></i> Clear</button>
                            <button class="btn btn-secondary"><i class="fa-solid fa-pencil"></i> Edit</button>
                            <button class="btn btn-secondary"><i class="fa-solid fa-trash"></i> Delete</button>
                        </div>
                    </div>

                    <div class="contentContainer">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Relation</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Civil Status</th>
                                    <th>Educational Attainment</th>
                                    <th>Employed</th>
                                    <th>Occupation</th>
                                    <th>Place of Work</th>
                                    <th>Monthly Income</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    
                </div>

                <div class="form-step" id="form-step-3">
                    <h5>Lot Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="lotOwner">Owner</label>
                            <input type="text" class="form-control" id="lotOwner">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="construction">Construction/Building Materials Used</label>
                            <select class="form-control" i="construction">
                                <option>Concrete</option>
                                <option>Wood/Nipa</option>
                                <option>Plastic Roof Only</option>
                                <option>Tent</option>
                                <option>Mixed Materials</option>
                                <option>Sharer</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="NOStoreys">Number Of Storeys</label>
                            <input type="number" id="NOStoreys" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="estimatedFloorArea">Estimated Floor Area</label>
                            <input type="number" class="form-control" id="estimatedFloorArea">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="comfortRoom">Comfort Room</label>
                            <select class="form-control" id="comfortRoom">
                                <option>With Septic Tank Vault</option>
                                <option>Without Septic</option>
                                <option>None</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="utilities">Utilities/Facilities Present Power(Electricity)</label>
                            <select class="form-control" id="utilities">
                                <option>Meralco</option>
                                <option>Connected To Other Subscriber</option>
                                <option>None</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="sourceOfWater">Source of Water</label>
                            <select class="form-control" id="sourceOfWater">
                                <option></option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="telephone">Telephone</label>
                            <select class="form-control" id="telephone">
                                <option>Landline</option>
                                <option>Cellphone</option>
                                <option>Others</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="modeOfHouse">Mode Of House/Structure Acquistion</label>
                            <select class="form-control" id="modeOfHouse">
                                <option>Sold Rights</option>
                                <option>Transfer Rights</option>
                                <option>Constructed</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="infoAboutLot">Information About The Surveyed Lot</label>
                            <select class="form-control" id="infoAboutLot">
                                <option>Caretaker</option>
                                <option>Co-Owner</option>
                                <option>Renter</option>
                                <option>RFO</option>
                                <option>Sharer</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label for="amountToPay">Amount To Pay</label>
                            <input type="number" id="amountToPay" class="form-control">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label for="relationshipWithOwner">Relationship With The Owner</label>
                            <select class="form-control" id="relationshipWithOwner">
                                <option>Lot Owner</option>
                                <option>Child</option>
                                <option>Parent</option>
                                <option>Relative</option>
                                <option>Others</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="typeOfStructure">Type Of Structure</label>
                            <select class="form-control" id="typeOfStructure">
                                <option>Residential</option>
                                <option>Commercial</option>
                                <option>Apartment</option>
                                <option>Institution</option>
                                <option>Others</option>
                            </select>
                        </div>
                    </div>
                   
                    <div class="row justify-content-between mt-4">
                       <div class="col">
                        
                       
                       </div>
                    </div>
                
            </div>
        </div>
        <div class="modal-footer"> 
            <button type="button" class="btn btn-primary" id="nextBtn1">Next</button>
            <button type="button" class="btn btn-secondary" id="prevBtn2" style="display:none;">Previous</button>
            <button type="button" class="btn btn-primary" id="nextBtn2" style="display:none;">Next</button>
            <button type="button" class="btn btn-secondary" id="prevBtn3" style="display:none;">Previous</button>
            <button type="button" class="btn btn-primary" id="submitBtn" style="display:none;">Submit</button>
        </div>
        
          
      </div>
    </div>
  </div>

          </div>
        </div>
    </div>



    <!--View Details Modal-->
     <!-- View Details Modal --> 
<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDetailsModalLabel">Permit Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Text information at the top -->
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Owner Name:</strong> <span id="housingOwnerName"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Issued On:</strong> <span id="issuedOnDate"></span></p>
                    </div>
                </div>
            
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Appointment Date:</strong> <span id="appointmentDateSched"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Permit ID:</strong> <span id="permitIdDisplay"></span></p>
                    </div>
                </div>
            
                <!-- Status selection in a row -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="statusSelect" class="form-label">Status</label>
                        <select id="statusSelect" class="form-select">
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="To Pay">To Pay</option>
                            <option value="For Approval">For Approval</option>
                            <option value="For Release">For Release</option>
                            <option value="Claimed">Claimed</option>
                        </select>
                    </div>
                </div>
            
                <!-- Comments section -->
                <div class="row">
                    <div class="col-md-12">
                        <label for="officerRemarks">Comments</label>
                        <textarea class="form-control" id="officerRemarks" rows="2"></textarea>
                    </div>
                </div>
            
                <div id="viewDetailsModalBtnGrp">
                    <!-- Any additional buttons can be added here if needed -->
                </div>
            
                <!-- Hidden input field to store the permit ID -->
                <input type="hidden" id="profileIdInput"> <!-- Update this to match your JavaScript -->
            </div>
            
            <div class="modal-footer">
                <button type="button" id="saveStatusBtn" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" ></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <script type="module" src="/Database/firebase.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
            authDomain: "chsd-mis.firebaseapp.com",
            projectId: "chsd-mis",
            storageBucket: "chsd-mis.appspot.com",
            messagingSenderId: "694967679357",
            appId: "1:694967679357:web:65cffd50f13739f934f414",
            measurementId: "G-XBQTQFRLJ5"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
    
        // Notification Function
        function showNotification(message, type) {
            const notificationContainer = document.getElementById('notification-container');
            if (notificationContainer) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notificationContainer.appendChild(notification);
                alert("Status updated successfully");
    
                // Automatically remove notification after 5 seconds
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            } else {
                console.error('Notification container not found.');
            }
        }
    
        // Pagination Variables
        let profilesPerPage = 10; // Profiles per page
        let currentPage = 1; // Current page
        let totalPages = 1; // Total pages
    
        // Function to Load Housing Profiles and Display in the Table
        async function loadProfiles() {
            try {
                const querySnapshot = await getDocs(collection(db, "Housing"));
                const housingDiv = document.querySelector("tbody");
                const prevPageBtn = document.getElementById("prevPageBtn");
                const nextPageBtn = document.getElementById("nextPageBtn");
                const pageInfo = document.getElementById("pageInfo");
    
                if (!housingDiv) {
                    console.error("housingDiv not found in the DOM.");
                    return;
                }
    
                housingDiv.innerHTML = ""; // Clear existing rows
    
                // Fetch and Process Housing Data
                const housingData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const uniqueHousingData = Array.from(new Set(housingData.map(a => a.id)))
                    .map(id => housingData.find(a => a.id === id));
    
                // Sort by createdAt (ascending)
                uniqueHousingData.sort((a, b) => {
                    const aTime = a.createdAt?.seconds || 0;
                    const bTime = b.createdAt?.seconds || 0;
                    return aTime - bTime;
                });
    
                // Calculate Total Pages
                totalPages = Math.ceil(uniqueHousingData.length / profilesPerPage);
    
                // Determine Profiles for Current Page
                const start = (currentPage - 1) * profilesPerPage;
                const end = start + profilesPerPage;
                const currentProfiles = uniqueHousingData.slice(start, end);
    
                for (const data of currentProfiles) {
                    const row = document.createElement("tr");
    
                    // Fetch Representative User Data (Household Head Name)
                    let representativeName = data.householdHeadName || "N/A";
    
                    const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";
    
                    row.innerHTML = `
                        <td>${data.ownerName || "495827350236426"}</td>
                        <td>${representativeName}</td>
                        <td>${createdAt}</td>
                        <td>${data.status || "N/A"}</td>
                        <td>
                            <button class="btn btn-primary btn-sm view-details-btn" data-permit-id="${data.id}">View Details</button>
                        </td>
                    `;
    
                    housingDiv.appendChild(row);
    
                    // Add Event Listener for "View Details" Button
                    const viewDetailsBtn = row.querySelector(".view-details-btn");
                    if (viewDetailsBtn) {
                        viewDetailsBtn.addEventListener("click", () => {
                            openViewDetailsModal(data);
                        });
                    }
                }
    
                // Update Pagination Info
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    
                // Enable/Disable Pagination Buttons
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
    
            } catch (error) {
                console.error("Error loading profiles:", error);
                showNotification("Failed to load profiles.", "error");
            }
        }
    
        // Function to Control Progressive Status Selection
        function updateStatusOptions(currentStatus) {
            const statusSelect = document.getElementById("statusSelect");
            const statusOptions = ["Pending", "Processing", "To Pay", "For Approval", "For Release", "Claimed"];
    
            // Clear existing options
            statusSelect.innerHTML = "";
    
            // Add only the next status options based on the current status
            const currentIndex = statusOptions.indexOf(currentStatus);
            for (let i = currentIndex; i < statusOptions.length; i++) {
                const option = document.createElement("option");
                option.value = statusOptions[i];
                option.textContent = statusOptions[i];
                statusSelect.appendChild(option);
            }
        }
    
        // Function to Handle Status Update
        async function updateStatus() {
            const selectedProfileId = document.getElementById("profileIdInput").value;
            const newStatus = document.getElementById("statusSelect").value;
            const timestamp = serverTimestamp();
    
            if (selectedProfileId) {
                try {
                    const profileRef = doc(db, "Housing", selectedProfileId);
                    await updateDoc(profileRef, {
                        status: newStatus,
                        updatedAt: timestamp
                    });
                    showNotification("Status updated successfully!", "success");
                    loadProfiles();
                    closeModal("viewDetailsModal"); // Close the modal after updating
                } catch (error) {
                    console.error("Error updating status:", error);
                    showNotification("Failed to update status.", "error");
                }
            } else {
                console.error("No profile selected for status update.");
            }
        }
    
        // Function to Open the View Details Modal
        function openViewDetailsModal(data) {
            // Set modal fields
            let representativeName = data.householdHeadName;
            const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";
            document.getElementById("housingOwnerName").textContent = representativeName || "N/A";
            
            // Set the status select value
            document.getElementById("statusSelect").value = data.status || "N/A"; // Use value instead of textContent
            
            // Ensure createdAtField is defined in the modal
            document.getElementById("issuedOnDate").textContent = createdAt || "N/A"; 
    
            // Update Profile ID for status update
            document.getElementById("profileIdInput").value = data.id;
    
            // Update status options based on current status
            updateStatusOptions(data.status);
    
            // Show modal
            const viewDetailsModal = new bootstrap.Modal(document.getElementById('viewDetailsModal'));
            viewDetailsModal.show();
        }
    
        // Function for Next Page
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadProfiles();
            }
        }
    
        // Function for Previous Page
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadProfiles();
            }
        }
    
        // Event Listeners for Pagination Buttons
        document.getElementById("prevPageBtn").addEventListener("click", prevPage);
        document.getElementById("nextPageBtn").addEventListener("click", nextPage);
        document.getElementById("saveStatusBtn").addEventListener("click", updateStatus); // Added event listener for save button
    
        // Load Profiles on Page Load
        loadProfiles();
    
        async function fetchPermitCounts() {
            // Show the loading screen
            document.getElementById('fetching-loading-screen').style.display = 'flex';
    
            // Collection references
            const housingRef = collection(db, "Housing");
    
            try {
                const housingSnapshot = await getDocs(housingRef);
                document.getElementById("housingCounts").textContent = housingSnapshot.size;
            } catch (error) {
                console.error("Error fetching permit counts: ", error);
            }
        }
    
        // Call the function to fetch and display permit counts
        fetchPermitCounts();
    </script>
    
    <script>
       // Function to show the next form step and control button visibility
function showNextStep(currentStep, nextStep) {
    document.getElementById(`form-step-${currentStep}`).classList.remove('active');
    document.getElementById(`form-step-${nextStep}`).classList.add('active');
    document.getElementById(`step-${currentStep}`).classList.add('completed');
    document.getElementById(`step-${nextStep}`).classList.add('active');
    document.getElementById(`step-${currentStep}`).classList.remove('active');

    // Handle button visibility
    handleButtonVisibility(nextStep);
}

// Function to show the previous form step and control button visibility
function showPreviousStep(currentStep, prevStep) {
    document.getElementById(`form-step-${currentStep}`).classList.remove('active');
    document.getElementById(`form-step-${prevStep}`).classList.add('active');
    document.getElementById(`step-${currentStep}`).classList.remove('completed');
    document.getElementById(`step-${prevStep}`).classList.add('active');

    // Handle button visibility
    handleButtonVisibility(prevStep);
}

// Function to handle button visibility based on the step
function handleButtonVisibility(step) {
    // Initially hide all buttons
    document.getElementById('nextBtn1').style.display = 'none';
    document.getElementById('prevBtn2').style.display = 'none';
    document.getElementById('nextBtn2').style.display = 'none';
    document.getElementById('prevBtn3').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';

    // Show buttons based on the step
    if (step === 1) {
        document.getElementById('nextBtn1').style.display = 'inline-block';
    } else if (step === 2) {
        document.getElementById('prevBtn2').style.display = 'inline-block';
        document.getElementById('nextBtn2').style.display = 'inline-block';
    } else if (step === 3) {
        document.getElementById('prevBtn3').style.display = 'inline-block';
        document.getElementById('submitBtn').style.display = 'inline-block';
    }
}

// Event Listeners for Next and Previous Buttons
document.getElementById('nextBtn1').addEventListener('click', function() {
    showNextStep(1, 2); // Move from step 1 to step 2
});

document.getElementById('nextBtn2').addEventListener('click', function() {
    showNextStep(2, 3); // Move from step 2 to step 3
});

document.getElementById('prevBtn2').addEventListener('click', function() {
    showPreviousStep(2, 1); // Move from step 2 to step 1
});

document.getElementById('prevBtn3').addEventListener('click', function() {
    showPreviousStep(3, 2); // Move from step 3 to step 2
});

    </script>
</body>
</html>
