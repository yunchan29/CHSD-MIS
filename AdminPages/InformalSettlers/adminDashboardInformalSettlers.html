<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
</head>
<body>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center">
                <!-- Empty avatar icon -->
               
               
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-white"><i class="fal fa-stream"></i>Menu</button>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav active"><a href="/AdminPages/InformalSettlers/adminDashboardInformalSettlers.html" class="text-decoration-none"><i class="fa-solid fa-user"></i> Profile</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/InformalSettlersApplication.html" class="text-decoration-none"><i class="fa-solid fa-folder"></i> Housing Application</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/InformalSettlersReport.html" class="text-decoration-none"><i class="fa-solid fa-chart-column"></i> Application Report</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/InformalSettlersUserManager.html" class="text-decoration-none"><i class="fa-solid fa-user-pen"></i> User Manager</a></li>
            </ul>
        </div>

        <div class="content">
           <!--Navigation Bar-->
<nav class="navigationBar navbar navbar-expand-lg bg-light">
  <div class="container-fluid">
      <!-- Mobile View -->
      <div class="d-flex justify-content-between d-md-none d-block">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
              <h5 class="mb-0 fs-5">CHSD</h5>
          </a>
          <button class="btn px-1 py-0 open-btn">
              <i class="fa-solid fa-bars-staggered"></i>
          </button>
      </div>

      <!-- Desktop View -->
      <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
          <a class="navbar-brand d-flex align-items-center" href="#">
              <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
              <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
          </a>
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <!-- Additional nav items go here -->
          </ul>
      </div>
  </div>
</nav>

            
            <div class="contentContainer">
               
               <!-- Bootstrap Table -->
               <div class="container">
                
                  <h5>Profile</h5>
                  
                  <div class="row mt-4">
                    <div class="col">
                     <a class="btn btn-dark text-white" data-bs-toggle="modal" data-bs-target="#profilingModal"><i class="fa-solid fa-plus"></i> Add Profile</a>
                    </div>
                    <div class="col">
                      <div class="d-flex justify-content-end mb-3">
                        <input type="text" class="form-control search-bar" placeholder="Search">
                        <div class="input-group-append">
                          <button class="btn btn-outline-secondary" type="button"><i class="fas fa-search"></i></button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Survey Number</th>
                        <th>Name</th>
                        <th>Date Profiled</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>2024-321</td>
                        <td>Mario Agustin</td>
                        <td>4/3/24</td>
                        <td>Profiling Completed</td>
                          <td>
                           <a class="btn btn-danger text-white">Delete</a>
                           <a class="btn btn-primary text-white" data-bs-toggle="modal" data-bs-target="#profilingModal">Edit</a>
                           <a class="btn btn-dark text-white"><i class="fa-solid fa-print"></i></a></td>
                      </tr>
                      <tr>
                        <td>2024-321</td>
                        <td>Marvin Delos Reyes</td>
                        <td>1/4/24</td>
                        <td>Profiling Completed</td>
                          <td>
                            <a class="btn btn-danger text-white">Delete</a>
                            <a class="btn btn-primary text-white" data-bs-toggle="modal" data-bs-target="#profilingModal">Edit</a>
                            <a class="btn btn-dark text-white"><i class="fa-solid fa-print"></i></a></td>
                      </tr>
                      <tr>
                        <td>2024-321</td>
                        <td>Drake Lamar</td>
                        <td>3/12/24</td>
                        <td>Profiling Completed</td>
                          <td>
                            <a class="btn btn-danger text-white">Delete</a>
                            <a class="btn btn-primary text-white" data-bs-toggle="modal" data-bs-target="#profilingModal">Edit</a>
                            <a class="btn btn-dark text-white"><i class="fa-solid fa-print"></i></a>
                          </td>
                      </tr>
                  

                    </tbody>
                  </table>
               </div>
               <!-- End of Bootstrap Table -->
               
            </div>
            
        </div>
    </div>
</div>


  
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">Application</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!--Application Modal Content-->
          <div class="container">
            <div class="step-progress">
              <div class="step completed">
                <div class="circle">1</div>
                <div class="label">Step 1</div>
              </div>
              <div class="step">
                <div class="circle">2</div>
                <div class="label">Step 2</div>
              </div>
              <div class="step">
                <div class="circle">3</div>
                <div class="label">Step 3</div>
              </div>
              <div class="step">
                <div class="circle">4</div>
                <div class="label">Step 4</div>
              </div>
            </div>
          
            <button id="nextStepButton" class="btn btn-primary">Next Step</button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Next</button>
        </div>
      </div>
    </div>
  </div>
<!--Profiling Modal-->
 
 <div class="modal fade" id="profilingModal" tabindex="-1" aria-labelledby="profilingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
      <div class="modal-content buldingPermitApplication">
          <div class="modal-header">
              <h1 class="modal-title fs-5" id="BuildingPermitModalLabel"><i class="fa-solid fa-user"></i> Profile</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <!-- Application Modal Content -->
              <div class="container">
                  <div class="step-progress mb-4">
                      <div class="step completed">
                          <div class="circle"></div>
                          <div class="label">Household</div>
                      </div>
                      <div class="step">
                          <div class="circle"></div>
                          <div class="label">Household Members</div>
                      </div>

                      <div class="step">
                        <div class="circle"></div>
                        <div class="label">Lot and House Characteristics</div>
                    </div>
                    </div>

                    <div class="contentContainer">
                      <div class="row">
                        <div class="col">
                           <label for="">Survey No.</label>
                           <input class="form-control" type="text" title="surveyNo" placeholder="">
                        </div>

                        <div class="col">
                          <label for="surveyDate">Date</label>
                          <input class="form-control" type="date" id="surveyDate" title="surveyNo" placeholder="">
                      </div>
                      
                        <div class="col">
                          <label for="barangay">Barangay</label>
                          <select class="form-control" id="barangay" name="barangay">
                            <option value="">Bagong Kalsada</option>
                            <option value="Barangay1">Banadero</option>
                            <option value="Barangay2">Banlic</option>
                            <option value="Barangay3">Barandal</option>
                            <option value="Barangay3">Batino</option>
                            <option value="Barangay3">Bubuyan</option>
                            <option value="Barangay3">Bucal</option>
                            <option value="Barangay3">Burol</option>
                            <option value="Barangay3">Camaligan</option>
                            <option value="Barangay3">Canlubang</option>
                            <option value="Barangay3">Halang</option>
                
                            <!-- Add more options as needed -->
                          </select>
                        </div>
                        
                        <div class="col">
                          <label for="">Sitio/Purok</label>
                           <input class="form-control" type="text" title="surveyNo" placeholder="">
                        </div>
                       
                        <div class="row">
                          <div class="col">
                            <label for="classificationArea">Classification Area</label>
                            <div>
                              <input type="radio" id="option1" name="classificationArea" value="Option 1">
                              <label for="option1">Danger Zone</label>
                            </div>
                            <div>
                              <input type="radio" id="option2" name="classificationArea" value="Option 2">
                              <label for="option2">Not Danger Zone</label>
                            </div>
                          </div>
                        </div>
                        

                          <div class="col">
                            <label for="">Remarks</label>
                            <textarea class="form-control" rows="1" title="surveyNo" placeholder=""></textarea>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col">
                            <label for="">Date of Birth</label>
                            <input class="form-control" type="date" title="surveyNo" placeholder="">
                          </div>
                          <div class="col">
                            <label for="">Gender</label>
                            <select class="form-control" id="" name="">
                              <option value="">Male</option>
                              <option value="">Female</option>
                              <option value="">Prefer not to say</option>
                              
                            </select>
                          </div>
                          <div class="col">
                            <label for="">Civil Status</label>
                            
                            <select class="form-control" id="" name="">
                              <option value="">Single</option>
                              <option value="">Married</option>
                              <option value="">Widowed</option>
                              <option value="">Live in</option>
                              <option value="">Single Parent</option>
                              <option value="">Separated</option>
                            </select>
                          </div>
                        </div>

                   
                        <div class="row">
                          <h6>Name</h6>
                        </div>
                        <div class="row">
                           <div class="col">
                            <label for="">Last Name</label>
                            <input class="form-control" type="text" title="surveyNo" placeholder="">
                           </div>
                           <div class="col">
                            <label for="">First Name</label>
                            <input class="form-control" type="text" title="surveyNo" placeholder="">
                           </div>
                           <div class="col">
                            <label for="">Middle Name</label>
                            <input class="form-control" type="text" title="surveyNo" placeholder="">
                           </div>
                           <div class="col">
                            <label for="">Maiden Name</label>
                            <input class="form-control" type="text" title="surveyNo" placeholder="">
                           </div>


                        <div class="row">
                          <div class="col">
                            <label for="">Occupation</label>
                            <input class="form-control" type="text" title="surveyNo" placeholder="">
                          </div>

                          <div class="col">
                            <label for="">Place of Work</label>
                            <input class="form-control" type="text" title="surveyNo" placeholder="">
                          </div>
                        </div>

                        <div class="row">
                          <div class="col">
                            <label for="">Present Address</label>
                            <input class="form-control" type="text" title="surveyNo" placeholder="">
                          </div>
                        </div>

                        <div class="row">
                          <h6>Name of Spouse</h6>
                        </div>
                        <div class="row">
                          <div class="col">
                           <label for="">Last Name</label>
                           <input class="form-control" type="text" title="surveyNo" placeholder="">
                          </div>
                          <div class="col">
                           <label for="">First Name</label>
                           <input class="form-control" type="text" title="surveyNo" placeholder="">
                          </div>
                          <div class="col">
                           <label for="">Middle Name</label>
                           <input class="form-control" type="text" title="surveyNo" placeholder="">
                          </div>
                          <div class="col">
                           <label for="">Maiden Name</label>
                           <input class="form-control" type="text" title="surveyNo" placeholder="">
                          </div>

                          <div class="row">
                            <div class="col-md-3">
                              <label for="">Date of Birth</label>
                           <input class="form-control" type="date" title="surveyNo" placeholder="">
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-md-6">
                              <label for="barangay">Classification of Survey Household</label>
                              <select class="form-control" id="barangay" name="barangay">
                                <option value="Barangay2">Owner</option>
                                <option value="Barangay1">Co-Owner</option>
                                <option value="Barangay3">Sharer</option>
                                <option value="Barangay3">RFO</option>
                                <option value="Barangay3">Caretaker</option>
                                <option value="Barangay3">Renter</option>
                               
                    
                                <!-- Add more options as needed -->
                              </select>
                            </div>

                            <div class="col-md-2">
                              <label for="">Amount</label>
                           <input class="form-control" type="text" title="surveyNo" placeholder="">
                            </div>

                            <div class="col-md-4">
                              <label for="">Structure Owner</label>
                           <input class="form-control" type="text" title="surveyNo" placeholder="">
                            </div>
                          </div>

                          <div class="row">
                            <div class="col">
                              <label for="">Province of Origin</label>
                              <input class="form-control" type="text" title="surveyNo" placeholder="">
                            </div>

                            <div class="col">
                              <label for="">Household Size</label>
                              <input class="form-control" type="text" title="surveyNo" placeholder="">
                            </div>
                            <div class="col">
                              <label for="">Years of Residency</label>
                              <input class="form-control" type="text" title="surveyNo" placeholder="">
                            </div>
                          </div>


                          <div class="container mt-3">
                            <div class="col">
                                <label for="reasonSelect">Reason/s for Establishing Residence in the Area:</label>
                                <select class="form-control" id="reasonSelect" name="reasons">
                                    <option value="Proximity of Livelihood">Proximity of Livelihood</option>
                                    <option value="Rent Free/Affordable Rental Rates">Rent Free/Affordable Rental Rates</option>
                                    <option value="Acquired Right">Acquired Right</option>
                                    <option value="Family Ties">Family Ties</option>
                                    <option value="Near School">Near School</option>
                                    <option value="No other place to go">No other place to go</option>
                                </select>
                            </div>
                        </div>
                        


                        </div>
              
                      </div>
        
                  </form>
                  </div>
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" id="nextStepButton" class="btn btn-primary">Next</button>
          </div>
      </div>
  </div>
</div>

<script type="module" src="/Database/firebase.js">
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, getDocs, updateDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
      apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
      authDomain: "chsd-mis.firebaseapp.com",
      projectId: "chsd-mis",
      storageBucket: "chsd-mis.appspot.com",
      messagingSenderId: "694967679357",
      appId: "1:694967679357:web:65cffd50f13739f934f414",
      measurementId: "G-XBQTQFRLJ5"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Notification Function
  function showNotification(message, type) {
      const notificationContainer = document.getElementById('notification-container');
      if (notificationContainer) {
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.textContent = message;
          notificationContainer.appendChild(notification);
          alert("status updated successfully");

          // Automatically remove notification after 5 seconds
          setTimeout(() => {
              notification.remove();
          }, 5000);
      } else {
          console.error('Notification container not found.');
      }
  }

  // Pagination Variables
  let profilesPerPage = 5; // Profiles per page
  let currentPage = 1; // Current page
  let totalPages = 1; // Total pages

  // Function to Load Housing Profiles and Display in the Table
  async function loadProfiles() {
      try {
          const querySnapshot = await getDocs(collection(db, "Housing"));
          const housingDiv = document.querySelector("tbody");
          const prevPageBtn = document.getElementById("prevPageBtn");
          const nextPageBtn = document.getElementById("nextPageBtn");
          const pageInfo = document.getElementById("pageInfo");

          if (!housingDiv) {
              console.error("housingDiv not found in the DOM.");
              return;
          }

          housingDiv.innerHTML = ""; // Clear existing rows

          // Fetch and Process Housing Data
          const housingData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          const uniqueHousingData = Array.from(new Set(housingData.map(a => a.id)))
              .map(id => housingData.find(a => a.id === id));

          // Sort by createdAt (ascending)
          uniqueHousingData.sort((a, b) => {
              const aTime = a.createdAt?.seconds || 0;
              const bTime = b.createdAt?.seconds || 0;
              return aTime - bTime;
          });

          // Calculate Total Pages
          totalPages = Math.ceil(uniqueHousingData.length / profilesPerPage);

          // Determine Profiles for Current Page
          const start = (currentPage - 1) * profilesPerPage;
          const end = start + profilesPerPage;
          const currentProfiles = uniqueHousingData.slice(start, end);

          // Loop Through Profiles and Populate Table
          for (const data of currentProfiles) {
              const row = document.createElement("tr");

              // Fetch Representative User Data
              let representativeName = "";
              if (data.ownerUid) {
                  try {
                      const userRef = doc(db, "users", data.ownerUid);
                      const userDoc = await getDoc(userRef);
                      if (userDoc.exists()) {
                          const userData = userDoc.data();
                          representativeName = `${userData.firstName} ${userData.lastName}`;
                      }
                  } catch (error) {
                      console.error("Error fetching user data:", error);
                  }
              }

              const createdAt = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString() : "N/A";

              row.innerHTML = `
                  <td>${data.ownerName || "N/A"}</td>
                  <td>${representativeName || "N/A"}</td>
                  <td>${createdAt}</td>
                  <td>${data.status || "N/A"}</td>
                  <td>
                      <button class="btn btn-primary btn-sm view-details-btn" data-permit-id="${data.id}">View Details</button>
                  </td>
              `;

              housingDiv.appendChild(row);

              // Add Event Listener for "View Details" Button
              const viewDetailsBtn = row.querySelector(".view-details-btn");
              if (viewDetailsBtn) {
                  viewDetailsBtn.addEventListener("click", () => {
                      openViewDetailsModal(data);
                  });
              }
          }

          // Update Pagination Info
          pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

          // Enable/Disable Pagination Buttons
          prevPageBtn.disabled = currentPage === 1;
          nextPageBtn.disabled = currentPage === totalPages;

      } catch (error) {
          console.error("Error loading profiles:", error);
          showNotification("Failed to load profiles.", "error");
      }
  }

  // Function to Control Progressive Status Selection
  function updateStatusOptions(currentStatus) {
      const statusSelect = document.getElementById("statusSelect");
      const statusOptions = ["Pending", "Processing", "To Pay", "For Approval", "For Release", "Claimed"];

      // Clear existing options
      statusSelect.innerHTML = "";

      // Add only the next status options based on the current status
      const currentIndex = statusOptions.indexOf(currentStatus);
      for (let i = currentIndex; i < statusOptions.length; i++) {
          const option = document.createElement("option");
          option.value = statusOptions[i];
          option.textContent = statusOptions[i];
          statusSelect.appendChild(option);
      }
  }

  // Function to Handle Status Update
  async function updateStatus() {
      const selectedProfileId = document.getElementById("profileIdInput").value;
      const newStatus = document.getElementById("statusSelect").value;
      const timestamp = serverTimestamp();

      if (selectedProfileId) {
          try {
              const profileRef = doc(db, "Housing", selectedProfileId);
              await updateDoc(profileRef, {
                  status: newStatus,
                  updatedAt: timestamp
              });
              showNotification("Status updated successfully!", "success");
              loadProfiles();
              closeModal("updateStatusModal"); // Close the modal after updating
          } catch (error) {
              console.error("Error updating status:", error);
              showNotification("Failed to update status.", "error");
          }
      } else {
          console.error("No profile selected for status update.");
      }
  }

  // Function to Open the View Details Modal
  function openViewDetailsModal(data) {
      // Set modal fields
      document.getElementById("ownerNameField").textContent = data.ownerName || "N/A";
      document.getElementById("statusField").textContent = data.status || "N/A";
      document.getElementById("createdAtField").textContent = new Date(data.createdAt.seconds * 1000).toLocaleString() || "N/A";

      // Update Profile ID for status update
      document.getElementById("profileIdInput").value = data.id;

      // Update status options based on current status
      updateStatusOptions(data.status);

      // Show modal
      const updateStatusModal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
      updateStatusModal.show();
  }

  // Function to Open Housing Form Modal
  function openViewHousingFormModal(data) {
      // Handle loading the housing form based on the data
      // You may need to customize this according to your form structure
      console.log("Viewing housing form for ID:", data.id);
  }

  // Function for Next Page
  function nextPage() {
      if (currentPage < totalPages) {
          currentPage++;
          loadProfiles();
      }
  }

  // Function for Previous Page
  function prevPage() {
      if (currentPage > 1) {
          currentPage--;
          loadProfiles();
      }
  }

  // Event Listeners for Pagination Buttons
  document.getElementById("prevPageBtn").addEventListener("click", prevPage);
  document.getElementById("nextPageBtn").addEventListener("click", nextPage);

  // Event Listener for Update Status Button
  document.getElementById("updateStatusBtn").addEventListener("click", updateStatus);

  // Load Profiles on Page Load
  loadProfiles();
</script>


<script>
  document.addEventListener('DOMContentLoaded', (event) => {
      const dateInput = document.getElementById('surveyDate');
      const today = new Date().toISOString().split('T')[0]; // Get today's date in yyyy-mm-dd format
      dateInput.value = today;
  });
</script>
<!--Navigation Bar-->
<script>
  document.querySelector('.open-btn').addEventListener('click', function() {
      document.getElementById('side_nav').classList.add('active');
  });

  document.querySelector('.close-btn').addEventListener('click', function() {
      document.getElementById('side_nav').classList.remove('active');
  });
</script>


<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/8d1b0b1c7b.js" crossorigin="anonymous"></script>
<script defer src="/Database/firebase.js" type="module"></script>
</body>
</html>
