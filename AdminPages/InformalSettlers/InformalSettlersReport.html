<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }
        #resultCount {
    display: none;
}

    </style>
</head>
<body>

    
    <div id="loadingScreen" class="loading-screen" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center">
                <!-- Empty avatar icon -->
                
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-white"><i class="fal fa-stream"></i>Menu</button>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/adminDashboardInformalSettlers.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/InformalSettlersApplication.html" class="text-decoration-none"><i class="fa-solid fa-folder"></i> Housing Application</a></li>
                <li class="sideNav active"><a href="/AdminPages/InformalSettlers/InformalSettlersReport.html" class="text-decoration-none"><i class="fa-solid fa-chart-column"></i> Application Report</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/followup.html" class="text-decoration-none"><i class="fa-solid fa-bullhorn"></i> Follow up</a></li>
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
               <!--Navigation Bar-->
<nav class="navigationBar navbar navbar-expand-lg bg-light">
    <div class="container-fluid">
        <!-- Mobile View -->
        <div class="d-flex justify-content-between d-md-none d-block">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
                <h5 class="mb-0 fs-5">CHSD</h5>
            </a>
            <button class="btn px-1 py-0 open-btn">
                <i class="fa-solid fa-bars-staggered"></i>
            </button>
        </div>
  
        <!-- Desktop View -->
        <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
                <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
            </a>
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <!-- Additional nav items go here -->
            </ul>
        </div>
    </div>
  </nav>

           
           
               <h4 class="text-center">Application Report</h4>
               <div class="contentContainer">
                <div class="container mt-3">
                    
                        
                <!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#advanceSearchModal">
    <i class="fa-solid fa-magnifying-glass"></i> Advance Search
  </button>

  <button type="button" class="btn btn-secondary"><i class="fa-solid fa-file-export"></i> Export</button> 
  
  <!-- Advance SearchModal -->
  <div class="modal fade" id="advanceSearchModal" tabindex="-1" aria-labelledby="advanceSearchModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="advanceSearchModalLabel">Advance Search</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="dateFrom">Date</label>
                    <input class="form-control" type="date" id="dateFrom" placeholder="">
                </div>
                <div class="col-md-1 d-flex align-items-center justify-content-center">
                    <span class="to-label">to</span>
                </div>
                <div class="col-md-4">
                    <label for="dateTo"></label>
                    <input class="form-control" type="date" id="dateTo" placeholder="">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-4">
                    <label for="ageFrom">Age</label>
                    <input type="number" class="form-control" id="ageFrom" placeholder="">
                </div>
                <div class="col-md-1 d-flex align-items-center justify-content-center">
                    <span class="to-label">to</span>
                </div>
                <div class="col-md-4">
                    <label for="ageTo"></label>
                    <input type="number" class="form-control" id="ageTo" placeholder="">
                </div>
            </div>
        

   <div class="row">
      <div class="col">
        <label for="householdHeadName>Name</label>
        <input class="form-control" type="text" title="name" id="householdHeadName" placeholder="">
      </div>
      <div class="col">
        <label for="classificationArea">Classification</label>
        <select class="form-control" type="text" title="classification" id="classificationArea" placeholder="">
            <option>Danger Zone</option>
                <option>Not Danger Zone</option>
                </select>
        </div>
   </div>

   <div class="row">
    <div class="col">
      <label for="barangay">Barangay</label>
      <select class="form-control" id="barangay">
        <option value="">Select Barangay</option>
        <option>Barangay Uno</option>
        <option>Barangay Dos</option>
        <option>Barangay Tres</option>
        <option>Barangay Kwatro</option>
        <option>Barangay Singko</option>
        <option>Barangay Sais</option>
        <option>Barangay Syete</option>
        <option>Bagong Kalsada</option>
        <option>Banadero</option>
        <option>Banlic</option>
        <option>Barandal</option>
        <option>Batino</option>
        <option>Bubuyan</option>
        <option>Bucal</option>
        <option>Bunggo</option>
        <option>Burol</option>
        <option>Camaligan</option>
        <option>Canlubang</option>
        <option>Halang</option>
        <option>Hornalan</option>
        <option>Kay-Anlog</option>
        <option>Laguerta</option>
        <option>Lamesa</option>
        <option>Lawa</option>
        <option>Lecheria</option>
        <option>Lingga</option>
        <option>Looc</option>
        <option>Mabato</option>
        <option>Makiling</option>
        <option>Majada Out</option>
        <option>Mapagong</option>
        <option>Masili</option>
        <option>Maunong</option>
        <option>Mayapa</option>
        <option>Milagrosa</option>
        <option>Palingon</option>
        <option>Paciano Rizal</option>
        <option>Palo Alto</option>
        <option>Pansol</option>
        <option>Parian</option>
        <option>Prinza</option>
        <option>Punta</option>
        <option>Puting Lupa</option>
        <option>Real</option>
        <option>Saimsim</option>
        <option>Sampiruhan</option>
        <option>San Cristobal</option>
        <option>San Jose</option>
        <option>San Juan</option>
        <option>Sirang Lupa</option>
        <option>Sucol</option>
        <option>Turbina</option>
        <option>Ulango</option>
        <option>Uwisan</option>
        </select>
    </div>
    <div class="col">
      <label for="sitioPurok">Sitio/Purok</label>
      <select class="form-control" type="text" id="sitioPurok" placeholder="">
        <option value="">Select Purok/Sitio</option>
        <option>Purok 1</option>
        <option>Purok 2</option>
        <option>Purok 3</option>
        <option>Purok 4</option>
        <option>Purok 5</option>
        <option>Purok 6</option>
        <option>Purok 7</option>
        <option>Purok 8</option>
        <option>Purok 9</option>
        <option>Purok 10</option>
        <option>Sitio Kapayapaan</option>
        <option>Sitio Lumot</option>
        <option>Sitio Putol</option>
        <option>Sitio Hulo</option>
        <option>Sitio Masaya</option>
        <option>Sitio Sungi</option>
        <option>Sitio Banlic</option>
        <option>Sitio Ilaya</option>
        <option>Sitio Calero</option>
        <option>Sitio Masiit</option>
        <option>Sitio Tubigan</option>
        <option>Sitio Sibulo</option>
        <option>Sitio Sto. Tomas</option>
        <option>Sitio Ronggot</option> 
    </select>
    </div>
 </div>
 <div class="row">
    <div class="col-md-3">
        <label for="gender">Gender</label>
        <select class="form-control" id="gender" name="">
          <option value="any">Any</option>
          <option value="">Male</option>
          <option value="">Female</option>
          <option value="">Prefer not to say</option>
          
        </select>
      </div>
      <div class="col-md-3">
        <label for="">Civil Status</label>
        
        <select class="form-control" id="" name="">
          <option value="">Single</option>
          <option value="">Married</option>
          <option value="">Widowed</option>
          <option value="">Live in</option>
          <option value="">Single Parent</option>
          <option value="">Separated</option>
        </select>
      </div>


    <div class="row">
        <div class="col-md-6">
          <label for="name">Address</label>
          <input class="form-control" type="text" title="name" placeholder="">
        </div>
        <div class="col-md-3">
          <label for="utilities">Utilities</label>
          <select class="form-control" id="utilities" title="classification" placeholder="">
            <option>Meralco</option>
            <option>Connected To Other Subscriber</option>
            <option>None</option>
        </select>
        </div>
        <div class="col-md-3">
            <label for="sourceOfWater">Source of Water</label>
          <select class="form-control" id="sourceOfWater" title="classification" placeholder="">
            <option value="">Select Source of Water</option>
            <option value="local_water_district">Local Water District</option>
            <option value="deep_well">Deep Well</option>
            <option value="shallow_well">Shallow Well</option>
            <option value="water_delivery">Water Delivery (Private Supplier)</option>
            <option value="communal_faucet">Communal Faucet System (Barangay/Community)</option>
            <option value="rainwater">Rainwater Collection</option>
        </select>
        </div>
 </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a class="btn btn-primary text-white"><i class="fa-solid fa-magnifying-glass"></i> Search</a>
        </div>
      </div>
    </div>
  </div>

            
            

          
            
            </div>
        </div>
        <table class="table mt-3">
            <thead>
                <tr>
                    <th>Household Name</th>
                    <th>Date of Birth</th>
                    <th>Age</th>
                    <th>Barangay</th>
                    <th>Sitio/Purok</th>
                    <th>COA</th>
                </tr>
            </thead>
            <tbody>
              
                
                <!-- Data will be dynamically inserted here -->
            </tbody>
        </table>
        <div id="resultInfo">
            <span id="resultCount">0 result(s) found</span>
        </div>
        
        <!-- Pagination Buttons and Page Info -->
        <div class="pagination-controls">
            <button id="prevPageBtn" class="btn btn-secondary" disabled>Previous</button>
            <span id="pageInfo"></span>
            <button id="nextPageBtn" class="btn btn-secondary" disabled>Next</button>
        </div>
    </div>

   

    <script type="module" src="/Database/firebase.js">
    </script>
    <!--Navigation Bar-->
<script>
    document.querySelector('.open-btn').addEventListener('click', function() {
        document.getElementById('side_nav').classList.add('active');
    });
  
    document.querySelector('.close-btn').addEventListener('click', function() {
        document.getElementById('side_nav').classList.remove('active');
    });
  </script>




<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
        authDomain: "chsd-mis.firebaseapp.com",
        projectId: "chsd-mis",
        storageBucket: "chsd-mis.appspot.com",
        messagingSenderId: "694967679357",
        appId: "1:694967679357:web:65cffd50f13739f934f414",
        measurementId: "G-XBQTQFRLJ5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const loadingScreen = document.getElementById("loadingScreen");
    const modalElement = document.getElementById("advanceSearchModal");
    const searchButton = document.querySelector(".btn-primary.text-white");
    const exportButton = document.querySelector(".btn-secondary");
    const resultCount = document.getElementById("resultCount");

    // Show and hide loading screen
    function showLoading() {
        loadingScreen.style.display = "block";
    }

    function hideLoading() {
        loadingScreen.style.display = "none";
    }

    function closeModal() {
        if (modalElement) {
            const modalInstance = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            modalInstance.hide();
        }
    }

    // Load submitted reports on page load
    window.onload = loadSubmittedReports;

    document.addEventListener("DOMContentLoaded", () => {
        searchButton.addEventListener("click", async () => {
            showLoading();

            // Retrieve filter values
            const dateFrom = document.getElementById("dateFrom").value;
            const dateTo = document.getElementById("dateTo").value;
            const barangay = document.getElementById("barangay").value;
            const ageFrom = document.getElementById("ageFrom").value;
            const ageTo = document.getElementById("ageTo").value;

            // Base query for "Submitted" status
            let searchQuery = query(collection(db, "Housing"), where("status", "==", "Submitted"));

            // Apply filters conditionally
            if (dateFrom && dateTo) {
                searchQuery = query(searchQuery, where("dateApplied", ">=", new Date(dateFrom)), where("dateApplied", "<=", new Date(dateTo)));
            }
            if (barangay) searchQuery = query(searchQuery, where("barangay", "==", barangay));
            if (ageFrom && ageTo) searchQuery = query(searchQuery, where("age", ">=", ageFrom), where("age", "<=", ageTo));

            try {
                // Fetch and display matching documents
                const snapshot = await getDocs(searchQuery);
                const results = snapshot.docs.map(doc => doc.data());

                displayResults(results);
                if (resultCount) {
                    resultCount.textContent = `${results.length} result(s) found`;
                    resultCount.style.display = "block";
                }
                closeModal();
            } catch (error) {
                console.error("Error retrieving documents:", error);
            } finally {
                hideLoading();
            }
        });

        exportButton.addEventListener("click", () => {
            showLoading();
            exportData();
            hideLoading();
        });
    });

    async function loadSubmittedReports() {
        showLoading();

        // Pagination Variables
        const profilesPerPage = 10;
        let currentPage = 1;
        let totalPages = 1;

        try {
            const q = query(collection(db, "Housing"), where("status", "==", "Submitted"));
            const querySnapshot = await getDocs(q);

            const housingData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            housingData.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            totalPages = Math.ceil(housingData.length / profilesPerPage);

            renderProfiles(housingData, currentPage, profilesPerPage, totalPages);
        } catch (error) {
            console.error("Error loading submitted reports:", error);
        } finally {
            hideLoading();
        }
    }

    function renderProfiles(data, currentPage, profilesPerPage, totalPages) {
        const start = (currentPage - 1) * profilesPerPage;
        const end = start + profilesPerPage;
        const currentProfiles = data.slice(start, end);

        const housingDiv = document.querySelector("tbody");
        if (!housingDiv) return;
        housingDiv.innerHTML = "";

        currentProfiles.forEach(profile => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${profile.householdHeadName || 'N/A'}</td>
                <td>${profile.householdBirthday || 'N/A'}</td>
                <td>${calculateAge(profile.householdBirthday) || 'N/A'}</td>
                <td>${profile.barangay || 'N/A'}</td>
                <td>${profile.sitioPurok || 'N/A'}</td>
                <td>${profile.classificationArea || 'N/A'}</td>
            `;
            housingDiv.appendChild(row);
        });

        document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById("prevPageBtn").disabled = currentPage === 1;
        document.getElementById("nextPageBtn").disabled = currentPage === totalPages;
    }

    function calculateAge(dob) {
        if (!dob) return "N/A";
        const birthDate = new Date(dob);
        const ageDate = new Date(Date.now() - birthDate.getTime());
        return Math.abs(ageDate.getUTCFullYear() - 1970);
    }

    function displayResults(results) {
        const tableBody = document.querySelector(".table tbody");
        tableBody.innerHTML = "";

        results.forEach(data => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${data.householdHeadName || ''}</td>
                <td>${data.householdBirthday || ''}</td>
                <td>${calculateAge(data.householdBirthday) || ''}</td>
                <td>${data.barangay || ''}</td>
                <td>${data.sitioPurok || ''}</td>
                <td>${data.classificationOfSurveyHousehold || ''}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function exportData() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const tableBody = document.querySelector(".table tbody");
    const rows = Array.from(tableBody.querySelectorAll("tr"));

    // Table headers
    doc.text("Application Report", 10, 10);
    doc.setFontSize(10);
    const headers = ["Household Head Name", "Birthday", "Age", "Barangay", "Sitio/Purok", "Classification Area"];
    doc.autoTable({
        head: [headers],
        body: rows.map(row => Array.from(row.querySelectorAll("td")).map(td => td.textContent)),
        startY: 20, // Position below title
        margin: { left: 10, right: 10 }
    });

    doc.save("Application_Report.pdf");
}

</script>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-8h4HcQkHVhz8MDe6f8W2uZ+P9f3L3/k4JcJURqxO0F+aGepEj0vDSeBbdQnKP9Oh" crossorigin="anonymous"></script>

</body>
</html>
