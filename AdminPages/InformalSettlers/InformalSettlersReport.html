<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link rel="icon" href="/resources/pictures/chsd.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />


    <style>
        .modal-backdrop {
    z-index: 1040;
}
.modal {
    z-index: 1050;
}

        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }
        #resultCount {
    display: none;
}
/* Styles specific to the custom-range-fields class */
.custom-range-fields .row.align-items-center {
    display: flex;
    align-items: center; /* Vertically aligns inputs and labels */
}

.custom-range-fields label.form-label {
    display: block;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.custom-range-fields .to-label {
    font-size: 1.2rem;
    font-weight: bold;
    color: #495057;
    margin-top: 1.5rem;
}

.custom-range-fields .text-center label {
    font-size: 1rem;
    font-weight: bold;
    margin-top: 1.5rem;
    display: block;
}

.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999; /* Ensure it covers everything */
}



    </style>
</head>
<body>

    
    <div id="loading-screen" class="loading-screen" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="main-container d-flex">
        <div class="sideNav" id="side_nav">
            <div class="header-box text-center">
                <!-- Empty avatar icon -->
                
                <button class="btn d-md-none d-block close-btn px-1 py-0 text-white"><i class="fal fa-stream"></i>Menu</button>
            </div>
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/adminDashboardInformalSettlers.html" class="text-decoration-none"><i class="fa-solid fa-house"></i> Dashboard</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/InformalSettlersApplication.html" class="text-decoration-none"><i class="fa-solid fa-folder"></i> Housing Application</a></li>
                <li class="sideNav active"><a href="/AdminPages/InformalSettlers/InformalSettlersReport.html" class="text-decoration-none"><i class="fa-solid fa-chart-column"></i> Application Report</a></li>
                <li class="sideNav"><a href="/AdminPages/InformalSettlers/followup.html" class="text-decoration-none"><i class="fa-solid fa-bullhorn"></i> Follow up</a></li>
                <li class="sideNav"><a id="admin-logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>

        <div class="content">
               <!--Navigation Bar-->
<nav class="navigationBar navbar navbar-expand-lg bg-light">
    <div class="container-fluid">
        <!-- Mobile View -->
        <div class="d-flex justify-content-between d-md-none d-block">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
                <h5 class="mb-0 fs-5">CHSD</h5>
            </a>
            <button class="btn px-1 py-0 open-btn">
                <i class="fa-solid fa-bars-staggered"></i>
            </button>
        </div>
  
        <!-- Desktop View -->
        <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
                <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
            </a>
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <!-- Additional nav items go here -->
            </ul>
        </div>
    </div>
  </nav>

           
           
               <h4 class="text-center">Application Report</h4>
               <div class="contentContainer">
                <div class="container mt-3">
                    
                        
                <!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#advanceSearchModal">
    <i class="fa-solid fa-magnifying-glass"></i> Advance Search
  </button>

  <button type="button" class="btn btn-secondary"><i class="fa-solid fa-file-export"></i> Export</button> 
  
  <!-- Advance Search Modal -->
<div class="modal fade" id="advanceSearchModal" tabindex="-1" aria-labelledby="advanceSearchModalLabel" aria-hidden="true">
    <div class="wide-modal modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="advanceSearchModalLabel">
                    <i class="fa-solid fa-magnifying-glass"></i> Advanced Search
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

            </div>
            <div class="modal-body">
                <div class="container">
                    <!-- Date and Age Range -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <strong><i class="fa-solid fa-calendar-alt me-2"></i> Filter by Date and Age Range</strong>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <label for="dateFrom" class="form-label me-2">From:</label>
                                        <input type="date" class="form-control" id="dateFrom" placeholder="Start date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <label for="dateTo" class="form-label me-2">To:</label>
                                        <input type="date" class="form-control" id="dateTo" placeholder="End date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <label for="ageFrom" class="form-label me-2">From Age:</label>
                                        <input type="number" class="form-control" id="ageFrom" placeholder="Min age">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <label for="ageTo" class="form-label me-2">To Age:</label>
                                        <input type="number" class="form-control" id="ageTo" placeholder="Max age">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Classification and Location -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <strong><i class="fa-solid fa-map-marker-alt me-2"></i> Location and Classification</strong>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="householdHeadName" class="form-label">Name</label>
                                    <input class="form-control" type="text" id="householdHeadName" placeholder="Enter name">
                                </div>
                                <div class="col-md-6">
                                    <label for="classificationArea" class="form-label">Classification</label>
                                    <select class="form-control" id="classificationArea">
                                        <option value="">Select Classification</option>
                                        <option>Danger Zone</option>
                                        <option>Not Danger Zone</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="barangay" class="form-label">Barangay</label>
                                    <select class="form-control" id="barangay">
                                        <option value="">Select Barangay</option>
                                        <option>Barangay Uno</option>
                                        <option>Barangay Dos</option>
                                        <option>Barangay Tres</option>
                                        <option>Barangay Kwatro</option>
                                        <option>Barangay Singko</option>
                                        <option>Barangay Sais</option>
                                        <option>Barangay Syete</option>
                                        <option>Bagong Kalsada</option>
                                        <option>Banadero</option>
                                        <option>Banlic</option>
                                        <option>Barandal</option>
                                        <option>Batino</option>
                                        <option>Bubuyan</option>
                                        <option>Bucal</option>
                                        <option>Bunggo</option>
                                        <option>Burol</option>
                                        <option>Camaligan</option>
                                        <option>Canlubang</option>
                                        <option>Halang</option>
                                        <option>Hornalan</option>
                                        <option>Kay-Anlog</option>
                                        <option>Laguerta</option>
                                        <option>Lamesa</option>
                                        <option>Lawa</option>
                                        <option>Lecheria</option>
                                        <option>Lingga</option>
                                        <option>Looc</option>
                                        <option>Mabato</option>
                                        <option>Makiling</option>
                                        <option>Majada Out</option>
                                        <option>Mapagong</option>
                                        <option>Masili</option>
                                        <option>Maunong</option>
                                        <option>Mayapa</option>
                                        <option>Milagrosa</option>
                                        <option>Palingon</option>
                                        <option>Paciano Rizal</option>
                                        <option>Palo Alto</option>
                                        <option>Pansol</option>
                                        <option>Parian</option>
                                        <option>Prinza</option>
                                        <option>Punta</option>
                                        <option>Puting Lupa</option>
                                        <option>Real</option>
                                        <option>Saimsim</option>
                                        <option>Sampiruhan</option>
                                        <option>San Cristobal</option>
                                        <option>San Jose</option>
                                        <option>San Juan</option>
                                        <option>Sirang Lupa</option>
                                        <option>Sucol</option>
                                        <option>Turbina</option>
                                        <option>Ulango</option>
                                        <option>Uwisan</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="sitioPurok" class="form-label">Sitio/Purok</label>
                                    <select class="form-control" id="sitioPurok">
                                        <option value="">Select Sitio/Purok</option>
                                        <option>Purok 1</option>
                                        <option>Purok 2</option>
                                        <option>Purok 3</option>
                                        <option>Purok 4</option>
                                        <option>Purok 5</option>
                                        <option>Purok 6</option>
                                        <option>Purok 7</option>
                                        <option>Purok 8</option>
                                        <option>Purok 9</option>
                                        <option>Purok 10</option>
                                        <option>Sitio Kapayapaan</option>
                                        <option>Sitio Lumot</option>
                                        <option>Sitio Putol</option>
                                        <option>Sitio Hulo</option>
                                        <option>Sitio Masaya</option>
                                        <option>Sitio Sungi</option>
                                        <option>Sitio Banlic</option>
                                        <option>Sitio Ilaya</option>
                                        <option>Sitio Calero</option>
                                        <option>Sitio Masiit</option>
                                        <option>Sitio Tubigan</option>
                                        <option>Sitio Sibulo</option>
                                        <option>Sitio Sto. Tomas</option>
                                        <option>Sitio Ronggot</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Filters -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <strong><i class="fa-solid fa-info-circle me-2"></i> Additional Filters</strong>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="gender" class="form-label">Gender</label>
                                    <select class="form-control" id="gender">
                                        <option value="any">Any</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="prefer-not">Prefer not to say</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="civilStatus" class="form-label">Civil Status</label>
                                    <select class="form-control" id="civilStatus">
                                        <option>Single</option>
                                        <option>Married</option>
                                        <option>Widowed</option>
                                        <option>Live-in</option>
                                        <option>Single Parent</option>
                                        <option>Separated</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="utilities" class="form-label">Utilities</label>
                                    <select class="form-control" id="utilities">
                                        <option>Meralco</option>
                                        <option>Connected To Other Subscriber</option>
                                        <option>None</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="sourceOfWater" class="form-label">Source of Water</label>
                                    <select class="form-control" id="sourceOfWater">
                                        <option>None</option>
                                        <option>Deepwell</option>
                                        <option>MWSS</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="remarks" class="form-label">Remarks</label>
                                    <input type="text" class="form-control" id="remarks" placeholder="Enter remarks">
                                </div>
                                <div class="col-md-4">
                                    <label for="income" class="form-label">Monthly Income</label>
                                    <input type="number" class="form-control" id="income" placeholder="Enter income">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="searchButton"><i class="fa-solid fa-search me-2"></i> Search</button>
            </div>
        </div>
    </div>
</div>

        
        
    
        <table class="table mt-3">
            <thead>
                <tr>
                    <th>Household Name</th>
                    <th>Date of Birth</th>
                    <th>Age</th>
                    <th>Barangay</th>
                    <th>Sitio/Purok</th>
                    <th>COA</th>
                </tr>
            </thead>
            <tbody>
              
                
                <!-- Data will be dynamically inserted here -->
            </tbody>
        </table>
        <div id="resultInfo">
            <span id="resultCount">0 result(s) found</span>
        </div>
        
        <!-- Pagination Buttons and Page Info -->
        <div class="pagination-controls">
            <button id="prevPageBtn" class="btn btn-secondary" disabled>Previous</button>
            <span id="pageInfo"></span>
            <button id="nextPageBtn" class="btn btn-secondary" disabled>Next</button>
        </div>
    

   

    <script type="module" src="/Database/firebase.js">
    </script>
    <!--Navigation Bar-->
<script>
    document.querySelector('.open-btn').addEventListener('click', function() {
        document.getElementById('side_nav').classList.add('active');
    });
  
    document.querySelector('.close-btn').addEventListener('click', function() {
        document.getElementById('side_nav').classList.remove('active');
    });
  </script>

<script>
    document.addEventListener('show.bs.modal', (event) => {
    // Close any open modals before showing a new one
    const openModals = document.querySelectorAll('.modal.show');
    openModals.forEach(modal => bootstrap.Modal.getInstance(modal).hide());
});

</script>


<script>
    const advanceSearchModal = document.getElementById('advanceSearchModal');
advanceSearchModal.addEventListener('hidden.bs.modal', () => {
    // Manually remove any leftover backdrops
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
    document.body.classList.remove('modal-open'); // Ensure body scroll is restored
});

</script>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
        authDomain: "chsd-mis.firebaseapp.com",
        projectId: "chsd-mis",
        storageBucket: "chsd-mis.appspot.com",
        messagingSenderId: "694967679357",
        appId: "1:694967679357:web:65cffd50f13739f934f414",
        measurementId: "G-XBQTQFRLJ5"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const loadingScreen = document.getElementById("loading-screen");
    const modalElement = document.getElementById("advanceSearchModal");
    const searchButton = document.getElementById("searchButton");
    const exportButton = document.querySelector(".btn-secondary");
    const resultCount = document.getElementById("resultCount");

    // Show and hide loading screen
    function showLoading() {
        loadingScreen.style.display = "block";
    }

    function hideLoading() {
        loadingScreen.style.display = "none";
    }

    function closeModal() {
        if (modalElement) {
            const modalInstance = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            modalInstance.hide();
        }
    }

    // Load submitted reports on page load
    window.onload = loadSubmittedReports;

    document.addEventListener("DOMContentLoaded", () => {
        searchButton.addEventListener("click", async () => {
            showLoading();

            // Retrieve filter values
            const dateFrom = document.getElementById("dateFrom").value;
            const dateTo = document.getElementById("dateTo").value;
            const barangay = document.getElementById("barangay").value;
            const ageFrom = document.getElementById("ageFrom").value;
            const ageTo = document.getElementById("ageTo").value;

            // Base query for "Submitted" status
            let searchQuery = query(collection(db, "Housing"), where("status", "==", "Submitted"));

            // Apply filters conditionally
            if (dateFrom && dateTo) {
                searchQuery = query(searchQuery, where("dateApplied", ">=", new Date(dateFrom)), where("dateApplied", "<=", new Date(dateTo)));
            }
            if (barangay) searchQuery = query(searchQuery, where("barangay", "==", barangay));
            if (ageFrom && ageTo) searchQuery = query(searchQuery, where("age", ">=", ageFrom), where("age", "<=", ageTo));

            try {
                // Fetch and display matching documents
                const snapshot = await getDocs(searchQuery);
                const results = snapshot.docs.map(doc => doc.data());

                displayResults(results);
                if (resultCount) {
                    resultCount.textContent = `${results.length} result(s) found`;
                    resultCount.style.display = "block";
                }
                closeModal(); // Close the modal after search results are displayed

                
            } catch (error) {
                console.error("Error retrieving documents:", error);
            } finally {
                hideLoading();
            }
        });

        exportButton.addEventListener("click", () => {
            showLoading();
            exportData();
            hideLoading();
        });
    });

    async function loadSubmittedReports() {
        showLoading();

        // Pagination Variables
        const profilesPerPage = 10;
        let currentPage = 1;
        let totalPages = 1;

        try {
            const q = query(collection(db, "Housing"), where("status", "==", "Submitted"));
            const querySnapshot = await getDocs(q);

            const housingData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            housingData.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            totalPages = Math.ceil(housingData.length / profilesPerPage);

            renderProfiles(housingData, currentPage, profilesPerPage, totalPages);
        } catch (error) {
            console.error("Error loading submitted reports:", error);
        } finally {
            hideLoading();
        }
    }

    function renderProfiles(data, currentPage, profilesPerPage, totalPages) {
        const start = (currentPage - 1) * profilesPerPage;
        const end = start + profilesPerPage;
        const currentProfiles = data.slice(start, end);

        const housingDiv = document.querySelector("tbody");
        if (!housingDiv) return;
        housingDiv.innerHTML = "";

        currentProfiles.forEach(profile => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${profile.householdHeadName || 'N/A'}</td>
                <td>${profile.householdBirthday || 'N/A'}</td>
                <td>${calculateAge(profile.householdBirthday) || 'N/A'}</td>
                <td>${profile.barangay || 'N/A'}</td>
                <td>${profile.sitioPurok || 'N/A'}</td>
                <td>${profile.classificationArea || 'N/A'}</td>
            `;
            housingDiv.appendChild(row);
        });

        document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById("prevPageBtn").disabled = currentPage === 1;
        document.getElementById("nextPageBtn").disabled = currentPage === totalPages;
    }

    function calculateAge(dob) {
        if (!dob) return "N/A";
        const birthDate = new Date(dob);
        const ageDate = new Date(Date.now() - birthDate.getTime());
        return Math.abs(ageDate.getUTCFullYear() - 1970);
    }

    function displayResults(results) {
        const tableBody = document.querySelector(".table tbody");
        tableBody.innerHTML = "";

        results.forEach(data => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${data.householdHeadName || ''}</td>
                <td>${data.householdBirthday || ''}</td>
                <td>${calculateAge(data.householdBirthday) || ''}</td>
                <td>${data.barangay || ''}</td>
                <td>${data.sitioPurok || ''}</td>
                <td>${data.classificationArea || ''}</td>
            `;
            tableBody.appendChild(row);
        });
    }

    function exportData() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const tableBody = document.querySelector(".table tbody");
        const rows = Array.from(tableBody.querySelectorAll("tr"));

        if (rows.length === 0) {
            alert("No data available to export.");
            return;
        }

        let reportTitle = "Application Report";

        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;
        const barangay = document.getElementById("barangay").value;
        const ageFrom = document.getElementById("ageFrom").value;
        const ageTo = document.getElementById("ageTo").value;

        if (dateFrom && dateTo) {
            reportTitle += ` From ${new Date(dateFrom).toLocaleDateString()} To ${new Date(dateTo).toLocaleDateString()}`;
        }

        if (barangay) {
            reportTitle += ` For Barangay ${barangay}`;
        }

        if (ageFrom && ageTo) {
            reportTitle += ` From Ages ${ageFrom} To ${ageTo}`;
        }

        if (!dateFrom && !dateTo && !barangay && !ageFrom && !ageTo) {
            const currentDate = new Date();
            reportTitle += ` For ${currentDate.toLocaleDateString()}`;
        }

        doc.text(reportTitle, 10, 10);
        doc.setFontSize(10);

        const headers = ["Household Head Name", "Birthday", "Age", "Barangay", "Sitio/Purok", "Classification Area"];
        doc.autoTable({
            head: [headers],
            body: rows.map(row => Array.from(row.querySelectorAll("td")).map(td => td.textContent)),
            startY: 20,
            margin: { left: 10, right: 10 }
        });

        const safeTitle = reportTitle.replace(/[^a-zA-Z0-9]/g, "_");
        doc.save(`${safeTitle}.pdf`);
    }
</script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
