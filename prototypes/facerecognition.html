<!DOCTYPE html>
<html>
<head>
    <title>Face Recognition Prototype</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
    <video id="video" width="720" height="560" autoplay muted></video>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-pw5kU3y9RGCX9jMeFPrY3nT4R1nJwiUy6XLZt2Z/6VRRI1j0U7fCZ0T6v7UsPlK/" crossorigin="anonymous"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "your_api_key",
            authDomain: "your_auth_domain",
            projectId: "your_project_id",
            storageBucket: "your_storage_bucket",
            messagingSenderId: "your_messaging_sender_id",
            appId: "your_app_id",
            measurementId: "your_measurement_id"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function setupCamera() {
            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        async function loadModels() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('models');
            await faceapi.nets.faceLandmark68Net.loadFromUri('models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('models');
        }

        async function start() {
            await loadModels();
            const video = await setupCamera();
            video.play();

            video.addEventListener('play', () => {
                const canvas = faceapi.createCanvasFromMedia(video);
                document.body.append(canvas);
                const displaySize = { width: video.width, height: video.height };
                faceapi.matchDimensions(canvas, displaySize);

                setInterval(async () => {
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                    if (detections.length > 0) {
                        await storeFacialData(detections);
                    }
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                }, 100);
            });
        }

        async function storeFacialData(detections) {
            const userId = "some_unique_user_id"; // Replace with actual user ID logic
            const descriptors = detections.map(det => Array.from(det.descriptor));

            try {
                await setDoc(doc(db, "facialData", userId), { descriptors });
                console.log("Facial data stored successfully!");
            } catch (e) {
                console.error("Error storing facial data: ", e);
            }
        }

        start();
    </script>
</body>
</html>
