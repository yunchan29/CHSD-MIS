<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHSD MIS</title>
    <link rel="stylesheet" href="/Stylesheets/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
   
    <style>
        /* CSS for the content container */
        .content {
            flex: 1; /* Take remaining space */
            overflow: hidden; /* Hide overflow content */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Column layout */
        }

        .content-container {
            overflow-y: auto; /* Enable vertical scrolling */
            padding: 20px; /* Add some padding */
        }

        .wide-modal {
            max-width: 80%;
        }
        @media(max-width){
            .wide-modal{
                max-width:100%;
            }
        }

        .form-control {
            margin-bottom: 1rem; /* Add margin between form controls */
        }

        .form-check {
            margin-bottom: 0.5rem; /* Add margin between checkboxes */
        }

        .row.g-3 .col-md-6,
        .row.g-3 .col-md-4,
        .row.g-3 .col-md-12 {
            margin-bottom: 1rem; /* Add margin to columns */
        }

        .d-flex .me-2 {
            margin-right: 1rem; /* Add margin to the right of the input */
        }
        .badge {
    font-size: 0.8rem;
    position: relative;
    top: -10px;
    left: 10px;
}

#calendarModal .modal-dialog {
    max-width: 90%;
    width: auto;
}

#calendar {
    width: 100%;
    height: 500px; /* Adjust height as needed */
}

    </style>
     <!-- FullCalendar CSS and JS -->
     <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet' />
     <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js'></script>
     <script>
        document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        selectable: true,
        dateClick: async function (info) {
            const selectedDate = info.date;
            try {
                // Update Firebase here with the selected date
                const docId = rescheduleBtn.getAttribute('data-id');
                const permitType = rescheduleBtn.getAttribute('data-permit-type');
                const permitDoc = doc(db, permitType === "Building Permit" ? "buildingPermits" :
                                              permitType === "Certificate of Occupancy" ? "OccupancyPermits" :
                                              permitType === "Housing Application" ? "Housing" : "ElectricalCert", docId);
                
                await updateDoc(permitDoc, { appointmentDate: Timestamp.fromDate(selectedDate) });
                alert('Appointment rescheduled successfully!');
                
                // Close modal
                new bootstrap.Modal(document.getElementById('calendarModal')).hide();
            } catch (error) {
                console.error("Error rescheduling appointment:", error);
                alert("Error rescheduling appointment.");
            }
        }
    });
    calendar.render();
});

     </script>
</head>
<body>
    <div id="fetching-loading-screen" class="fetching-loading-screen">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Fetching from database...</span>
        </div>
        <p class="loading-text">Fetching from database...</p>
    </div>
    
    <div class="main-container d-flex">

        <!--Sidebar-->
        <div class="sideNav" id="side_nav">
            <div class="container">
                <div class="header-box text-center px-2 pt-3 pb-4 ">
                    <button class="btn d-md-none d-block close-btn px-1 py-0 text-black"><i class="fa-solid fa-bars-staggered"></i></button>
                    <div class="avatar-placeholder">
                        <img id="client-avatar" src="" alt="loading..." width="100" height="100">

                    </div>
                    <div class="avatar-text">
                        <!-- Client ID and Name -->
                        <div id="user-name">loading...</div>
                    </div>
                    
                </div>
            </div>
            <ul class="sideBarList list-unstyled px-2">
                <li class="sideNav active"><a href="clientDashboard.html" class="text-decoration-none"><i class="fa-solid fa-circle-info"></i> Application Status</a></li>
                <li class="sideNav"><a href="clientRequirements.html" class="text-decoration-none"><i class="fa-solid fa-list"></i> Requirements List</a></li>
                <li class="sideNav"><a href="clientApplication.html" class="text-decoration-none"><i class="fa-solid fa-newspaper"></i> Applications</a></li>
                <li class="sideNav"><a href="clientProfile.html" class="text-decoration-none"><i class="fa-solid fa-gear"></i> Settings</a></li>
                
                <li class="sideNav" id="user-logout-btn"><a href="#" class="text-decoration-none"><i class="fa-solid fa-right-from-bracket"></i> Log out</a></li>
            </ul>
        </div>
       

        <div class="content">
           

          <!-- Navigation Bar -->
<nav class="navigationBar navbar navbar-expand-lg bg-light">
    <div class="container-fluid">
        <!-- Mobile View -->
        <div class="d-flex justify-content-between d-md-none d-block">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="/resources/pictures/chsd.png" alt="CHSD" width="40" height="40" class="me-2">
                <h5 class="mb-0 fs-5">CHSD</h5>
            </a>
            <button class="btn px-1 py-0 open-btn">
                <i class="fa-solid fa-bars-staggered"></i>
            </button>
        </div>

        <!-- Desktop View -->
        <div class="collapse navbar-collapse d-none d-md-flex" id="navbarSupportedContent">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="/resources/pictures/chsd.png" alt="CHSD" width="75" height="75" class="me-2">
                <h5 class="mb-0 fs-5 fs-lg-4">City Housing and Settlements Department</h5>
            </a>

            <!-- Right-aligned content: Notifications -->
<ul class="navbar-nav ms-auto">
    <!-- Notifications Dropdown -->
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-bell"></i>
            <span id="notification-badge" class="badge bg-danger" style="display: none;">0</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown" style="width: 500px; padding: 15px; max-height: 500px; overflow-y: auto;">
            <li>
                <h6 class="dropdown-header">Notifications</h6>
            </li>
            <li>
                <div class="notifications-container" id="notification-container" style="max-height: 400px; overflow-y: auto; overflow-x: hidden;">
                    <!-- Notifications will be dynamically added here -->
                </div>
            </li>
            <li>
                <div class="dropdown-item text-center">
                    <button id="prevPageBtn" class="btn btn-secondary btn-sm">Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextPageBtn" class="btn btn-secondary btn-sm">Next</button>
                </div>
            </li>
        </ul>
    </li>
</ul>

        </div>
    </div>
</nav>
            <div class="contentContainer">
                <div id="existing-remarks"></div>
                <h4 class="text-start">Application Status</h4>
                <!-- Bootstrap Table -->
                <div class="container">
                    <div class="d-flex justify-content-end mb-3">
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Permit/Housing No.</th>
                                <th>Client Name</th>
                                <th>Request</th>
                                <th>Date Filed</th>
                                <th>Status</th>
                                <th>Appointment</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="permit-status-table">
                            <!-- Dynamically generated rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <!-- End of Bootstrap Table -->
            </div>
        </div>
    </div>

    <!-- Application Modal -->
    <div class="modal fade" id="buildingPermitModal" tabindex="-1" aria-labelledby="BuildingPermitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable wide-modal">
            <div class="modal-content buldingPermitApplication">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="BuildingPermitModalLabel"><i class="fa-solid fa-user"></i> Application</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Application Modal Content -->
                    <div class="container">
                        <div class="step-progress mb-4">
                            <div class="step completed">
                                <div class="circle"></div>
                                <div class="label">Form</div>
                            </div>
                            <div class="step">
                                <div class="circle"></div>
                                <div class="label">Order of Payment</div>
                            </div>
                            <div class="step">
                                <div class="circle"></div>
                                <div class="label">Certificate</div>
                            </div>
                        </div>
                        <form>
                            <div class="mb-3">
                                <div class="d-flex col-md-3">
                                    <input type="text" class="form-control me-2" id="hsdFormNo" placeholder="HSD Form No.">
                                    <button type="button" class="btn btn-secondary" onclick="window.print();"><i class="fa-solid fa-print"></i> Print</button>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="buildingPermitNo" placeholder="Building Permit No.">
                                </div>
                                <div class="col-md-6">
                                   <div class="input-group">
                                   <span class="input-group-text" id="basic-addon3">Issued on:</span>
                                  <input type="date" class="form-control" id="basic-url" aria-describedby="basic-addon3 basic-addon4">
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <input type="text" class="form-control" id="ownerName" placeholder="Owner/Applicant (Last Name, First Name, MI)">
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="addressTelNo" placeholder="Address and Tel No.">
                                </div>
                                
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="projectLocation" placeholder="Project Location">
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="row g-3">
                                    <label for="form-check" class="form-label">Scope of Work</label>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="option1" id="option1">
                                            <label class="form-check-label" for="option1">New Construction</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="option2" id="option2">
                                            <label class="form-check-label" for="option2">Addition</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="option3" id="option3">
                                            <label class="form-check-label" for="option3">Repair Renovation</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="option4" id="option4">
                                            <label class="form-check-label" for="option4">Others</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="row g-3">
                                    <label for="form-check" class="form-label">Project Justification</label>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="justification1" id="justification1">
                                            <label class="form-check-label" for="justification1">Single Attached/Semi-Attached/Duplex</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="justification2" id="justification2">
                                            <label class="form-check-label" for="justification2">Single/Detached</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="justification3" id="justification3">
                                            <label class="form-check-label" for="justification3">Row House/Multi-family Dwelling</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="nextStepButton" class="btn btn-primary">Next</button>
                </div>
            </div>
        </div>
    </div>

    
   <!-- Remarks Modal -->
<div class="modal fade" id="viewRemarks" tabindex="-1" aria-labelledby="remarksModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="remarksModalLabel">Remarks</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="remarks-content">
            
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="calendarModalLabel">Reschedule Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="followUpModal" tabindex="-1" aria-labelledby="followUpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="followUpModalLabel">Follow-up Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="followUpForm">
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Update Phone Number</label>
                        <input type="text" class="form-control" id="phoneNumber" placeholder="Enter your phone number">
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <label for="householdAddress">Present Address</label>
                            <input type="text" class="form-control" id="householdAddress" placeholder="Enter your present address">
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="submitFollowUpRequest">Update Info and Submit Follow-up</button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    // Prevent dropdown from closing when clicking on buttons or notifications
    document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
        dropdown.addEventListener('click', (event) => {
            if (event.target.closest('.btn') || event.target.closest('.client-notification')) {
                event.stopPropagation();
            }
        });
    });

    handleAuthState();
});

  </script>

  <!--Download PDF and Excel Libraries-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log(typeof ExcelJS); // Should print 'object'
    });
</script>


<script>
    const { jsPDF } = window.jspdf;

</script>


    <!-- Firebase and custom scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/exceljs@4.2.1/dist/exceljs.min.js"></script>
    <script type="module" defer src="/Database/firebase.js"></script>

    // Firebase and custom scripts
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, limit, onSnapshot, startAfter, getDocs, updateDoc} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBhvoPidRWGeJmnN2E11SBS5n8oyxVLJ0M",
            authDomain: "chsd-mis.firebaseapp.com",
            projectId: "chsd-mis",
            storageBucket: "chsd-mis.appspot.com",
            messagingSenderId: "694967679357",
            appId: "1:694967679357:web:65cffd50f13739f934f414",
            measurementId: "G-XBQTQFRLJ5"
        };
    
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
    
        let notificationsPerPage = 5; // Number of notifications per page
        let currentPage = 1; // Track the current page
        let totalPages = 1; // Total pages based on the number of notifications
        let lastVisibleDoc = null; // Keep track of the last document for pagination
    
        // Function to load client notifications with pagination
        async function loadClientNotifications(userId) {
            const notificationsRef = collection(db, "notifications");
            const notificationContainer = document.getElementById("notification-container");
    
            const prevPageBtn = document.getElementById("prevPageBtn");
            const nextPageBtn = document.getElementById("nextPageBtn");
            const pageInfo = document.getElementById("pageInfo");
    
            // Fetch total notifications for user to calculate total pages
            const allNotificationsSnapshot = await getDocs(query(
                notificationsRef,
                where("userId", "==", userId)
            ));
    
            const totalNotifications = allNotificationsSnapshot.size;
            totalPages = Math.ceil(totalNotifications / notificationsPerPage);
    
            // Query notifications for the current page, ordered by timestamp
            let notificationsQuery = query(
                notificationsRef,
                where("userId", "==", userId),
                orderBy("timestamp", "desc"),
                limit(notificationsPerPage)
            );
    
            // If it's not the first page, start after the last visible document
            if (lastVisibleDoc && currentPage > 1) {
                notificationsQuery = query(notificationsQuery, startAfter(lastVisibleDoc));
            }
    
            onSnapshot(notificationsQuery, (snapshot) => {
                notificationContainer.innerHTML = ''; // Clear previous notifications
    
                if (snapshot.docs.length === 0) {
                    notificationContainer.innerHTML = '<p>No notifications available.</p>';
                }
    
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const notification = document.createElement('div');
                    notification.className = 'client-notification';
                    
                    // Apply bold style for unread notifications
                    if (!data.read) {
                        notification.style.fontWeight = 'bold';
                    }
    
                    // Make notification clickable
                    notification.innerHTML = `${data.message} <br><small>${new Date(data.timestamp.seconds * 1000).toLocaleString()}</small>`;
                    notification.style.cursor = 'pointer';
    
                    notification.addEventListener('click', async () => {
                        // Mark the notification as read in Firestore
                        await updateDoc(doc.ref, {
                            read: true
                        });
    
                        // Remove the bold style
                        notification.style.fontWeight = 'normal';
    
                        // Reload unread notifications to update the badge
                        fetchUnreadNotifications(userId);
                    });
    
                    notificationContainer.appendChild(notification);
                });
    
                // Track the last visible document for pagination
                lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];
    
                // Update page info
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    
                // Disable/enable pagination buttons
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            });
        }
    
        // Function to fetch unread notifications and update the badge
        async function fetchUnreadNotifications(userId) {
            const notificationsRef = collection(db, "notifications");
    
            const unreadNotificationsQuery = query(
                notificationsRef,
                where("userId", "==", userId),
                where("read", "==", false)
            );
    
            const unreadSnapshot = await getDocs(unreadNotificationsQuery);
            const unreadCount = unreadSnapshot.size;
    
            updateNotificationBadge(unreadCount); // Update the badge
        }
    
        // Function to update the notification badge
        function updateNotificationBadge(unreadCount) {
            const badgeElement = document.getElementById('notification-badge');
            if (unreadCount > 0) {
                badgeElement.style.display = 'inline-block'; // Show the badge
                badgeElement.textContent = unreadCount;      // Set the count
            } else {
                badgeElement.style.display = 'none';         // Hide the badge if no unread notifications
            }
        }
    
        // Function to handle authentication state
        function handleAuthState() {
            const prevPageBtn = document.getElementById("prevPageBtn");
            const nextPageBtn = document.getElementById("nextPageBtn");
    
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, get user ID and load notifications
                    const userId = user.uid;
    
                    // Load initial notifications
                    loadClientNotifications(userId);
    
                    // Fetch unread notifications to update the badge
                    fetchUnreadNotifications(userId);
    
                    // Handle "Previous Page" button click
                    prevPageBtn.addEventListener("click", () => {
                        if (currentPage > 1) {
                            currentPage--;
                            lastVisibleDoc = null; // Reset last visible document when going to the previous page
                            loadClientNotifications(userId);
                        }
                    });
    
                    // Handle "Next Page" button click
                    nextPageBtn.addEventListener("click", () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            loadClientNotifications(userId);
                        }
                    });
                } else {
                    console.error("User is not signed in.");
                }
            });
        }
    
        // Start monitoring authentication state when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            handleAuthState();
        });
    </script>
    
    

    <!-- Bootstrap and other scripts -->
  
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
    <script src="/ClientPages/navBarScript.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
        var sideNav = document.getElementById('side_nav');
        var openBtn = document.querySelector('.open-btn');
        var closeBtn = document.querySelector('.close-btn');
        var dropdownItems = document.querySelectorAll('.sideNav.dropdown');
    
        // Toggle the sidebar for mobile view
        openBtn.addEventListener('click', function() {
            sideNav.classList.add('active');
        });
    
        closeBtn.addEventListener('click', function() {
            sideNav.classList.remove('active');
        });
    
        // Handle dropdown in sidebar
        dropdownItems.forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevents clicks from closing the sidebar
                this.classList.toggle('open');
            });
        });
    
        // Close the sidebar when clicking outside of it (optional)
        document.addEventListener('click', function(e) {
            if (!sideNav.contains(e.target) && !openBtn.contains(e.target)) {
                sideNav.classList.remove('active');
            }
        });
    });
    
    
        </script>





    
    
    
    </body>
    </html>